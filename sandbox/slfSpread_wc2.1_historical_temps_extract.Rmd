---
title: "slfSpread_wc2.1_historical_temps_extract"
author: "Sam Owens"
date: "2023-05-08"
output: html_document
---

# convert rasters to dfs

This vignette was created for two purposes:

First, to extract climate rasters from [worldclim](https://www.worldclim.org/data/worldclim21.html) to data frames. These data are historical temperature minimums, maximums and meanss from 1970-2000. They are further divided by month. Each file is a raster containing tmin/tmean/tmax for that month over the 30 year period for the globe. These will be extracted to individual data frames and then joined into three final rasters (one for each of the 3 kinds of data). 

These data will be used to produce a binary suitability map via the Lewkiewicz et al PDE model for SLF. The final data produced from this model will also be manipulated and explored here

file paths edited 2023-06-01

```{r library necessary packages}

#install.packages("tidyverse")
library(tidyverse)

#install.packages("here")
library(here)
here()
# here() is ".../Shared drives/slfClimate/projects/slfSpread/slfSpread_pkg"

# install.packages("terra")
library(terra)

```

## tmin rasters conversion

```{r convert Jan tmin data}

# pathing
mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")



# load in raster
tmin_jan <- rast(x = file.path(mypath, "originals", "tmin", "wc2.1_5m_tmin_01.tif"))

# attributes of raster
#tmin_jan@layers # only 1 layer
#ext(tmin_jan) # extent is too large

# extent object
#same.extent <- extent(-180, 180, -60, 84) 
# layer to trim other layers to
#main_layer <- crop(raster(file.path(mypath,"tmin", "wc2.1_5m_tmin_01.tif")), y = same.extent, overwrite = F)

# set CRS
#crs(tmin_jan) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
#tmin_jan <- resample(x = tmin_jan, y = main_layer, method = "bilinear")

# overwrite as df
tmin_jan <- terra::as.data.frame(tmin_jan, cells = TRUE, xy = TRUE)

# write to csv
write_csv(x = tmin_jan, file = file.path(mypath, "dfs", "tmin", "wc2.1_5m_tmin_01.csv"))

```

```{r crap code}

#output_paths$input_paths <- substr(output_paths$input_paths, 1, nchar(input_paths)-25)
  # convert back to list
#output_paths <- as.character(output_paths$input_paths)
  # gsub endings
#output_paths <- gsub(pattern = "originals/", replacement = "dfs/tmin", x = output_paths)

#output_paths[4]

```


```{r loop for conversion of remaining tmin data to data.frame}

# my path
mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

# First, I need to create a directory of file paths and of final file names

# EDIT THESE, NOT THE LOOP


# pathing objects

# list of input file paths
input_paths <- list.files(file.path(mypath, "originals", "tmin"), full.names = TRUE)

input_paths[1]

# file path for output
output_path <- gsub(pattern = "originals/tmin/wc2.1_5m_tmin_01.tif", replacement = "dfs/tmin", x = input_paths[1])

# naming objects

# list of .tif file names for conversion
input_names <- list.files(file.path(mypath, "originals", "tmin"), full.names = FALSE)
# list of df names for output from the loop
output_names <- gsub(pattern = ".tif", replacement = ".csv", x = input_names)



# check

# check input paths
input_paths[5]
# check output path
paste0(output_path, output_names[5])


# loop
for (i in seq_along(1:length(input_paths))) {
  
  # read the data
  data_import <- rast(input_paths[i])
  
  # convert to data.frame
  data_import <- terra::as.data.frame(data_import, cells = TRUE, xy = TRUE)
  
  # write as csv
  write_csv(x = data_import, file = file.path(output_path, output_names[i]))
  
}

```

## tavg rasters conversion

```{r tavg to df loop}

# ONLY EDIT THESE TWO OBJECTS

# my path
mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

data_type <- "tavg"





# First, I need to create a directory of file paths and of final file names

# pathing objects

# list of input file paths
input_paths <- list.files(file.path(mypath, "originals", data_type), full.names = TRUE)

input_paths[1]

# file path for output
output_path <- gsub(pattern = paste0("originals/", data_type, "/wc2.1_5m_", data_type, "_01.tif"), replacement = paste0("dfs/", data_type), x = input_paths[1])

# naming objects

# list of .tif file names for conversion
input_names <- list.files(file.path(mypath, "originals", data_type), full.names = FALSE)
# list of df names for output from the loop
output_names <- gsub(pattern = ".tif", replacement = ".csv", x = input_names)


# check

# check input paths
input_paths[5]
# check output path
paste0(output_path, output_names[5])



# loop
for (i in seq_along(1:length(input_paths))) {
  
  # read the data
  data_import <- rast(input_paths[i])
  
  # convert to data.frame
  data_import <- terra::as.data.frame(data_import, cells = TRUE, xy = TRUE)
  
  # write as csv
  write_csv(x = data_import, file = file.path(output_path, output_names[i]))
  
}

```

## tmax rasters conversion

```{r tmax to df loop}

# ONLY EDIT THESE TWO OBJECTS

# my path
mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

data_type <- "tmax"





# First, I need to create a directory of file paths and of final file names

# pathing objects

# list of input file paths
input_paths <- list.files(file.path(mypath, "originals", data_type), full.names = TRUE)

# file path for output
output_path <- gsub(pattern = paste0("originals/", data_type, "/wc2.1_5m_", data_type, "_01.tif"), replacement = paste0("dfs/", data_type), x = input_paths[1])



# naming objects

# list of .tif file names for conversion
input_names <- list.files(file.path(mypath, "originals", data_type), full.names = FALSE)
# list of df names for output from the loop
output_names <- gsub(pattern = ".tif", replacement = ".csv", x = input_names)


# check

# check input paths
input_paths[5]
# check output path
paste0(output_path, output_names[5])

# loop
for (i in seq_along(1:length(input_paths))) {
  
  # read the data
  data_import <- rast(input_paths[i])
  
  # convert to data.frame
  data_import <- terra::as.data.frame(data_import, cells = TRUE, xy = TRUE)
  
  # write as csv
  write_csv(x = data_import, file = file.path(output_path, output_names[i]))
  
}

```

# file consolidation

## tmin csvs

```{r tmin csv joining}

# ONLY EDIT THESE TWO OBJECTS

# my path
mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

data_type <- "tmin"





# First, I need to create a directory of file paths and of final file names

# pathing objects

# list of input file paths
input_paths <- list.files(file.path(mypath, "dfs", data_type), full.names = TRUE)

# file path for output
output_path <- file.path(mypath, "dfs")




# testing
feb <- read_csv(input_paths[2])

range(data_join$cell)
range(feb$cell)

range(data_join$x)
range(feb$x)

# the initial object that others will be joined to (the january df)- RUN THIS LINE BEFORE THE FOR LOOP
data_join <- read_csv(input_paths[1])

# loop- RUN ABOVE CODE FIRST
for (i in 2:length(input_paths)) {
  
  # read the other csvs into this object
  data_join <- read_csv(input_paths[i]) %>%
    # join each other csv to the january csv. I am like 99% sure the lat, long and cell number are the same between months
    right_join(data_join, ., by = c("cell", "x", "y"))
  
}

# write as csv
write_csv(x = data_join, file = file.path(output_path, paste0("ANNUAL_wc2.1_5m_", data_type, ".csv")))
  
```

## tavg csvs

```{r tmin csv joining}

# ONLY EDIT THESE TWO OBJECTS

# my path
mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

data_type <- "tavg"





# First, I need to create a directory of file paths and of final file names

# pathing objects

# list of input file paths
input_paths <- list.files(file.path(mypath, "dfs", data_type), full.names = TRUE)

# file path for output
output_path <- file.path(mypath, "dfs")


# the initial object that others will be joined to (the january df)- RUN THIS LINE BEFORE THE FOR LOOP
data_join <- read_csv(input_paths[1])

# loop- RUN ABOVE CODE FIRST
for (i in 2:length(input_paths)) {
  
  # read the other csvs into this object
  data_join <- read_csv(input_paths[i]) %>%
    # join each other csv to the january csv. I am like 99% sure the lat, long and cell number are the same between months
    right_join(data_join, ., by = c("cell", "x", "y"))
  
}

# write as csv
write_csv(x = data_join, file = file.path(output_path, paste0("ANNUAL_wc2.1_5m_", data_type, ".csv")))
  
```

## tmax csvs

```{r tmin csv joining}

# ONLY EDIT THESE TWO OBJECTS

# my path
mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

data_type <- "tmax"





# First, I need to create a directory of file paths and of final file names

# pathing objects

# list of input file paths
input_paths <- list.files(file.path(mypath, "dfs", data_type), full.names = TRUE)

# file path for output
output_path <- file.path(mypath, "dfs")


# the initial object that others will be joined to (the january df)- RUN THIS LINE BEFORE THE FOR LOOP
data_join <- read_csv(input_paths[1])

# loop- RUN ABOVE CODE FIRST
for (i in 2:length(input_paths)) {
  
  # read the other csvs into this object
  data_join <- read_csv(input_paths[i]) %>%
    # join each other csv to the january csv. I am like 99% sure the lat, long and cell number are the same between months
    right_join(data_join, ., by = c("cell", "x", "y"))
  
}

# write as csv
write_csv(x = data_join, file = file.path(output_path, paste0("ANNUAL_wc2.1_5m_", data_type, ".csv")))
  
```

The above datasets were used to create a binary suitability based on DD accumulation. This function used a threshold number of degree days that is necessary for 50% of an SLF population to reach egg-laying stage. From this count, a binary suitability metric was computed. I need to convert this output from the DD function, which was calculated using the datasets above, into a raster and visualize it.

Stephanie created the original version of this output using code written in MatLab. She then translated the MatLab code into R and created the second version of the output. I will compare these versions to ensure that the R function is working properly. After this, I will "rasterize" the final output.

```{r compare matlab and R versions of DD output}

mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

# load outputs
DD_output_matlab <- read_csv(file.path(mypath, "dd_accumulation_work", "annual_degree_days_20230519.csv")) %>%
  # make col names consistent
  rename("x" = "x_lon",
         "y" = "y_lat")

DD_output_R <- read_csv(file.path(mypath, "dd_accumulation_work", "annual_degree_days_20230605.csv")) %>%
  # remove rownames column
  select(-`...1`) %>%
  # make col names consistent
  rename("reaches_egg_laying" = "reaches_egglaying")


# check for matches in DD count column
test <- as.data.frame(ifelse(DD_output_matlab$total_annual_dds == DD_output_R$total_annual_dds,
                             "",
                             "DOES NOT MATCH")) %>%
  mutate(row_num = seq_len(nrow(test))) %>%
  select(row_num, everything()) %>%
# filter out only those that dont match
  filter(., `ifelse(DD_output_matlab$total_annual_dds == DD_output_R$total_annual_dds, \"\", \"DOES NOT MATCH\")` == "DOES NOT MATCH") 

# about 44,000 don't match
# pull out mismatches to see closeness

# create a list of mismatch rows
mismatch_list <- as.vector(test$row_num)

# side by side of mismatched rows
mismatch_compare <- DD_output_matlab %>%
  left_join(., DD_output_R, by = c("cell", "x", "y")) %>%
  select(total_annual_dds.x, total_annual_dds.y) %>%
  slice(mismatch_list) %>%
  mutate(row_num = mismatch_list) %>%
  select(row_num, everything()) %>%
  rename("matlab" = "total_annual_dds.x",
         "R" = "total_annual_dds.y")

# pull out match sample
DD_output_matlab[236184, 4]

# they are all the same, despite being labeled as mismatches

# check for matches in binary column
test <- as.data.frame(ifelse(DD_output_matlab$reaches_egg_laying == DD_output_R$reaches_egg_laying,
                             "",
                             "DOES NOT MATCH")) %>%
  filter(., `ifelse(DD_output_matlab$reaches_egg_laying == DD_output_R$reaches_egg_laying, \"\", \"DOES NOT MATCH\")` == "DOES NOT MATCH")
# no mismatches detected

colnames(test)

# CONCLUSION- mismatch_compare object is a side-by-side comparison of inconsistent rows. They are identical despite saying they are mismatched. The functions are identical, so the Matlab output will be used. In the future, the R function will be used if these values need to be re-generated.

```

# convert DD model output to raster (use version created in Matlab)

```{r convert DD model output csv to raster and export}

mypath <- file.path(here() %>%
                   dirname(),
                 "maxent", "historical_climate_rasters", "wc2.1_5arcmin")

# load in an original tif as a sample
sample_tif <- rast(x = file.path(mypath, "originals", "tmin", "wc2.1_5m_tmin_01.tif"))

# load in DD calculation created in R
DD_suitable_area <- read_csv(file = file.path(mypath, "dd_accumulation_work", "annual_dd_accumulation_adult_emergence-1_20230619.csv")) %>%
  dplyr::select(-c(cell, total_annual_dds, `...1`))
# convert to raster
DD_suitable_area_raster <- rast(x = DD_suitable_area)

# set extent

# extent does not need to be cropped
ext(sample_tif)
ext(DD_suitable_area_raster)

# extent object
#ext.obj <- ext(sample_tif) # use extent of original tif to set extent of new tif
# set extent
#DD_suitable_area_raster <- terra::crop(x = DD_suitable_area_raster, y = ext.obj)
# check extent
#ext(DD_suitable_area_raster)

# set crs

# crs object- uses same proj4 string used in other maxent models
crs.obj <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
# check crs
crs(DD_suitable_area_raster, describe = TRUE, proj = TRUE)
# set crs
crs(DD_suitable_area_raster) <- crs.obj
# project
# DD_suitable_area_raster <- project(x = DD_suitable_area_raster, from = DD_suitable_area_raster, to = crs.obj)
# ensure crs is set
crs(DD_suitable_area_raster, describe = TRUE, proj = TRUE)


# write as raster
writeRaster(x = DD_suitable_area_raster, filename = file.path(mypath, "DD_suitable_area_adult_emergence-1.tif"), filetype = "GTiff", overwrite = FALSE)

```

```{r masking .tif file}
# create masked version for use in MaxEnt

DD_suitable_area_masked <- subst(DD_suitable_area_raster, from = 0, to = NA)

# write as raster
writeRaster(x = DD_suitable_area_masked, filename = file.path(mypath, "DD_suitable_area_masked.tif"), filetype = "GTiff", overwrite = FALSE)

```

# visualize DD model

```{r visualize and EDA DD suitable area}

#convert sample to df to visualize
sample_tif_df <- terra::as.data.frame(sample_tif, xy = TRUE)

# visualize over sample tif
test_map <- ggplot() +
  geom_raster(data = sample_tif_df,
              aes(x = x, y = y),
              fill = "red") +
  geom_raster(data = DD_suitable_area,
              aes(x = x, y = y, fill = reaches_egg_laying)) +
  coord_quickmap()

# visualize over ggplot world map
test_map <- ggplot() +
  geom_polygon(data = map_data('world'), 
               aes(x = long, y = lat, group = group), 
               fill = "red", 
               color = "red",
               size = 0.75) +
  geom_raster(data = DD_suitable_area,
              aes(x = x, y = y, fill = reaches_egg_laying)) +
  coord_quickmap()

# save map to ask for help
ggsave(test_map, filename = file.path("C:/Users/tun83449/Downloads/DD_suitable_area_map.png"), dpi = "retina")
  
# raster is not lining up with ggplot basemap. Troubleshooting to follow

# check crs of raster
crs(DD_suitable_area_raster, describe = TRUE)
# compare with original
crs(sample_tif, describe = TRUE)
# crs is the same

# check extent
ext(DD_suitable_area_raster)
# extent of sample tif
ext(sample_tif)

```


