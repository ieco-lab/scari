---
title: "slfSpread_jumps_locations_v3"
author: "Sam Owens"
contact: 'sam.owens@temple.edu'
date: '2022-04-14'
output: html_document
---

This code is being rerun because errors were found in the output of the lycordata packages by Seba de bona. The script to discern which data points in the SLF occurrence data are jumps (999_Dataset_rarefication) was re-run by Nadege. This script will produce a table with the most up-to-date list of SLF "jumps" to new locations. 

file paths edited 2023-06-01

# Load necessary packages and datasets

```{r load necessary packages, include=FALSE}

install.packages(c("here", "tidyverse", "magittr", "sf", "tigris", "maps"))

library(here)
here()
# here() is "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/slfSpread_pkg"

library(tidyverse)
library(magrittr)
library(sf)
library(tigris)
library(maps)
options(tigris_use_cache = TRUE)

```

```{r load necessary datasets, echo = FALSE}

# Here is where the raw jump records data were read in
SLF_jumps_clustered <- read_csv(
  file.path(here(), "data_raw/jumps_full_rarefied_v2.csv")
)

# Here is an object containing strings of state names that will be used with the counties object in the tigris package
which_states <- c("Alabama",
                  "Alaska",
                  "Arizona",
                  "Arkansas",
                  "California",
                  "Colorado",
                  "Connecticut",
                  "Delaware",
                  "Florida",
                  "Georgia",
                  "Hawaii",
                  "Idaho",
                  "Illinois",
                  "Indiana",
                  "Iowa",
                  "Kansas",
                  "Kentucky",
                  "Louisiana",
                  "Maine",
                  "Maryland",
                  "Massachusetts",
                  "Michigan",
                  "Minnesota",
                  "Mississippi",
                  "Missouri",
                  "Montana",
                  "Nebraska",
                  "Nevada",
                  "New Hampshire",
                  "New Jersey",
                  "New Mexico",
                  "New York",
                  "North Carolina",
                  "North Dakota",
                  "Ohio",
                  "Oklahoma",
                  "Oregon",
                  "Pennsylvania",
                  "Rhode Island",
                  "South Carolina",
                  "South Dakota",
                  "Tennessee",
                  "Texas",
                  "Utah",
                  "Vermont",
                  "Virginia",
                  "Washington",
                  "West Virginia",
                  "Wisconsin",
                  "Wyoming"
)

# Here are the state names that will be added to the counties tigris dataset. They were initially retrieved from USGS.gov on 2021-04-21.
state_names <- read_csv(
  file.path(here(), "data_raw/US_FIPS_Codes.csv"),
  skip = 1
)

counties <- counties(state = which_states,
                     cb = T,
                     resolution = "500k"
) %>%
  mutate(FIPS = as.numeric(paste0(STATEFP,
                                  COUNTYFP))
  )

urban_areas <- urban_areas()

```

# Data tidying and joining

```{r tidying state_names and joining, echo = FALSE}

state_names %<>%
  select(State, `FIPS State`) %>%
  # eliminating duplicate entries- county FIPS names caused duplicates
  unique() %>%
  rename(FIPS_State = `FIPS State`)

counties %<>%
  left_join(state_names,
            by = c("STATEFP" = "FIPS_State")
  )

```

```{r unique key ID and ref number added to jump dataset, echo = FALSE}

SLF_jumps_transform <- SLF_jumps_clustered %>%
  select(bio_year,
         latitude_rounded,
         longitude_rounded,
         # the rarefied column keeps only the centroid point in a cluster of points so, = TRUE represents a unique spread event
         Rarefied
  ) %>%
  filter(Rarefied == "TRUE" ) %>%
  arrange(bio_year,
          latitude_rounded,
          longitude_rounded
  ) %>%
  mutate(ref_ID = paste(latitude_rounded,
                        longitude_rounded,
                        sep = "_"),
    row_ID = seq(along.with = ref_ID)
         # This ID column is simply a series of numbers that are used to match the FIPS codes. They are deleted once the FIPS codes are added
  )

```

```{r FIPS codes, county names, municipal data joined with cleaned jump dataset, echo = FALSE}

# county names and FIPS codes

SLF_jumps_transform %<>%
  # reducing data to coordinates only, and ID for future merging
  select(latitude_rounded, longitude_rounded, row_ID) %>%
  # transforming into spatial feature (sf) object
  sf::st_as_sf(coords = c("longitude_rounded", "latitude_rounded"),
               crs = sf::st_crs(counties)) %>%
  # intersecting state polygons with coordinate points in data, to find in which US state the coordinates are
  st_join(., counties, join = sf::st_intersects) %>%
  as_tibble() %>%
  # simplifying to row ID, county name and county identity
  select(row_ID, county = NAME, FIPS, State) %>%
  # then joining this into main dataset
  left_join(SLF_jumps_transform, ., by = "row_ID")

# municipal data

SLF_jumps_transform  %<>%
  select(latitude_rounded, longitude_rounded, row_ID) %>%
  sf::st_as_sf(coords = c("longitude_rounded", "latitude_rounded"),
               crs = sf::st_crs(urban_areas)) %>%
  st_join(., urban_areas, join = sf::st_intersects) %>%
  as_tibble() %>%
  select(row_ID, urban_area = NAMELSAD10, urban_GEOID = GEOID10) %>%
  left_join(SLF_jumps_transform, ., by = "row_ID")

```

# Final data cleaning and export

```{r final data cleaning, echo = FALSE}

SLF_jumps_tidied <- SLF_jumps_transform %>%
  rename(county_FIPS = FIPS) %>%
  # moving the ref_ID column to front and moving state names to left of county names
  select(ref_ID,
         bio_year,
         latitude_rounded,
         longitude_rounded,
         State,
         everything()
  ) %>%
  # removing unnecessary rowID and Rarefied columns
  select(-c(row_ID, Rarefied))

```

```{r data export}

write_csv(SLF_jumps_tidied,
          file.path(here(), "data_root/slfSpread_jumps_locations_SMO_v3.csv")
)

```
