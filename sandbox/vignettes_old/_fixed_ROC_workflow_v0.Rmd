---
title: "fixed_ROC_workflow"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2023-10-10"
output: html_document
---

*Note* Before running this vignette, you should either run the function `slfSpread::compute_MaxEnt_summary_statistics()`, or run the following sections in vignette 050: "tidy datasets for modeling", "Train a maxent model", and "evaluate a maxent model". All of "evaluate a maxent model" should be run up until the subsection "Fixed area AUC". 

*Note* This vignette is an example of the workflow for the function within this package called `slfSpread::compute_MaxEnt_fixed_ROC()`, which is used in vignette 050 to obtain the final results. This vignette does not need to be run to obtain the final results of the workflow. 

# Overview

This vignette outlines the workflow used to create a custom ROC curve for the fixed area background points created in vignette 040. These points will then be used to calculate an alternative AUC that is insensitive to background size in vignette 050. 

STUFF



All of these results can also be obtained using a function in this package called `compute_MaxEnt_fixed_ROC()`. 

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here()
# here() starts at the root folder of this package.
library(devtools)

library(viridis)

# essential packages
library(terra) 
library(pROC)
library(SDMtune)

library(patchwork)

```

# Fixed area AUC

## Make predictions for test dataset

In order to calculate the ROC values for fixed vs flexible AUC, I need to extract the predicted suitability for the test data that were separated off and for the background points that were selected from a regular grid across the study area. Some of this method was taken from Phillips et.al, 2017.

First, I will load in the test dataset and make predictions for only those presences.

```{r load test dataset}

entire_fixed_presences <- read.csv(file = file.path(mypath, "easternUSA_entire_test.csv")) %>%
  dplyr::filter(pa == 1) %>%
  dplyr::select(bio11_1981_2010:bio2_1981_2010)

```

```{r make predictions for test dataset}

entire_fixed_presences_predict <- SDMtune::predict(
  object = easternUSA_entire_model, # model
  data = entire_fixed_presences, # data for prediction
  fun = "mean", # function to be applied
  type = "cloglog", # default for MaxEnt
  clamp = FALSE, # dont do clamping to restrict predictions
  progress = TRUE # progress bar
) %>%
  as.data.frame() %>%
  rename("cloglog_suitability" = ".")

```

```{r bind rows and write to csv}

# read in dataset again
entire_fixed_presences <- read.csv(file = file.path(mypath, "easternUSA_entire_test.csv")) %>%
  dplyr::filter(pa == 1) %>%
  dplyr::select(Species, X, Y)

# bind rows
entire_fixed_presences <- cbind(entire_fixed_presences, entire_fixed_presences_predict) 
  
entire_fixed_presences <-   dplyr::rename(entire_fixed_presences, "x" = "X", "y" = "Y")
# output directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_entire_step1_v1")
# save output
write_csv(x = entire_fixed_presences, file = file.path(mypath, "easternUSA_entire_predicted_suitability_test_presences.csv"))

```

## Make predictions for fixed background points

Next, I will perform the same procedure for the fixed background points. I will also need to extract the raster values at each point to perform this calculation, which could take quite awhile. 

```{r load fixed background points and extract raster values}

a_entire_fixed_background <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_fixed_area_points_v1.csv")) %>%
  dplyr::select(-cell) 

if (FALSE) {

  # get SWD object containing point location data from rasters
  a_entire_fixed_background <- SDMtune::prepareSWD(species = "Lycorma delicatula",
                                                   env = x_env_covariates, 
                                                   a = a_entire_fixed_background,
                                                   verbose = TRUE 
                                                   )
  
#  a_entire_fixed_background <- terra::extract(
#    x = x_env_covariates, 
#    y = a_entire_fixed_background, 
 #   xy = TRUE, 
 #   method = "simple", 
#    bind = TRUE
#    )
                                       
}

```

```{r make predictions for background dataset}

entire_fixed_background_predict <- SDMtune::predict(
  object = easternUSA_entire_model, # model
  data = a_entire_fixed_background, # data for prediction
  fun = "mean", # function to be applied
  type = "cloglog", # default for MaxEnt
  clamp = FALSE, # dont do clamping to restrict predictions
  progress = TRUE # progress bar
) %>%
  as.data.frame() %>%
  rename("cloglog_suitability" = ".")

```

```{r bind rows and write to csv}

# read in dataset again
entire_fixed_background <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_fixed_area_points_v1.csv")) %>%
  dplyr::select(-cell)

# bind rows
entire_fixed_background <- cbind(entire_fixed_background, entire_fixed_background_predict)
# output directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_entire_step1_v1")
# save output
write_csv(x = entire_fixed_background, file = file.path(mypath, "easternUSA_entire_predicted_suitability_fixed_background.csv"))

```

## Format data for pROC

These data frames need to be combined into one data frame with 3 columns: the type (label of test vs background point), the responses (whether a point is 1 for a test presence or 0 for a background point), and the predictors (the predicted suitability values). I will be using the `pROC` package to calculate an ROC. 

Finally, I will create an ROC curve for the fixed area AUC and test presences and calculate an AUC from it.

```{r format data for ROC curve}

# add response columns (pb)
entire_fixed_presences <- dplyr::mutate(entire_fixed_presences, pb = 1) %>%
  # also drop species name
  dplyr::select(-Species)
entire_fixed_background <- dplyr::mutate(entire_fixed_background, pb = 0)

# join datasets
entire_fixed_ROC_df <- full_join(entire_fixed_presences, entire_fixed_background, by = c("x", "y", "pb", "cloglog_suitability")) %>%
  dplyr::select(-c(x, y))

```

## Create ROC object and plot

```{r create ROC curve}

# set plot type for graphics to square
#par(pty = "s")

# calculate ROC object
entire_fixed_ROC <- pROC::roc(
  response = entire_fixed_ROC_df$pb, # the actual presence or background data
  predictor = entire_fixed_ROC_df$cloglog_suitability, # the predictions made by the model
  )

# calculate AUC as object
entire_fixed_ROC_AUC <- pROC::auc(roc = entire_fixed_ROC)
# isolate AUC numeric value
entire_fixed_ROC_AUC_value <- as.numeric(print(entire_fixed_ROC_AUC)) %>%
  round(., digits = 3)

# plot
#entire_fixed_ROC_plot <- pROC::plot.roc(
#  x = entire_fixed_ROC,
#  print.auc = TRUE,
#  print.auc.x = 0.45, # print AUC at x = 45 location
#  # graphics settings
#  legacy.axes = TRUE, # makes x axis 1-specificity
#  xlab = "True Positive Rate",
#  ylab = "False Positive Rate",
#  main = "entire_easternUSA_model fixed area ROC curve and AUC",
#  col = "red2",
#  lwd = 2,
#  asp = 1
#)

# plot as ggplot object
entire_fixed_ROC_ggplot <- pROC::ggroc(
  data = entire_fixed_ROC,
  legacy.axes = TRUE, # makes x axis 1-specificity
  colour = "red2",
  linewidth = 1
) +
  geom_abline(slope = 1,
              linetype = 2) + # add 0.5 null model line
  theme_bw() +
  theme(aspect.ratio = 1,
        legend.position = "right") +
  labs(title = "easternUSA_entire_model fixed area ROC curve and AUC") +
  xlab("False Positive Rate") +
  ylab("True Positive Rate") +
  # ggtitle("easternUSA_entire_model fixed area ROC curve and AUC") +
  annotate(geom = "text",
          x = 0.75,
          y = 0.25,
          label = paste0("Fixed Area AUC:\n", entire_fixed_ROC_AUC_value)
          )

```

```{r save ROC curve}
# output dorectory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_entire_step1_v1")

# save plot
ggsave(
  filename = file.path(mypath, "plots", "easternUSA_entire_model_fixed_background_ROC.jpg"),
  plot = entire_fixed_ROC_ggplot,
  device = "jpeg",
  height = 8,
  width = 10,
  dpi = "retina"
  )

# close device
#dev.off()
# reset plotting settings
#par(pty = "m")

```

## Create csv with fixed and flexible AUC values

I will export the AUC values for the fixed vs flexible background points as a data frame. These will be used later to create a plot for the fixed and flexible area AUCs for all 3 models, in order to discern the best background size.

```{r Fixed and flexible AUC}

# output directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_entire_step1_v1")

# redefine AUC object
entire_fixed_ROC_AUC_value <- as.numeric(print(entire_fixed_ROC_AUC)) %>%
  round(., digits = 7)

entire_AUC_fixed_flexible_df <- data.frame(
  "Flexible_Area_AUC" = SDMtune::auc(model = easternUSA_entire_model, test = easternUSA_entire_test),
  "Fixed_Area_AUC" = entire_fixed_ROC_AUC_value
)

# write to csv
write.csv(entire_AUC_fixed_flexible_df, file = file.path(mypath, "easternUSA_entire_fixed_flexible_AUCs.csv"), row.names = FALSE)

```


## Plot combined ROC for fixed and flexible AUC values

I will overlay the ROC curve for the flexible area points (those used to train the model) with the curve for the fixed area points. The flexible area plot will be called using `SDMtune::plotROC()` and then will be added to the fixed area plot. 

First, I need to select the highest AUC model iteration to use as the representative flexible area AUC plot.

```{r extract test AUCs per model iteration}


# create empty date frame for joining
empty.table <- data.frame(
  SDMtune::auc(easternUSA_entire_model@models[[1]], test = easternUSA_entire_test)
) 

colnames(empty.table) <- "temp"

# loop to write summary statistics for each iteration of the model
for (a in seq(length(easternUSA_entire_model@models))) {
  
  # load in temp object 
  data.obj <- data.frame(
    SDMtune::auc(easternUSA_entire_model@models[[a]], test = easternUSA_entire_test)
  )
  
  # change colname
  colnames(data.obj) <- paste0("iter_", a, "_AUC")
  
  # while a has not reached the length of the model replicates, append the AUCs to the empty table
  while (a <= length(easternUSA_entire_model@models)) {
    # join data.obj temporary object to empty table
    empty.table <- cbind(empty.table, data.obj)
    
    break
    
  }
  
  # write new object if length is met
  if (a == length(easternUSA_entire_model@models)) {
   
    test_flexible_AUCs <- dplyr::select(empty.table, -temp)
     
  }
  
  # remove temp object
  rm(data.obj)
  
}

# take max AUC iteration
max_AUC <- which.max(test_flexible_AUCs) %>%
  as.numeric()

```

From this workflow, we see that iteration 3 has the highest test AUC. I couldnt figure out how to add these two ggplot objects together, so we will just patchwork them into a plot of the fixed and flexible ROC curves.

```{r patchwork fixed and flexible ROC curves}
# path to directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_entire_step1_v1")

# create ROC plot
entire_flexible_ROC_ggplot <- SDMtune::plotROC(easternUSA_entire_model@models[[max_AUC]], test = easternUSA_entire_test) +
  ggtitle("flexible area ROC")

entire_fixed_ROC_ggplot <- entire_fixed_ROC_ggplot +
  labs(title = element_blank()) +
  labs(title = "fixed area ROC")

entire_fixed_flexible_ROC_ggplot <- entire_fixed_ROC_ggplot + entire_flexible_ROC_ggplot +
  patchwork::plot_annotation(title = "easternUSA_entire ROC plots")

```

```{r save output}

ggsave(
  filename = file.path(mypath, "plots", "easternUSA_entire_fixed_flexible_ROC_plots.jpg"),
  plot = entire_fixed_flexible_ROC_ggplot,
  device = "jpeg",
  height = 8,
  width = 10,
  dpi = "retina"
  )

```


