---
title: "slfrsk_practice_step-1-2"
author: "Sam Owens"
date: '2022-07-07'
contact: 'sam.owens@temple.edu'
output: html_document
---

This file will practice execution of the analyses outlined in the slfrsk research compendium, written by Nick Huron. The goal of this analysis is to help me to understand SDMs and their creation. I will be performing these analyses using a randomized and reduced subset of tinyslf (n = 500). 

```{r load necesssary packages, echo = FALSE}

library(tidyverse) #data tidying
library(magrittr) #fast pipe assign
library(lubridate) #extract years
library(stargazer) #make easy model table for pub
library(here)

```

```{r load necessary datasets, echo = FALSE}

#slfrsk data (trade)
data("states_summary_present_ensemble",package = "slfrsk")

#recode the established variable as binary
states_summary_present_ensemble <- states_summary_present_ensemble %>%
  mutate(estab = ifelse(status == "established", 1, 0)) %>%
   dplyr::select(ID:status, estab, everything())

# A randomly selected subset of tinyslf for analysis. 500 observations selected
tinyslf_500 <- tinyslf %>%
  sample_n(. , 500)

# reading manually added data (for a later step)
man_county_data <- read_csv(file.path("/Users/samuelowens/Downloads/SLF County Record Timeline.csv"),
                            col_types = cols(.default = "c", FIPS = "d", 
                                          RT_check = "l", ST_check = "l", RS_match = "l"))

```

# clean and add states to jump dataset

```{r cleanup and recoding of man_county_data and states summary}

# standardizing dates
man_county_data %<>%
  mutate_at(vars(starts_with("Date")), .funs = ~parsedate::parse_date(.))

# getting years for data
man_county_data %<>%
  mutate(Year_Alive = year(Date_Alive),
          Year_Morbund = year(Date_Morbund),
          Year_FirstRecord = ifelse(!(is.na(Year_Alive) & is.na(Year_Morbund)),
                                    pmin(Year_Alive, Year_Morbund, na.rm = TRUE),
                                    NA)
          ) %>%
  dplyr::select(-c(Year_Alive, Year_Morbund))

# creating variables that mirror those in by_county dataset
man_county_data %<>%
  filter(!is.na(Status)) %>%
  # 1. grab date from date_alive or date_established columns
  # 2. Attribute 2020 to entries without date using nested ifelse statements
  mutate(YearOfEstablishment_man = ifelse(
    Status == "Infestation" & !is.na(Date_Establish),
    year(Date_Establish),
    ifelse(
      Status == "Infestation" & is.na(Date_Establish),
      2020,
      NA)
    ),
    FirstRecord_man = ifelse(
      Status != "Infestation" & !is.na(Year_FirstRecord),
      Year_FirstRecord,
      ifelse(
        Status == "Infestation" & is.na(Year_FirstRecord),
        2020,
        NA)
      )) %>%
  dplyr::select(-Year_FirstRecord)

# get state records by pulling counties with records of establishment
reg_states <- man_county_data %>%
  rename(state = State) %>%
  filter(!is.na(FirstRecord_man) | !is.na(YearOfEstablishment_man)) %>%
  summarize(states = toupper(unique(state))) %>%
  # append to subsetted tinyslf dataset
  bind_rows(tinyslf_500 %>%
              filter(slf_present == TRUE | slf_established == TRUE) %>% 
              summarize(states = unique(state)), .) %>%
  # keep only unique vales
  distinct(states)

# recode reg event states
states_summary_present_ensemble <- states_summary_present_ensemble %>%
  mutate(regulatory = ifelse(ID %in% reg_states$states, 
                             1, 
                             0)
         ) %>%
  dplyr::select(ID:estab, regulatory, everything())

```

# model relationship between trade with established states and variables ESTAB and REGULATORY

```{r models}

glm.fit1 <- glm(estab ~ log10_avg_infected_mass, data = states_summary_present_ensemble, family = "binomial")

summary(glm.fit1)

glm.fit2 <- glm(regulatory ~ log10_avg_infected_mass, data = states_summary_present_ensemble, family = "binomial")

summary(glm.fit2)
```

# Display models

```{r display model statistics}

star_table <- stargazer(glm.fit1, glm.fit2,
                        type = "html",
                        intercept.bottom = TRUE,
                        ci = FALSE,
                        digits = 2, 
                        style = "io",
                        title = "SI Table: Logistic regression of SLF status on trade",
                        out = paste0(here::here(), "/vignettes/slfrsk_logistic_model.doc")
                        )


```

