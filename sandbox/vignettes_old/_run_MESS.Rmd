---
title: "Run a MESS analysis"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-04-09"
output: html_document
---

EXPLANATION

In this vignette, I will run a MESS analysis for each regional-scale model and calculate the most important covariate based on each model. The MESS will be used for two main purposes:

1. This metric will allow us to quantify the level of extrapolation that is happening with our models as they are being projected to new locations and time periods. An ExDet value below 0 or above 1 indicates extrapolation. Below 0 indicates a type 1 extrapolation within a single covariates, while a value above 1 indicates a type 2 extrapolation between multiple covariates.

2. We will weight each regional model using the ExDet measurement in preparation for an ensemble model. This way, our predictions are weighted by our level of confidence and the level of climate analogy.

I will specifically use the background points that were used to train each model to perform the ExDet analysis. By doing this, I am effectively testing whether the covariates in other locations are significantly different from our model. This analysis will be performed for both the historical and climate change versions of the rasters. 

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)

library(here) 
# here() is set at the root folder of this package

# spatial data handling
library(terra)
library(raster)
# remotes::install_github("densitymodelling/dsmextra")
library(dsmextra) # ExDet and MIC

library(predicts) # MESS

```

```{r map style object}

map_style_MESS <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "azure3",
                                        colour = "azure3")
  ),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  labs(fill = "Suitability for SLF"),
  scale_fill_gradientn(
    name = "MESS score",
    #low = "#67001f",
    #mid = "white",
    #high = "#053061",
    #midpoint = 0,
    limits = c(-100, 100),
    colors = c("#67001f", "#b2182b", "#d6604d", "#f4a582", "#fddbc7", "white", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#053061")
  ),
  #guides(fill = guide_colourbar(theme = theme(
 # legend.key.width  = unit(100, "lines"),
 # legend.key.height = unit(100, "lines")
#))),
  coord_equal()
)

# color scheme taken from: https://colorbrewer2.org/?type=diverging&scheme=RdBu&n=11

```

```{r set wd}

# path to directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent")

```

## Import datasets

I need the historical bioclim layers.

```{r env layer names}

# extent object for N America (retrieved 11-30-2023)
ext.obj <- terra::ext(-140.976563, -51.064453, 15.182421, 60.586967)

# layer name object. Check order of layers first
env_layer_names <- c("bio11", "bio12", "bio15", "bio2")

```

```{r hist raster layers import}

# list of covariates
x_global_hist_env_covariates_list <- list.files(path = file.path(mypath, "historical_climate_rasters", "chelsa2.1_30arcsec", "v1_maxent_10km"), pattern = "\\.asc$", full.names = TRUE) %>%
    grep("bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE)


# stack env covariates
x_global_hist_env_covariates <- terra::rast(x = x_global_hist_env_covariates_list)

# attributes
nlyr(x_global_hist_env_covariates)
names(x_global_hist_env_covariates)
minmax(x_global_hist_env_covariates)
# ext(x_global_hist_env_covariates)
# crs(x_global_hist_env_covariates)


# change names
names(x_global_hist_env_covariates) <- env_layer_names


# remove unnecessary object
rm(x_global_hist_env_covariates_list)

```

I also need the background point sets that were used to train each model. These copies need to include the values of each raster at those particular locations.

```{r background point sets}

# global
global_background <- read_csv(
  file = file.path(here(), "vignette-outputs", "data-tables", "global_background_points_with_data_v3.csv")
) %>%
  dplyr::select(-c(Species, X, Y)) %>%
  as.data.frame()


# regional_native
regional_native_background <- read_csv(
  file.path(here(), "vignette-outputs", "data-tables", "regional_native_background_points_with_data.csv")
  ) %>%
  dplyr::select(-c(Species, X, Y)) %>%
  as.data.frame()


# regional_invaded
regional_invaded_background <- read_csv(
  file.path(here(), "vignette-outputs", "data-tables", "regional_invaded_background_points_with_data_v4.csv")
  ) %>%
  dplyr::select(-c(Species, X, Y)) %>%
  as.data.frame()


# regional_invaded_asian
regional_invaded_asian_background <- read_csv(
  file.path(here(), "vignette-outputs", "data-tables", "regional_invaded_asian_background_points_with_data_v0.csv")
  ) %>%
  dplyr::select(-c(Species, X, Y)) %>%
  as.data.frame()

```

# MESS

## global model

```{r global MESS}

global_mess <- predicts::mess(
  x = x_global_hist_env_covariates, # global historical covariate layers
  v = global_background, # background points for global model
  full = FALSE, # only return MESS
  filename = file.path(mypath, "models", "working_dir", "MESS_slf_global_v2_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
)

# convert to df
global_mess <- terra::rast(x = file.path(mypath, "models", "working_dir", "MESS_slf_global_v2_background_projGlobe.tif")) 
# convert to df
global_mess_df <- terra::as.data.frame(global_mess, xy = TRUE)

```

```{r create global figure}

# plot mean raster first
global_mess_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = global_mess_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(
    title = "MESS analysis: bio2, bio11, bio12 and bio15",
    subtitle = "Global climate divergence from 'global' model training set",
    fill = "MESS score"
    ) +
  # default plot style
  map_style_MESS 

```

```{r save plot}

# save plot
ggsave(
  global_mess_plot, 
  filename = file.path(here(), "vignette-outputs", "figures", "MESS_slf_global_v2_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

```{r create N America figure}

# crop raster
global_mess_cropped <- terra::crop(global_mess, ext.obj)
# convert to df
global_mess_cropped_df <- terra::as.data.frame(global_mess_cropped, xy = TRUE)


# plot mean raster first
global_mess_NAmerica_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = global_mess_cropped_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(
    title = "MESS analysis: bio2, bio11, bio12 and bio15",
    subtitle = "NAmerica climate divergence from 'global' model training set",
    fill = "MESS score"
    ) +
  # default plot style
  map_style_MESS 

```

```{r save plot}

# save plot
ggsave(
  global_mess_NAmerica_plot, 
  filename = file.path(here(), "vignette-outputs", "figures", "MESS_slf_global_v2_background_projNAmerica.jpg"),
  height = 8, 
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```



## regional_native model

```{r regional_native MESS}

regional_native_mess <- predicts::mess(
  x = x_global_hist_env_covariates, 
  v = regional_native_background,
  full = FALSE,
  filename = file.path(mypath, "models", "working_dir", "MESS_slf_regional_native_v1_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
)

# convert to df
regional_native_mess <- terra::rast(x = file.path(mypath, "models", "working_dir", "MESS_slf_regional_native_v1_background_projGlobe.tif")) 
# convert to df
regional_native_mess_df <- terra::as.data.frame(regional_native_mess, xy = TRUE)

```

```{r create global figure}

# plot mean raster first
regional_native_mess_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_mess_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(
    title = "MESS analysis: bio2, bio11, bio12 and bio15",
    subtitle = "Global climate divergence from 'regional_native' model training set",
    fill = "MESS score"
    ) +
  # default plot style
  map_style_MESS 

```

```{r save plot}

# save plot
ggsave(
  regional_native_mess_plot, 
  filename = file.path(here(), "vignette-outputs", "figures", "MESS_slf_regional_native_v1_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

```{r create N America figure}

# crop raster
regional_native_mess_cropped <- terra::crop(regional_native_mess, ext.obj)
# convert to df
regional_native_mess_cropped_df <- terra::as.data.frame(regional_native_mess_cropped, xy = TRUE)


# plot mean raster first
regional_native_mess_NAmerica_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_mess_cropped_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(
    title = "MESS analysis: bio2, bio11, bio12 and bio15",
    subtitle = "NAmerica climate divergence from 'regional_native' model training set",
    fill = "MESS score"
    ) +
  # default plot style
  map_style_MESS 

```

```{r save plot}

# save plot
ggsave(
  regional_native_mess_NAmerica_plot, 
  filename = file.path(here(), "vignette-outputs", "figures", "MESS_slf_regional_native_v1_background_projNAmerica.jpg"),
  height = 8, 
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```



## regional_invaded model

```{r regional_native MESS}

regional_invaded_mess <- predicts::mess(
  x = x_global_hist_env_covariates, 
  v = regional_native_background,
  full = FALSE,
  filename = file.path(mypath, "models", "working_dir", "MESS_slf_regional_invaded_v5_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
)

# convert to df
regional_native_mess <- terra::rast(x = file.path(mypath, "models", "working_dir", "MESS_slf_regional_native_v1_background_projGlobe.tif")) 
# convert to df
regional_native_mess_df <- terra::as.data.frame(regional_native_mess, xy = TRUE)

```

```{r create global figure}

# plot mean raster first
regional_native_mess_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_mess_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(
    title = "MESS analysis: bio2, bio11, bio12 and bio15",
    subtitle = "Global climate divergence from 'regional_native' model training set",
    fill = "MESS score"
    ) +
  # default plot style
  map_style_MESS 

```

```{r save plot}

# save plot
ggsave(
  regional_native_mess_plot, 
  filename = file.path(here(), "vignette-outputs", "figures", "MESS_slf_regional_native_v1_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

```{r create N America figure}

# crop raster
regional_native_mess_cropped <- terra::crop(regional_native_mess, ext.obj)
# convert to df
regional_native_mess_cropped_df <- terra::as.data.frame(regional_native_mess_cropped, xy = TRUE)


# plot mean raster first
regional_native_mess_NAmerica_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_mess_cropped_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(
    title = "MESS analysis: bio2, bio11, bio12 and bio15",
    subtitle = "NAmerica climate divergence from 'regional_native' model training set",
    fill = "MESS score"
    ) +
  # default plot style
  map_style_MESS 

```

```{r save plot}

# save plot
ggsave(
  regional_native_mess_NAmerica_plot, 
  filename = file.path(here(), "vignette-outputs", "figures", "MESS_slf_regional_native_v1_background_projNAmerica.jpg"),
  height = 8, 
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```

# References

Elith, J., M. Kearney, and S. Phillips. 2010. The art of modelling range-shifting species. Methods in Ecology and Evolution 1:330–342.

Extrapolation Detection (exDet) for SDMs - plantarum.ca. (n.d.). . https://plantarum.ca/2023/12/19/exdet/.

Mesgaran, M. B., R. D. Cousens, and B. L. Webber. 2014. Here be dragons: a tool for quantifying novelty due to covariate range and correlation change when projecting species distribution models. Diversity and Distributions 20:1147–1159.
