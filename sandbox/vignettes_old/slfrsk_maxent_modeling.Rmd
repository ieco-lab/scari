---
title: "slfrsk_maxent_modeling (slfrsk_practice_step_1-5)"
author: "Sam Owens"
contact: "sam.owens@temple.edu"
date: "2022-08-03"
output: html_document
---

This file will practice execution of the analyses outlined in the slfrsk research compendium, written by Nick Huron. The goal of this analysis is to help me to understand SDMs and their creation. I will be performing these analyses using a randomized and reduced subset of tinyslf (n = 500). 

File paths edited 2023-01-24, 2023-06-01

```{r load necesssary packages, echo = FALSE}

#library(slfrsk) #this package, has extract_enm()
library(tidyverse)  #data manipulation

library(here) #making directory pathways easier on different instances
here()
# here() is ".../Shared drives/slfClimate/projects/slfSpread/slfSpread_pkg"

library(ENMTools) #enviro collinearity analyses
library(patchwork) #easy combined plots
library(scales) #rescale the plots easily
library(rgdal) #load shapefiles
library(doParallel) #parallized extraction
library(stringi)
library(terra)
library(patchwork)

```

# Reading and Visualizing Presence Data

```{r Read in cleaned gbif datasets}

slf_points_cleaned <- read_csv(file.path(here(), "data_root", "slf_points_cleaned_v0.csv"))

toh_points_cleaned <- read_csv(file.path(here(), "data_root", "toh_points_cleaned_v0.csv"))

```


```{r mapping slf and toh presence separately}

# these data frames were created by Nick and read in as the main data for the original tifs I (Sam) created with this script- Matt wants to see the differences between my data and Nick's, so I will need to run what I retrieved from gbif

# TOH
map_toh <- ggplot() +
  geom_polygon(data = map_data("world"), aes(x = long, y = lat, group = group), fill = "#FFFFFF", color = "black", lwd = 0.15) + # world map
  geom_point(data = toh_points_cleaned, aes(x = x, y = y), color = "#0072b2", alpha = 0.10) +
  theme_bw() +
  labs(x = "", y = "") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "#f0f8ff")) +
  coord_quickmap(xlim = c(-164.5, 163.5), ylim = c(-55, 85)) +
  ggtitle(label = "TOH Presence")
  
# SLF
map_slf <- ggplot() +
  geom_polygon(data = map_data('world'), aes(x = long, y = lat, group = group), fill = "#FFFFFF", color = "black", lwd = 0.15) + #world map
  geom_point(data = slf_points_cleaned, aes(x = x, y = y), color = "#d55e00", alpha = 0.50) +
  theme_bw() +
  labs(x = "", y = "") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #plot.background = element_rect(fill ="#f0f8ff"),
        panel.background = element_rect(fill = "#f0f8ff")) +
  coord_quickmap(xlim = c(-164.5, 163.5), ylim = c(-55,85)) +
  ggtitle(label = "SLF Presence")
  
# patch maps together
map_toh / map_slf

# save maps
ggsave((map_toh / map_slf), filename = file.path(here(), "figures", "slf_toh_presence_2022.png"), height = 10, width = 10)

```

```{r plot together}

ggplot() +
  geom_polygon(data = map_data('world'), aes(x = long, y = lat, group = group), fill = "#FFFFFF", color = "black", lwd = 0.15) + #world map
geom_point(data = toh_points, aes(x = x, y = y), color = "#0072b2", alpha = 0.10) +
geom_point(data = slf_points, aes(x = x, y = y), color = "#d55e00", alpha = 0.50) +
  theme_bw() +
  labs(x = "", y = "") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #plot.background = element_rect(fill ="#f0f8ff"),
        panel.background = element_rect(fill = "#f0f8ff")) +
  #theme_bw() +
  coord_quickmap(xlim = c(-164.5, 163.5), ylim = c(-55,85))

```

# Preparation of Spatial Data

```{r set raster extent}

if(FALSE){

  mypath <- file.path(here() %>% 
                        dirname(),
                      "maxent/historical_climate_rasters/wc2.1_30arcsec")
  
  #ensure that extent is identical
#get file names
env.files <- list.files(file.path(mypath, "originals"), pattern = "[.]tif", full.names = T)
env.short <- list.files(file.path(mypath, "originals"), pattern = "[.]tif", full.names = F)

#change the labeling of the output layers
output.files <- env.short

#change weird BIOCLIM prefix
output.files <- gsub(pattern = "wc2.1_30s_bio", replacement = "global_bio", x = output.files)
#change weird ENVIREM prefix
#  <- gsub(pattern = "global", replacement = "global_env", x = output.files) #had to edit, assumed this was for forest height and elevation

#change weird ATC prefix
output.files <- gsub(pattern = "2015_accessibility_to_cities_v1.0", replacement = "global_atc", x = output.files)

#crop one of the BIOCLIM layers to set the bounding box and resolution to have files fixed
same.extent <- extent(-180, 180, -60, 84)
main_layer <- crop(raster(file.path(mypath,"originals", "wc2.1_30s_bio_1.tif")), y = same.extent, overwrite = F)

#reset extent stepwise
for(a in seq_along(env.files)){

  #ensure that the CRS is consistent
  rast.hold <- raster(env.files[a])
  crs(rast.hold) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
  #resample to fit the extent/resolution of the reference BIOCLIM layer
  #use bilinear interpolation, since values are continuous
  rast.hold <- resample(x = rast.hold, y = main_layer, method = "bilinear")

  #write out the new resampled rasters!
  writeRaster(x = rast.hold, filename = file.path(mypath,"v1", output.files[a]), overwrite = T)
}

} #closes no run if
  
```

```{r downsize raster resolution}

if(FALSE) {
  
  mypath <- file.path(here() %>% 
                        dirname(),
                      "maxent/historical_climate_rasters/wc2.1_30arcsec")
  
  #list env layers, load
  env.files <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = T)
  env.short <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = F)
  # I had to modify "pattern" to not include the .tif.aux.xml files
  
  # downsampling by factor of 2 (read 2 cells deep around cell) and take mean of cells
  
  for(a in seq_along(env.files)){
    
    holder <- raster(env.files[a])
    down_holder <- raster::aggregate(holder, fact = 2, fun = mean, expand = TRUE, na.rm = TRUE, filename = file.path(mypath, "v1_downsampled", env.short[a]), overwrite = T)
    
  }
  
}

```

# Evaluation of Spatial Data Collinearity

```{r Take pearson correlation of raster layers}

if(FALSE){
  
  mypath <- file.path(here() %>% 
                        dirname(),
                      "maxent/historical_climate_rasters/wc2.1_30arcsec")
  
  # load downsampled layers and stack for raster.cor.matrix command
  
  # list of layer paths
  env.files <- list.files(path = file.path(mypath, "v1_downsampled"), pattern = "\\.tif$", full.names = T)
  
  # stack downsampled layers
  env <- raster::stack(env.files)
  
  # evaluate correlations for raster layers
  # create a correlation matrix for picking model layers
  env.corr <- ENMTools::raster.cor.matrix(env, method = "pearson")
  
  # write out correlations as .csv
  write.csv(x = env.corr, file = file.path(here(), "data_raw/env_cor_v1_2022_downsampled.csv"), col.names = TRUE, row.names = TRUE)
  
}

```

```{r tidy env_cor_v1}

env.corr_2 <- read_csv(file = file.path(here(), "data_root/data_old/env_cor_v2_2022_downsampled.csv"))
# in this file, numbers of climatic variables were manually changed to include leading 0's (01 instead of 1)

env.corr_2_tidy <- as.data.frame(env.corr_2) 

row.names(env.corr_2_tidy) <- env.corr_2_tidy$...1
# read in data and make 1st column rownames

env.corr_2_tidy <- env.corr_2_tidy[, which(names(env.corr_2_tidy) != "...1")]

env.corr_2_tidy <- env.corr_2_tidy %>%
  select(order(colnames(env.corr_2_tidy))) %>%
  abs(.)

write.csv(x = env.corr_2_tidy, file = file.path(here(), "data_root/env_cor_v4_abs_2022_downsampled.csv"), col.names = TRUE, row.names = TRUE)
# row names will be re-ordered in excel

```


```{r visualize correlations as heatmap}

# re-read in correlation table 
env.cor <- read.csv(file = file.path(here(), "data_root/env_cor_v4_abs_2022_downsampled.csv"))
# v3 not used because abs value of correlations not taken

row.names(env.cor) <- env.cor$X
# first column is rowname

# make correlations into absolute values and tidy data for plotting
p_env_cor <- env.cor[, which(names(env.cor) != "X")] %>%
  abs(.) %>%
  as_tibble() %>%
  mutate(covar = colnames(.)) %>%
  dplyr::select(covar, everything()) %>%
  pivot_longer(cols = -covar, names_to = "var") %>%
  dplyr::select(var, covar, everything()) %>%
  ggplot() +
  geom_tile(aes(x = var, y = covar, fill = value)) +
  viridis::scale_fill_viridis(discrete = FALSE, direction = -1, limits = c(0,1), name = "abs(Correlation)") +
  guides(x =  guide_axis(angle = 90)) +
  labs(x = "", y = "")

p_env_cor

ggsave(p_env_cor, filename = file.path(here(), "figures", "p_env_cor2022_v4.png"), height = 10, width = 10)

```


```{r conversion of .tif to .asc files}

if(FALSE){
  
  mypath <- file.path(here() %>% 
                        dirname(),
                      "maxent/historical_climate_rasters/wc2.1_30arcsec")
  
  # get/set file names
  env.files <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = T) 
  
 # env.files.1 <- env.files[!env.files %in% c("G:/Shared drives/slfModeling/projects/slfSpread/slfSpread_pkg/maxent_raw_env2022/v1/global_atc.tif",
  #                                           "G:/Shared drives/slfModeling/projects/slfSpread/slfSpread_pkg/maxent_raw_env2022/v1/global_bio_1.tif",
   #                                          "G:/Shared drives/slfModeling/projects/slfSpread/slfSpread_pkg/maxent_raw_env2022/v1/global_bio_10.tif",
    #                                         "G:/Shared drives/slfModeling/projects/slfSpread/slfSpread_pkg/maxent_raw_env2022/v1/global_bio_11.tif")]
  # subset of env.files containing first entry- to see file size
  
  env.short <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = F)
  
#  env.short.1 <- env.short[!env.short %in% c("global_atc.tif", "global_bio_1.tif", "global_bio_10.tif", "global_bio_11.tif")]
  # subset of env.files containing first entry- to see file size
  
  env.asc <- gsub(pattern = ".tif", replacement = ".asc", x = env.short)
  
 # env.asc.1 <- env.asc[!env.asc %in% c("global_atc.asc", "global_bio_1.asc", "global_bio_10.asc", "global_bio_11.asc")]
  # a copy to try only one entry of the list
  
  # loop to convert, set NAs equal to -9999 as required by Maxent
for(a in seq_along(env.files)){
    
  file_to_asc <- raster(env.files[a])
  NAvalue(file_to_asc) <- -9999
  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[a]), format = "ascii", overwrite = F)
    
  }
  
   # file_to_asc <- env.files[1] %>%
    #  raster(.) %>%
     # NAvalue(.) <- -9999 %>%
    #  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[1]), format = "ascii", overwrite = F)
    # just do 1 to start and see how large it is
}

```

# Building and evaluating Maxent SDMs

Maxent was used under the default parameters, excluding the following changes:

1. all feature types made available but set to AUTO FEATURES (linear, quadratic, product, threshold and hinge set to TRUE before setting auto features to TRUE)

2. Creative response curves set to TRUE

3. Do jackknife to measure variable importance set to TRUE

4. Replicates set to 5 for SLF 
    (this is # of k-fold crossvalidation replicates and determines test proportion from k), 10 for TOH
    
5. Apply threshold rule set to MINIMUM training presence

6. Threads set to available number of processor threads available

## At this point, run model in MaxEnt



# Cropping most used bioclim layers to N America bounding box and visualizing

Library necessary packages

```{r library packages}

library(terra) # most of analyses done here
library(raster) # used some for rasters
library(sf) # dependency of terra
library(tidyverse)
library(here) # pathing

```

```{r cropping bioclim layers to N america}

if(FALSE) {

  # path to directory
  mypath <- file.path(here::here() %>% 
                        dirname(),
                      "maxent/historical_climate_rasters/wc2.1_30arcsec")

  # load in bioclim layers to be cropped- the original .tif files
  env.files <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = T) %>%
  # extract the 6 bioclim layers (plus global_atc) that I expect to use in future regional models
    grep("global_atc.tif|bio_1.tif|bio_2.tif|bio_7.tif|bio_12.tif|bio_15.tif", ., value = TRUE)

   # output file names
  output.files <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = F) %>%
  # extract the 6 bioclim layers (plus global_atc) that I expect to use in future regional models
    grep("global_atc.tif|bio_1.tif|bio_2.tif|bio_7.tif|bio_12.tif|bio_15.tif", ., value = TRUE) %>%
    # get rid of filetype endings
    gsub(pattern = ".tif", replacement = "") 
  
  
  # define extent object
  NAmerica_extent <- terra::ext(-133.593750, -52.294922, 25.085599, 55.304138)
  
  # create main layer to crop others to
  main_layer <- terra::crop(terra::rast(x = env.files[2]),
                            # crop global_bio_1 to extent
                            y = NAmerica_extent, overwrite = FALSE)
  
  # ensure crs is correct
  crs(main_layer, describe = TRUE)
  
  # crs isnt correct. will set in loop
  
  
  
  # convert to df for plotting 
  main_layer_df <- terra::as.data.frame(main_layer, xy = TRUE)
  
  # plot main layer as example
  main_plot <- ggplot() +
    # change scale of plots to be standard across figures
    geom_raster(data = main_layer_df, 
              aes(x = x, y = y, fill = global_bio_1)) +
    # set view to N America extent, plus 2 on each side to see if cropping worked
    coord_cartesian() +
    xlab("longitude") +
    ylab("latitude") +
    theme_minimal() +
    theme(legend.position = "none") +
    coord_quickmap()
  # the cropping worked
  
  # view list of filetypes for terra, use .ascii
  View(terra::gdal(drivers = TRUE))
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    crs(rast.hold) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
    #resample to fit the extent/resolution of the reference BIOCLIM layer
    #use bilinear interpolation, since values are continuous
    rast.hold <- terra::resample(x = rast.hold, y = main_layer, method = "bilinear")
    
    # set NA value, a requirement of maxent .asc files
    rast.hold <- terra::subst(rast.hold, NA, -9999)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, "v1_maxent", paste0(output.files[a], "_NAmerica", ".asc")), filetype = "AAIGrid", overwrite = TRUE)
    
  }
  
}

```


```{r visualize new layers and MaxEnt output from slf_gbif_v5}

# path to directory
  mypath <- file.path(here::here() %>% 
                        dirname(),
                      "maxent/models")

# load in global model
v5_global <- terra::rast(x = file.path(mypath, "maxent_slf_gbif_v5_global", "Lycorma_delicatula_avg.asc")) %>%
  # crop to only area of interest because entire raster too long (almost impossible) to convert to df
  crop(., y = NAmerica_extent)

# do a quick plot
terra::plot(v5_global)

# convert to df to plot with other layers
v5_global_df <- terra::as.data.frame(v5_global, xy = TRUE) %>%
  # remove NAs
  na.omit()

# plot
v5_global_plot <- ggplot() +
  geom_raster(data = v5_global_df, 
              aes(x = x, y = y, fill = Lycorma_delicatula_avg)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Predicted current global niche for Lycorma delicatula") +
  coord_quickmap()



# load in regional model
v5_regional <- terra::rast(x = file.path(mypath, "maxent_slf_gbif_v5_regional", "Lycorma_delicatula_avg.asc"))

# quick plot
terra::plot(v5_regional)

# convert to df
v5_regional_df <- terra::as.data.frame(v5_regional, xy = TRUE) %>%
  na.omit()

# plot
v5_regional_plot <- ggplot() +
  geom_raster(data = v5_regional_df, 
              aes(x = x, y = y, fill = Lycorma_delicatula_avg)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(title = "Predicted current regional niche for \n Lycorma delicatula") +
  coord_equal()

```

# Creating reference layer cropped to Eastern USA

```{r cropping bioclim layers to N america}

if(TRUE) {

  # path to directory
  mypath <- file.path(here::here() %>% 
                        dirname(),
                      "maxent/historical_climate_rasters/wc2.1_30arcsec")

  # load in bioclim layers to be cropped- the original .tif files
  env.files <- list.files(path = file.path(mypath, "v1"), pattern = "global_bio_1.tif$", full.names = T)

   # output file names
  output.files <- list.files(path = file.path(mypath, "v1"), pattern = "global_bio_1.tif$", full.names = F) %>%
    # get rid of filetype endings
    gsub(pattern = ".tif", replacement = "") %>%
    gsub(pattern = "global_", replacement = "")
  
  
  # define extent object
  easternUSA_extent <- terra::ext(-96.503906, -59.589844, 28.304381, 47.457809)
  
  # create main layer to crop others to
  main_layer <- terra::crop(terra::rast(x = env.files),
                            # crop global_bio_1 to extent
                            y = easternUSA_extent, overwrite = FALSE)
  
  # ensure crs is correct
  crs(main_layer, describe = TRUE)
  
  # convert to df for plotting 
  main_layer_df <- terra::as.data.frame(main_layer, xy = TRUE)
  
  # plot main layer as example
  main_plot <- ggplot() +
    # change scale of plots to be standard across figures
    geom_raster(data = main_layer_df, 
              aes(x = x, y = y, fill = global_bio_1)) +
    xlab("longitude") +
    ylab("latitude") +
    theme_minimal() +
    theme(legend.position = "none") +
    coord_equal()
  # the cropping worked
  
  # view list of filetypes for terra, use .ascii
  View(terra::gdal(drivers = TRUE))
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    crs(rast.hold) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
    #resample to fit the extent/resolution of the reference BIOCLIM layer
    #use bilinear interpolation, since values are continuous
    rast.hold <- terra::resample(x = rast.hold, y = main_layer, method = "bilinear")
    
    # set NA value, a requirement of maxent .asc files
    rast.hold <- terra::subst(rast.hold, NA, -9999)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, "v1_maxent", paste0("easternUSA_", output.files[a], ".asc")), filetype = "AAIGrid", overwrite = TRUE)
    
  }
  
}

```



