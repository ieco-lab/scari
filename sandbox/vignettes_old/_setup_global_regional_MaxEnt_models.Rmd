---
title: "Setup for regional and global models (project step 2)"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2023-10-20"
output: html_document
---

# Overview

In the previous vignette (`050_run_easternUSA_MaxEnt_models_v1`), I selected the background area type that would be the most suited to modeling SLF. I found that using the entire background area was the best choice. I will now set up for the next two sets of models, a historical global/regional pair and a climate change global/regional pair. The global model will be trained on global climate data, while the regional model will be trained climate data from the SLF invaded range. The regional model has already been trained; this was the easternUSA_entire model trained in the previous vignette. In the next few vignettes, I will train the global model and create the same outputs as for the regional model. I will also create models for a climate change scenario. This vignette will select the background points and crop rasters needed for the next models

(EXPAND)

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation

library(here) #making directory pathways easier on different instances
here()
# here() starts at the root folder of this package.
# utilities
library(devtools)
library(rJava) # for running MaxEnt
# spatial data handling
library(raster) 
library(terra) 
library(dismo) 
# other
library(viridis)

```

```{r ggplot object for map style}

map_style <- list(
      xlab("longitude"),
      ylab("latitude"),
      theme_classic(),
      theme(legend.position = "bottom",
            panel.background = element_rect(fill = "lightblue",
                                            colour = "lightblue")
      ),
      labs(fill = "Suitability for SLF"),
      viridis::scale_fill_viridis(option = "D"),
      coord_equal()
    )

```


# 1. Select background points for global model

Just for review, these points are used to characterize the variables that affect SLF distribution. Temperature / precipitation values will be extracted from the rasters for each point in this set. MaxEnt will then use these points to calculate an equation that describes the relationship of SLF with its environment and predict suitability. 

First, I will load in known SLF presences so that background sampling does not occur at those points.

```{r load in SLF presences}

# dismo requires the base function (not tidyverse)
slf_points <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "slf_all_final_coords_v1_2023-08.csv")) %>%
   dplyr::select(-species) 

```

Gallien et.al recommended 20,000 points for background with a global scale model. Gallien also found that a higher number of background points artificially deflates maxent predicitons. Background points datasets will be stored in `vignette-outputs/data-tables`.

```{r background points for global models}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_30arcsec/v1_maxent")

# load in reference layer. needs to be done with raster package because dismo doesnt recognize terra package objects
bio11_global <- raster::raster(x = file.path(mypath, "bio11_1981-2010_global.asc"))

# set seed so that the random points for this dataset are the same the next time this code is run
set.seed(100)
# generate random points 
global_background_points <- dismo::randomPoints(mask = bio11_global, 
                                                n = 23000, # set higher than 20,000 because the function was under-producing
                                                # n = 50000, # deprecated
                                                p = slf_points,
                                                excludep = TRUE, # exclude cells where slf has been found
                                                lonlatCorrection = TRUE, # weight samples by latitude because cell size is larger closer to equator
                                                warn = 2 # higher number gives most warnings, including if sample size not reached
                                                ) %>%
  as.data.frame(.)

# save as csv
write_csv(x = global_background_points, file = file.path(here(), "vignette-outputs", "data-tables", "global_background_points_v1.csv"))
# save as rda file
save(global_background_points, file = file.path(here(), "data", "global_background_points_v1.rda"))
  
```

I set the number of points generated higher than my actual goal because the function was consistently under-producing. The final number of points selected was 0.8481 times the requested number (23,000), or 19,506 points.

*DEPRECATED* Initially, I selected 50000 random background points using `dismo::randomPoints()`. This amount was recommended when modeling at a global scale (Santana Jr et.al, 2019). The initial run threw a warning that only 0.85046 times 50,000 points could be selected. This came to 42,523 points in total. The v1 dataset with 20000I will not try to plot this, because it crashed my PC when I tried.

# 2. Crop Bioclim Layers to N. America

These rasters will be used to project the models I will create to a new area. We are specifically interested in the suitable area for the entire North American continent. When projecting a model to create a raster of suitability, SDMtune requires a raster stack containing a layer for each covariate that was used to create the model, with the same naming convention. 

## Historical rasters

```{r setup for cropping bioclim layers}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/historical_climate_rasters/chelsa2.1_30arcsec")

# lists of target files in the directory
# load in bioclim layers to be cropped- the original .asc files
env.files <- list.files(path = file.path(mypath, "v1_maxent"), pattern = "\\.asc$", full.names = TRUE) %>%
# extract the 4 bioclim layers I will be using in my models. Access to cities will not be used until later models
  grep("atc_2015_global.asc|bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE)

# output file names
output.files <- list.files(path = file.path(mypath, "v1_maxent"), pattern = "\\.asc$", full.names = FALSE) %>%
  grep("atc_2015_global|bio2_1981-2010_global|bio11_1981-2010_global|bio12_1981-2010_global|bio15_1981-2010_global", ., value = TRUE) %>%
  gsub(pattern = "global", replacement = "NAmerica")

# extent object for N America
# see here(), data-raw, bounding_boxes.txt
ext.obj <- terra::ext(-136.968747, -51.363278, 15.182421, 58.022064)

```

I will ensure that the raster attributes are correct.

```{r check raster attributes}

env.files.stack <- terra::rast(x = env.files)

nlyr(env.files.stack)
names(env.files.stack)
minmax(env.files.stack)

```

Now, I will loop through the rasters on the list, crop them to the proper extent and save them with the new file naming. This is the same process that was done for cropping the rasters in vignette 050.

```{r loop to crop bioclim layers to N america}

# view list of filetypes for terra, use .ascii
View(terra::gdal(drivers = TRUE))

if(FALSE) {
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    
    # crop new rasters to extent
    rast.hold <- terra::crop(x = rast.hold, y = ext.obj, overwrite = FALSE)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, "v1_maxent", output.files[a]), filetype = "AAIGrid", overwrite = FALSE)
    
    # remove object once its done
    rm(rast.hold)
    
  }
  
}

# I am pretty sure this method resets the raster cell numbers, which might be annoying downstream....

```

Lets plot one of the new layers to make sure the cropping worked.

```{r plot main_layer to ensure cropping worked}

bio11 <- terra::rast(x = file.path(mypath, "v1_maxent", "bio11_1981-2010_NAmerica.asc")) 
# convert to df
bio11_df <- terra::as.data.frame(bio11, xy = TRUE)

# plot layer as example
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = bio11_df, 
            aes(x = x, y = y, fill = `CHELSA_bio11_1981-2010_V.2.1`)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)
# the cropping worked

```

The layers have been cropped to the proper extent.

## SSP370 Future Climate rasters

This process will be the same as above and for the 2041-2070 versions of the rasters, except for atc_2015 (this raster is not projected for climate change).

```{r setup for cropping bioclim layers}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/future_climate_rasters/chelsa2.1_30arcsec/2041-2070_ssp370_GFDL")

# lists of target files in the directory
# load in bioclim layers to be cropped- the original .asc files
env.files <- list.files(path = file.path(mypath, "v1_maxent"), pattern = "\\.asc$", full.names = TRUE) %>%
# extract the 4 bioclim layers I will be using in my models. Access to cities will not be used until later models
  grep("bio2_2041-2070_gfdl_370_global.asc|bio11_2041-2070_gfdl_370_global.asc|bio12_2041-2070_gfdl_370_global.asc|bio15_2041-2070_gfdl_370_global.asc", ., value = TRUE)

# output file names
output.files <- list.files(path = file.path(mypath, "v1_maxent"), pattern = "\\.asc$", full.names = FALSE) %>%
  grep("bio2_2041-2070_gfdl_370_global|bio11_2041-2070_gfdl_370_global|bio12_2041-2070_gfdl_370_global|bio15_2041-2070_gfdl_370_global", ., value = TRUE) %>%
  gsub(pattern = "global", replacement = "NAmerica")

# extent object for N America
# see here(), data-raw, bounding_boxes.txt
ext.obj <- terra::ext(-136.968747, -51.363278, 15.182421, 58.022064)

```

```{r check raster attributes}

env.files.stack <- terra::rast(x = env.files)

nlyr(env.files.stack)
names(env.files.stack)
minmax(env.files.stack)

```

```{r loop to crop bioclim layers to N america}

# view list of filetypes for terra, use .ascii
View(terra::gdal(drivers = TRUE))

if(FALSE) {
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    
    # crop new rasters to extent
    rast.hold <- terra::crop(x = rast.hold, y = ext.obj, overwrite = FALSE)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, "v1_maxent", output.files[a]), filetype = "AAIGrid", overwrite = FALSE)
    
    # remove object once its done
    rm(rast.hold)
    
  }
  
}

# I am pretty sure this method resets the raster cell numbers, which might be annoying downstream....

```

```{r plot main_layer to ensure cropping worked}

bio11 <- terra::rast(x = file.path(mypath, "v1_maxent", "bio11_2041-2070_gfdl_370_NAmerica.asc")) 
names(bio11)
# convert to df
bio11_df <- terra::as.data.frame(bio11, xy = TRUE)

# plot main layer as example
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = bio11_df, 
            aes(x = x, y = y, fill = `CHELSA_bio11_2041-2070_gfdl-esm4_ssp370_V.2.1`)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)
# the cropping worked

```




# Appendix



# References

Santana Jr, P. A., L. Kumar, R. S. Da Silva, J. L. Pereira, and M. C. Picanço. 2019. Assessing the impact of climate change on the worldwide distribution of Dalbulus maidis (DeLong) using MaxEnt. Pest Management Science 75:2706–2715.

