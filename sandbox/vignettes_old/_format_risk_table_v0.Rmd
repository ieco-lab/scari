---
title: "Format risk tables for SLF populations and viticultural regions"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-05-07"
output: html_document
---

# Overview


(THEORY)

# Setup

```{r load necesssary packages, echo = FALSE}

# general tools
library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here::here() # here() starts at the root folder of this package.
library(devtools)

# table aesthetics
library(scales)
library(grid)
library(formattable)
library(kableExtra)
library(webshot2)

```

# IVR risk table

```{r read in table}

IVR_risk_table <- read.csv(file = file.path(here::here(), "vignette-outputs", "data-tables", "IVR_risk_table.csv"), row.names = 1) %>%
  dplyr::rename(
    "extreme_2055" = "extreme",
    "high_2055" = "high",
    "moderate_2055" = "moderate",
    "low_2055" = "low"
  )

# change rownames
rownames(IVR_risk_table) <- c("extreme_present", "high_present", "moderate_present", "low_present", "total_2055")


```

I will calculate the percentage of IVRs that increase and decrease risk overall and will report this in the paper.

```{r calculate percentages}

total_IVR <- sum(IVR_risk_table[1:4, 1:4])

IVR_shift_prop_table <- tibble(
  risk_shift = c("no_shift", "risk_increase", "risk_decrease"),
  prop_change = c(
    sum(IVR_risk_table[1, 1], IVR_risk_table[2, 2], IVR_risk_table[3, 3], IVR_risk_table[4, 4]) / total_IVR,
    sum(IVR_risk_table[2:4, 1], IVR_risk_table[3:4, 2], IVR_risk_table[4, 3]) / total_IVR,
    sum(IVR_risk_table[1, 2], IVR_risk_table[1:2, 3], IVR_risk_table[1:3, 4]) / total_IVR
  )
) %>%
  # make % format
  dplyr::mutate(prop_change = scales::label_percent(accuracy = 0.01) (prop_change))


```

For reporting purposes, we see that about 69.7% of the 1063 IVRs experience no change in risk of SLF establishment due to climate change by 2055. Meanwhile, about 1.7% actually experience an increase in risk due to climate change and the remaining 28.6% move down one or more levels of risk by 2055.

```{r save table from above, if desired}

if(TRUE) {
  
  # make kable
  IVR_shift_prop_table <- knitr::kable(IVR_shift_prop_table, "html", escape = FALSE) %>% 
    kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
    # standardize col width
    kableExtra::column_spec(1:2, width_min = '4cm') %>%
    kableExtra::add_header_above(., header = c("IVR risk table shift proportions" = 2), bold = TRUE)

  
  # save as .html
  kableExtra::save_kable(
    IVR_shift_prop_table, 
    file = file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table_shift_prop.html"),
    self_contained = TRUE
    )
  
  # initialize webshot by 
 # webshot::install_phantomjs()
  # convert to pdf
  webshot2::webshot(
    url = file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table_shift_prop.html"),
    file = file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table_shift_prop.jpg")
  )
  
  # rm html
  file.remove(file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table_shift_prop.html"))
    
}

```

Now I will format and export the table. I will add colored proportion bars to the columns, which indicate the category distribution of IVRs entering that risk category. In other words, the columns represent the risk category in 2055, so the proportion bars represent the distribution of which current risk category those points move from by 2055. I will also add positive and negative signs to indicate a risk increase or decrease. The diagonal (top L to bottom R) will have no signs because this represents no shift in risk by 2055. All points experiencing a decline in risk sit above the diagonal, and points experiencing an increase in risk sit below the diagonal.

```{r format table}

# convert top half (above diagonal) to negative numbers
IVR_risk_table[1, 2] <- -(IVR_risk_table[1, 2])
IVR_risk_table[1:2, 3] <- -(IVR_risk_table[1:2, 3])
IVR_risk_table[1:3, 4] <- -(IVR_risk_table[1:3, 4])

# add positive sign to bottom half
IVR_risk_table[2:4, 1] <- sprintf("%+.0f", IVR_risk_table[2:4, 1])
IVR_risk_table[3:4, 2] <- sprintf("%+.0f", IVR_risk_table[3:4, 2])
IVR_risk_table[4, 3] <- sprintf("%+.0f", IVR_risk_table[4, 3])

# add html formatting
IVR_risk_table[1:4, 1] <- formattable::proportion_bar("darkred")(IVR_risk_table[1:4, 1])
IVR_risk_table[1:4, 2] <- formattable::proportion_bar("darkorange")(IVR_risk_table[1:4, 2])
IVR_risk_table[1:4, 3] <- formattable::proportion_bar("gold")(IVR_risk_table[1:4, 3])
IVR_risk_table[1:4, 4] <- formattable::proportion_bar("gray")(IVR_risk_table[1:4, 4])

# print table, e.g., in html format
IVR_risk_table <- kable(IVR_risk_table, "html", escape = FALSE) %>% 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
  # standardize col width
  kableExtra::column_spec(1:5, width_min = '4cm') %>%
  # add footnotes
  kableExtra::add_footnote("number signs indicate whether climate change is increasing or decreasing risk", notation = "alphabet") %>%
  kableExtra::add_footnote("bars indicate the porportion of points in each current risk category that are a part of each 2055 risk category", notation = "alphabet") %>%
  # add header
  kableExtra::add_header_above(., header = c("Risk of L delicatula establishment in globally important viticultural regions" = 6), bold = TRUE)

  
```

```{r save table from above, if desired}

if(TRUE) {
  
  # save as .html
  kableExtra::save_kable(
    IVR_risk_table, 
    file = file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table.html"),
    self_contained = TRUE
    )
  
  # initialize webshot by 
 # webshot::install_phantomjs()
  # convert to pdf
  webshot2::webshot(
    url = file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table.html"),
    file = file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table.jpg")
  )
  
  # rm html
  file.remove(file.path(here::here(), "vignette-outputs", "figures", "IVR_risk_table.html"))
    
}

```

# SLF risk table

I will do the same for the SLF populations.

```{r read in table}

slf_risk_table <- read.csv(file = file.path(here::here(), "vignette-outputs", "data-tables", "slf_risk_table.csv"), row.names = 1) %>%
  dplyr::rename(
    "extreme_2055" = "extreme",
    "high_2055" = "high",
    "moderate_2055" = "moderate",
    "low_2055" = "low"
  )

# change rownames
rownames(slf_risk_table) <- c("extreme_present", "high_present", "moderate_present", "low_present", "total_2055")

```

```{r calculate percentages}

total_slf <- sum(slf_risk_table[1:4, 1:4])

slf_shift_prop_table <- tibble(
  risk_shift = c("no_shift", "risk_increase", "risk_decrease"),
  prop_change = c(
    sum(slf_risk_table[1, 1], slf_risk_table[2, 2], slf_risk_table[3, 3], slf_risk_table[4, 4]) / total_slf,
    sum(slf_risk_table[2:4, 1], slf_risk_table[3:4, 2], slf_risk_table[4, 3]) / total_slf,
    sum(slf_risk_table[1, 2], slf_risk_table[1:2, 3], slf_risk_table[1:3, 4]) / total_slf
  )
) %>%
  # make % format
  dplyr::mutate(prop_change = scales::label_percent(accuracy = 0.01) (prop_change))

```

For reporting purposes, we see that about 86.2% of the 769 slf populations experience no change in risk of persistence due to climate change by 2055. Meanwhile, about 2.7% actually experience an increase in risk due to climate change and the remaining 11% move down one or more levels of risk by 2055.


```{r save table from above, if desired}

if(TRUE) {
  
  # make kable
  slf_shift_prop_table <- kable(slf_shift_prop_table, "html", escape = FALSE) %>% 
    kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
    # standardize col width
    kableExtra::column_spec(1:2, width_min = '4cm') %>%
    kableExtra::add_header_above(., header = c("SLF risk table shift proportions" = 2), bold = TRUE)
  
  
  # save as .html
  kableExtra::save_kable(
    slf_shift_prop_table, 
    file = file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table_shift_prop.html"),
    self_contained = TRUE
    )
  
  # initialize webshot by 
 # webshot::install_phantomjs()
  # convert to pdf
  webshot2::webshot(
    url = file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table_shift_prop.html"),
    file = file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table_shift_prop.jpg")
  )
  
  # rm html
  file.remove(file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table_shift_prop.html"))
    
}

```

```{r format table}

# convert top half (above diagonal) to negative numbers
slf_risk_table[1, 2] <- -(slf_risk_table[1, 2])
slf_risk_table[1:2, 3] <- -(slf_risk_table[1:2, 3])
slf_risk_table[1:3, 4] <- -(slf_risk_table[1:3, 4])

# add positive sign to bottom half
slf_risk_table[2:4, 1] <- sprintf("%+.0f", slf_risk_table[2:4, 1])
slf_risk_table[3:4, 2] <- sprintf("%+.0f", slf_risk_table[3:4, 2])
slf_risk_table[4, 3] <- sprintf("%+.0f", slf_risk_table[4, 3])

# add html formatting
slf_risk_table[1:4, 1] <- formattable::proportion_bar("darkred")(slf_risk_table[1:4, 1])
slf_risk_table[1:4, 2] <- formattable::proportion_bar("darkorange")(slf_risk_table[1:4, 2])
slf_risk_table[1:4, 3] <- formattable::proportion_bar("gold")(slf_risk_table[1:4, 3])
slf_risk_table[1:4, 4] <- formattable::proportion_bar("gray")(slf_risk_table[1:4, 4])

# print table, e.g., in html format
slf_risk_table <- kable(slf_risk_table, "html", escape = FALSE) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
  # standardize col width
  kableExtra::column_spec(1:5, width_min = '4cm') %>%
  add_header_above(., header = c("Risk of persistence for known L delicatula populations" = 6), bold = TRUE)

  
```


```{r save table from above, if desired}

if(TRUE) {
  
  # save as .html
  kableExtra::save_kable(
    slf_risk_table, 
    file = file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table.html"),
    self_contained = TRUE
    )
  
  # initialize webshot by 
 # webshot::install_phantomjs()
  # convert to pdf
  webshot2::webshot(
    url = file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table.html"),
    file = file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table.jpg")
  )
  
  # rm html
  file.remove(file.path(here::here(), "vignette-outputs", "figures", "slf_risk_table.html"))
    
}

```

