---
title: "wc2.1_extractLayers_future_CA"
author: "Sam Owens"
contact: "sam.owens@temple.edu"
date: "2022-11-28"
output: html_document
---

```{r install packages}

install.packages("viridis")

```


```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
library(ENMTools) #enviro collinearity analyses
library(patchwork) #easy combined plots
library(scales) #rescale the plots easily
library(rgdal) #load shapefiles
library(doParallel) #parallized extraction
library(raster)

library(ggplot2)
library(rgeos)
library(maptools)
library(sp)
library(viridis)
library(slfrsk)

```

This file was produced to extract a bounding box of just CA for the bioclim projection layers. The bounding box was retrieved from https://anthonylouisdagostino.com/bounding-boxes-for-all-us-states/ and was x = -124.409591, -114.131211, y = 32.534156, 42.009518. This model was run 2022-11-28.

# 1. map of just CA to validate area selection

```{r create map of CA to test lat/long range}

map_CA <- ggplot() +
  geom_polygon(data = map_data('state'), aes(x = long, y = lat, group = group), fill = "#FFFFFF", color = "black", lwd = 0.15) + #world map
  theme_bw() +
  labs(x = "long", y = "lat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #plot.background = element_rect(fill ="#f0f8ff"),
        panel.background = element_rect(fill = "#f0f8ff")) +
  coord_quickmap(xlim = c(-124.409591, -114.131211), ylim = c(32.534156, 42.009518)) +
  ggtitle(label = "CA")

```

# 2. set extent to just CA

```{r set raster extent}

if(FALSE){
  
  mypath <- "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec"
  
  #ensure that extent is identical
#get file names
env.files <- list.files(file.path(mypath, "orig_layers"), pattern = "\\.tif$", full.names = T)
env.short <- list.files(file.path(mypath, "orig_layers"), pattern = "\\.tif$", full.names = F)

# selecting only the files I need for my analysis to speed up code, as of 2022-11-12
env.files.1 <- env.files[env.files %in% c("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/orig_layers/global_bio_1.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/orig_layers/global_bio_2.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/orig_layers/global_bio_7.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/orig_layers/global_bio_12.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/orig_layers/global_bio_15.tif"
)]

# select only those used in analysis
env.short.1 <- env.short[env.short %in% c("global_bio_1.tif", 
                                          "global_bio_2.tif",
                                          "global_bio_7.tif", 
                                          "global_bio_12.tif",
                                          "global_bio_15.tif"
                                          )]
                                          
#change the labeling of the output layers
output.files <- env.short.1

#crop one of the BIOCLIM layers to set the bounding box and resolution to have files fixed
same.extent <- extent(-124.409591, -114.131211, 32.534156, 42.009518)
main_layer <- crop(raster(file.path(mypath, "orig_layers", "global_bio_1.tif")), y = same.extent, overwrite = F)

#reset extent stepwise
for(a in seq_along(env.files.1)){

  #ensure that the CRS is consistent
  rast.hold <- raster(env.files.1[a])
  crs(rast.hold) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
  #resample to fit the extent/resolution of the reference BIOCLIM layer
  #use bilinear interpolation, since values are continuous
  rast.hold <- resample(x = rast.hold, y = main_layer, method = "bilinear")

  #write out the new resampled rasters!
  writeRaster(x = rast.hold, filename = file.path(mypath, "v1_CA", output.files[a]), overwrite = T)
}

} #closes no run if
  
```

# 3. conversion of file format for Maxent

```{r conversion of .tif to .asc files}

if(FALSE){
  
  mypath <- "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec"
  
  # get/set file names
  env.files <- list.files(path = file.path(mypath, "v1_CA"), pattern = "\\.tif$", full.names = T) 
  
  # subset of files needed for next model
 env.files.2 <- env.files[env.files %in% c("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/v1_CA/global_bio_1.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/v1_CA/global_bio_2.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/v1_CA/global_bio_7.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/v1_CA/global_bio_12.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/v1_CA/global_bio_15.tif"
                                          )]
  
  env.short <- list.files(path = file.path(mypath, "v1_CA"), pattern = "\\.tif$", full.names = F)
  
  # subset of the env short that I need for my next model
  env.short.2 <- env.short[env.short %in% c("global_bio_1.tif", 
                                          "global_bio_2.tif",
                                          "global_bio_7.tif", 
                                          "global_bio_12.tif",
                                          "global_bio_15.tif"
                                          )]
  
  env.asc <- gsub(pattern = ".tif", replacement = ".asc", x = env.short.2)
  
 # env.asc.1 <- env.asc[!env.asc %in% c("global_atc.asc", "global_bio_1.asc", "global_bio_10.asc", "global_bio_11.asc")]
  # a copy to try only one entry of the list
  
  # loop to convert, set NAs equal to -9999 as required by Maxent
for(a in seq_along(env.files.2)){
    
  file_to_asc <- raster(env.files.2[a])
  NAvalue(file_to_asc) <- -9999
  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent_CA_2021-2040", env.asc[a]), format = "ascii", overwrite = F)
    
  }
  
   # file_to_asc <- env.files[1] %>%
    #  raster(.) %>%
     # NAvalue(.) <- -9999 %>%
    #  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[1]), format = "ascii", overwrite = F)
    # just do 1 to start and see how large it is
}

```

I need to crop the output layer for the current day to just CA

# crop extent/ set CRS/ export to tif for current CA predictions

```{r crop extent of current prediction to just CA and set CRS}

# I picked the avg of both replicates to crop

# 1st, convert objects to .tif format
# asc_to_tif <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/Lycorma_delicatula_avg.asc")) 

# next, set extent object and crop to an object
current.extent <- extent(-124.409591, -114.131211, 32.534156, 42.009518)
# crop raster to extent

# use here

#main_layer.2 <- crop(raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/Lycorma_delicatula_avg.asc")), 
#                     y = current.extent, overwrite = F)

main_layer.2 <- crop(raster(file.path(here() %>% dirname(), "maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/Lycorma_delicatula_avg.asc")), 
                     y = current.extent, overwrite = F)

#main_layer.2 <- crop(raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/Lycorma_delicatula_avg.asc")), 
#                     y = current.extent, overwrite = F)


# writeRaster(x = asc_to_tif, filename = file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/asc_to_tif/Lycorma_delicatula_avg"), format = "GTiff", overwrite = F)

current_tif <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/Lycorma_delicatula_avg.asc")) 

# set CRS
crs(current_tif) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
current_tif@crs

# resample
current_tif <- resample(x = current_tif, y = main_layer.2, method = "bilinear")

writeFormats()

# write as a .tif
writeRaster(x = current_tif, filename = file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/manipulated_outputs/Lycorma_delicatula_avg_CA.tif"), format = "GTiff", overwrite = F)

#also write as a .asc
writeRaster(x = current_tif, filename = file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/manipulated_outputs/Lycorma_delicatula_avg_CA.asc"), format = "ascii", overwrite = F)

```

# Visualize current and future CA predictions

```{r visualize current CA predictions}

# load in cropped asc file from above
current_CA <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/manipulated_outputs/Lycorma_delicatula_avg_CA.asc")) 

current_df <- as.data.frame(current_CA, xy = TRUE)

visualize_CA_current <- ggplot() +
  geom_polygon(data = map_data('state'), aes(x = long, y = lat, group = group), fill = "black", color = "white") +
  geom_raster(data = current_df, aes(x = x, y = y, fill = Lycorma_delicatula_avg_CA)) +
  geom_polygon(data = map_data('state'), aes(x = long, y = lat, group = group), fill = NA, color = "white") +
  # set xlim and ylim to CA bounding box
  coord_sf(xlim = c(-124.409591, -114.131211), ylim = c(32.534156, 42.5), expand = FALSE) +
  scale_fill_viridis(option = "inferno") +
  ggtitle("Predicted Establishment Potential for Lycorma delicatula in CA, 1970-2000") +
  labs(fill = "L delicatula establishment potential")

# export image
ggsave(filename = "Predicted Establishment Potential for Lycorma delicatula in CA, 1970-2000.jpg", 
       path = file.path(here(), "figures"), 
       device = "jpeg", 
       dpi = "retina")

```

```{r load and visualize future CA predictions}

# load in future CA prediction map
future_CA <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040/Lycorma_delicatula_v1_maxent_CA_2021-2040_avg.asc")) 

future_df <- as.data.frame(future_CA, xy = TRUE)

visualize_CA_future <- ggplot() +
  geom_polygon(data = map_data('state'), aes(x = long, y = lat, group = group), fill = "black", color = "white") +
  geom_raster(data = future_df, aes(x = x, y = y, fill = Lycorma_delicatula_v1_maxent_CA_2021.2040_avg)) +
  geom_polygon(data = map_data('state'), aes(x = long, y = lat, group = group), fill = NA, color = "white") +
  # set xlim and ylim to CA bounding box
  coord_sf(xlim = c(-124.409591, -114.131211), ylim = c(32.534156, 42.5), expand = FALSE) +
  scale_fill_viridis(option = "inferno") +
  ggtitle("Predicted Establishment Potential for Lycorma delicatula in CA, 2021-2040") +
  labs(fill = "L delicatula establishment potential")

ggsave(filename = "Predicted Establishment Potential for Lycorma delicatula in CA, 2021-2040.jpg", 
       path = file.path(here(), "figures"), 
       device = "jpeg", 
       dpi = "retina")

```


# Rerun of model including global ATC. Maps will be produced for all of CA as well as Napa county

The bounding box was retrieved from https://anthonylouisdagostino.com/bounding-boxes-for-all-us-counties/ and was x = -124.409591, -114.131211, y = 32.534156, 42.009518. This model was run 2022-11-28.

```{r create map of Napa county, CA to test lat/long range}

map_napa <- ggplot() +
  geom_polygon(data = map_data('county'), aes(x = long, y = lat, group = group), fill = "#FFFFFF", color = "black", lwd = 0.15) +
  theme_bw() +
  labs(x = "long", y = "lat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #plot.background = element_rect(fill ="#f0f8ff"),
        panel.background = element_rect(fill = "#f0f8ff")) +
  coord_quickmap(xlim = c(-122.646421, -122.061379), ylim = c(38.154933, 38.864245)) +
  ggtitle(label = "Napa county, CA")

```

## 1. set extent to just CA for just global_atc current predictions

```{r set raster extent}

if(FALSE){
  
  mypath <- "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/current_climate_rasters"
  
  #ensure that extent is identical
#get file names
env.files <- list.files(file.path(mypath, "originals"), pattern = "\\.tif$", full.names = T)
env.short <- list.files(file.path(mypath, "originals"), pattern = "\\.tif$", full.names = F)

# selecting only the files I need for my analysis to speed up code, as of 2022-11-12
env.files.4 <- env.files[env.files %in% "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/current_climate_rasters/originals/2015_accessibility_to_cities_v1.0.tif"]
                                          
# select only those used in analysis
env.short.4 <- env.short[env.short %in% "2015_accessibility_to_cities_v1.0.tif"]
                                          
#change the labeling of the output layers
output.files <- env.short.4

output.files <- gsub(pattern = "2015_accessibility_to_cities_v1.0", replacement = "global_atc", x = output.files)

#crop one of the BIOCLIM layers to set the bounding box and resolution to have files fixed
same.extent <- extent(-124.409591, -114.131211, 32.534156, 42.009518)
main_layer <- crop(raster(file.path(mypath, "originals", "2015_accessibility_to_cities_v1.0.tif")), y = same.extent, overwrite = F)

#reset extent stepwise
for(a in seq_along(env.files.4)){

  #ensure that the CRS is consistent
  rast.hold <- raster(env.files.4[a])
  crs(rast.hold) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
  #resample to fit the extent/resolution of the reference BIOCLIM layer
  #use bilinear interpolation, since values are continuous
  rast.hold <- resample(x = rast.hold, y = main_layer, method = "bilinear")

  #write out the new resampled rasters!
  writeRaster(x = rast.hold, filename = file.path(mypath, "v1", "global_atc_CA_current.tif"), overwrite = T)
}

} #closes no run if
  
```

## 2. conversion of global_atc file format for Maxent

```{r conversion of .tif to .asc files}

if(FALSE){
  
  mypath <- "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/current_climate_rasters"
  
  
  # get/set file names
  env.files <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = T) 
  # subset of files needed for next model
  env.files.5 <- env.files[env.files %in% "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/current_climate_rasters/v1/global_atc_CA_current.tif"]
  
  
  env.short <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = F)
  # subset of the env short that I need for my next model
  env.short.5 <- env.short[env.short %in% "global_atc_CA_current.tif"]
  
  
  env.asc <- gsub(pattern = ".tif", replacement = ".asc", x = env.short.5)
  
 # env.asc.1 <- env.asc[!env.asc %in% c("global_atc.asc", "global_bio_1.asc", "global_bio_10.asc", "global_bio_11.asc")]
  # a copy to try only one entry of the list
  
  # loop to convert, set NAs equal to -9999 as required by Maxent
for(a in seq_along(env.files.5)){
    
  file_to_asc <- raster(env.files.5[a])
  NAvalue(file_to_asc) <- -9999
  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[a]), format = "ascii", overwrite = F)
    
  }
  
   # file_to_asc <- env.files[1] %>%
    #  raster(.) %>%
     # NAvalue(.) <- -9999 %>%
    #  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[1]), format = "ascii", overwrite = F)
    # just do 1 to start and see how large it is
}

```

## 3. Visualize global_atc for validation

```{r visualize newly cropped atc raster}
CA_atc <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/future_climate_rasters_CMIP6/2021-2040_30arcsec/v1_maxent_CA_2021-2040/global_atc.asc")) 

CA_atc_df <- as.data.frame(CA_atc, xy = TRUE)

visualize_CA_atc <- ggplot() +
  geom_polygon(data = map_data('state'), aes(x = long, y = lat, group = group), fill = "black", color = "white") +
  geom_raster(data = CA_atc_df, aes(x = x, y = y, fill = global_atc)) +
  geom_polygon(data = map_data('state'), aes(x = long, y = lat, group = group), fill = NA, color = "white") +
  # set xlim and ylim to CA bounding box
  coord_sf(xlim = c(-124.409591, -114.131211), ylim = c(32.534156, 42.5), expand = FALSE) +
  scale_fill_viridis(option = "inferno", direction = -1) +
  ggtitle("2010 access to cities for CA") +
  labs(fill = "travel time to cities (min)")
```

Run model here

## model output manipulation for CA model with global_atc

```{r load in wineries dataset from slfrsk}

data("wineries")

```

### crop extent/ set CRS/ export to tif for current CA predictions

```{r crop extent of current prediction to just CA and set CRS}

# I picked the avg of both replicates to crop

# first, set extent object and crop to an object
current.extent <- extent(-124.409591, -114.131211, 32.534156, 42.009518)
# crop raster to extent
main_layer.3 <- crop(raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/Lycorma_delicatula_avg.asc")), 
                     y = current.extent, overwrite = F)

current_tif <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/Lycorma_delicatula_avg.asc")) 

# set CRS
crs(current_tif) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
current_tif@crs

# resample
current_tif <- resample(x = current_tif, y = main_layer.3, method = "bilinear")

writeFormats()

# write as a .tif
writeRaster(x = current_tif, filename = file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/manipulated_outputs/Lycorma_delicatula_avg_CA.tif"), format = "GTiff", overwrite = F)

#also write as a .asc
writeRaster(x = current_tif, filename = file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/manipulated_outputs/Lycorma_delicatula_avg_CA.asc"), format = "ascii", overwrite = F)

```

### Visualize current global-scale predictions with global_atc

```{r visualize current global predictions with global_atc, eval = FALSE}

# load in cropped asc file from above
current_global <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/Lycorma_delicatula_avg.asc")) 

global_df <- as.data.frame(current_global, xy = TRUE)

visualize_global_current <- ggplot() +
  geom_polygon(data = map_data('world'), aes(x = long, y = lat, group = group), fill = "white", color = "black") +
  geom_raster(data = global_df, aes(x = x, y = y, fill = Lycorma_delicatula_avg)) +
  geom_polygon(data = map_data('world'), aes(x = long, y = lat, group = group), fill = NA, color = "black") +
  scale_fill_gradientn(name = "Lycorma_delicatula_avg", colors = rev(c("#e31a1c","#fd8d3c", "#fecc5c", "#FFFFFF"))) +
  ggtitle("Global Predicted Suitability for Establishment of Lycorma delicatula, 1970-2000") +
  labs(fill = "suitability")

# export image
ggsave(filename = "Global Predicted Suitability for Establishment of Lycorma delicatula, 1970-2000, with global_atc.jpg", 
       path = file.path(here(), "figures"), 
       device = "jpeg", 
       dpi = "retina")

```

### Visualize current and future CA predictions with global atc for the entire state

```{r visualize current CA predictions with global_atc}

# load in cropped asc file from above
current_CA <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/manipulated_outputs/Lycorma_delicatula_avg_CA.asc")) 

current_df <- as.data.frame(current_CA, xy = TRUE)

visualize_CA_current <- ggplot() +
  geom_polygon(data = map_data('state'), 
               aes(x = long, y = lat, group = group), 
               fill = "white", 
               color = "black",
               size = 0.75) +
  # change scale of plots to be standard across figures
  geom_raster(data = current_df, 
              aes(x = x, y = y, fill = rescale(Lycorma_delicatula_avg_CA, to = c(0, 1)))) +
  geom_polygon(data = map_data('state'), 
               aes(x = long, y = lat, group = group), 
               fill = NA, 
               color = "black",
               size = 0.75) +
  # set xlim and ylim to CA bounding box
  coord_sf(xlim = c(-124.409591, -114.131211), 
           ylim = c(32.534156, 42.5),  
           expand = TRUE) +
  # edit fill gradient
  scale_fill_gradientn(name = "suitability", 
                       colors = rev(c("#e31a1c","#fd8d3c", "#fecc5c", "#FFFFFF")),
                       na.value = "white") +
  ggtitle("Predicted Suitability for Establishment of Lycorma delicatula",
          subtitle = "California, 1970-2000") +
  xlab("Longitude") + 
  ylab("Latitude")

# export image
ggsave(filename = "Predicted Suitability for Establishment of Lycorma delicatula in CA, 1970-2000, with global_atc_v1.jpg", 
       path = file.path(here(), "figures"),
       plot = visualize_CA_current,
       device = "jpeg", 
       dpi = "retina")

```

```{r load and visualize future CA predictions}

# load in future CA prediction map
future_CA <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/Lycorma_delicatula_v1_maxent_CA_2021-2040_avg.asc")) 

future_df <- as.data.frame(future_CA, xy = TRUE)

# visualize
visualize_CA_future <- ggplot() +
  geom_polygon(data = map_data('state'), 
               aes(x = long, y = lat, group = group), 
               fill = "white", 
               color = "black",
               size = 0.75) +
  # change scale of plots to be standard across figures
  geom_raster(data = future_df, 
              aes(x = x, y = y, fill = rescale(Lycorma_delicatula_v1_maxent_CA_2021.2040_avg, to = c(0, 1)))) +
  geom_polygon(data = map_data('state'), 
               aes(x = long, y = lat, group = group), 
               fill = NA, 
               color = "black",
               size = 0.75) +
  # set xlim and ylim to CA bounding box
  coord_sf(xlim = c(-124.409591, -114.131211), 
           ylim = c(32.534156, 42.5), 
           expand = TRUE) +
  # edit fill gradient
  scale_fill_gradientn(name = "suitability", 
                       colors = rev(c("#e31a1c","#fd8d3c", "#fecc5c", "#FFFFFF")),
                       na.value = "white") +
  ggtitle("Predicted Suitability for Establishment of Lycorma delicatula",
          subtitle = "California, 2021-2040") +
  xlab("Longitude") + 
  ylab("Latitude")

ggsave(filename = "Predicted Suitability for Establishment of Lycorma delicatula in CA, 2021-2040, with global_atc_v1.jpg", 
       path = file.path(here(), "figures"), 
       plot = visualize_CA_future,
       device = "jpeg", 
       dpi = "retina")

```

### Visualize current and future CA predictions with global atc for napa county CA

```{r visualize current CA predictions with global_atc}

# load in cropped asc file from above
current_napa <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/manipulated_outputs/Lycorma_delicatula_avg_CA.asc")) 

current_napa_df <- as.data.frame(current_napa, xy = TRUE)


# visualize
visualize_napa_current <- ggplot() +
  geom_polygon(data = map_data('county'), 
               aes(x = long, y = lat, group = group), 
               fill = "white", 
               color = "black",
               size = 0.75) +
  # change scale of plots to be standard across figures
  geom_raster(data = current_napa_df, 
              aes(x = x, y = y, fill = rescale(Lycorma_delicatula_avg_CA, to = c(0, 1)))) +
  geom_polygon(data = map_data('county'), 
               aes(x = long, y = lat, group = group), 
               fill = NA, 
               color = "black",
               size = 0.75) +
  # set xlim and ylim to napa county bounding box
  coord_sf(xlim = c(-122.646421, -122.061379), 
           ylim = c(38.154933, 38.864245), 
           expand = TRUE) +
  # edit fill gradient
  scale_fill_gradientn(name = "suitability", 
                       colors = rev(c("#e31a1c","#fd8d3c", "#fecc5c", "#FFFFFF")),
                       na.value = "white") +
  ggtitle("Predicted Suitability for Establishment of Lycorma delicatula",
          subtitle = "Napa county, CA, 1970-2000") +
  xlab("Longitude") + 
  ylab("Latitude")


# export image
ggsave(filename = "Predicted Suitability for Establishment of Lycorma delicatula in Napa county, CA, 1970-2000, with global_atc_v2.jpg",
       plot = visualize_napa_current,
       path = file.path(here(), "figures"), 
       device = "jpeg", 
       dpi = "retina")

```

```{r load and visualize future predictions for Napa county CA}

# load in future CA prediction map
future_napa <- raster(file.path("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent_EDA_2022/maxent_models/maxent_slf_2022_gbif_CA_2021-2040_withATC/Lycorma_delicatula_v1_maxent_CA_2021-2040_avg.asc")) 

future_napa_df <- as.data.frame(future_napa, xy = TRUE)

visualize_napa_future <- ggplot() +
  geom_polygon(data = map_data('county'), 
               aes(x = long, y = lat, group = group), 
               fill = "white", 
               color = "black",
               size = 0.75) +
  # change scale of plots to be standard across figures
  geom_raster(data = future_napa_df, 
              aes(x = x, y = y, fill = rescale(Lycorma_delicatula_v1_maxent_CA_2021.2040_avg, to = c(0, 1)))) +
  geom_polygon(data = map_data('county'), 
               aes(x = long, y = lat, group = group), 
               fill = NA, 
               color = "black",
               size = 0.75) +
  # set xlim and ylim to napa county bounding box
  coord_sf(xlim = c(-122.646421, -122.061379), 
           ylim = c(38.154933, 38.864245), 
           expand = TRUE) +
  # edit fill gradient
  scale_fill_gradientn(name = "suitability", 
                       colors = rev(c("#e31a1c","#fd8d3c", "#fecc5c", "#FFFFFF")),
                       na.value = "white") +
  ggtitle("Predicted Suitability for Establishment of Lycorma delicatula",
          subtitle = "Napa county, CA, 2021-2040") +
  xlab("Longitude") + 
  ylab("Latitude")

# export image
ggsave(filename = "Predicted Suitability for Establishment of Lycorma delicatula in Napa county, CA, 2021-2040, with global_atc_v2.jpg", 
       plot = visualize_napa_future,
       path = file.path(here(), "figures"), 
       device = "jpeg", 
       dpi = "retina")

```


