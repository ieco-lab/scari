---
title: "wc2.1_extractLayers_future"
author: "Sam Owens"
contact: "sam.owens@temple.edu"
date: "2022-11-08"
output: html_document
---

File paths edited 2023-01-24, 2023-06-01

```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation

library(here) #making directory pathways easier on different instances
here()
# here() is "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/slfSpread_pkg"

library(ENMTools) #enviro collinearity analyses
library(patchwork) #easy combined plots
library(scales) #rescale the plots easily
library(rgdal) #load shapefiles
library(doParallel) #parallized extraction
library(raster)

library(ggplot2)
library(rgeos)
library(maptools)
library(sp)

```

# 1. Get raster attributes and extract layers

Future bioclim data was taken from Worldclim. It was downloaded as a multiband raster, so the layers need to be extracted.

```{r raster attributes}

mypath <- file.path(here() %>% 
                      dirname(),
                      "maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS")

# load in raster
bioclim <- stack(file.path(mypath, "originals", "wc2.1_30s_bioc_GISS-E2-1-G_ssp370_2021-2040.tif"))

# bioclim_brick <- raster(file.path(mypath, "originals", "wc2.1_30s_bioc_GISS-E2-1-G_ssp370_2021-2040.tif")) %>%
#  brick()

# nlayers(bioclim_brick)

object.size(bioclim) 
bioclim@layers # check # layers
bioclim@crs # crs will get set later
bioclim@extent #raster extent will get set later

bioclim_stats <- data.frame(matrix(ncol = 3, nrow = 1))
colnames(bioclim_stats) <- c("min", "max", "mean")

bioclim_stats[1, ] <- c(cellStats(bioclim, min),
                        cellStats(bioclim, max),
                        cellStats(bioclim, mean)
)

```

```{r write each layer of bioclim raster to a .tif}

# used to extract specific layers if needed
bioclim <- stack(file.path(mypath, "originals", "wc2.1_30s_bioc_GISS-E2-1-G_ssp370_2021-2040.tif"))
# bioclim@layers

writeRaster(bioclim, 
            filename = file.path(mypath, "orig_layers", "global_bio.tif"), 
            format = "GTiff", 
            bylayer = TRUE,
            suffix = "numbers",
            progress = "text",
            # so it wont overwrite if you make a mistake
            overwrite = FALSE
            )

```

# 2. set extent and downsize rasters

```{r set raster extent}

if(FALSE){
  
  mypath <- file.path(here() %>% 
                      dirname(),
                      "maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS")
  
  #ensure that extent is identical
#get file names
env.files <- list.files(file.path(mypath, "orig_layers"), pattern = "\\.tif$", full.names = T)
env.short <- list.files(file.path(mypath, "orig_layers"), pattern = "\\.tif$", full.names = F)

# selecting only the files I need for my analysis to speed up code, as of 2022-11-12
#env.files.1 <- env.files[env.files %in% c("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_1.tif",
#                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_2.tif",
 #                                         "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_7.tif",
  #                                        "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_12.tif",
   #                                       "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_15.tif"
#)]

# select only those used in analysis
# env.short.1 <- env.short[env.short %in% c("global_bio_1.tif", 
  #                                        "global_bio_2.tif",
   #                                       "global_bio_7.tif", 
    #                                      "global_bio_12.tif",
     #                                     "global_bio_15.tif"
      #                                    )]
                                          
#change the labeling of the output layers
output.files <- env.short

#crop one of the BIOCLIM layers to set the bounding box and resolution to have files fixed
same.extent <- extent(-180, 180, -60, 84)
main_layer <- crop(raster(file.path(mypath, "orig_layers", "global_bio_1.tif")), y = same.extent, overwrite = F)

#reset extent stepwise
for(a in seq_along(env.files)){

  #ensure that the CRS is consistent
  rast.hold <- raster(env.files[a])
  crs(rast.hold) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
  #resample to fit the extent/resolution of the reference BIOCLIM layer
  #use bilinear interpolation, since values are continuous
  rast.hold <- resample(x = rast.hold, y = main_layer, method = "bilinear")

  #write out the new resampled rasters!
  writeRaster(x = rast.hold, filename = file.path(mypath, "v1", output.files[a]), overwrite = T)
}

} #closes no run if
  
```

```{r downsize raster resolution}

if(FALSE) {
  
mypath <- file.path(here() %>% 
                      dirname(),
                      "maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS")
  
  #list env layers, load
  env.files <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = T)
  env.short <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = F)
  # I had to modify "pattern" to not include the .tif.aux.xml files

  # selecting only the files I need for my analysis to speed up code, as of 2022-11-12
env.files.2 <- env.files[env.files %in% c("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_1.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_2.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_7.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_12.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_15.tif"
                                          )]

# select only those used in analysis
env.short.2 <- env.short[env.short %in% c("global_bio_1.tif", 
                                          "global_bio_2.tif",
                                          "global_bio_7.tif", 
                                          "global_bio_12.tif",
                                          "global_bio_15.tif"
                                          )]
  
  # downsampling by factor of 2 (read 2 cells deep around cell) and take mean of cells
  
  for(a in seq_along(env.files.2)){
    
    holder <- raster(env.files.2[a])
    down_holder <- raster::aggregate(holder, fact = 2, fun = mean, expand = TRUE, na.rm = TRUE, filename = file.path(mypath, "v1_downsampled", env.short.2[a]), overwrite = T)
    
  }
  
}

```

# 3. conversion of file format for Maxent

```{r conversion of .tif to .asc files}

if(FALSE){
  
mypath <- file.path(here() %>% 
                      dirname(),
                      "maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS")
  
  # get/set file names
  env.files <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = T) 
  
  # subset of files needed for next model
 env.files.3 <- env.files[env.files %in% c("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_1.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_2.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_7.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_12.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1/global_bio_15.tif"
                                          )]
  
  env.short <- list.files(path = file.path(mypath, "v1"), pattern = "\\.tif$", full.names = F)
  
  # subset of the env short that I need for my next model
  env.short.3 <- env.short[env.short %in% c("global_bio_1.tif", 
                                          "global_bio_2.tif",
                                          "global_bio_7.tif", 
                                          "global_bio_12.tif",
                                          "global_bio_15.tif"
                                          )]
  
  env.asc <- gsub(pattern = ".tif", replacement = ".asc", x = env.short.3)
  
 # env.asc.1 <- env.asc[!env.asc %in% c("global_atc.asc", "global_bio_1.asc", "global_bio_10.asc", "global_bio_11.asc")]
  # a copy to try only one entry of the list
  
  # loop to convert, set NAs equal to -9999 as required by Maxent
for(a in seq_along(env.files.3)){
    
  file_to_asc <- raster(env.files.3[a])
  NAvalue(file_to_asc) <- -9999
  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[a]), format = "ascii", overwrite = F)
    
  }
  
   # file_to_asc <- env.files[1] %>%
    #  raster(.) %>%
     # NAvalue(.) <- -9999 %>%
    #  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[1]), format = "ascii", overwrite = F)
    # just do 1 to start and see how large it is
}

```

## set different raster extent for future bioclim rasters (only N America) for projection layers 

### 1. set extent to N America

```{r create map of N America to test lat/long range}

map_nAmerica <- ggplot() +
  geom_polygon(data = map_data('world'), aes(x = long, y = lat, group = group), fill = "#FFFFFF", color = "black", lwd = 0.15) + #world map
  theme_bw() +
  labs(x = "long", y = "lat") +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #plot.background = element_rect(fill ="#f0f8ff"),
        panel.background = element_rect(fill = "#f0f8ff")) +
  coord_quickmap(xlim = c(-135, -60), ylim = c(25,60)) +
  ggtitle(label = "N. America")

```


```{r set raster extent}

if(FALSE){
  
mypath <- file.path(here() %>% 
                      dirname(),
                      "maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS")
  
  #ensure that extent is identical
#get file names
env.files <- list.files(file.path(mypath, "orig_layers"), pattern = "\\.tif$", full.names = T)
env.short <- list.files(file.path(mypath, "orig_layers"), pattern = "\\.tif$", full.names = F)

# selecting only the files I need for my analysis to speed up code, as of 2022-11-12
env.files.4 <- env.files[env.files %in% c("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_1.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_2.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_7.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_12.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/orig_layers/global_bio_15.tif"
)]

# select only those used in analysis
env.short <- env.short[env.short %in% c("global_bio_1.tif", 
                                          "global_bio_2.tif",
                                          "global_bio_7.tif", 
                                          "global_bio_12.tif",
                                          "global_bio_15.tif"
                                          )]
                                          
#change the labeling of the output layers
output.files <- env.short

#crop one of the BIOCLIM layers to set the bounding box and resolution to have files fixed
same.extent <- extent(-135, -60, 25, 60) # crop to N America
main_layer <- crop(raster(file.path(mypath, "orig_layers", "global_bio_1.tif")), y = same.extent, overwrite = F)

#reset extent stepwise
for(a in seq_along(env.files.4)){

  #ensure that the CRS is consistent
  rast.hold <- raster(env.files.4[a])
  crs(rast.hold) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
  #resample to fit the extent/resolution of the reference BIOCLIM layer
  #use bilinear interpolation, since values are continuous
  rast.hold <- resample(x = rast.hold, y = main_layer, method = "bilinear")

  #write out the new resampled rasters!
  writeRaster(x = rast.hold, filename = file.path(mypath, "v1_Namerica", output.files[a]), overwrite = T)
}

} #closes no run if
  
```

### 2. conversion of file format for Maxent

```{r conversion of .tif to .asc files}

if(FALSE){
  
mypath <- file.path(here() %>% 
                      dirname(),
                      "maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS")
  
  # get/set file names
  env.files <- list.files(path = file.path(mypath, "v1_Namerica"), pattern = "\\.tif$", full.names = T) 
  
  # subset of files needed for next model
 env.files.5 <- env.files[env.files %in% c("C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1_Namerica/global_bio_1.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1_Namerica/global_bio_2.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1_Namerica/global_bio_7.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1_Namerica/global_bio_12.tif",
                                          "C:/Users/tun83449/OneDrive - Temple University/Shared drives/slfClimate/projects/slfSpread/maxent/future_climate_rasters_CMIP6/2021-2040_ssp370_30arcsec_GISS/v1_Namerica/global_bio_15.tif"
                                          )]
  
  env.short <- list.files(path = file.path(mypath, "v1_Namerica"), pattern = "\\.tif$", full.names = F)
  
  # subset of the env short that I need for my next model
  env.short.5 <- env.short[env.short %in% c("global_bio_1.tif", 
                                          "global_bio_2.tif",
                                          "global_bio_7.tif", 
                                          "global_bio_12.tif",
                                          "global_bio_15.tif"
                                          )]
  
  env.asc <- gsub(pattern = ".tif", replacement = ".asc", x = env.short.5)
  
  # loop to convert, set NAs equal to -9999 as required by Maxent
for(a in seq_along(env.files.5)){
    
  file_to_asc <- raster(env.files.5[a])
  NAvalue(file_to_asc) <- -9999
  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent_Namerica_2021-2040", env.asc[a]), format = "ascii", overwrite = F)
    
  }
  
   # file_to_asc <- env.files[1] %>%
    #  raster(.) %>%
     # NAvalue(.) <- -9999 %>%
    #  writeRaster(x = file_to_asc, filename = file.path(mypath, "v1_maxent", env.asc[1]), format = "ascii", overwrite = F)
    # just do 1 to start and see how large it is
}

```
