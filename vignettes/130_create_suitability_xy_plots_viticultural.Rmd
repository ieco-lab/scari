---
title: "Plot suitability for SLF in important grape growing regions and climate change effects"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-04-30"
output: html_document
---
# Overview

EDIT

This vignette will compare the invaded region model for SLF, which was created in `050_run_easternUSA_MaxEnt_models.Rmd`, with the global version of this model, which was created in `070_run_global_historical_MaxEnt_model.Rmd`. First, I will compare these models using flexible AUC. Second, I will also project these models to N. America and compare the proportion of suitable area. Third, I will calculate suitability values for all SLF points and IVR regions. Finally, I will perform an invasion stage analysis following the methods of Gallien et.al, 2012. 

In step 1, I tested the best fit background data using SLF occurrences and climate data only from the SLF invaded range (the eastern half of the United States). 

(THEORY)

# Setup

```{r load necesssary packages, echo = FALSE}

# general tools
library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here::here() # here() starts at the root folder of this package.
library(devtools)

# spatial data handling
library(terra)
library(scrubr)

# plot aesthetics
library(scales)
library(patchwork)

```

```{r set wd}

mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models")

```

I will load in some aesthetic objects, including for breaks and plot styles. I will have separate style lists for both current and climate change scatters, due to different axis labels and threshold lines

```{r plot style 1995}

scatter_style_1995 <- list(
  # aesthetics
   labs(title = "Risk of SLF establishment in globally important viticultural areas",
        subtitle = "1981-2010 | 'global' vs 'regional_ensemble' models",
        caption = "suitability measured using MTSS threshold (dashed)",
        x = "'global' model suitability",
        y = "'regional_ensemble' model suitability"
        ),
   theme_bw(),
  # MTSS threshold
  geom_vline(xintercept = as.numeric(summary_global[42, ncol(summary_global)]), linetype = "dashed"),
  geom_hline(yintercept = as.numeric(summary_regional_native[42, 2]), linetype = "dashed")
  
)

```

```{r plot style 2055}

scatter_style_1995 <- list(
  # aesthetics
   labs(title = "Risk of SLF establishment in globally important viticultural areas",
        subtitle = "2041-2070 | ssp3-70 | GFDL | 'global' vs 'regional_ensemble' models",
        caption = "suitability measured using MTSS threshold (dashed)",
        x = "'global' model suitability",
        y = "'regional_ensemble' model suitability"
        ),
   theme_bw(),
  # MTSS threshold
  geom_vline(xintercept = as.numeric(summary_global[42, ncol(summary_global)]), linetype = "dashed"),
  geom_hline(yintercept = as.numeric(summary_regional_native[42, 2]), linetype = "dashed")
  
)

```

```{r axis breaks}

breaks <- c(0.0, 0.2, 0.4, 0.6, 0.8, 1.0)

```

Load in summary files for the global and regional ensemble models, which contain the thresholds.

```{r load in summary files}
# summary file to extract thresholds from

# global
summary_global <- read_csv(file = file.path(mypath, "slf_global_v2", "global_summary_all_iterations.csv"))

summary_regional_ensemble <- read_csv(file = file.path(mypath, "slf_regional_ensemble_v0", "ensemble_threshold_values.csv"))


```

I will load in dataset containing locations of globally important viticultural regions. I will also de-duplicate the records because there were "many-to-many" joining matches downstream. De-duplicating removed about 17 records. I also remove the species column, which is automatically created by `SDMtune::predict()` upstream.

```{r load in wineries dataset}

load(file.path(here::here(), "data", "wineries.rda"))

IVR_locations <- wineries %>%
  # tidy
  dplyr::select(-c(Latitude, Longitude)) %>%
  dplyr::filter(
    !is.na(x),
    !is.na(y)
    ) %>%
  # de-duplicate
  scrubr::dedup(how = "one", tolerance = 0.99) 

# remove unnecessary obj
rm(wineries)

```

Finally, I will load in the global and regional ensemble suitability maps. These will be used both for extracting the new xy suitability values and for plotting.

```{r load in suitability rasters}

# global
global_1995 <- terra::rast(x = file.path(mypath, "slf_global_v2", "global_pred_suit_clamped_cloglog_globe_1981-2010_mean.asc"))

global_2055 <- terra::rast(x = file.path(mypath, "slf_global_v2", "global_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370_mean.asc"))


# regional_ensemble
regional_ensemble_1995 <- terra::rast(
  x = file.path(mypath, "slf_regional_ensemble_v0", "ensemble_regional_weighted_mean_globe_1981-2010.asc")
  )

regional_ensemble_2055 <- terra::rast(
  x = file.path(mypath, "slf_regional_ensemble_v0", "ensemble_regional_weighted_mean_globe_2041-2070_GFDL_ssp370.asc")
  )

```

# Retrieve/Import xy suitability

These scatter plots will be based on the suitability for the IVR points in both the global and regional_ensemble models. I have already calculated the xy suitability for the global model based on these points, using the function `slfSpread::predict_xy_suitability()`. This function will not work for the regional_ensemble because it calls for a model object, which we did not use to predict the ensemble suitability. So, I will use `terra::extract()` to perform this action.

```{r import global suitability}

global_xy_suit_1995 <- read_csv(
  file = file.path(mypath, "slf_global_v2", "global_wineries_1981-2010_xy_pred_suit_clamped_cloglog_mean.csv")
  ) %>%
  dplyr::select(-Species)

global_xy_suit_2055 <- read_csv(
  file = file.path(mypath, "slf_global_v2", "global_wineries_2041-2070_GFDL_ssp370_xy_pred_suit_clamped_cloglog_mean.csv")
  ) %>%
  dplyr::select(-Species)

```

```{r retrieve xy suitability for regional_ensemble}

# 1995
regional_ensemble_xy_suit_1995 <- terra::extract(
  x = regional_ensemble_1995,
  y = dplyr::select(IVR_locations, x, y), # points
  method = "simple",
  xy = TRUE, # return coordinates
  ID = FALSE
) %>%
  # tidy
  dplyr::rename("cloglog_suitability" = "sum") %>%
  dplyr::relocate(x, y)


# 2055
regional_ensemble_xy_suit_2055 <- terra::extract(
  x = regional_ensemble_2055,
  y = dplyr::select(IVR_locations, x, y), # points
  method = "simple",
  xy = TRUE, # return coordinates
  ID = FALSE
) %>%
  dplyr::rename("cloglog_suitability" = "sum") %>%
  dplyr::relocate(x, y)

```

```{r save predicted suitability}



```


# Transform xy suitability

I will plot the suitability values in two different ways- I will plot the raw xy suitability and I will transform the data so that the MTSS threshold is the center of the scatter plot. This way, movement across the minimum suitability threshold is more easily visualized. 

```{r}

slfSpread::rescale_cloglog_suitability(
  xy.predicted = global_xy_suit_1995,
  thresh = "MTP",
  exponential.file = file.path(here::here(), "data-raw", "threshold_exponential_values.csv"),
  summary.file = summary_global,
  rescale.name = "global_1995",
  rescale.thresholds = TRUE
)

slfSpread::rescale_cloglog_suitability(
  xy.predicted = regional_ensemble_xy_suit_1995,
  thresh = "MTSS",
  exponential.file = file.path(here::here(), "data-raw", "threshold_exponential_values.csv"),
  summary.file = summary_regional_ensemble,
  rescale.name = "regional_ensemble_1995",
  rescale.thresholds = TRUE
)

```



# References

Gallien, L., R. Douzet, S. Pratte, N. E. Zimmermann, and W. Thuiller. 2012. Invasive species distribution models – how violating the equilibrium assumption can create new insights. Global Ecology and Biogeography 21:1126–1136.
