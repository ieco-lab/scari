---
title: "Create suitability scatter plots and binarized maps (chapter 1)"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-02-29"
output: html_document
---
# Overview

This vignette will compare the invaded region model for SLF, which was created in `050_run_easternUSA_MaxEnt_models.Rmd`, with the global version of this model, which was created in `070_run_global_historical_MaxEnt_model.Rmd`. First, I will compare these models using flexible AUC. Second, I will also project these models to N. America and compare the proportion of suitable area. Third, I will calculate suitabilitiy values for all SLF points and IVR regions. Finally, I will perform an invasion stage analysis following the methods of Gallien et.al, 2012. 

In step 1, I tested the best fit background data using SLF occurrences and climate data only from the SLF invaded range (the eastern half of the United States). 

(THEORY)

# Setup

```{r load necesssary packages, echo = FALSE}

# general tools
library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here() # here() starts at the root folder of this package.
library(devtools)

# SDMtune and dependencies
library(SDMtune) # main package used to run SDMs
library(dismo) # package underneath SDMtune
library(rJava) # for running MaxEnt
library(plotROC) # plots ROCs

# spatial data handling
library(raster) 
library(terra) 

library(viridis)

```

```{r ggplot object for plot style}

# a vector to rescale the axes of the plots
breaks <- c(0.0, 0.2, 0.4, 0.6, 0.8, 1.0)

scatter_style <- list(
  scale_x_continuous(name = "suitability in global model", limits = c(0, 1), breaks = breaks),
  scale_y_continuous(name = "suitability in regional model", limits = c(0, 1), breaks = breaks),
  theme_minimal()
)

```

```{r set wd}

mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models")

```


# Analyze xy suitability values for global vs regional models

## SLF presences

### Historical predictions

In the previous vignette, I extracted point-wise suitability values for all SLF presences used to train the model. I will now plot them as a scatter plot to infer the stage of invasion for each population. Gallien et.al 2012 developed this method for making more rigorous predictions for presence-only models in non-equilibrium situations, such as for invasive species. 

```{r set wd}

# pathing
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models")

```

```{r load in xy suitability}

# global
slf_suit_global_hist <- read_csv(
  file = file.path(mypath, "slf_global_v2", "global_slf_all_coords_1981-2010_xy_pred_suit_clamped_cloglog_mean.csv")
  ) %>%
  dplyr::rename("global_suitability" = "cloglog_suitability")



# regional_invaded
slf_suit_regional_invaded_hist <- read_csv(
  file = file.path(mypath, "slf_regional_invaded_v4", "regional_invaded_slf_all_coords_1981-2010_xy_pred_suit_clamped_cloglog.csv")
  ) %>%
  dplyr::rename("regional_invaded_suitability" = "cloglog_suitability")



# regional_native
slf_suit_regional_native_hist <- read_csv(
  file = file.path(mypath, "slf_regional_native_v1", "regional_native_slf_all_coords_1981-2010_xy_pred_suit_clamped_cloglog.csv")
  ) %>%
  dplyr::rename("regional_native_suitability" = "cloglog_suitability")

```

```{r load in summary files}
# summary file to extract thresholds from

# global
summary_global_hist <- read_csv(file = file.path(mypath, "slf_global_v2", "global_summary_all_iterations.csv"))


# regional_native
summary_regional_invaded_hist <- read_csv(file = file.path(mypath, "slf_regional_invaded_v4", "regional_invaded_summary.csv"))


# regional_native
summary_regional_native_hist <- read_csv(file = file.path(mypath, "slf_regional_native_v1", "regional_native_summary.csv"))


```




```{r read in datasets}

# join datasets for plotting
slf_suitability <- full_join(slf_suit_regional, slf_suit_global, by = c("Species", "x", "y"))

```

```{r plot SLF suitability values}

(slf_suit_scatter <- ggplot() +
   # midpoint line
   geom_vline(xintercept = 0.5) + 
   geom_hline(yintercept = 0.5) +
   # MTP threshold
   geom_vline(xintercept = as.numeric(summary_global[30, ncol(summary_global)]), linetype = "dotted", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional[30, ncol(summary_regional)]), linetype = "dotted", alpha = 0.5) +
   # 10 percentile threshold
   geom_vline(xintercept = as.numeric(summary_global[34, ncol(summary_global)]), linetype = "twodash", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional[34, ncol(summary_regional)]), linetype = "twodash", alpha = 0.5) +
   # MTSS threshold
   geom_vline(xintercept = as.numeric(summary_global[42, ncol(summary_global)]), linetype = "dashed", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional[42, ncol(summary_regional)]), linetype = "dashed", alpha = 0.5) +
   # data
   geom_point(data = slf_suitability, 
               aes(x = global_suitability, y = invaded_regional_suitability), 
               color = "darkorange", size = 1
               ) +
   # aesthetics
   labs(title ="Suitability for SLF establishment at locations with known SLF presences",
         subtitle = "global vs regional historical models",
         caption = "thresholds: dotted = MTP, twodash = 10_percentile, dashed = MTSS"
         ) +
   scatter_style
)

```

```{r save scatterplot}

ggsave(slf_suit_scatter, filename = file.path(here(), "vignette-outputs", "figures", "slf_suitability_historical_models_ch1.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```







```{r join datasets}

# join datasets for plotting
slf_suit_global_native <- full_join(slf_suit_regional_native, slf_suit_global, by = c("Species", "x", "y"))

```

```{r plot SLF suitability values}

(slf_suit_global_native_plot <- ggplot() +
   # midpoint line
   geom_vline(xintercept = 0.5) + 
   geom_hline(yintercept = 0.5) +
   # MTP threshold
   geom_vline(xintercept = as.numeric(summary_global[30, ncol(summary_global)]), linetype = "dotted", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional_native[30, ncol(summary_regional_native)]), linetype = "dotted", alpha = 0.5) +
   # 10 percentile threshold
   geom_vline(xintercept = as.numeric(summary_global[34, ncol(summary_global)]), linetype = "twodash", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional_native[34, ncol(summary_regional_native)]), linetype = "twodash", alpha = 0.5) +
   # MTSS threshold
   geom_vline(xintercept = as.numeric(summary_global[42, ncol(summary_global)]), linetype = "dashed", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional_native[42, ncol(summary_regional_native)]), linetype = "dashed", alpha = 0.5) +
   # data
   geom_point(data = slf_suit_global_native, 
               aes(x = global_suitability, y = regional_native_suitability), 
               color = "darkorange", size = 1
               ) +
   # aesthetics
   labs(title ="Suitability for SLF establishment at locations with known SLF presences",
         subtitle = "MODELS: 'global' vs 'regional_native' | 1981-2010",
         caption = "thresholds: dotted = MTP, twodash = 10_percentile, dashed = MTSS"
         ) +
   scatter_style
)

```

```{r save scatterplot}

ggsave(slf_suit_scatter, filename = file.path(here(), "vignette-outputs", "figures", "slf_suitability_historical_models_ch1.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```


### CMIP6 predictions

```{r read in datasets}

# pathing
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models")

# suitability values
# regional
slf_suit_regional_CMIP6 <- read_csv(
  file = file.path(mypath, "slf_invaded_regional_ch1", "invaded_regional_slf_all_coords_2041-2070_GFDL_ssp370_xy_predicted_suitability_mean.csv")
  ) %>%
  dplyr::rename("invaded_regional_suitability" = "cloglog_suitability")
# global
slf_suit_global_CMIP6 <- read_csv(
  file = file.path(mypath, "slf_global_ch1", "global_slf_all_coords_2041-2070_GFDL_ssp370_predicted_suitability_mean.csv")
  ) %>%
  dplyr::rename("global_suitability" = "cloglog_suitability")

# join datasets for plotting
slf_suitability_CMIP6 <- full_join(slf_suit_regional_CMIP6, slf_suit_global_CMIP6, by = c("Species", "x", "y"))


# the summary files are the same, so no need to load these in again

```

```{r plot SLF suitability values}

(slf_suit_scatter_CMIP6 <- ggplot() +
   # midpoint line
   geom_vline(xintercept = 0.5) + 
   geom_hline(yintercept = 0.5) +
   # MTP threshold
   geom_vline(xintercept = as.numeric(summary_global[30, ncol(summary_global)]), linetype = "dotted", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional[30, ncol(summary_regional)]), linetype = "dotted", alpha = 0.5) +
   # 10 percentile threshold
   geom_vline(xintercept = as.numeric(summary_global[34, ncol(summary_global)]), linetype = "twodash", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional[34, ncol(summary_regional)]), linetype = "twodash", alpha = 0.5) +
   # MTSS threshold
   geom_vline(xintercept = as.numeric(summary_global[42, ncol(summary_global)]), linetype = "dashed", alpha = 0.5) +
   geom_hline(yintercept = as.numeric(summary_regional[42, ncol(summary_regional)]), linetype = "dashed", alpha = 0.5) +
   # data
   geom_point(data = slf_suitability_CMIP6, 
               aes(x = global_suitability, y = invaded_regional_suitability), 
               color = "darkorange", size = 1
               ) +
   # aesthetics
   labs(title ="Suitability for SLF establishment at locations with known SLF populations",
         subtitle = "MODELS: global vs invaded_regional; CMIP6 model GFDL, 2041-2070, ssp370",
         caption = "thresholds: dotted = MTP, twodash = 10_percentile, dashed = MTSS"
         ) +
   scatter_style
)

```

```{r save scatterplot}

ggsave(slf_suit_scatter_CMIP6, filename = file.path(here(), "vignette-outputs", "figures", "slf_suitability_CMIP6_models_ch1.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```







## IVRs

### Historical

```{r read in datasets}

# pathing
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models")

# suitability values
# regional
IVR_suit_regional <- read_csv(
  file = file.path(mypath, "slf_invaded_regional_ch1", "invaded_regional_wineries_1981-2010_xy_predicted_suitability_mean.csv")
  ) %>%
  dplyr::rename("regional_suitability" = "cloglog_suitability")
# global
IVR_suit_global <- read_csv(
  file = file.path(mypath, "slf_global_ch1", "global_wineries_1981-2010_predicted_suitability_mean.csv")
  ) %>%
  dplyr::rename("global_suitability" = "cloglog_suitability")

# join datasets for plotting
IVR_suitability <- full_join(IVR_suit_regional, IVR_suit_global, by = c("x", "y"))

```

Now that the values have been extracted, lets plot them.

```{r plot IVR suitability values}

(IVR_suit_scatter <- ggplot() +
    # midpoint line
    geom_vline(xintercept = 0.5) + 
    geom_hline(yintercept = 0.5) +
    # MTP threshold
    geom_vline(xintercept = as.numeric(summary_global[30, ncol(summary_global)]), linetype = "dotted", alpha = 0.5) +
    geom_hline(yintercept = as.numeric(summary_regional[30, ncol(summary_regional)]), linetype = "dotted", alpha = 0.5) +
    # 10 percentile threshold
    geom_vline(xintercept = as.numeric(summary_global[34, ncol(summary_global)]), linetype = "twodash", alpha = 0.5) +
    geom_hline(yintercept = as.numeric(summary_regional[34, ncol(summary_regional)]), linetype = "twodash", alpha = 0.5) +
    # MTSS threshold
    geom_vline(xintercept = as.numeric(summary_global[42, ncol(summary_global)]), linetype = "dashed", alpha = 0.5) +
    geom_hline(yintercept = as.numeric(summary_regional[42, ncol(summary_regional)]), linetype = "dashed", alpha = 0.5) +
    # data
    geom_point(data = IVR_suitability, 
               aes(x = global_suitability, y = regional_suitability), 
               color = "darkviolet", size = 1) +
    labs(title ="Suitability for SLF establishment at locations of important IVR regions",
         subtitle = "global vs regional historical models",
         caption = "thresholds: dotted = MTP, twodash = 10_percentile, dashed = MTSS"
         ) +
    scatter_style
)

```

```{r save scatterplot}

ggsave(IVR_suit_scatter, filename = file.path(here(), "vignette-outputs", "figures", "IVR_suitability_historical_models_ch1.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```

### CMIP6

```{r read in datasets}

# pathing
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models")

# suitability values
# regional
IVR_suit_regional_CMIP6 <- read_csv(
  file = file.path(mypath, "slf_invaded_regional_ch1", "invaded_regional_wineries_2041-2070_GFDL_ssp370_xy_predicted_suitability_mean.csv")
  ) %>%
  dplyr::rename("regional_suitability" = "cloglog_suitability")
# global
IVR_suit_global_CMIP6 <- read_csv(
  file = file.path(mypath, "slf_global_ch1", "global_wineries_2041-2070_GFDL_ssp370_predicted_suitability_mean.csv")
  ) %>%
  dplyr::rename("global_suitability" = "cloglog_suitability")

# join datasets for plotting
IVR_suitability_CMIP6 <- full_join(IVR_suit_regional_CMIP6, IVR_suit_global_CMIP6, by = c("x", "y"))

```

Now that the values have been extracted, lets plot them.

```{r plot IVR suitability values}

(IVR_suit_scatter_CMIP6 <- ggplot() +
    # midpoint line
    geom_vline(xintercept = 0.5) + 
    geom_hline(yintercept = 0.5) +
    # MTP threshold
    geom_vline(xintercept = as.numeric(summary_global[30, ncol(summary_global)]), linetype = "dotted", alpha = 0.5) +
    geom_hline(yintercept = as.numeric(summary_regional[30, ncol(summary_regional)]), linetype = "dotted", alpha = 0.5) +
    # 10 percentile threshold
    geom_vline(xintercept = as.numeric(summary_global[34, ncol(summary_global)]), linetype = "twodash", alpha = 0.5) +
    geom_hline(yintercept = as.numeric(summary_regional[34, ncol(summary_regional)]), linetype = "twodash", alpha = 0.5) +
    # MTSS threshold
    geom_vline(xintercept = as.numeric(summary_global[42, ncol(summary_global)]), linetype = "dashed", alpha = 0.5) +
    geom_hline(yintercept = as.numeric(summary_regional[42, ncol(summary_regional)]), linetype = "dashed", alpha = 0.5) +
    # data
    geom_point(data = IVR_suitability_CMIP6, 
               aes(x = global_suitability, y = regional_suitability), 
               color = "darkviolet", size = 1) +
    labs(title ="Suitability for SLF establishment at locations of important IVR regions",
         subtitle = "MODELS: global vs invaded_regional; CMIP6 model GFDL, 2041-2070, ssp370",
         caption = "thresholds: dotted = MTP, twodash = 10_percentile, dashed = MTSS"
         ) +
    scatter_style
)

```

```{r save scatterplot}

ggsave(IVR_suit_scatter_CMIP6, filename = file.path(here(), "vignette-outputs", "figures", "IVR_suitability_CMIP6_models_ch1.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```


# plot presences over global and regional models

## Plot points over global model

Here, I will plot the IVRs (purple) and known SLF points (orange) over the global model I produced.

```{r load in global and regional rasters}

# global raster
global_hist_mean <- terra::rast(
  x = file.path(mypath, "slf_global_v2", "global_pred_suit_clamped_cloglog_NAmerica_1981-2010_mean.asc")
  )
# convert to df for plotting
global_hist_mean_df <- terra::as.data.frame(x = global_hist_mean, xy = TRUE)



# regional_invaded raster
regional_invaded_hist_mean <- terra::rast(
  x = file.path(mypath, "slf_regional_invaded_v4", "regional_invaded_pred_suit_clamped_cloglog_NAmerica_1981-2010.asc")
  )
# convert to df for plotting
regional_invaded_hist_mean_df <- terra::as.data.frame(x = regional_invaded_hist_mean, xy = TRUE)



# regional_native raster
regional_native_hist_mean <- terra::rast(
  x = file.path(mypath, "slf_regional_native_v1", "regional_native_pred_suit_clamped_cloglog_NAmerica_1981-2010.asc")
  )
# convert to df for plotting
regional_native_hist_mean_df <- terra::as.data.frame(x = regional_native_hist_mean, xy = TRUE)

```


```{r plot SLF suitability values}

# plot with IVR and SLF points
v5_global_IVR_SLF <- ggplot() +
  geom_raster(data = terra::as.data.frame(v5_global1, xy = TRUE), 
              aes(x = x, y = y, fill = v5_global)) +
  geom_point(data = slf_points, 
             aes(x = x, y = y, color = "SLF populations"), size = 0.1, show.legend = TRUE) +
  geom_point(data = IVR_points, 
             aes(x = x, y = y, color = "IVR regions"), size = 0.1, show.legend = TRUE) +
  xlim(-133.593750, -52.294922) +
  ylim(25.085599, 55.304138) +
  scale_fill_distiller(name = "suitability for SLF", palette = "Greys", type = "seq", direction = 1) +
  scale_color_manual(name = "Point Data", values = c("SLF populations" = "darkorange", "IVR regions" = "darkviolet")) +
  guides(color = guide_legend(ncol = 1, byrow = TRUE, override.aes = list(size = 3))) +
  labs(title = "Contemporary SLF suitability in global model with IVR locations") +
  map_style

```

```{r save map}

ggsave(v5_global_IVR_SLF, filename = file.path(here(), "vignette-outputs", "figures", "v5_global_IVR_SLF.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```

## Plot points over regional model

Now, I will plot the IVRs (purple) and known SLF points (orange) over the regional model.

# create binary overlay distribution maps






# Appendix

```{r crop presences to rasters}

# extent object for eastern USA
ext.obj <- terra::ext(-96.503906, -59.589844, 28.304381, 47.457809)

# conert to vector
slf_suitability_cropped <- terra::vect(x = slf_suitability, geom = c("x", "y"), crs = "EPSG:4326") %>%
  # crop by extent area of interest
  terra::crop(., y = ext.obj) %>%
  # convert to geom, which gets coordinates of a spatVector
  terra::geom() 

# convert back to data frame
slf_suitability_cropped <- terra::as.data.frame(slf_suitability_cropped) %>%
  dplyr::select(-c(geom, part, hole))

# join back missing columns
slf_suitability_cropped <- left_join(x = slf_suitability_cropped, y = slf_suitability, by = c("x", "y"))

```


## EDA for SLF and IVR scatter plots

### histograms

The distributions of suitability values for SLF presences is very strange. I 

Why?
* 50,000 background points for global vs 10,000 for regional
* 

```{r histograms of suitability value distributions- SLF}

# global suitability histogram
(global_suit_hist <- ggplot(data = slf_suitability) +
  geom_histogram(aes(x = global_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

# regional suitability histogram
(regional_suit_hist <- ggplot(data = slf_suitability) +
  geom_histogram(aes(x = regional_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

```

```{r histograms of suitability value distributions- IVR}

# global suitability histogram
(ggplot(data = IVR_suitability) +
  geom_histogram(aes(x = global_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

# regional suitability histogram
(ggplot(data = IVR_suitability) +
  geom_histogram(aes(x = regional_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

```

### Scatter plots 

```{r distribution of suitability values by longitude}

# scatter of global suitability vs longitude
(global_suit_longitude <- ggplot(data = slf_suitability) +
   geom_point(aes(x = x, y = global_suitability), size = 1) +
   xlab("longitude") +
   theme_bw()
)

# scatter of regional suitability vs longitude
(regional_suit_longitude <- ggplot(data = slf_suitability) +
    geom_point(aes(x = x, y = regional_suitability), size = 1) +
    xlab("longitude") +
   theme_bw()
)

```

```{r distribution of suitability values by longitude}

# scatter of global suitability vs longitude
(ggplot(data = IVR_suitability) +
   geom_point(aes(x = x, y = global_suitability), size = 1) +
   xlab("longitude") +
   theme_bw()
)

# scatter of regional suitability vs longitude
(ggplot(data = IVR_suitability) +
    geom_point(aes(x = x, y = regional_suitability), size = 1) +
    xlab("longitude") +
   theme_bw()
)

# scatter of global suitability vs longitude
(ggplot(data = IVR_suitability) +
   geom_point(aes(x = global_suitability, y = y), size = 1) +
   ylab("latitude") +
   theme_bw()
)

# scatter of regional suitability vs longitude
(ggplot(data = IVR_suitability) +
   geom_point(aes(x = regional_suitability, y = y), size = 1) +
   ylab("latitude") +
   theme_bw()
)

```

# References

Gallien, L., R. Douzet, S. Pratte, N. E. Zimmermann, and W. Thuiller. 2012. Invasive species distribution models – how violating the equilibrium assumption can create new insights. Global Ecology and Biogeography 21:1126–1136.

