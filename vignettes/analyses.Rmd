---
title: "Extra analyses"
author: "Sam Owens"
date: "2023-08-21"
output: html_document
---



This vignette contains extra analyses and figures to explore ideas that don't necessarily fit with the main flow of the `slfSpread` project (or have yet to find a spot). 

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)

library(here) 
# here() is set at the root folder of this package

library(terra)
library(predicts) # MESS

```

```{r map style object}

map_style <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom"),
  viridis::scale_fill_viridis(option = "magma"),
  coord_equal()
)

```


# MESS

```{r env layer names}

# layer name object. Check order of layers first
env_layer_names <- c("bio11", "bio12", "bio15", "bio2")

```


```{r hist data import}

# set wd
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent")

# list of covariates
x_global_hist_env_covariates_list <- list.files(path = file.path(mypath, "historical_climate_rasters", "chelsa2.1_30arcsec", "v1_maxent_10km"), pattern = "\\.asc$", full.names = TRUE) %>%
    grep("bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE)


# stack env covariates
x_global_hist_env_covariates <- terra::rast(x = x_global_hist_env_covariates_list)

# attributes
nlyr(x_global_hist_env_covariates)
names(x_global_hist_env_covariates)
minmax(x_global_hist_env_covariates)
# ext(x_global_hist_env_covariates)
# crs(x_global_hist_env_covariates)


# change names
names(x_global_hist_env_covariates) <- env_layer_names


# remove unnecessary object
rm(x_global_hist_env_covariates_list)

```

```{r CMIP6 data import}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/future_climate_rasters/chelsa2.1_30arcsec/2041-2070_ssp370_GFDL")

# the env covariates for performing xy predictions for global slf and IVR points
x_global_CMIP6_env_covariates_list <- list.files(path = file.path(mypath, "v1_maxent_10km"), pattern = "\\_global.asc$", full.names = TRUE) %>%
  # dont include Access to cities
  grep(pattern = "atc_2015", value = TRUE, invert = TRUE)



# stack env covariates
x_global_CMIP6_env_covariates <- terra::rast(x = x_global_CMIP6_env_covariates_list)

# attributes
nlyr(x_global_CMIP6_env_covariates)
names(x_global_CMIP6_env_covariates)
minmax(x_global_CMIP6_env_covariates)
# ext(x_global_CMIP6_env_covariates)
# crs(x_global_CMIP6_env_covariates)

names(x_global_CMIP6_env_covariates) <- env_layer_names

# rm unnecessary object
rm(x_global_CMIP6_env_covariates_list)

```

## Native Range

```{r set wd}

# path to directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent")

```

```{r native background points}

# import SLF point raster data
regional_native_background <- read_csv(
  file.path(here(), "vignette-outputs", "data-tables", "regional_native_background_points_with_data.csv")
  ) 
# historical version
regional_native_background_hist <- regional_native_background %>%
  dplyr::select(-c(Species, X, Y)) %>%
  as.data.frame()





# CMIP6 version- extract new raster values
regional_native_background_CMIP6 <- regional_native_background %>%
  dplyr::select(c(X, Y)) %>%
  as.data.frame() %>%
  terra::extract(
    x = x_global_CMIP6_env_covariates,
    y = .,
    method = "bilinear"
  ) %>%
  dplyr::select(-ID)

```

### native model historical MESS

```{r historical MESS}

regional_native_hist_mess <- predicts::mess(
  x = x_global_hist_env_covariates, 
  v = regional_native_background_hist,
  full = FALSE,
  filename = file.path(mypath, "models", "working_dir", "regional_native_MESS_1981-2010.tif"),
  filetype = "GTiff",
  overwrite = FALSE
)

```

```{r create global figure}

regional_native_hist_mess_df <- terra::as.data.frame(regional_native_hist_mess, xy = TRUE)

# plot mean raster first
regional_native_hist_mess_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_hist_mess_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(title = "MESS analysis: bio2, bio11, bio12 and bio15",
       subtitle = "1981-2010 | 'regional_native' model background points with data",
       fill = "MESS score"
       ) +
  map_style 

# save plot
ggsave(regional_native_hist_mess_plot, 
       filename = file.path(here(), "vignette-outputs", "figures", "regional_native_MESS_1981-2010_globe.jpg"),
       device = "jpeg",
       dpi = "retina")

```

```{r create regional figure}

# extent object for N America (retrieved 11-30-2023)
ext.obj <- terra::ext(-140.976563, -51.064453, 15.182421, 60.586967)
# crop raster
regional_native_hist_mess_cropped <- terra::crop(regional_native_hist_mess, ext.obj)
# convert to df
regional_native_hist_mess_cropped_df <- terra::as.data.frame(regional_native_hist_mess_cropped, xy = TRUE)

# plot mean raster first
regional_native_hist_mess_cropped_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_hist_mess_cropped_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(title = "MESS analysis: bio2, bio11, bio12 and bio15",
       subtitle = "1981-2010 | 'regional_native' model background points with data",
       fill = "MESS score"
       ) +
  map_style 

# save plot
ggsave(regional_native_hist_mess_cropped_plot, 
       filename = file.path(here(), "vignette-outputs", "figures", "regional_native_MESS_1981-2010_NAmerica.jpg"),
       device = "jpeg",
       dpi = "retina")

```

### native model CMIP6 MESS

```{r CMIP6 MESS}

regional_native_CMIP6_mess <- predicts::mess(
  x = x_global_CMIP6_env_covariates, 
  v = regional_native_background_CMIP6,
  full = FALSE,
  filename = file.path(mypath, "models", "working_dir", "regional_native_MESS_2041-2070_ssp370_GFDL.tif"),
  filetype = "GTiff",
  overwrite = FALSE
)

```

```{r create global figure}

regional_native_CMIP6_mess_df <- terra::as.data.frame(regional_native_CMIP6_mess, xy = TRUE)

# plot mean raster first
regional_native_CMIP6_mess_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_CMIP6_mess_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(title = "MESS analysis: bio2, bio11, bio12 and bio15",
       subtitle = "2041-2070 | ssp370 GFDL | 'regional_native' model background points with data",
       fill = "MESS score"
       ) +
  map_style 

# save plot
ggsave(regional_native_CMIP6_mess_plot, 
       filename = file.path(here(), "vignette-outputs", "figures", "regional_native_MESS_2041-2070_ssp370_GFDL_globe.jpg"),
       device = "jpeg",
       dpi = "retina")

```

```{r create regional figure}

# extent object for N America (retrieved 11-30-2023)
ext.obj <- terra::ext(-140.976563, -51.064453, 15.182421, 60.586967)
# crop raster
regional_native_CMIP6_mess_cropped <- terra::crop(regional_native_CMIP6_mess, ext.obj)
# convert to df
regional_native_CMIP6_mess_cropped_df <- terra::as.data.frame(regional_native_CMIP6_mess_cropped, xy = TRUE)

# plot mean raster first
regional_native_CMIP6_mess_cropped_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = regional_native_CMIP6_mess_cropped_df, 
              aes(x = x, y = y, fill = mess)) +
  labs(title = "MESS analysis: bio2, bio11, bio12 and bio15",
       subtitle = "2041-2070 | ssp370 GFDL | 'regional_native' model background points with data",
       fill = "MESS score"
       ) +
  map_style 

# save plot
ggsave(regional_native_CMIP6_mess_cropped_plot, 
       filename = file.path(here(), "vignette-outputs", "figures", "regional_native_MESS_2041-2070_ssp370_GFDL_NAmerica.jpg"),
       device = "jpeg",
       dpi = "retina")

```
## Invaded Range

```{r set wd}

# path to directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent")

```

```{r native background points}

# import SLF point raster data
regional_native_background <- read_csv(
  file.path(here(), "vignette-outputs", "data-tables", "regional_invaded_background_points_with_data.csv")
  ) %>%
  dplyr::select(-c(Species, X, Y)) %>%
  as.data.frame()

head(regional_native_background)

```

```{r historical MESS}

regional_native_hist_mess <- predicts::mess(
  x = x_global_hist_env_covariates, 
  v = regional_native_background,
  full = FALSE,
  filename = file.path(mypath, "models", "working_dir", "regional_native_hist_MESS.tif"),
  filetype = "GTiff",
  overwrite = FALSE
)

```

```{r CMIP6 MESS}

regional_native_CMIP6_mess <- predicts::mess(
  x = x_global_CMIP6_env_covariates, 
  v = regional_native_background,
  full = FALSE,
  filename = file.path(mypath, "models", "working_dir", "regional_native_hist_MESS.tif"),
  filetype = "GTiff",
  overwrite = FALSE
)

```

# other ideas



## Invasion stage preliminary predictions

I will create a map where I vaguely outline areas that I think are suitable for SLF. I will also create a map with circles around areas where SLF populations might be at certain invasion stages (ex. sink populations vs established populations).

```{r}

```

