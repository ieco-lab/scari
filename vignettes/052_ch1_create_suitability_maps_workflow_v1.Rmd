---
title: "Suitability Maps Output- Workflow (chapter 1)"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2023-10-20"
output: html_document
---

# Overview

This vignette will outline the workflow used to create the mean and thresholded suitability maps. These maps are created for the easternUSA models and main models. 

Lastly, I will use the `SDMtune::predict()` function to predict the suitability for the range of interest. The output will be a raster of suitability that can be used in our background size comparison. I will also threshold the map by the MTSS threshold. The workflow for this function can be found in vignette `053_create_suitability_maps_workflow.Rmd` and is wrapped into the function `slfSpread::create_MaxEnt_suitability_maps()`.

I will take the above map and reclassify it so that areas that aren't suitable are more obvious. I will use the maximum training sensitivity plus specificity threshold, as this threshold is one of the most rigorous available (ADD MORE). First, I will retrieve the specific value for the MTSS threshold for this model and use it to define a what is considered unsuitable in this raster. Then, I will reclassify the mean raster so that anything below this threshold is now "unsuitable". I will use the mean cloglog threshold for all iterations. I will create a binary version of the mean raster, with unsuitable regions, which are below the MTSS training threshold, as 0, and those above the threshold as 1. Then, I can reclassify averaged raster of maxent predictions. I will load in the averaged prediction for this model and reclassify the raster using a temporary raster layer that I will create. This raster will only have values where the model predicts the climate to be unsuitable, so that it can be plotted overtop the averaged raster to mask unsuitable areas

(SPREAD OUT)

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation

library(here) #making directory pathways easier on different instances
here()
# here() starts at the root folder of this package.
library(devtools)

# modeling
library(SDMtune) # main package used to run SDMs
# spatial data handling
library(terra) 

library(viridis)

```

```{r ggplot object for map style}

map_style <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "lightblue",
                                colour = "lightblue")
        ),
  labs(fill = "Suitability for SLF"),
  coord_equal() 
)

```

# Create mean distribution map 

```{r predict function to create raster}

# output directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_buffered_step1")

# write .asc file of avg predictions
SDMtune::predict(
  object = easternUSA_buffered_model, 
  data = x_env_covariates, # the covariate layers used to train the model
  fun = "mean", 
  type = "cloglog", 
  clamp = FALSE, 
  progress = TRUE, 
  filename = file.path(mypath, "easternUSA_buffered_predicted_suitability.asc"), 
    # the function automatically adds the function name on the end
  filetype = "AAIGrid"
) 

```

```{r convert to df and plot}

# load in mean predictions
easternUSA_buffered_suit <- terra::rast(x = file.path(mypath, "easternUSA_buffered_predicted_suitability_mean.asc")) %>%
  terra::as.data.frame(., xy = TRUE) 
  
# plot
easternUSA_buffered_suit_plot <- ggplot() +
  geom_raster(data = easternUSA_buffered_suit, 
              aes(x = x, y = y, fill = mean)) +
  labs(title = "Mean suitability for SLF",
       subtitle = "Model: easternUSA_buffered") +
  viridis::scale_fill_viridis(option = "D") +
  map_style

# save plot output
ggsave(easternUSA_buffered_suit_plot, 
           filename = file.path(mypath, "plots", "easternUSA_buffered_predicted_suitability_mean.jpg"),
           height = 8, 
           width = 10,
           device = "jpeg",
           dpi = "retina")

```

# Create thresholded suitability map



```{r discern MTSS threshold}

# output directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_buffered_step1")

MTSS_value <- read.csv(file = file.path(mypath, "easternUSA_buffered_summary_all_iterations.csv")) %>%
  .[42, 6]

```

## Create binary raster with MTSS threshold

This is for later use.

```{r terra required classification matrices}

# create regional suitability value matrix for terra
buffered_rescale_class <- data.frame(
  from = c(0, MTSS_value),
  to = c(MTSS_value, 1),
  becomes = c(0, 1)
)

```

```{r reclassify maxent outputs}

# path to directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_easternUSA_buffered_step1")

# load in raster
buffered_mean_raster <- terra::rast(x = file.path(mypath, "easternUSA_buffered_predicted_suitability_mean.asc"))

if(FALSE) {
  
  terra::classify(x = buffered_mean_raster, 
                  rcl = buffered_rescale_class,
                  right = FALSE, # close left side of value
                  filename = file.path(mypath, "easternUSA_buffered_predicted_suitability_mean_thresholded.asc"), # also write to file
                  overwrite = FALSE
                  ) 
  
}
  
```

## Create mask raster for thresholded raster figure

This raster will only be used as an overlay layer in the thresholded suitability map plot. It is a binary raster of the the entire land mass (the easternUSA), with unsuitable areas as a 1 and everything else as an NA. This plot can be put on top of the mean suitability layer and set to a color to "grey out" unsuitable areas on land. 

```{r reclassify maxent outputs}

# create regional suitability value matrix for terra
buffered_rescale_class <- data.frame(
  from = 0,
  to = MTSS_value,
  becomes = 1
)

if(TRUE) {
  
  # reclassify and write regional raster
  buffered_mask_layer <- terra::classify(x = buffered_mean_raster, 
                                             rcl = buffered_rescale_class,
                                             right = FALSE, # close left side of value
                                             others = NA,
                                             filename = file.path(mypath, "easternUSA_buffered_MTSS_mask_layer.asc"), # also write to file
                                             overwrite = FALSE) 
  
}
  
```

## Create thresholded suitability map

```{r overlay plots}
  
# load in mean predictions
buffered_mask_layer_df <- terra::rast(x = file.path(mypath, "easternUSA_buffered_MTSS_mask_layer.asc")) %>%
  terra::as.data.frame(., xy = TRUE)

buffered_mean_raster_df <- terra::as.data.frame(buffered_mean_raster, xy = TRUE)

# plot mean raster first
easternUSA_buffered_threshold_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = buffered_mean_raster_df, 
              aes(x = x, y = y, fill = mean)) +
    # plot binary threshold on top
  geom_raster(data = buffered_mask_layer_df, 
              aes(x = x, y = y), fill = "azure4") +
  labs(title = "Suitability for SLF, MTSS training threshold",
       subtitle = "Model: 355km buffer") +
  viridis::scale_fill_viridis(option = "D") +
  map_style 

# save plot output
ggsave(easternUSA_buffered_threshold_plot, 
           filename = file.path(mypath, "plots", "easternUSA_buffered_predicted_suitability_mean_thresholded.jpg"),
           height = 8, 
           width = 10,
           device = "jpeg",
           dpi = "retina")

```
