---
title: "Run an Extrapolation Detection (NT2) analysis and calculate MIC"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-04-09"
output: html_document
---

In this vignette, I will run an ExDet analysis for each regional-scale model and calculate the most important covariate based on each model. The ExDet will be used for two main purposes:

1. This metric will allow us to quantify the level of extrapolation that is happening with our models as they are being projected to new locations and time periods. An ExDet value below 0 or above 1 indicates extrapolation. Below 0 indicates a type 1 extrapolation within a single covariates, while a value above 1 indicates a type 2 extrapolation between multiple covariates.

2. We will weight each regional model using the ExDet measurement in preparation for an ensemble model. This way, our predictions are weighted by our level of confidence and the level of climate analogy.

I will specifically use the background points that were used to train each model to perform the ExDet analysis. By doing this, I am effectively testing whether the covariates in other locations are significantly different from our model. This analysis will be performed for both the historical and climate change versions of the rasters. 

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)

library(here) 
# here() is set at the root folder of this package

# spatial data handling
library(terra)
library(raster)
# remotes::install_github("densitymodelling/dsmextra")
library(dsmextra) # ExDet and MIC

library(viridis)

```

```{r map style exdet}

map_style_exdet <- list(
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "azure3",
                                        colour = "azure3")
  ),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  labs(
    x = "longitude",
    y = "latitude"
  ),
  coord_equal()
)

# color scheme taken from: https://colorbrewer2.org/?type=diverging&scheme=RdBu&n=11

```

```{r map style MIC}

map_style_MIC <- list(
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "azure3",
                                        colour = "azure3")
  ),
  viridis::scale_fill_viridis(option = "rainbow", discrete = TRUE, labels = c("analogous", "bio11", "bio12", "bio15", "bio2")),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  labs(
    x = "longitude",
    y = "latitude"
  ),
  coord_equal()
)

# color scheme taken from: https://colorbrewer2.org/?type=diverging&scheme=RdBu&n=11

```

## Import datasets

First, I will import and tidy the global bioclim layers for 1981-2010 and 2041-2070.

```{r load in historical covariates}

# path to directory
mypath <- file.path(here::here() %>% 
                       dirname(),
                     "maxent/historical_climate_rasters/chelsa2.1_30arcsec")

# the env covariates used to train the model global
x_global_hist_env_covariates_list <- list.files(path = file.path(mypath, "v1_maxent_10km"), pattern = "\\.asc$", full.names = TRUE) %>%
    grep("bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE)

```

```{r load in CMIP6 covariates}

# path to directory
  mypath <- file.path(here::here() %>% 
                       dirname(),
                     "maxent/future_climate_rasters/chelsa2.1_30arcsec/2041-2070_ssp370_GFDL")

# the env covariates for performing xy predictions for global slf and IVR points
x_global_CMIP6_env_covariates_list <- list.files(path = file.path(mypath, "v1_maxent_10km"), pattern = "\\_global.asc$", full.names = TRUE) %>%
  # dont include Access to cities
  grep(pattern = "atc_2015", value = TRUE, invert = TRUE)

```

I will rename the variables and import the rasters.

```{r naming object}

# layer name object. Check order of layers first
env_layer_names <- c("bio11", "bio12", "bio15", "bio2")

```

```{r stack historical covariates and make naming consistent}

# stack env covariates
x_global_hist_env_covariates <- terra::rast(x = x_global_hist_env_covariates_list)

# attributes
nlyr(x_global_hist_env_covariates)
names(x_global_hist_env_covariates)
minmax(x_global_hist_env_covariates)
# ext(x_global_hist_env_covariates)
# crs(x_global_hist_env_covariates)


# I will change the name of the variables because they are throwing errors in SDMtune
names(x_global_hist_env_covariates) <- env_layer_names
# confirmed- SDMtune doesnt like dashes in column names (it is read as a mathematical operation)

```

```{r stack CMIP6 covariates and make naming consistent}

# stack env covariates
x_global_CMIP6_env_covariates <- terra::rast(x = x_global_CMIP6_env_covariates_list)

# attributes
nlyr(x_global_CMIP6_env_covariates)
names(x_global_CMIP6_env_covariates)
minmax(x_global_CMIP6_env_covariates)
# ext(x_global_CMIP6_env_covariates)
# crs(x_global_CMIP6_env_covariates)

names(x_global_CMIP6_env_covariates) <- env_layer_names
  
```

```{r remove unneeded objects}

rm(x_global_hist_env_covariates_list)
rm(x_global_CMIP6_env_covariates_list)

```

I also need the background point sets that were used to train each regional model. These copies need to include the values of each raster at those particular locations.

```{r background point sets}

# regional_native
regional_native_background <- read_csv(
  file.path(here::here(), "vignette-outputs", "data-tables", "regional_native_background_points_with_data_v2.csv")
  ) %>%
  as.data.frame()


# regional_invaded
regional_invaded_background <- read_csv(
  file.path(here::here(), "vignette-outputs", "data-tables", "regional_invaded_background_points_with_data_v6.csv")
  ) %>%
  as.data.frame()


# regional_invaded_asian
regional_invaded_asian_background <- read_csv(
  file.path(here::here(), "vignette-outputs", "data-tables", "regional_invaded_asian_background_points_with_data_v1.csv")
  ) %>%
  as.data.frame()

```

## Extract variables for climate data

I will also load the background points dataset used to train the model and that will be used to train the ExDet analysis. I have extracted the climate dataset from 1981-2010 for these points, but not for our projected time period. I will extract these values as well. 

```{r extract CMIP6 values for background points}

# regional_native model

# extract values from 2060 projected raster
regional_native_background_CMIP6 <- regional_native_background %>%
  dplyr::select("X", "Y") %>%
  # extract new values
  terra::extract(x_global_CMIP6_env_covariates, y = ., method = "simple", ID = FALSE)




# regional_invaded model

regional_invaded_background_CMIP6 <- regional_invaded_background %>%
  dplyr::select("X", "Y") %>%
  # extract new values
  terra::extract(x_global_CMIP6_env_covariates, y = ., method = "simple", ID = FALSE)





# regional_invaded_asian model

regional_invaded_asian_background_CMIP6 <- regional_invaded_asian_background %>%
  dplyr::select("X", "Y") %>%
  # extract new values
  terra::extract(x_global_CMIP6_env_covariates, y = ., method = "simple", ID = FALSE)


```

I will be projecting the ExDet and MIC analyses for the globe, so I will extract both the current and CMIP6 raster values now.

```{r convert projection rasters to df}

global_projection_hist_df <- terra::as.data.frame(x_global_hist_env_covariates, xy = TRUE)

global_projection_CMIP6_df <- terra::as.data.frame(x_global_CMIP6_env_covariates, xy = TRUE)

```

```{r select only data columns}

# native
regional_native_background <- dplyr::select(regional_native_background, 4:7)
# invaded
regional_invaded_background <- dplyr::select(regional_invaded_background, 4:7)
# regional_invaded_asian
regional_invaded_asian_background <- dplyr::select(regional_invaded_asian_background, 4:7)

```


# Run ExDet / MIC Function

First, I will run the function that calculates the ExDet and MIC indices. I will use the background points datasets to train each analysis and will project to the entire global raster. This will be done for each of the historical and climate change time periods. This function outputs rasters and data frames that can be used for plotting.

```{r set wd}

# output directory
mypath <- file.path(here::here() %>% 
                       dirname(),
                     "maxent")

```

## Historical Climate

```{r regional_native model}

exdet_MIC_regional_native_hist <- dsmextra::compute_extrapolation(
  samples = regional_native_background, # training set of background points
  covariate.names = env_layer_names, # names of covariates
  prediction.grid = global_projection_hist_df, # projection area for extrapolation test
  coordinate.system = "EPSG:4326", # CRS
  verbose = TRUE
)

```

```{r regional_invaded model}

exdet_MIC_regional_invaded_hist <- dsmextra::compute_extrapolation(
  samples = regional_invaded_background, # training set of background points
  covariate.names = env_layer_names, # names of covariates
  prediction.grid = global_projection_hist_df, # projection area for extrapolation test
  coordinate.system = "EPSG:4326", # CRS
  verbose = TRUE
)

```

```{r regional_invaded_asian model}

exdet_MIC_regional_invaded_asian_hist <- dsmextra::compute_extrapolation(
  samples = regional_invaded_asian_background, # training set of background points
  covariate.names = env_layer_names, # names of covariates
  prediction.grid = global_projection_hist_df, # projection area for extrapolation test
  coordinate.system = "EPSG:4326", # CRS
  verbose = TRUE
)

```

## CMIP6 2041-2070 projected climate

```{r regional_native model}

exdet_MIC_regional_native_CMIP6 <- dsmextra::compute_extrapolation(
  samples = regional_native_background_CMIP6, # training set of background points
  covariate.names = env_layer_names, # names of covariates
  prediction.grid = global_projection_CMIP6_df, # projection area for extrapolation test
  coordinate.system = "EPSG:4326", # CRS
  verbose = TRUE
)

```

```{r regional_invaded model}

exdet_MIC_regional_invaded_CMIP6 <- dsmextra::compute_extrapolation(
  samples = regional_invaded_background_CMIP6, # training set of background points
  covariate.names = env_layer_names, # names of covariates
  prediction.grid = global_projection_CMIP6_df, # projection area for extrapolation test
  coordinate.system = "EPSG:4326", # CRS
  verbose = TRUE
)

```

```{r regional_invaded_asian model}

exdet_MIC_regional_invaded_asian_CMIP6 <- dsmextra::compute_extrapolation(
  samples = regional_invaded_asian_background_CMIP6, # training set of background points
  covariate.names = env_layer_names, # names of covariates
  prediction.grid = global_projection_CMIP6_df, # projection area for extrapolation test
  coordinate.system = "EPSG:4326", # CRS
  verbose = TRUE
)

```

# Save and plot ExDet and MIC rasters

The final step will be to pull the rasters from the above functions and will save them to my working directory. Then, I will create plots of each raster and save those as well.

## regional_native hist

First, I will save the summary files from the analysis to each model folder.

### Save outputs

```{r save summary files}

# summary of data
write_csv(
  x = exdet_MIC_regional_native_hist[["data"]][["all"]],
  file = file.path(mypath, "models", "slf_regional_native_v2", "exdet_mic_analysis_results.csv")
  )

# exdet
write_csv(
  x = as.data.frame(exdet_MIC_regional_native_hist[["summary"]][["extrapolation"]]),
  file = file.path(mypath, "models", "slf_regional_native_v2", "exdet_analysis_summary.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_native_hist[["summary"]][["mic"]][[1]]),
  file = file.path(mypath, "models", "slf_regional_native_v2", "mic_analysis_univariate_summary.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_native_hist[["summary"]][["mic"]][[2]]),
  file = file.path(mypath, "models", "slf_regional_native_v2", "mic_analysis_combinatorial_summary.csv")
  )

```

Next, I will save the output rasters. 

```{r save rasters}

# exdet
raster::writeRaster(
  x = exdet_MIC_regional_native_hist[["rasters"]][["ExDet"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_native_v2_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

raster::writeRaster(
  x = exdet_MIC_regional_native_hist[["rasters"]][["mic"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "MIC_slf_regional_native_v2_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

# also isolate exdet raster
exdet_regional_native_hist <- exdet_MIC_regional_native_hist[["rasters"]][["ExDet"]][["all"]]

```

### Plot ExDet

Finally, I will create plots of each of the ExDet and MIC analyses.

```{r create exdet plot}

# plot mean raster first
exdet_regional_native_hist_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_native_hist[["data"]][["all"]], aes(x = x, y = y, fill = ExDet)) +
  labs(
    title = "ExDet analysis: bio2, bio11, bio12 and bio15",
    subtitle = "Global climate divergence from 'regional_native' model training set",
    fill = "ExDet Analysis"
    ) +
  # default plot style
  map_style_exdet +
  # fill scale
  scale_fill_gradientn(
  name = "ExDet Score",
  colors = c("#67001f", "#f4a582", "white", "white", "white", "#92c5de", "#053061"),
  values = scales::rescale(x = c(min(values(exdet_regional_native_hist), na.rm = TRUE), 0, 1, max(values(exdet_regional_native_hist), na.rm = TRUE))),
  breaks = c(
    round(min(values(exdet_regional_native_hist), na.rm = TRUE), 5), 
    round(0, 1), round(1, 1), 
    round(max(values(exdet_regional_native_hist), na.rm = TRUE), 5)
    ),
  guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20)
  )

```

```{r save plot}

# save plot
ggsave(
  exdet_regional_native_hist_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "ExDet_slf_regional_native_v2_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

### Plot MIC

```{r create MIC plot}

# plot mean raster first
mic_regional_native_hist_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_native_hist[["data"]][["all"]], aes(x = x, y = y, fill = as.factor(mic))) +
  labs(
    title = "Most Influential Covariate (MIC) for 'regional_native' model",
    subtitle = "Covariate causing most extrapolation from model training set",
    fill = "MIC"
    ) +
  # default plot style
  map_style_MIC 

```

```{r save plot}

# save plot
ggsave(
  mic_regional_native_hist_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_native_v2_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

I will repeat this workflow for each of the models and their CMIP6 version climate data, so I will not annotate much of the rest of this vignette.

## regional_native CMIP6

### Save outputs

```{r save summary files}

# summary of data
write_csv(
  x = exdet_MIC_regional_native_CMIP6[["data"]][["all"]],
  file = file.path(mypath, "models", "slf_regional_native_v2", "exdet_mic_analysis_results_2041-2070_ssp370_GFDL.csv")
  )

# exdet
write_csv(
  x = as.data.frame(exdet_MIC_regional_native_CMIP6[["summary"]][["extrapolation"]]),
  file = file.path(mypath, "models", "slf_regional_native_v2", "exdet_analysis_summary_2041-2070_ssp370_GFDL.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_native_CMIP6[["summary"]][["mic"]][[1]]),
  file = file.path(mypath, "models", "slf_regional_native_v2", "mic_analysis_univariate_summary_2041-2070_ssp370_GFDL.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_native_CMIP6[["summary"]][["mic"]][[2]]),
  file = file.path(mypath, "models", "slf_regional_native_v2", "mic_analysis_combinatorial_summary_2041-2070_ssp370_GFDL.csv")
  )

```

```{r save rasters}

# exdet
raster::writeRaster(
  x = exdet_MIC_regional_native_CMIP6[["rasters"]][["ExDet"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_native_v2_background_projGlobe_2041-2070_ssp370_GFDL.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

raster::writeRaster(
  x = exdet_MIC_regional_native_CMIP6[["rasters"]][["mic"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "MIC_slf_regional_native_v2_background_projGlobe_2041-2070_ssp370_GFDL.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

# also isolate exdet raster
exdet_regional_native_CMIP6 <- exdet_MIC_regional_native_CMIP6[["rasters"]][["ExDet"]][["all"]]

```

### Plot ExDet

```{r create exdet plot}

# plot mean raster first
exdet_regional_native_CMIP6_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_native_CMIP6[["data"]][["all"]], aes(x = x, y = y, fill = ExDet)) +
  labs(
    title = "ExDet analysis | bio2, bio11, bio12, bio15 | 2041-2070, ssp370, GFDL",
    subtitle = "Global climate divergence from 'regional_native' model training set",
    fill = "ExDet Analysis"
    ) +
  # default plot style
  map_style_exdet +
  # fill scale
  scale_fill_gradientn(
  name = "ExDet Score",
  colors = c("#67001f", "#f4a582", "white", "white", "white", "#92c5de", "#053061"),
  values = scales::rescale(x = c(min(values(exdet_regional_native_CMIP6), na.rm = TRUE), 0, 1, max(values(exdet_regional_native_CMIP6), na.rm = TRUE))),
  breaks = c(
    round(min(values(exdet_regional_native_CMIP6), na.rm = TRUE), 6), 
    round(0, 1), round(1, 1), 
    round(max(values(exdet_regional_native_CMIP6), na.rm = TRUE), 6)
    ),
  guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20)
  )

```

```{r save plot}

# save plot
ggsave(
  exdet_regional_native_CMIP6_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "ExDet_slf_regional_native_v2_background_projGlobe_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

### Plot MIC

```{r create MIC plot}

# plot mean raster first
mic_regional_native_CMIP6_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_native_CMIP6[["data"]][["all"]], aes(x = x, y = y, fill = as.factor(mic))) +
  labs(
    title = "Most Influential Covariate (MIC) for 'regional_native' model",
    subtitle = "Covariate causing most extrapolation from model training set, projected for 2041-2070, ssp370, GFDL",
    fill = "MIC"
    ) +
  # default plot style
  map_style_MIC 

```

```{r save plot}

# save plot
ggsave(
  mic_regional_native_CMIP6_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_native_v2_background_projGlobe_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

## regional_invaded hist

### Save outputs

```{r save summary files}

# summary of data
write_csv(
  x = exdet_MIC_regional_invaded_hist[["data"]][["all"]],
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_exdet_mic_analysis_results.csv")
  )

# exdet
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_hist[["summary"]][["extrapolation"]]),
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_exdet_analysis_summary.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_hist[["summary"]][["mic"]][[1]]),
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_mic_analysis_univariate_summary.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_hist[["summary"]][["mic"]][[2]]),
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_mic_analysis_combinatorial_summary.csv")
  )

```

```{r save rasters}

# exdet
raster::writeRaster(
  x = exdet_MIC_regional_invaded_hist[["rasters"]][["ExDet"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_v6_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

raster::writeRaster(
  x = exdet_MIC_regional_invaded_hist[["rasters"]][["mic"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "MIC_slf_regional_invaded_v6_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

# also isolate exdet raster
exdet_regional_invaded_hist <- exdet_MIC_regional_invaded_hist[["rasters"]][["ExDet"]][["all"]]

```

### Plot ExDet

```{r create exdet plot}

# plot mean raster first
exdet_regional_invaded_hist_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_hist[["data"]][["all"]], aes(x = x, y = y, fill = ExDet)) +
  labs(
    title = "ExDet analysis: bio2, bio11, bio12 and bio15",
    subtitle = "Global climate divergence from 'regional_invaded' model training set",
    fill = "ExDet Analysis"
    ) +
  # default plot style
  map_style_exdet +
  # fill scale
  scale_fill_gradientn(
  name = "ExDet Score",
  colors = c("#67001f", "#f4a582", "white", "white", "white", "#92c5de", "#053061"),
  values = scales::rescale(x = c(min(values(exdet_regional_invaded_hist), na.rm = TRUE), 0, 1, max(values(exdet_regional_invaded_hist), na.rm = TRUE))),
  breaks = c(
    round(min(values(exdet_regional_invaded_hist), na.rm = TRUE), 5), 
    round(0, 1), round(1, 1), 
    round(max(values(exdet_regional_invaded_hist), na.rm = TRUE), 5)
    ),
  guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20)
  ) + 
  theme(legend.text = element_text(angle = 25))

```

```{r save plot}

# save plot
ggsave(
  exdet_regional_invaded_hist_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "ExDet_slf_regional_invaded_v6_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

### Plot MIC

```{r create MIC plot}

# plot mean raster first
mic_regional_invaded_hist_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_hist[["data"]][["all"]], aes(x = x, y = y, fill = as.factor(mic))) +
  labs(
    title = "Most Influential Covariate (MIC) for 'regional_invaded' model",
    subtitle = "Covariate causing most extrapolation from model training set",
    fill = "MIC"
    ) +
  # default plot style
  map_style_MIC 

```

```{r save plot}

# save plot
ggsave(
  mic_regional_invaded_hist_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_invaded_v6_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

## regional_invaded CMIP6

### Save outputs

```{r save summary files}

# summary of data
write_csv(
  x = exdet_MIC_regional_invaded_CMIP6[["data"]][["all"]],
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_exdet_mic_analysis_results_2041-2070_ssp370_GFDL.csv")
  )

# exdet
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_CMIP6[["summary"]][["extrapolation"]]),
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_exdet_analysis_summary_2041-2070_ssp370_GFDL.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_CMIP6[["summary"]][["mic"]][[1]]),
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_mic_analysis_univariate_summary_2041-2070_ssp370_GFDL.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_CMIP6[["summary"]][["mic"]][[2]]),
  file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_mic_analysis_combinatorial_summary_2041-2070_ssp370_GFDL.csv")
  )

```

```{r save rasters}

# exdet
raster::writeRaster(
  x = exdet_MIC_regional_invaded_CMIP6[["rasters"]][["ExDet"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_v6_background_projGlobe_2041-2070_ssp370_GFDL.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

raster::writeRaster(
  x = exdet_MIC_regional_invaded_CMIP6[["rasters"]][["mic"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "MIC_slf_regional_invaded_v6_background_projGlobe_2041-2070_ssp370_GFDL.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

# also isolate exdet raster
exdet_regional_invaded_CMIP6 <- exdet_MIC_regional_invaded_CMIP6[["rasters"]][["ExDet"]][["all"]]

```

### Plot ExDet

```{r create exdet plot}

# plot mean raster first
exdet_MIC_regional_invaded_CMIP6_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_CMIP6[["data"]][["all"]], aes(x = x, y = y, fill = ExDet)) +
  labs(
    title = "ExDet analysis | bio2, bio11, bio12, bio15 | 2041-2070, ssp370, GFDL",
    subtitle = "Global climate divergence from 'regional_invaded' model training set",
    fill = "ExDet Analysis"
    ) +
  # default plot style
  map_style_exdet +
  # fill scale
  scale_fill_gradientn(
  name = "ExDet Score",
  colors = c("#67001f", "#f4a582", "white", "white", "white", "#92c5de", "#053061"),
  values = scales::rescale(x = c(min(values(exdet_regional_invaded_CMIP6), na.rm = TRUE), 0, 1, max(values(exdet_regional_invaded_CMIP6), na.rm = TRUE))),
  breaks = c(
    round(min(values(exdet_regional_invaded_CMIP6), na.rm = TRUE), 5), 
    round(0, 1), round(1, 1), 
    round(max(values(exdet_regional_invaded_CMIP6), na.rm = TRUE), 5)
    ),
  guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20)
  ) + 
  theme(legend.text = element_text(angle = 25))

```

```{r save plot}

# save plot
ggsave(
  exdet_MIC_regional_invaded_CMIP6_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "ExDet_slf_regional_invaded_v6_background_projGlobe_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

### Plot MIC

```{r create MIC plot}

# plot mean raster first
mic_regional_invaded_CMIP6_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_CMIP6[["data"]][["all"]], aes(x = x, y = y, fill = as.factor(mic))) +
  labs(
    title = "Most Influential Covariate (MIC) for 'regional_invaded' model",
    subtitle = "Covariate causing most extrapolation from model training set, projected for 2041-2070, ssp370, GFDL",
    fill = "MIC"
    ) +
  # default plot style
  map_style_MIC 

```

```{r save plot}

# save plot
ggsave(
  mic_regional_invaded_CMIP6_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_invaded_v6_background_projGlobe_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

## regional_invaded_asian hist

### Save outputs

```{r save summary files}

# summary of data
write_csv(
  x = exdet_MIC_regional_invaded_asian_hist[["data"]][["all"]],
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_exdet_mic_analysis_results.csv")
  )

# exdet
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_asian_hist[["summary"]][["extrapolation"]]),
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_exdet_analysis_summary.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_asian_hist[["summary"]][["mic"]][[1]]),
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_mic_analysis_univariate_summary.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_asian_hist[["summary"]][["mic"]][[2]]),
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_mic_analysis_combinatorial_summary.csv")
  )

```

```{r save rasters}

# exdet
raster::writeRaster(
  x = exdet_MIC_regional_invaded_asian_hist[["rasters"]][["ExDet"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_asian_v1_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

raster::writeRaster(
  x = exdet_MIC_regional_invaded_asian_hist[["rasters"]][["mic"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "MIC_slf_regional_invaded_asian_v1_background_projGlobe.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

# also isolate exdet raster
exdet_regional_invaded_asian_hist <- exdet_MIC_regional_invaded_asian_hist[["rasters"]][["ExDet"]][["all"]]

```

### Plot ExDet

```{r create exdet plot}

# plot mean raster first
exdet_regional_invaded_asian_hist_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_asian_hist[["data"]][["all"]], aes(x = x, y = y, fill = ExDet)) +
  labs(
    title = "ExDet analysis: bio2, bio11, bio12 and bio15",
    subtitle = "Global climate divergence from 'regional_invaded_asian' model training set",
    fill = "ExDet Analysis"
    ) +
  # default plot style
  map_style_exdet +
  # fill scale
  scale_fill_gradientn(
  name = "ExDet Score",
  colors = c("#67001f", "#f4a582", "white", "white", "white", "#92c5de", "#053061"),
  values = scales::rescale(x = c(min(values(exdet_regional_invaded_asian_hist), na.rm = TRUE), 0, 1, max(values(exdet_regional_invaded_asian_hist), na.rm = TRUE))),
  breaks = c(
    round(min(values(exdet_regional_invaded_asian_hist), na.rm = TRUE), 15), 
    round(0, 1), round(1, 1), 
    round(max(values(exdet_regional_invaded_asian_hist), na.rm = TRUE), 15)
    ),
  guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20)
  ) + 
  theme(legend.text = element_text(angle = 25))

```

```{r save plot}

# save plot
ggsave(
  exdet_regional_invaded_asian_hist_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "ExDet_slf_regional_invaded_asian_v1_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

### Plot MIC

```{r create MIC plot}

# plot mean raster first
mic_regional_invaded_asian_hist_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_asian_hist[["data"]][["all"]], aes(x = x, y = y, fill = as.factor(mic))) +
  labs(
    title = "Most Influential Covariate (MIC) for 'regional_invaded_asian' model",
    subtitle = "Covariate causing most extrapolation from model training set",
    fill = "MIC"
    ) +
  # default plot style
  map_style_MIC 

```

```{r save plot}

# save plot
ggsave(
  mic_regional_invaded_asian_hist_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_invaded_asian_v1_background_projGlobe.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

## regional_invaded_asian CMIP6

### Save outputs

```{r save summary files}

# summary of data
write_csv(
  x = exdet_MIC_regional_invaded_asian_CMIP6[["data"]][["all"]],
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_exdet_mic_analysis_results_2041-2070_ssp370_GFDL.csv")
  )

# exdet
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_asian_CMIP6[["summary"]][["extrapolation"]]),
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_exdet_analysis_summary_2041-2070_ssp370_GFDL.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_asian_CMIP6[["summary"]][["mic"]][[1]]),
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_mic_analysis_univariate_summary_2041-2070_ssp370_GFDL.csv")
  )

# mic univariate
write_csv(
  x = as.data.frame(exdet_MIC_regional_invaded_asian_CMIP6[["summary"]][["mic"]][[2]]),
  file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_mic_analysis_combinatorial_summary_2041-2070_ssp370_GFDL.csv")
  )

```

```{r save rasters}

# exdet
raster::writeRaster(
  x = exdet_MIC_regional_invaded_asian_CMIP6[["rasters"]][["ExDet"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_asian_v1_background_projGlobe_2041-2070_ssp370_GFDL.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

raster::writeRaster(
  x = exdet_MIC_regional_invaded_asian_CMIP6[["rasters"]][["mic"]][["all"]], 
  filename = file.path(mypath, "models", "working_dir", "MIC_slf_regional_invaded_asian_v1_background_projGlobe_2041-2070_ssp370_GFDL.tif"),
  filetype = "GTiff",
  overwrite = FALSE
  )

# also isolate exdet raster
exdet_regional_invaded_asian_CMIP6 <- exdet_MIC_regional_invaded_asian_CMIP6[["rasters"]][["ExDet"]][["all"]]

```

### Plot ExDet

```{r create exdet plot}

# plot mean raster first
exdet_MIC_regional_invaded_asian_CMIP6_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_asian_CMIP6[["data"]][["all"]], aes(x = x, y = y, fill = ExDet)) +
  labs(
    title = "ExDet analysis | bio2, bio11, bio12, bio15 | 2041-2070, ssp370, GFDL",
    subtitle = "Global climate divergence from 'regional_invaded_asian' model training set",
    fill = "ExDet Analysis"
    ) +
  # default plot style
  map_style_exdet +
  # fill scale
  scale_fill_gradientn(
  name = "ExDet Score",
  colors = c("#67001f", "#f4a582", "white", "white", "white", "#92c5de", "#053061"),
  values = scales::rescale(x = c(min(values(exdet_regional_invaded_asian_CMIP6), na.rm = TRUE), 0, 1, max(values(exdet_regional_invaded_asian_CMIP6), na.rm = TRUE))),
  breaks = c(
    round(min(values(exdet_regional_invaded_asian_CMIP6), na.rm = TRUE), 6), 
    round(0, 1), round(1, 1), 
    round(max(values(exdet_regional_invaded_asian_CMIP6), na.rm = TRUE), 6)
    ),
  guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20)
  ) + 
  theme(legend.text = element_text(angle = 25))

```

```{r save plot}

# save plot
ggsave(
  exdet_MIC_regional_invaded_asian_CMIP6_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "ExDet_slf_regional_invaded_asian_v1_background_projGlobe_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```

### Plot MIC

```{r create MIC plot}

# plot mean raster first
mic_regional_invaded_asian_CMIP6_plot <- ggplot() +
  # plot regular raster of values first
  geom_raster(data = exdet_MIC_regional_invaded_asian_CMIP6[["data"]][["all"]], aes(x = x, y = y, fill = as.factor(mic))) +
  labs(
    title = "Most Influential Covariate (MIC) for 'regional_invaded_asian' model",
    subtitle = "Covariate causing most extrapolation from model training set, projected for 2041-2070, ssp370, GFDL",
    fill = "MIC"
    ) +
  # default plot style
  map_style_MIC 

```

```{r save plot}

# save plot
ggsave(
  mic_regional_invaded_asian_CMIP6_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_invaded_asian_v1_background_projGlobe_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 14,
  device = "jpeg",
  dpi = "retina"
  )

```



# References

Bouchet P, Miller D, Roberts J, Mannocci L, Harris C, Thomas L (2020). dsmextra: Extrapolation assessment tools for density surface models. Methods in Ecology and Evolution. DOI: 10.1111/2041-210X.13469

Elith, J., M. Kearney, and S. Phillips. 2010. The art of modelling range-shifting species. Methods in Ecology and Evolution 1:330–342.

Mesgaran, M. B., R. D. Cousens, and B. L. Webber. 2014. Here be dragons: a tool for quantifying novelty due to covariate range and correlation change when projecting species distribution models. Diversity and Distributions 20:1147–1159.
