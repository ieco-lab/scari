---
title: "Create suitability scatter plots and binarized maps (chapter 1)"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-02-29"
output: html_document
---
# Overview

EDIT

This vignette will compare the invaded region model for SLF, which was created in `050_run_easternUSA_MaxEnt_models.Rmd`, with the global version of this model, which was created in `070_run_global_historical_MaxEnt_model.Rmd`. First, I will compare these models using flexible AUC. Second, I will also project these models to N. America and compare the proportion of suitable area. Third, I will calculate suitabilitiy values for all SLF points and IVR regions. Finally, I will perform an invasion stage analysis following the methods of Gallien et.al, 2012. 

In step 1, I tested the best fit background data using SLF occurrences and climate data only from the SLF invaded range (the eastern half of the United States). 

(THEORY)

# Setup

```{r load necesssary packages, echo = FALSE}

# general tools
library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here() # here() starts at the root folder of this package.
library(devtools)

# SDMtune and dependencies
library(SDMtune) # main package used to run SDMs
library(dismo) # package underneath SDMtune
library(rJava) # for running MaxEnt
library(plotROC) # plots ROCs

# spatial data handling
library(raster) 
library(terra) 

library(viridis)

```

I will load in preset styles for my plots and maps



```{r ggplot object for map style}

map_style <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "lightblue2",
                                        colour = "lightblue2")
  ),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  labs(fill = "Suitability for SLF"),
  viridis::scale_fill_viridis(option = "D"),
  coord_equal()
)

```

```{r set wd}

mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models")

```


# plot presences over global and regional models

## Plot points over global model

Here, I will plot the IVRs (purple) and known SLF points (orange) over the global model I produced.

```{r load in global and regional rasters}

# global raster
global_hist_mean <- terra::rast(
  x = file.path(mypath, "slf_global_v2", "global_pred_suit_clamped_cloglog_NAmerica_1981-2010_mean.asc")
  )
# convert to df for plotting
global_hist_mean_df <- terra::as.data.frame(x = global_hist_mean, xy = TRUE)



# regional_invaded raster
regional_invaded_hist_mean <- terra::rast(
  x = file.path(mypath, "slf_regional_invaded_v4", "regional_invaded_pred_suit_clamped_cloglog_NAmerica_1981-2010.asc")
  )
# convert to df for plotting
regional_invaded_hist_mean_df <- terra::as.data.frame(x = regional_invaded_hist_mean, xy = TRUE)



# regional_native raster
regional_native_hist_mean <- terra::rast(
  x = file.path(mypath, "slf_regional_native_v1", "regional_native_pred_suit_clamped_cloglog_NAmerica_1981-2010.asc")
  )
# convert to df for plotting
regional_native_hist_mean_df <- terra::as.data.frame(x = regional_native_hist_mean, xy = TRUE)

```


```{r plot SLF suitability values}

# plot with IVR and SLF points
v5_global_IVR_SLF <- ggplot() +
  geom_raster(data = terra::as.data.frame(v5_global1, xy = TRUE), 
              aes(x = x, y = y, fill = v5_global)) +
  geom_point(data = slf_points, 
             aes(x = x, y = y, color = "SLF populations"), size = 0.1, show.legend = TRUE) +
  geom_point(data = IVR_points, 
             aes(x = x, y = y, color = "IVR regions"), size = 0.1, show.legend = TRUE) +
  xlim(-133.593750, -52.294922) +
  ylim(25.085599, 55.304138) +
  scale_fill_distiller(name = "suitability for SLF", palette = "Greys", type = "seq", direction = 1) +
  scale_color_manual(name = "Point Data", values = c("SLF populations" = "darkorange", "IVR regions" = "darkviolet")) +
  guides(color = guide_legend(ncol = 1, byrow = TRUE, override.aes = list(size = 3))) +
  labs(title = "Contemporary SLF suitability in global model with IVR locations") +
  map_style

```

```{r save map}

ggsave(v5_global_IVR_SLF, filename = file.path(here(), "vignette-outputs", "figures", "v5_global_IVR_SLF.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```

## Plot points over regional model

Now, I will plot the IVRs (purple) and known SLF points (orange) over the regional model.

# create binary overlay distribution maps






# Appendix

```{r crop presences to rasters}

# extent object for eastern USA
ext.obj <- terra::ext(-96.503906, -59.589844, 28.304381, 47.457809)

# conert to vector
slf_suitability_cropped <- terra::vect(x = slf_suitability, geom = c("x", "y"), crs = "EPSG:4326") %>%
  # crop by extent area of interest
  terra::crop(., y = ext.obj) %>%
  # convert to geom, which gets coordinates of a spatVector
  terra::geom() 

# convert back to data frame
slf_suitability_cropped <- terra::as.data.frame(slf_suitability_cropped) %>%
  dplyr::select(-c(geom, part, hole))

# join back missing columns
slf_suitability_cropped <- left_join(x = slf_suitability_cropped, y = slf_suitability, by = c("x", "y"))

```


## EDA for SLF and IVR scatter plots

### histograms

The distributions of suitability values for SLF presences is very strange. I 

Why?
* 50,000 background points for global vs 10,000 for regional
* 

```{r histograms of suitability value distributions- SLF}

# global suitability histogram
(global_suit_hist <- ggplot(data = slf_suitability) +
  geom_histogram(aes(x = global_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

# regional suitability histogram
(regional_suit_hist <- ggplot(data = slf_suitability) +
  geom_histogram(aes(x = regional_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

```

```{r histograms of suitability value distributions- IVR}

# global suitability histogram
(ggplot(data = IVR_suitability) +
  geom_histogram(aes(x = global_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

# regional suitability histogram
(ggplot(data = IVR_suitability) +
  geom_histogram(aes(x = regional_suitability), binwidth = 0.1) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
   theme_bw()
)

```

### Scatter plots 

```{r distribution of suitability values by longitude}

# scatter of global suitability vs longitude
(global_suit_longitude <- ggplot(data = slf_suitability) +
   geom_point(aes(x = x, y = global_suitability), size = 1) +
   xlab("longitude") +
   theme_bw()
)

# scatter of regional suitability vs longitude
(regional_suit_longitude <- ggplot(data = slf_suitability) +
    geom_point(aes(x = x, y = regional_suitability), size = 1) +
    xlab("longitude") +
   theme_bw()
)

```

```{r distribution of suitability values by longitude}

# scatter of global suitability vs longitude
(ggplot(data = IVR_suitability) +
   geom_point(aes(x = x, y = global_suitability), size = 1) +
   xlab("longitude") +
   theme_bw()
)

# scatter of regional suitability vs longitude
(ggplot(data = IVR_suitability) +
    geom_point(aes(x = x, y = regional_suitability), size = 1) +
    xlab("longitude") +
   theme_bw()
)

# scatter of global suitability vs longitude
(ggplot(data = IVR_suitability) +
   geom_point(aes(x = global_suitability, y = y), size = 1) +
   ylab("latitude") +
   theme_bw()
)

# scatter of regional suitability vs longitude
(ggplot(data = IVR_suitability) +
   geom_point(aes(x = regional_suitability, y = y), size = 1) +
   ylab("latitude") +
   theme_bw()
)

```

# References

Gallien, L., R. Douzet, S. Pratte, N. E. Zimmermann, and W. Thuiller. 2012. Invasive species distribution models – how violating the equilibrium assumption can create new insights. Global Ecology and Biogeography 21:1126–1136.

