---
title: "111_calculate_ExDet_MIC_workflow"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-03-22"
output: html_document
---

Much of this workflow was taken from: URL

EXPLAIN

# Setup

```{r load necesssary packages, echo = FALSE}

# general tools
library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here() # here() starts at the root folder of this package.
library(devtools)

# spatial data handling
library(terra)

# statistical
library(stats)

# aesthetics

```

```{r map style object}

map_style_MESS <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "azure3",
                                        colour = "azure3")
  ),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  labs(fill = "Suitability for SLF"),
  scale_fill_gradientn(
    name = "MESS score",
    #low = "#67001f",
    #mid = "white",
    #high = "#053061",
    #midpoint = 0,
    limits = c(-100, 100),
    colors = c("#67001f", "#b2182b", "#d6604d", "#f4a582", "#fddbc7", "white", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#053061")
  ),
  #guides(fill = guide_colourbar(theme = theme(
 # legend.key.width  = unit(100, "lines"),
 # legend.key.height = unit(100, "lines")
#))),
  coord_equal()
)

# color scheme taken from: https://colorbrewer2.org/?type=diverging&scheme=RdBu&n=11

```

```{r set wd}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent")

```

# 1. Import Datasets

## bioclim

I will load in the training and projection region rasters

```{r load in covariate layers}

# training region
x_China_env_covariates_list <- list.files(
  path = file.path(mypath, "historical_climate_rasters", "chelsa2.1_30arcsec", "v1_maxent_10km"), 
  pattern = "\\.asc$", 
  full.names = TRUE
  ) %>%
  grep("bio2_1981-2010_China.asc|bio11_1981-2010_China.asc|bio12_1981-2010_China.asc|bio15_1981-2010_China.asc", ., value = TRUE)

# projection region
# the scale used to make xy predictions
x_global_hist_env_covariates_list <- list.files(
  path = file.path(mypath, "historical_climate_rasters", "chelsa2.1_30arcsec", "v1_maxent_10km"),
  pattern = "\\_global.asc$", 
  full.names = TRUE
  ) %>%
  # dont include Access to cities
  grep(pattern = "atc_2015", value = TRUE, invert = TRUE)

```

```{r naming object}

# layer name object. Check order of layers first
env_layer_names <- c("bio11", "bio12", "bio15", "bio2")

```

```{r stack historical covariates and make naming consistent}

# stack env covariates
x_China_env_covariates <- terra::rast(x = x_China_env_covariates_list)

# attributes
nlyr(x_China_env_covariates)
names(x_China_env_covariates)
minmax(x_China_env_covariates)
# ext(x_China_env_covariates)
# crs(x_China_env_covariates)

# I will change the name of the variables because they are throwing errors in SDMtune
names(x_China_env_covariates) <- env_layer_names
# confirmed- SDMtune doesnt like dashes in column names (it is read as a mathematical operation)

# stack env covariates
x_global_hist_env_covariates <- terra::rast(x = x_global_hist_env_covariates_list)

# attributes
nlyr(x_global_hist_env_covariates)
names(x_global_hist_env_covariates)
minmax(x_global_hist_env_covariates)
# ext(x_global_hist_env_covariates)
# crs(x_global_hist_env_covariates)

# I will change the name of the variables because they are throwing errors in SDMtune
names(x_global_hist_env_covariates) <- env_layer_names
# confirmed- SDMtune doesnt like dashes in column names (it is read as a mathematical operation)

```

```{r remove lists}

rm(x_China_env_covariates_list)
rm(x_global_hist_env_covariates_list)

```


## background

# 2. ExDet Analysis

## calculate mahalanobis distance in training range

```{r stats}

# raster values
env_covar_values <- values(x_China_env_covariates) %>%
  as.data.frame()

# take statistics
# variable means
env_covar_means <- colMeans(env_covar_values, na.rm = TRUE)
# variable variance
env_covar_variance <- var(env_covar_values, na.rm = TRUE)
# mahalanobis distance
env_covar_mah <- mahalanobis(
  x = env_covar_values, 
  center = env_covar_means,
  cov = env_covar_variance,
  na.rm = TRUE
  )

```

```{r graph for sanity}

ggplot(data = as.data.frame(env_covar_mah)) +
  geom_histogram(aes(x = env_covar_mah), binwidth = 1) +
  labs(
    title = "Mahalanobis distances for the 'regional_native' model",
    x = "Mahalanobis distances"
  )

```

have large outliers. clean.

```{r calculate mah distance from max}

# threshold for outliers outside 95th percentile 
thresh <- quantile(env_covar_mah, probs = 0.95, na.rm = TRUE)
# remove outliers
env_covar_mah[which(env_covar_mah > thresh)] <- NA
# get max
env_covar_max <- max(env_covar_mah, na.rm = TRUE)


# transform distances into distance from the max
env_covar_mah_from_max <- env_covar_mah / env_covar_max

```

```{r plot again to see if quantile worked}

ggplot(data = as.data.frame(env_covar_mah_from_max)) +
  geom_histogram(aes(x = env_covar_mah_from_max), binwidth = 0.1) +
  labs(
    title = "Trimmed Mahalanobis distances for the 'regional_native' model",
    x = "Mahalanobis distances"
  )

```

Looks great! Now I will imprort these values onto a raster.

```{r import mah from max onto raster}

# create raster layer
train_mah_max_dist <- x_China_env_covariates[[1]]
values(train_mah_max_dist) <- env_covar_mah_from_max

```

## calculate mahalanobis distance of projected range from the max in the adventive range

```{r calculate distance of }

naMah <- mahalanobis(naVal[, VARS], 
                     trainMeans, trainVar, na.rm = TRUE)
naMah <- naMah/maxMah

## Create a new raster map for North America:
naMahR <- naWC[[1]]

## set the values to our Mahalanobis distances:
values(naMahR) <- naMah

```


# References



