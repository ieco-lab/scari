---
title: "Ensemble regional models into a single prediction"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-04-10"
output: html_document
---

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)

library(here) 
# here() is set at the root folder of this package

# spatial data handling
library(terra)

```

```{r set wd}

# output directory
mypath <- file.path(here::here() %>% 
                       dirname(),
                     "maxent")

```

```{r create directory for ensemble product}

dir.create(path = file.path(mypath, "models", "slf_regional_ensemble_v0", "plots"))

```


# Import datasets

## MaxEnt Predictions

First, I need to load in the rasters containing the predictions from each model. I will load in both the historical and climate change versions of these predictions.

```{r regional model predictions historical}

pred_regional_native <- terra::rast(
  x = file.path(mypath, "models", "slf_regional_native_v2", "regional_native_pred_suit_clamped_cloglog_globe_1981-2010.asc")
)

pred_regional_invaded <- terra::rast(
  x = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_pred_suit_clamped_cloglog_globe_1981-2010.asc")
)

pred_regional_invaded_asian <- terra::rast(
  x = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_pred_suit_clamped_cloglog_globe_1981-2010.asc")
)


```

```{r regional model predictions 2041-2070}

pred_regional_native_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "slf_regional_native_v2", "regional_native_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370.asc")
)

pred_regional_invaded_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370.asc")
)

pred_regional_invaded_asian_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370.asc")
)


```

## AUC values

Next, I will load in the AUC value from each model, which will be used to weight each model's predictions, specifically based on its test AUC value. 

```{r test AUC values}

AUC_regional_native <- read_csv(file = file.path(mypath, "models", "slf_regional_native_v2", "regional_native_AUC_TSS.csv")) %>%
  dplyr::select(AUC) %>%
  dplyr::slice(2) %>%
  as.numeric()

AUC_regional_invaded <- read_csv(file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_AUC_TSS.csv")) %>%
  dplyr::select(AUC) %>%
  dplyr::slice(2) %>%
  as.numeric()

AUC_regional_invaded_asian <- read_csv(file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_AUC_TSS.csv")) %>%
  dplyr::select(AUC) %>%
  dplyr::slice(2) %>%
  as.numeric()

```

```{r table of AUC values}

AUC_values <- tibble(
  model = c("AUC_regional_native", "AUC_regional_invaded", "AUC_regional_invaded_asian"),
  AUC_value = c(AUC_regional_native, AUC_regional_invaded, AUC_regional_invaded_asian)
)

```

## ExDet rasters

Finally, I will load in the results from the ExDet analysis to weight the ensemble.

```{r regional model predictions historical}

exdet_regional_native <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_native_v2_background_projGlobe.tif")
)

exdet_regional_invaded <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_v6_background_projGlobe.tif")
)

exdet_regional_invaded_asian <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_asian_v1_background_projGlobe.tif")
)


```

```{r regional model predictions 2041-2070}

exdet_regional_native_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_native_v2_background_projGlobe_2041-2070_ssp370_GFDL.tif")
)

exdet_regional_invaded_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_v6_background_projGlobe_2041-2070_ssp370_GFDL.tif")
)

exdet_regional_invaded_asian_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "ExDet_slf_regional_invaded_asian_v1_background_projGlobe_2041-2070_ssp370_GFDL.tif")
)

```

## Stack rasters

I will need to stack the predicted and ExDet rasters to perform this analysis.

```{r pred suitability}

pred_hist_stack <- c(pred_regional_native, pred_regional_invaded, pred_regional_invaded_asian)

pred_CMIP6_stack <- c(pred_regional_native_CMIP6, pred_regional_invaded_CMIP6, pred_regional_invaded_asian_CMIP6)

```

```{r ExDet rasters}

exdet_hist_stack <- c(exdet_regional_native, exdet_regional_invaded, exdet_regional_invaded_asian)

exdet_CMIP6_stack <- c(exdet_regional_native_CMIP6, exdet_regional_invaded_CMIP6, exdet_regional_invaded_asian_CMIP6)

```

## Preparatory raster edits

The pred rasters need to be cropped slightly because the function used to create the ExDet rasters cropped them slightly. These raster sets need to share the same extent for downstream manipulations.

```{r crop pred rasters}

terra::ext(pred_hist_stack)
terra::ext(pred_CMIP6_stack)
terra::ext(exdet_hist_stack)
terra::ext(exdet_CMIP6_stack)

# I will trim the rasters to the extent of the exdet rasters
ext.obj <- terra::ext(-180.00013888885, 178.999859675084, -58.5001390148238, 82.99986041915)

# crop rasters
# hist
pred_hist_stack <- terra::crop(pred_hist_stack, ext.obj)
# CMIP6
pred_CMIP6_stack <- terra::crop(pred_CMIP6_stack, ext.obj)

```

```{r rename pred raster layers}

names(pred_hist_stack) <- c("pred_regional_native", "pred_regional_invaded", "pred_regional_invaded_asian")

names(pred_CMIP6_stack) <- c("pred_regional_native_CMIP6", "pred_regional_invaded_CMIP6", "pred_regional_invaded_asian_CMIP6")

```

Now, I need to prepare to weight the predicted distribution rasters using their respective ExDet raster. 

# Ensemble rasters

## take ABS value of Exdet rasters

First, I will need to manipulate the ExDet rasters so they can be used for weighting. I will begin by adding 1 to any negative ExDet value and then taking the absolute value of each cell. This way, the weighting is performed on a positive scale. The ExDet metric works such that anything between 0 and 1 is not extrapolated, while anything below 0 or above 1 is extrapolated. Next, I will convert any ExDet value below 0 to 1, so that cells without extrapolation are simply not weighted. 

1. Add 1 to any negative ExDet values
2. Take abs value of ExDet values
3. Convert any ExDet value below 1 to 1
4. Take reciprocal of ExDet raster values

```{r exdet historical stack}

# 1. add 1 to negatives

# take minmax before
minmax(exdet_hist_stack)

# the min values of each layer should be -1.4, -2.79 and -2.5 respectively after ifelse
# the max values should be unchanged at 1.4, 1.22 and 2.2

exdet_hist_stack <- terra::ifel(
  exdet_hist_stack < 0, # if the value is < 0
  exdet_hist_stack - 1, # subtract 1
  exdet_hist_stack # else, keep the same
  )

# minmax after
minmax(exdet_hist_stack)


# 2. take abs

exdet_hist_stack <- abs(exdet_hist_stack)

minmax(exdet_hist_stack)


# 3. convert values below 1 to 1

exdet_hist_stack <- terra::ifel(
  exdet_hist_stack < 1, # if the value is < 1 or == 0
  1, # make 1
  exdet_hist_stack # else, keep the same
  )

minmax(exdet_hist_stack)


# 4. take reciprocals

exdet_hist_stack <- terra::app(exdet_hist_stack, fun = (function(i) 1 / i))

minmax(exdet_hist_stack)


```

```{r save raster}

terra::writeRaster(
  x = exdet_hist_stack, 
  filename = c(
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_native_v2.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_v6.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_asian_v1.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )

```

I will do the same for the CMIP6 exdet rasters

```{r exdet CMIP6 stack}

# 1. add 1 to negatives

# take minmax before
minmax(exdet_CMIP6_stack)


exdet_CMIP6_stack <- terra::ifel(
  exdet_CMIP6_stack < 0, # if the value is < 0
  exdet_CMIP6_stack - 1, # subtract 1
  exdet_CMIP6_stack # else, keep the same
  )

# minmax after
minmax(exdet_CMIP6_stack)


# 2. take abs

exdet_CMIP6_stack <- abs(exdet_CMIP6_stack)

minmax(exdet_CMIP6_stack)


# 3. convert values below 1 to 1

exdet_CMIP6_stack <- terra::ifel(
  exdet_CMIP6_stack < 1 | exdet_CMIP6_stack == 0, # if the value is < 1 or == 0
  1, # make 1
  exdet_CMIP6_stack # else, keep the same
  )

minmax(exdet_CMIP6_stack)


# 4. take reciprocals

exdet_CMIP6_stack <- terra::app(exdet_CMIP6_stack, fun = (function(i) 1 / i))

minmax(exdet_CMIP6_stack)


```

```{r save raster}

terra::writeRaster(
  x = exdet_hist_stack, 
  filename = c(
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_native_v2_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_v6_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_asian_v1_2041-2070_ssp370_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )

```

## Weight Models using Test AUC

The second step in this weighting process is to also weight each model by its goodness-of-fit. We will use the AUC value for each model and integrate this into the weighting formula so that each model contributes based on this goodness of fit. AUC already ranges from 0-1, so if AUC is 1 then the weight will remain unchanged for that model. However, if AUC is less than 1, it will lessen the weight of that model in the overall ensemble. I will multiply each raster by its AUC value and then save these rasters as ensemble weights.

```{r weight hist pred rasters using AUC}

minmax(exdet_hist_stack)

# layer 1
exdet_hist_stack[[1]] <-terra::app(
  x = exdet_hist_stack[[1]],
  fun = function(x) x * as.numeric(AUC_values[[1, 2]])
)

# layer 2
exdet_hist_stack[[2]] <-terra::app(
  x = exdet_hist_stack[[2]],
  fun = function(y) y * as.numeric(AUC_values[[2, 2]])
)

# layer 3
exdet_hist_stack[[3]] <-terra::app(
  x = exdet_hist_stack[[3]],
  fun = function(z) z * as.numeric(AUC_values[[3, 2]])
)


# other operations
minmax(exdet_hist_stack)
# add names
names(exdet_hist_stack) <- c("regional_native", "regional_invaded", "regional_invaded_asian")


```

```{r save raster}

terra::writeRaster(
  x = exdet_hist_stack, 
  filename = c(
    file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_weights_slf_regional_native_v2.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_weights_slf_regional_invaded_v6.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_weights_slf_regional_invaded_asian_v1.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )

```

Now, I will perform the same operation to the CMIP6 rasters.

```{r weight hist pred rasters using AUC}

minmax(exdet_CMIP6_stack)

# layer 1
exdet_CMIP6_stack[[1]] <-terra::app(
  x = exdet_CMIP6_stack[[1]],
  fun = function(x) x * as.numeric(AUC_values[[1, 2]])
)

# layer 2
exdet_CMIP6_stack[[2]] <-terra::app(
  x = exdet_CMIP6_stack[[2]],
  fun = function(y) y * as.numeric(AUC_values[[2, 2]])
)

# layer 3
exdet_CMIP6_stack[[3]] <-terra::app(
  x = exdet_CMIP6_stack[[3]],
  fun = function(z) z * as.numeric(AUC_values[[3, 2]])
)


# other operations
minmax(exdet_CMIP6_stack)
# add names
names(exdet_CMIP6_stack) <- c("regional_native_2041-2070", "regional_invaded_2041-2070", "regional_invaded_asian_2041-2070")


```

```{r save raster}

terra::writeRaster(
  x = exdet_CMIP6_stack, 
  filename = c(
    file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_weights_slf_regional_native_v2_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_weights_slf_regional_invaded_v6_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_weights_slf_regional_invaded_asian_v1_2041-2070_ssp370_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )

```


## Weight models using confidence metric (ExDet)

Finally, I will apply these weighting factors to the predicted raster layers from each model and take a weighted mean. Weighted means are a common method for creating model ensembles (Araújo & New, 2007). The three predicted suitability rasters will each be weighted by their respective weighted exdet raster. This will be repeated for the CMIP6 rasters as well. I will save these to a new folder where I will keep the ensemble output.

```{r weighted mean pred rasters}

# historical
pred_hist_mean <- terra::weighted.mean(
  x = pred_hist_stack,
  w = exdet_hist_stack,
  filename = file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_regional_weighted_mean_globe_1981-2010.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)

# CMIP6
pred_CMIP6_mean <- terra::weighted.mean(
  x = pred_CMIP6_stack,
  w = exdet_CMIP6_stack,
  filename = file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_regional_weighted_mean_globe_2041-2070_GFDL_ssp370.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)

```




We now have a weighted mean raster for each of the historical and CMIP rasters!

# Ensemble thresholds

I also need to ensemble the thresholds that I will be using to create scatter plots and thresholded maps downstream. The ensemble will be performed using the same method as above, but slightly altered. I will use the pred rasters to extract the coordinates of locations that have the same suitability value as the threshold. Next, I will take these coordinates and extract the ExDet values from those same locations. I will take the mean or median of those values. Then, I will multiply the threshold by this value and the AUC for that model. Finally, I will take the weighted mean of the three modified thresh values. This will be repeated for the MTP threshold as well. Finally, this process will also be completed for the CC version of these models.

Per projected time period (historical and CC) and threshold value:
1. Extract all values from `pred` rasters that match the respective model threshold value.
2. Extract all values from the converted `exdet` rasters at those locations
3. Take mean of the exdet values at those locations.
4. Multiply this mean by the AUC value for that model. 
5. Take the weighted mean of the three threshold values using these created weights.

## Import data 

### ExDet rasters

I will load in the results from the ExDet analysis to weight the ensemble.

```{r converted exdet values historical}

exdet_weight_regional_native <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_native_v2.tif")
)

exdet_weight_regional_invaded <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_v6.tif")
)

exdet_weight_regional_invaded_asian <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_asian_v1.tif")
)


```

```{r converted exdet values 2041-2070}

exdet_weight_regional_native_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_native_v2_2041-2070_ssp370_GFDL.tif")
)

exdet_weight_regional_invaded_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_v6_2041-2070_ssp370_GFDL.tif")
)

exdet_weight_regional_invaded_asian_CMIP6 <- terra::rast(
  x = file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_asian_v1_2041-2070_ssp370_GFDL.tif")
)

```

```{r stack ExDet rasters}

exdet_weight_hist_stack <- c(exdet_weight_regional_native, exdet_weight_regional_invaded, exdet_weight_regional_invaded_asian)

exdet_weight_CMIP6_stack <- c(exdet_weight_regional_native_CMIP6, exdet_weight_regional_invaded_CMIP6, exdet_weight_regional_invaded_asian_CMIP6)

```

## Pred rasters

I will also convert the pred rasters to dfs

```{r convert pred rasters to df}

pred_hist_stack_df <- terra::as.data.frame(pred_hist_stack, xy = TRUE)

pred_CMIP6_stack_df <- terra::as.data.frame(pred_CMIP6_stack, xy = TRUE)

```

### thresh values

The summary files contain the actual threshold values, so I will load each one in and then isolate the threshold.

```{r load in thresh values from summary files}

# MTSS
MTSS_regional_native <- read_csv(file = file.path(mypath, "models", "slf_regional_native_v2", "regional_native_summary.csv")) %>%
  dplyr::select(statistic_value) %>%
  slice(42) %>%
  as.numeric()
  
MTSS_regional_invaded <- read_csv(file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_summary.csv")) %>%
  dplyr::select(statistic_value) %>%
  slice(42) %>%
  as.numeric()

MTSS_regional_invaded_asian <- read_csv(file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_summary.csv")) %>%
  dplyr::select(statistic_value) %>%
  slice(42) %>%
  as.numeric()

# convert to vector
MTSS_all <- c(MTSS_regional_native, MTSS_regional_invaded, MTSS_regional_invaded_asian)



# MTP
MTP_regional_native <- read_csv(file = file.path(mypath, "models", "slf_regional_native_v2", "regional_native_summary.csv")) %>%
  dplyr::select(statistic_value) %>%
  slice(30) %>%
  as.numeric()

MTP_regional_invaded <- read_csv(file = file.path(mypath, "models", "slf_regional_invaded_v6", "regional_invaded_summary.csv")) %>%
  dplyr::select(statistic_value) %>%
  slice(30) %>%
  as.numeric()

MTP_regional_invaded_asian <- read_csv(file = file.path(mypath, "models", "slf_regional_invaded_asian_v1", "regional_invaded_asian_summary.csv")) %>%
  dplyr::select(statistic_value) %>%
  slice(30) %>%
  as.numeric()

# convert to vector
MTP_all <- c(MTP_regional_native, MTP_regional_invaded, MTP_regional_invaded_asian)

```

## Create weight for thresh

### MTSS

First, I will perform these operations for the historical rasters.

```{r weights for hist rasters}

# 1. Extract all values from pred rasters that match the respective model threshold value.

MTSS_regional_native_hist_coords <- pred_hist_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTSS_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_hist_coords <- pred_hist_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTSS_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_asian_hist_coords <- pred_hist_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTSS_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTSS_regional_native_exdet_weight <- terra::extract(exdet_weight_hist_stack, y = MTSS_regional_native_hist_coords)
# tidy
MTSS_regional_native_exdet_weight <- MTSS_regional_native_exdet_weight %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTSS_regional_invaded_exdet_weight <-  terra::extract(exdet_weight_hist_stack, y = MTSS_regional_invaded_hist_coords)
# tidy
MTSS_regional_invaded_exdet_weight <- MTSS_regional_invaded_exdet_weight %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTSS_regional_invaded_asian_exdet_weight <- terra::extract(exdet_weight_hist_stack, y = MTSS_regional_invaded_asian_hist_coords) 
# tidy
MTSS_regional_invaded_asian_exdet_weight <- MTSS_regional_invaded_asian_exdet_weight %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTSS_regional_native_exdet_weight <- MTSS_regional_native_exdet_weight * as.numeric(AUC_values[1, 2])

MTSS_regional_invaded_exdet_weight <- MTSS_regional_invaded_exdet_weight * as.numeric(AUC_values[2, 2])

MTSS_regional_invaded_asian_exdet_weight <- MTSS_regional_invaded_asian_exdet_weight * as.numeric(AUC_values[3, 2])


# convert to vector

MTSS_hist_weights <- c(MTSS_regional_native_exdet_weight, MTSS_regional_invaded_exdet_weight, MTSS_regional_invaded_asian_exdet_weight)


```

Now, I will take the weighted mean

```{r weighted mean of hist thresh values}

MTSS_hist_thresh <- stats::weighted.mean(
  x = MTSS_all,
  w = MTSS_hist_weights
)

```

Next, I will perform this operation for the CMIP6 rasters

```{r weights for CMIP6 rasters}

# 1. Extract all values from pred rasters that match the respective model threshold value.

MTSS_regional_native_CMIP6_coords <- pred_CMIP6_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTSS_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_CMIP6_coords <- pred_CMIP6_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTSS_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_asian_CMIP6_coords <- pred_CMIP6_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTSS_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTSS_regional_native_exdet_weight <- terra::extract(exdet_weight_CMIP6_stack, y = MTSS_regional_native_CMIP6_coords)
# tidy
MTSS_regional_native_exdet_weight <- MTSS_regional_native_exdet_weight %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTSS_regional_invaded_exdet_weight <-  terra::extract(exdet_weight_CMIP6_stack, y = MTSS_regional_invaded_CMIP6_coords)
# tidy
MTSS_regional_invaded_exdet_weight <- MTSS_regional_invaded_exdet_weight %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTSS_regional_invaded_asian_exdet_weight <- terra::extract(exdet_weight_CMIP6_stack, y = MTSS_regional_invaded_asian_CMIP6_coords) 
# tidy
MTSS_regional_invaded_asian_exdet_weight <- MTSS_regional_invaded_asian_exdet_weight %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTSS_regional_native_exdet_weight <- MTSS_regional_native_exdet_weight * as.numeric(AUC_values[1, 2])

MTSS_regional_invaded_exdet_weight <- MTSS_regional_invaded_exdet_weight * as.numeric(AUC_values[2, 2])

MTSS_regional_invaded_asian_exdet_weight <- MTSS_regional_invaded_asian_exdet_weight * as.numeric(AUC_values[3, 2])


# convert to vector

MTSS_CMIP6_weights <- c(MTSS_regional_native_exdet_weight, MTSS_regional_invaded_exdet_weight, MTSS_regional_invaded_asian_exdet_weight)


```

Now, I will take the weighted mean

```{r weighted mean of CMIP6 thresh values}

MTSS_CMIP6_thresh <- stats::weighted.mean(
  x = MTSS_all,
  w = MTSS_CMIP6_weights
)

```

I need to repeat the above operations for the MTP thresholds as well. I will then put all of these thresholds into a table and save it in the ensemble folder.

### MTP

```{r weights for hist rasters- MTP}

# 1. Extract all values from pred rasters that match the respective model threshold value.

MTP_regional_native_hist_coords <- pred_hist_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTP_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_hist_coords <- pred_hist_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTP_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_asian_hist_coords <- pred_hist_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTP_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTP_regional_native_exdet_weight <- terra::extract(exdet_weight_hist_stack, y = MTP_regional_native_hist_coords)
# tidy
MTP_regional_native_exdet_weight <- MTP_regional_native_exdet_weight %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTP_regional_invaded_exdet_weight <-  terra::extract(exdet_weight_hist_stack, y = MTP_regional_invaded_hist_coords)
# tidy
MTP_regional_invaded_exdet_weight <- MTP_regional_invaded_exdet_weight %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTP_regional_invaded_asian_exdet_weight <- terra::extract(exdet_weight_hist_stack, y = MTP_regional_invaded_asian_hist_coords) 
# tidy
MTP_regional_invaded_asian_exdet_weight <- MTP_regional_invaded_asian_exdet_weight %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTP_regional_native_exdet_weight <- MTP_regional_native_exdet_weight * as.numeric(AUC_values[1, 2])

MTP_regional_invaded_exdet_weight <- MTP_regional_invaded_exdet_weight * as.numeric(AUC_values[2, 2])

MTP_regional_invaded_asian_exdet_weight <- MTP_regional_invaded_asian_exdet_weight * as.numeric(AUC_values[3, 2])


# convert to vector

MTP_hist_weights <- c(MTP_regional_native_exdet_weight, MTP_regional_invaded_exdet_weight, MTP_regional_invaded_asian_exdet_weight)


```

```{r weighted mean of hist thresh values- MTP}

MTP_hist_thresh <- stats::weighted.mean(
  x = MTP_all,
  w = MTP_hist_weights
)

```

```{r weights for CMIP6 rasters- MTP}

# 1. Extract all values from pred rasters that match the respective model threshold value.

MTP_regional_native_CMIP6_coords <- pred_CMIP6_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTP_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_CMIP6_coords <- pred_CMIP6_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTP_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_asian_CMIP6_coords <- pred_CMIP6_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTP_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTP_regional_native_exdet_weight <- terra::extract(exdet_weight_CMIP6_stack, y = MTP_regional_native_CMIP6_coords)
# tidy
MTP_regional_native_exdet_weight <- MTP_regional_native_exdet_weight %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTP_regional_invaded_exdet_weight <-  terra::extract(exdet_weight_CMIP6_stack, y = MTP_regional_invaded_CMIP6_coords)
# tidy
MTP_regional_invaded_exdet_weight <- MTP_regional_invaded_exdet_weight %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTP_regional_invaded_asian_exdet_weight <- terra::extract(exdet_weight_CMIP6_stack, y = MTP_regional_invaded_asian_CMIP6_coords) 
# tidy
MTP_regional_invaded_asian_exdet_weight <- MTP_regional_invaded_asian_exdet_weight %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTP_regional_native_exdet_weight <- MTP_regional_native_exdet_weight * as.numeric(AUC_values[1, 2])

MTP_regional_invaded_exdet_weight <- MTP_regional_invaded_exdet_weight * as.numeric(AUC_values[2, 2])

MTP_regional_invaded_asian_exdet_weight <- MTP_regional_invaded_asian_exdet_weight * as.numeric(AUC_values[3, 2])


# convert to vector

MTP_CMIP6_weights <- c(MTP_regional_native_exdet_weight, MTP_regional_invaded_exdet_weight, MTP_regional_invaded_asian_exdet_weight)


```

```{r weighted mean of CMIP6 thresh values- MTP}

MTP_CMIP6_thresh <- stats::weighted.mean(
  x = MTP_all,
  w = MTP_CMIP6_weights
)

```

## Combine in table and export

Now, I can create a table for these thresholds and export these data.

```{r table of ensemble threshold values}

ensemble_thresh_values <- tibble(
  thresh = c("MTP", "MTP", "MTSS", "MTSS"),
  time_period = c("1981-2010", "2041-2070", "1981-2010", "2041-2070"),
  CMIP6_model = c(NA, "ssp370_GFDL", NA, "ssp370_GFDL"),
  value = c(MTP_hist_thresh, MTP_CMIP6_thresh, MTSS_hist_thresh, MTSS_CMIP6_thresh)
)

```

```{r export table}

write_csv(ensemble_thresh_values, file = file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_threshold_values.csv"))

```

Now that I have the suitability values and thresholds ensembled, I can begin to analyze the differences between the global and regional ensemble predictions. I will begin by creating suitability maps in the next vignette.

# Appendix

## Unweighted mean ensemble

The weighted mean ensemble is more rigorous because it considers climatic extrapolation and goodness of fit in how it combines the models. However, I will also include the code to create an unweighted ensemble, in the event that someone preferred that over the weighted ensemble.

```{r unweighted mean pred rasters}

# historical
pred_hist_mean <- terra::app(
  x = pred_hist_stack,
  fun = "mean",
  filename = file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_regional_unweighted_mean_globe_1981-2010.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)

# CMIP6
pred_CMIP6_mean <- terra::app(
  x = pred_CMIP6_stack,
  fun = "mean",
  filename = file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_regional_unweighted_mean_globe_2041-2070_GFDL_ssp370.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)

```

I will also take the mean of the MTSS and MTP thresholds

```{r unweighted mean of thresholds}

#take means
MTSS_mean_unweighted <- mean(MTSS_all)
MTP_mean_unweighted <- mean(MTP_all)

# put into table
ensemble_thresh_values_unweighted <- tibble(
  thresh = c("MTP", "MTSS"),
  value = c(MTP_mean_unweighted, MTSS_mean_unweighted)
)

```

```{r export table}

write_csv(ensemble_thresh_values_unweighted, file = file.path(mypath, "models", "slf_regional_ensemble_v0", "ensemble_threshold_values_unweighted.csv"))

```

## test

I wanted to test if the weighted.mean function normalizes weights to 1. My weights sum to above 1 so I wanted to make sure they normalize.

```{r test to ensure weights worked}

test_raster <- exdet_hist_stack
values(test_raster) <- 2

minmax(pred_hist_stack)

# weighted mean
test_weighted <- terra::weighted.mean(
  x = pred_hist_stack,
  w = test_raster # all cell weights are 2
)

minmax(test_weighted)

# just take the mean
test_unweighted <- terra::app(
  x = pred_hist_stack,
  fun = "mean" 
)

minmax(test_unweighted)





# also try with different weights
values(test_raster[[1]]) <- 0.33
values(test_raster[[2]]) <- 0.52
values(test_raster[[3]]) <- 0.15

# weighted mean
test_weighted <- terra::weighted.mean(
  x = pred_hist_stack,
  w = test_raster # all cell weights are 2
)

minmax(test_weighted)

# just take the mean
test_unweighted <- terra::app(
  x = pred_hist_stack,
  fun = "mean" 
)

minmax(test_unweighted)

```

I think they do because the weighted.mean was the same as the mean when the weights were kept equal proportionally to each other, but summed to over 1.

# References

Araújo, M. B., and M. New. 2007. Ensemble forecasting of species distributions. Trends in Ecology & Evolution 22:42–47.

Mesgaran, M. B., R. D. Cousens, and B. L. Webber. 2014. Here be dragons: a tool for quantifying novelty due to covariate range and correlation change when projecting species distribution models. Diversity and Distributions 20:1147–1159.

