---
title: "Predict xy Suitability From Model- workflow (chapter 1)"
author: "Samuel M. Owens"
date: "2024-01-18"
output: html_document
---

*Note* This vignette is an example of the workflow for the function within this package called `slfSpread::predict_xy_suitability()`, which is used in vignette 050 to obtain output from the model. This vignette does not need to be run to obtain the final results of the workflow. 

I will get projected suitability values, calculated on the cloglog scale (between 0 and 1) for each of the SLF presence points. These suitability values will be added back to the original data frame and saved. First, I will use `SDMtune::prepareSWD()` to extract raster values from each layer used to build the model. I will save this output.

```{r isolate values for SLF points using global covariates}

mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_global_ch1")

# load in all slf points
slf_presences <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "slf_all_final_coords_2024-01-05.csv")) %>%
  dplyr::select(-species)

# get SWD object containing point location data from rasters
slf_presences_withdata <- SDMtune::prepareSWD(species = "Lycorma delicatula",
                                     env = x_global_env_covariates,
                                     p = slf_presences,
                                     verbose = TRUE # print helpful messages
                                     )

# save to file
SDMtune::swd2csv(slf_presences_withdata, file_name = file.path(mypath, "global_slf_all_coords_with_data_1981-2010.csv"))

```

Sometimes, the `SDMtune::prepareSWD()` function will leave out presence points when collecting raster data. I need to figure out which presences were left out and tidy the data to be fed into the predict function.

```{r format data for prediction and reconcile missing points}

# read data in again
slf_presences_tidy <- read_csv(file = file.path(mypath, "global_slf_all_coords_with_data_1981-2010.csv")) %>%
  rename("x" = "X",
         "y" = "Y")

# join with original SLF presences dataset to find presences with no data
slf_presences_nodata <- anti_join(x = slf_presences, y = slf_presences_tidy, by = c("x", "y"))
# write to csv 
write_csv(x = slf_presences_nodata, file = file.path(file.path(mypath, "global_slf_all_coords_no_data_1981-2010.csv")))

# tidy dataset for sdmtune::predict
slf_presences_withdata_tidy <- semi_join(x = slf_presences_tidy, y = slf_presences, by = c("x", "y")) %>%
  # select only necessary columns
  dplyr::select(5:length(.))

```

Now that the data have been formatted correctly, I will apply the predict function. This function returns only a 1-column dataframe of a suitability value per presence, so I need to join it with the original dataset using `cbind` and save that output.

```{r prediction for SLF presences}

# make predictions
slf_presences_predict <- SDMtune::predict(
  object = global_model, # model
  data = slf_presences_withdata_tidy, # data for prediction
  fun = "mean", # function to be applied
  type = "cloglog", # default for MaxEnt
  clamp = FALSE, # dont do clamping to restrict predictions
  progress = TRUE # progress bar
) %>%
  as.data.frame() %>%
  rename("cloglog_suitability" = ".")


# bind predictions with tidy dataset
slf_presences_predict <- cbind(slf_presences_predict, slf_presences_tidy) %>%
  # select only necessary data
  dplyr::select(Species, x, y, cloglog_suitability)

# save output
write_csv(x = slf_presences_predict, file = file.path(mypath, "global_slf_all_coords_predicted_suitability_mean_1981-2010.csv"))

```
