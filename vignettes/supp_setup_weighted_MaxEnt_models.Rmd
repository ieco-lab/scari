---
title: "Setup invaded regional maxent models using weighting technique"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-01-05"
output: html_document
---

# Setup

I will prepare for this vignette by loading the necessary packages to run this script. I will also be creating maps during this analysis, so I will create a list object containing a standardized map style that I will continue to use.

```{r load necesssary packages, echo = FALSE}

# general tools
library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here() # here() starts at the root folder of this package.
library(devtools)

library(dismo) # generate random background points

# spatial data handling
library(raster) 
library(terra)
library(sf)

# spatial data sources
library(rnaturalearth)
# remotes::install_github("ropensci/rnaturalearthhires")
library(rnaturalearthhires)

# aesthetics
# devtools::install_github("slowkow/ggrepel")
library(ggrepel)

```

```{r ggplot object for map style}

map_style <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "lightblue2",
                                        colour = "lightblue2")
  ),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  labs(fill = "Suitability for SLF"),
  viridis::scale_fill_viridis(option = "D"),
  coord_equal()
)

```

# Use weighting technique to choose background points

## Invaded Regional (eastern USA)

Gallien et.al found that their regional model of the invaded range performed better when the background point were weighted by the output of the global model. As stated earlier, this also accounts for the fact that SLF has not had an adequate change to reach all potentially suitable areas. So, as part of the preparation for creating the regional model, we need to create a background dataset (just like we did for the global model), but we also need to weight those points by the cloglog suitability output from the global model. However, the SDMtune package does not allow weights to be attributed to pseudo-absences in the MaxEnt algorithm (nor do any packages I have seen, Gallien was performing other types of models that may integrate this function.). So, my work-around is to apply a weighting formula to the entire suitability raster from the global model and choose the background points based on this weight. The end result should be that there are more points selected where suitability for SLF is lower. 

Gallien et.al provided the following inverse logarithmic weighting formula:

$$
weight = \frac{1}{1 + (\frac{suitG}{suitG-1})^2}
$$

"suitG" indicates the suitability value in the global model. I will apply this formula to the mean suitability output from the global model.

To do that, I will use the `terra::app` function to convert the global mean raster to a list of suitability values at the cell value level. Then I will use the `dismo::randomPoints()` function again, but will give it the raster of weighted suitability values so that it chooses values according to the weight. 

First I will load in the global raster output. I will also load in the slf_points dataset for sampling

```{r set wd}

# path to directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent")

```

```{r load in global model predictions}

# load in averaged global output
global_mean <- terra::rast(x = file.path(mypath, "models", "slf_global_v2", "global_pred_suit_clamped_cloglog_NAmerica_1981-2010_mean.asc"))
# also convert to df
global_mean_df <- terra::as.data.frame(global_mean, xy = TRUE)

# slf points
slf_points <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "slf_all_final_coords_2024-02-01.csv")) %>%
   dplyr::select(-species) 

# mask layer I will use
mask_layer <- raster::raster(x = file.path(mypath, "historical_climate_rasters", "chelsa2.1_30arcsec", "v1_maxent_10km", "atc_2015_NAmerica.asc"))

```

Now I need to transform each raster cell according to the weighting formula. I wrote a function to do this called `slfSpread::weight_model_output`.

```{r apply weighting function}

global_mean_weighted <- terra::app(
  x = global_mean,
  fun = slfSpread::weight_model_output
)

# get name
names(global_mean_weighted)
# change layer name
names(global_mean_weighted) <- "weight"

```

```{r save}

# write to file
terra::writeRaster(
  x = global_mean_weighted, 
  filename = file.path(mypath, "models", "working_dir", "global_v2_pred_suit_clamped_cloglog_NAmerica_1981-2010_mean_weighted.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
  )

```

The function will also work on numbers, so I can just give it a range of decimals from 0-1. It should nearly reverse the values if it is working properly. The minmax of each raster should be about 0-1. 

```{r validation}

# this function acts like a math formula, so it should work on numbers. It should work to reverse the order of values from 0 - 1. A 1 suitability should be a 0 weighted suitability
weight_model_output(1)
weight_model_output(0.6)
weight_model_output(0.4)
weight_model_output(0)

# the minmax should also be 0 - 1 in both cases
minmax(global_mean)
minmax(global_mean_weighted)

```

Now, I will sample the raster. I will still correct for the latitudinal stretching of the grid cells and exclude cells containing presences, as before. First, I will need to load in the rasters using the `raster` package for `dismo` compatibility.

```{r load weighted raster and crop}
 
# ext object for eastern USA
ext.obj <- raster::extent(-96.503906, -59.589844, 23.5, 47.457809)

# I will load in the raster and crop it to the training area extent.
global_mean_weighted <- raster::raster(
  x = file.path(mypath, "models", "working_dir", "global_v2_pred_suit_clamped_cloglog_NAmerica_1981-2010_mean_weighted.asc")
  ) %>%
  raster::mask(x = ., mask = mask_layer) %>%
  raster::crop(x = ., y = ext.obj) # crop to EasternUSA

  
# also conver to df
global_mean_weighted_df <- raster::as.data.frame(global_mean_weighted, xy = TRUE)

```

Now, select random points. These will be corrected for the latitudinal stretching and will not be selected from presence locations, like with the global model. However, these points will be selected based on a probability (that we created above), unlike the global background points.

```{r random points}

# set seed
set.seed(5)

# generate random points 
regional_points <- dismo::randomPoints(
  mask = global_mean_weighted, # cropped to eastern USA
  n = 10000, # default number used by maxent
  p = slf_points,
  excludep = TRUE, # exclude cells where slf has been found
  prob = TRUE,  # the raster contains probability weights
  lonlatCorrection = TRUE, # weight samples by latitude because cell size is larger closer to equator
  warn = 2 # higher number gives most warnings, including if sample size not reached
  ) %>%
  as.data.frame(.)

# save as csv
write_csv(x = regional_points, file = file.path(here(), "vignette-outputs", "data-tables", "regional_invaded_background_points_v3.csv"))
# save as rds file
write_rds(regional_points, file = file.path(here(), "data", "regional_invaded_background_points_v3.rds"))

```

Now lets visualize the result.

```{r load in raster for plotting}

easternUSA <- terra::rast(
  x = file.path(mypath, "historical_climate_rasters", "chelsa2.1_30arcsec", "v1_maxent_10km", "atc_2015_easternUSA.asc")
  )

# also convert to df
easternUSA_df <- terra::as.data.frame(easternUSA, xy = TRUE)

regional_points <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "regional_invaded_background_points_v3.csv"))

```

```{r plot}

# plot at the continental scale
(regional_points_plot <- ggplot() +
   geom_raster(data = global_mean_df, aes(x = x, y = y), fill = "azure4") +
   geom_raster(data = easternUSA_df, aes(x = x, y = y), fill = "azure1") +
   geom_point(data = regional_points, aes(x = x, y = y), color = "firebrick2", size = 0.001) +
   ggtitle("'regional_invaded' model background points") +
   labs(caption = "point selection was weighted by the 'global_model' suitability predictions") +
   map_style +
   theme(legend.position = "none") 
)

```

We can see that the background points are isolated to the eastern half of the United States and some of Canada. This is what we want because the model will be trained on this area. We can also see that points were selected from areas where the model did not predict high suitability (most highly suitable areas were near PA and NJ). For comparison, this figure is roughly opposite of the figure depicting the suitability values for the mean output from the global model.  

```{r save plot}

ggsave(regional_points_plot, 
       filename = file.path(here(), "vignette-outputs", "figures", "regional_invaded_model_background_points_v3.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina"
       )

```



# References

Calvin, D. D., J. Rost, J. Keller, S. Crawford, B. Walsh, M. Bosold, and J. Urban. 2023. Seasonal activity of spotted lanternfly (Hemiptera: Fulgoridae), in Southeast Pennsylvania. Environmental Entomology 52:1108–1125.

Du, Z., Y. Wu, Z. Chen, L. Cao, T. Ishikawa, S. Kamitani, T. Sota, F. Song, L. Tian, W. Cai, and H. Li. 2021. Global phylogeography and invasion history of the spotted lanternfly revealed by mitochondrial phylogenomics. Evolutionary Applications.

Gallien, L., R. Douzet, S. Pratte, N. E. Zimmermann, and W. Thuiller. 2012. Invasive species distribution models – how violating the equilibrium assumption can create new insights. Global Ecology and Biogeography 21:1126–1136.

Lewkiewicz, S. M., S. De Bona, M. R. Helmus, and B. Seibold. 2022. Temperature sensitivity of pest reproductive numbers in age-structured PDE models, with a focus on the invasive spotted lanternfly. Journal of Mathematical Biology 85:29.

Santana Jr, P. A., L. Kumar, R. S. Da Silva, J. L. Pereira, and M. C. Picanço. 2019. Assessing the impact of climate change on the worldwide distribution of Dalbulus maidis (DeLong) using MaxEnt. Pest Management Science 75:2706–2715.

Xin, B., Y. Zhang, X. Wang, L. Cao, K. A. Hoelmer, H. J. Broadley, and J. R. Gould. 2020. Exploratory survey of spotted lanternfly (Hemiptera: Fulgoridae) and its natural enemies in China. Environmental Entomology 50:36–45.



