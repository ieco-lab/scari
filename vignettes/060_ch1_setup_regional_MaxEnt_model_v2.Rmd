---
title: "Setup for global and invaded regional MaxEnt Models (chapter 1)"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-01-05"
output: html_document
---
# Overview

In the previous vignette, I retrieved and formatted rasters of 24 global-scale climate and human impact variables from [CHELSA](https://chelsa-climate.org/). These represent some of the most relevant variables for the accomplishment of my goal, which is to explain the distribution for Lycorma delicatula according to climate. I also retrieved climate change versions of these variables, created by the [CMIP6](https://pcmdi.llnl.gov/CMIP6/) climate modeling project. These variables were standardized and formatted for my needs. Additionally, the most relevant variables were chosen for all future models. The goal is to produce two models for chapter 1, a global model and an invaded regional model, both based on historical climate data. The global model will consider and be trained on all available climate data, while the regional model will be trained the subset of climate data from the SLF invaded range in the Eastern half of the United States (easternUSA). Both of these models will then be projected for climate change.

In this vignette, I will crop the rasters that were retrieved and tidied in the previous vignette to the relevant spatial scale. I will crop the historical versions of these rasters to both the Eastern USA and North America. The easternUSA rasters will be used to train the regional version of the global model. The North America rasters will only be used to produce map outputs of the model's predictions (projection). The CMIP6 rasters will only be cropped to North America; I only need to project the historical global and regional models for climate change, so there is no need to train separate climate change models (nor would this make sense). Lastly, I will select the background point datasets for both the global and regional models. MaxEnt uses these points to calculate an equation that describes the relationship of SLF with its environment and predict suitability (the model output).

```{r extents table}

extents <- data.frame(
  "spatial_extent" = c("global model training", "regional model training", "projection"),
  "long_min" = c(-180, -96.504, -140.977),
  "long_max" = c(179, -59.590, -51.064),
  "lat_min" = c(-60, 23.5, 15.182),
  "lat_max" = c(83, 47.458, 60.589)
)

extents_kable <- knitr::kable(x = extents)
  
```

# Setup

I will prepare for this vignette by loading the necessary packages to run this script. I will also be creating maps during this analysis, so I will create a list object containing a standardized map style that I will continue to use.

```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation

library(here) #making directory pathways easier on different instances
here()
# here() starts at the root folder of this package.

library(devtools)
library(dismo) # generate random background points

# spatial data handling
library(raster) 
library(terra)

# aesthetics
library(viridis)

```

# 1. Trim Bioclim layers

## Historical- eastern USA

First, I will need to create a few copies of the bioclim layers that I tidied in the last vignette. I will create a set that have been cropped only to the eastern USA, which will be used to train the invaded regional models I produce.

These rasters will be used for model training. In this chunk, I will extract the names and file paths for the desired rasters and set the extent. I am also cropping "access to cities" because some future models may include it.

```{r set wd}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/historical_climate_rasters/chelsa2.1_30arcsec/v1_maxent_10km")

```

```{r setup for cropping bioclim layers}

# lists of target files in the directory
# load in bioclim layers to be cropped- the 10km .asc files
env.files <- list.files(path = file.path(mypath), pattern = "\\.asc$", full.names = TRUE) %>%
# extract the 4 bioclim layers I will be using in my models. Access to cities will not be used until later models
  grep("atc_2015_global.asc|bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE)

# output file names
output.files <- list.files(path = file.path(mypath), pattern = "\\.asc$", full.names = FALSE) %>%
  grep("atc_2015_global|bio2_1981-2010_global|bio11_1981-2010_global|bio12_1981-2010_global|bio15_1981-2010_global", ., value = TRUE) %>%
  gsub(pattern = "global", replacement = "easternUSA")

# extent object for eastern USA
ext.obj <- terra::ext(-96.503906, -59.589844, 23.5, 47.457809)

```

These rasters need to be cropped and converted to the .ascii format for MaxEnt.

```{r loop to crop bioclim layers to eastern N america}

# view list of filetypes for terra, use .ascii
View(terra::gdal(drivers = TRUE))

if(FALSE) {
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    
    # crop new rasters to extent
    rast.hold <- terra::crop(x = rast.hold, y = ext.obj, overwrite = FALSE)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, output.files[a]), filetype = "AAIGrid", overwrite = FALSE)
    
    # remove object once its done
    rm(rast.hold)
    
  }
  
}

# I am pretty sure this method resets the raster cell numbers, which might be annoying downstream....

```

Lets plot one of the new layers to make sure the cropping worked.

```{r plot main_layer to ensure cropping worked}

bio11 <- terra::rast(x = file.path(mypath, "bio11_1981-2010_easternUSA.asc")) 
# convert to df
bio11_df <- terra::as.data.frame(bio11, xy = TRUE)

# plot main layer as example
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = bio11_df, 
            aes(x = x, y = y, fill = `CHELSA_bio11_1981-2010_V.2.1`)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)
# the cropping worked

```

The rasters look good!


# 2. Background point choice

## Invaded Regional Model (eastern USA)

`THIS SHOULD BE BASED ON THE WEIGHTED MODEL OUTPUT`

load in global model output

```{r load in global model predictions}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/models/slf_global_ch1")

# load in averaged global output
global_mean <- terra::rast(x = file.path(mypath, "global_predicted_suitability_NAmerica_1981-2010_projected_mean.asc"))

```


transform global model output using terra::app

```{r apply weighting function}

global_mean_weighted <- terra::app(
  x = global_mean,
  fun = weight_model_output,
  filename = file.path(mypath, "global_predicted_suitability_NAmerica_1981-2010_projected_mean_weighted.asc"),
  overwrite = FALSE
)

# also convert to df
global_mean_weighted_df <- as.data.frame(global_mean_weighted, xy = TRUE) 

# rename
colnames(global_mean_weighted_df) <- c("x", "y", "weights")

```

validation

```{r validation}

# this function acts like a math formula, so it should work on numbers. It should work to reverse the order of values from 0 - 1
weight_model_output(1)
weight_model_output(0.6)
weight_model_output(0.4)
weight_model_output(0)

# the minmax should also be 0 - 1 in both cases
minmax(global_mean)
minmax(global_mean_weighted)

```

load in rasters for sampling

```{r}

# path to directory
mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/historical_climate_rasters/chelsa2.1_30arcsec")

# the env covariates used to project to N America
x_NAmerica_hist_env_covariates_list <- list.files(path = file.path(mypath, "v1_maxent_10km"), pattern = "\\_NAmerica.asc$", full.names = TRUE) %>%
  # dont include Access to cities
  grep(pattern = "atc_2015", value = TRUE, invert = TRUE)

# load in rasters
x_NAmerica_hist_env_covariates <- terra::rast(x = x_NAmerica_hist_env_covariates_list)

```


```{r spatsample}



```


I will also select a set of background points for the invaded regional model. I will select only half as many points (10,000) to account for the decrease in the overall training area.

```{r background points for invaded regional models}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_30arcsec/v1_maxent_10km")

# load in reference layer. needs to be done with raster package because dismo doesnt recognize terra package objects
easternUSA_bio2 <- raster::raster(x = file.path(mypath, "bio2_1981-2010_easternUSA.asc"))
# check number of cells
terra::ncell(easternUSA_bio2)
# plenty of cells to work with if we remove those with SLF points

# set seed so that the random points for this dataset are the same the next time this code is run
set.seed(2)
# generate random points 
easternUSA_points <- dismo::randomPoints(
  mask = easternUSA_bio2, 
  n = 10000, # default number used by maxent
  p = slf_points,
  excludep = TRUE, # exclude cells where slf has been found
  lonlatCorrection = TRUE, # weight samples by latitude because cell size is larger closer to equator
  warn = 2 # higher number gives most warnings, including if sample size not reached
  ) %>%
  as.data.frame(.)

# save as csv
write_csv(x = easternUSA_points, file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_background_points.csv"))
# save as rda file
save(easternUSA_points, file = file.path(here(), "data", "easternUSA_background_points.csv"))
  
  
```

Now, I will plot these points for visualization purposes.

```{r load in files for plotting}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_30arcsec/v1_maxent_10km")

easternUSA_bio2_df <- terra::rast(x = file.path(mypath, "bio2_1981-2010_easternUSA.asc")) %>%
  terra::as.data.frame(., xy = TRUE)

easternUSA_points <- read_csv(file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_background_points.csv"))

```

```{r plot points}

easternUSA_points_plot <- ggplot() +
    geom_raster(data = easternUSA_bio2_df, aes(x = x, y = y), fill = "azure1") +
    geom_point(data = easternUSA_points, aes(x = x, y = y), color = "darkorange", size = 0.5) +
    ggtitle("Eastern USA background points") +
    map_style +
    theme(legend.position = "none") 

```

The points cover the extent of the regional study area, so this will be sufficient for our analysis.

```{r save plot}

ggsave(easternUSA_points_plot, 
       filename = file.path(here(), "vignette-outputs", "figures", "easternUSA_background_points.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```


# References

D.D Calvin, J. Rost, J. Keller, S. Crawford, Julie Urban, B. Walsh, and M. Bosold. Seasonal Activity of Spotted Lanternfly, Lycorma delicatula (White) (Hemiptera: Fulgoridae), in Southeast Pennsylvania. Unpublished.

Gallien, L., R. Douzet, S. Pratte, N. E. Zimmermann, and W. Thuiller. 2012. Invasive species distribution models – how violating the equilibrium assumption can create new insights. Global Ecology and Biogeography 21:1126–1136.

Lewkiewicz, S. M., S. De Bona, M. R. Helmus, and B. Seibold. 2022. Temperature sensitivity of pest reproductive numbers in age-structured PDE models, with a focus on the invasive spotted lanternfly. Journal of Mathematical Biology 85:29.

Santana Jr, P. A., L. Kumar, R. S. Da Silva, J. L. Pereira, and M. C. Picanço. 2019. Assessing the impact of climate change on the worldwide distribution of Dalbulus maidis (DeLong) using MaxEnt. Pest Management Science 75:2706–2715.



