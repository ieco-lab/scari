---
title: "Map regional ensemble predictions and intercept with global model"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-04-26"
output: html_document
---
# Overview

EDIT

OUTLINE
1. suitability maps (thresholded) of the regional ensemble
2. binarized overlap between the regional and global models





In this vignette, I will compare known SLF presences with the predicted SLF suitability to infer an "invasion stage" for each point. This will be done by extracting the predicted suitability values at each known SLF point from both models. I will then binarize these rasters (suitable/unsuitable) and use these versions to infer the level of range filling and invasion stage of the points. I ran two trial models, v5_global and v5_regional that will be used to build this analysis. 

For my analysis, I need to compare the predictions of both the regional and global models in the invaded region. I will begin by comparing the performance of each model at each point across the invaded range. Gallien et.al did this for both observed presences and pseudo-absences ("background points"), but in this vignette I will only use known SLF presences. The extracted values of the points were used to produce a boxplot of predicted suitability for the global vs the regional model. I will create a boxplot of the values and plot the points over the rasters

Next, I will need to infer the amount of range filling and invasion stage of SLF according to each model. In Gallien et.al, this was done by binarizing each raster and overlaying them. The raster values are summed I will then overlay known SLF presences.  There are a few steps to this process:

1. Create suitable vs unsuitable classes based on the range of values in each raster (likely the suitability threshold rule chosen in MaxEnt, MTP).
2. Convert each output to binary (suitable/unsuitable) based on these suitability thresholds 
2. Mosaic the rasters and sum their values.
2. Re-classify summed raster as areas where both agree on presence, both agree on absence, or one classifies and the other classifies absent (4 total categories)




# Setup

```{r load necesssary packages, echo = FALSE}

# general tools
library(tidyverse)  #data manipulation
library(here) #making directory pathways easier on different instances
here::here() # here() starts at the root folder of this package.
library(devtools)

# spatial data handling
library(terra) 
library(scrubr)

library(viridis)

```

I will load in preset styles for the maps. The regular map_style will be for the continuous suitability maps, while map_style_binarized will be used for specialized binary overlay maps between the regional ensemble and the global models.

```{r map style}

map_style <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(
    # legend
    legend.position = "bottom",
    legend.title = element_text(margin = margin(r = 15, b = 45), hjust = 1),
    legend.text = element_text(margin = margin(t = 10), angle = 25),
    # background
    panel.background = element_rect(fill = "lightblue2",
                                        colour = "lightblue2")
  ),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  labs(fill = "Suitability for SLF \n(cloglog)"),
  coord_equal()
)

```

```{r map style binarized}

map_style_binarized <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(
    # legend
    legend.position = "bottom",
    # background
    panel.background = element_rect(fill = "lightblue2",
                                        colour = "lightblue2")
  ),
  scale_x_continuous(expand = c(0, 0)),
  scale_y_continuous(expand = c(0, 0)),
  coord_equal()
)

```

```{r set wd}

mypath <- file.path(here::here() %>% 
                       dirname(),
                     "maxent/models")

```

# Import datasets

## regional ensemble

```{r ensemble rasters}

regional_ensemble_1995 <- terra::rast(
  x = file.path(mypath, "slf_regional_ensemble_v0", "ensemble_regional_weighted_mean_globe_1981-2010.asc")
  )

regional_ensemble_2055 <- terra::rast(
  x = file.path(mypath, "slf_regional_ensemble_v0", "ensemble_regional_weighted_mean_globe_2041-2070_GFDL_ssp370.asc")
  )

# change names
names(regional_ensemble_1995) <- "ensemble_suitability"
names(regional_ensemble_2055) <- "ensemble_suitability"

# also convert to df
regional_ensemble_1995_df <- terra::as.data.frame(regional_ensemble_1995, xy = TRUE)
regional_ensemble_2055_df <- terra::as.data.frame(regional_ensemble_2055, xy = TRUE)

```

```{r ensemble thresholds}

regional_ensemble_thresholds <- read_csv(file = file.path(mypath, "slf_regional_ensemble_v0", "ensemble_threshold_values.csv"))

```

## Global model

```{r global model rasters}

global_1995 <- terra::rast(
  x = file.path(mypath, "slf_global_v2", "global_pred_suit_clamped_cloglog_globe_1981-2010_mean.asc")
  )

global_2055 <- terra::rast(
  x = file.path(mypath, "slf_global_v2", "global_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370_mean.asc")
  )

# change names
names(global_1995) <- "global_suitability"
names(global_2055) <- "global_suitability"

# also convert to df
global_1995_df <- terra::as.data.frame(global_1995, xy = TRUE)
global_2055_df <- terra::as.data.frame(global_2055, xy = TRUE)

```

```{r summary file}

summary_global <- read_csv(file.path(mypath, "slf_global_v2", "global_summary_all_iterations.csv")) %>%
  dplyr::select(., statistic, mean)

```



# 1. Map regional ensemble

First, I will create general suitability maps of the regional ensemble I created in the previous vignette. These maps will depict the weighted suitability values, but will also threshold the map using the calculated MTP and MTSS thresholds. Anything unsuitable will be depicted in dark grey, anything suitable above the MTP threshold in light grey, and the suitable above the MTSS threshold in a color ramp.

```{r map regional ensemble: 1981-2010}

regional_ensemble_1995_plot <- ggplot() +
  # plot raster
  geom_raster(data = regional_ensemble_1995_df, aes(x = x, y = y, fill = ensemble_suitability)) +
  # aesthetics
  scale_fill_gradientn(
    # the values of the color divisions: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    values = c(
      0, # minimum
      as.numeric(regional_ensemble_thresholds[1, 3]), # MTP thresh
      as.numeric(regional_ensemble_thresholds[1, 3]) + 0.0000001, # some small amount more than the MTP
      as.numeric(regional_ensemble_thresholds[1, 4]), # MTSS thresh
      as.numeric(regional_ensemble_thresholds[1, 4]) + 0.0000001,
      # the rest
      0.5,
      0.75,
      1
      ),
    # these colors taken from viridis color scale D
    # the colors for the divisions in the order: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    colors = c("azure4", "azure4", "azure2", "azure2", "#481567FF", "#2D708EFF", "#3CBB75FF", "#FDE725FF"),
    # the tick marks
    breaks = c(0, as.numeric(regional_ensemble_thresholds[1, 3]), as.numeric(regional_ensemble_thresholds[1, 4]), 0.5, 0.75, 1.00),
    # labels for the tick marks
    labels = c("unsuitable", "", "MTSS thresh", 0.5, 0.75, 1),
    limits = c(0, 1.0),
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20, draw.ulim = TRUE, draw.llim = TRUE)
    ) +
  # labs
  labs(
    title = "Suitability for SLF in regional model ensemble",
    subtitle = "",
    caption = "MTP & MTSS thresholds | clamped"
    ) +
  # default style
  map_style

```

```{r save plot}

ggsave(
  regional_ensemble_1995_plot,
  filename = file.path(mypath, "slf_regional_ensemble_v0", "plots", "regional_ensemble_pred_suit_globe_1981-2010.jpg"),
  height = 8,
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```

Now, I will map the predictions for 2041-2070

```{r map regional ensemble: 2041-2070}

# I had to change the row call of the thresholds tibble to row 2 [2, x]

regional_ensemble_2055_plot <- ggplot() +
  # plot raster
  geom_raster(data = regional_ensemble_2055_df, aes(x = x, y = y, fill = ensemble_suitability)) +
  # aesthetics
  scale_fill_gradientn(
    # the values of the color divisions: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    values = c(
      0, # minimum
      as.numeric(regional_ensemble_thresholds[2, 3]), # MTP thresh
      as.numeric(regional_ensemble_thresholds[2, 3]) + 0.0000001, # some small amount more than the MTP
      as.numeric(regional_ensemble_thresholds[2, 4]), # MTSS thresh
      as.numeric(regional_ensemble_thresholds[2, 4]) + 0.0000001,
      # the rest
      0.5,
      0.75,
      1
      ),
    # these colors taken from viridis color scale D
    # the colors for the divisions in the order: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    colors = c("azure4", "azure4", "azure2", "azure2", "#481567FF", "#2D708EFF", "#3CBB75FF", "#FDE725FF"),
    # the tick marks
    breaks = c(0, as.numeric(regional_ensemble_thresholds[2, 3]), as.numeric(regional_ensemble_thresholds[2, 4]), 0.5, 0.75, 1.00),
    # labels for the tick marks
    labels = c("unsuitable", "", "MTSS thresh", 0.5, 0.75, 1),
    limits = c(0, 1.0),
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20, draw.ulim = TRUE, draw.llim = TRUE)
    ) +
  # labs
  labs(
    title = "Suitability for SLF in regional model ensemble",
    subtitle = "projected to 2041-2070 | ssp3-70 | GFDL",
    caption = "MTP & MTSS thresholds | clamped"
    ) +
  # default style
  map_style

```

```{r save plot}

ggsave(
  regional_ensemble_2055_plot,
  filename = file.path(mypath, "slf_regional_ensemble_v0", "plots", "regional_ensemble_pred_suit_globe_2041-2070_GFDL_ssp370.jpg"),
  height = 8,
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```

# 2. Create binary threshold maps to infer range filling

First, I will create matrix objects that will be used to reclassify the output rasters to a binary predictor of suitability. 0.5 will be the threshold: anything above 0.5 will be considered suitable, while anything below will not be. This threshold is essential for my invasion stage anaylsis further downstream.

To reclassify, package terra takes a 3-column matrix for its "classify" function, which re-classifies groups of values to other values. I will create one for the global model output and one for the regional model output. The reason for having two separate matrices is because I will need to differentiate between a "suitable" spot on the global and regional rasters. Because of this, I will be encoding the rasters into base-2 binary so that the end result is 4 categories of values (the idea for this was found in [this forum](https://gis.stackexchange.com/questions/127055/comparing-and-finding-inaccuracies-in-two-raster-layers)). For the regional raster, I will encode the logistical output of MaxEnt into these values:

*Regional unsuitable = 0-0.079 -> 00000001 = 1
*Regional suitable = 0.0791-1 ->  00000010 = 2

For the global rasters, I will encode the outputs into these values:

*Global unsuitable = 0-0.163 -> 00000100 = 4
*Global suitable = 0.1631-1 ->  00001000 = 8

By encoding the rasters into base-2, I have created only 4 possible values of the raster layers, which can be translated into 4 categories:

*Unsuitable Agreement = 5 (00000101)
*Suitable Agreement = 10 (00001010)
*unsuitable regional/suitable global = 9 (00001001)
*Suitable regional/unsuitable global = 6 (00000110)

I will also interpret these categories in terms of risk of SLF suitability. These categories can be thought of as:

*Unsuitable Agreement = low risk
*Suitable Agreement = high risk
*Suitable regional/unsuitable global = adaptive risk
*unsuitable regional/suitable global = imminent risk

Gallien et al, 2012 interprets these categories in terms of specific ecological mechanisms, but we prefer to interpret them in terms of the risk for SLF.

## convert output rasters to binary predictors

### Time period: 1981-2010

To convert the rasters to binary predictors of presence / absence, first I will create the classification matrices needed by the `terra` package. Before converting, lets check the range of values.

```{r minmax of rasters}

# get the range of the values in the raster
terra::minmax(global_1995) %>%
  format(., scientific = FALSE) # convert scientific notation to decimals


# get the range of the values in the raster
terra::minmax(regional_ensemble_1995) %>%
  format(., scientific = FALSE)

# all looks good

```

Now I will create the classification rasters. The lower range of what is considered suitable will be determined by the "Maximum Test Sensitivity Plus Specificity" threshold given in the Maxent output. I will pull these from their respective .csv files.

```{r terra required classification matrices}

# create regional suitability value matrix for terra
regional_ensemble_classes <- data.frame(
  from = c(0, as.numeric(regional_ensemble_thresholds[1, 4]) + 0.0000000001), # add a small amount to the lower end of the 2nd range
  to = c(as.numeric(regional_ensemble_thresholds[1, 4]), 1), 
  becomes = c(strtoi(00000001, base = 2), strtoi(00000010, base = 2)) # the strtoi function converts to base-2, becomes 1 and 2
)

global_classes <- data.frame(
  from = c(0, as.numeric(summary_global[42, 2]) + 0.0000000001),
  to = c(as.numeric(summary_global[42, 2]), 1), 
  becomes = c(strtoi(00000100, base = 2), strtoi(00001000, base = 2)) # becomes 4 and 8
)

```

Now I can reclassify the MaxEnt outputs. I will load in the averaged predictions for the global and regional models for the time period 1981-2010. I will reclassify their values based on the two matrices above. This chunk might take some time to run.

```{r reclassify maxent outputs}

if(FALSE) {
  
  # regional
  # reclassify and write regional raster
  regional_ensemble_1995_classified <- terra::classify(
    x = regional_ensemble_1995, 
    rcl = regional_ensemble_classes,
    right = NA, # close both ends of the range of classification values
    others = strtoi(00000001, base = 2), # make it the unsuitable value if not in this range
    filename = file.path(mypath, "working_dir", "slf_regional_ensemble_v0_binarized_1981-2010.asc"), # also write to file
    filetype = "AAIGrid",
    overwrite = FALSE
    ) 
  
  # global
  # reclassify and write global raster
  global_1995_classified <- terra::classify(
    x = global_1995, 
    rcl = global_classes, 
    right = NA, 
    others = strtoi(00000100, base = 2), 
    filename = file.path(mypath, "working_dir", "slf_global_v2_binarized_1981-2010.asc"), 
    filetype = "AAIGrid",
    overwrite = FALSE
    ) 

}

```

I will run a few error checks to ensure that the binarization process worked. 

```{r error checks}

# take minmax
terra::minmax(global_1995_classified) %>%
  format(., scientific = FALSE)

terra::minmax(regional_ensemble_1995_classified) %>%
  format(., scientific = FALSE)

# all good

# check unique values
unique(values(global_1995_classified))
unique(values(regional_ensemble_1995_classified))


```


Now that the rasters have been converted to binary, we will visualize them to ensure that the process worked. Since the same process was done to both the regional and global models, I will only plot the regional model.

```{r prepare for plotting}

# load in binary raster just created and convert to df
regional_ensemble_1995_classified_df <- terra::rast(
  x = file.path(mypath, "working_dir", "slf_regional_ensemble_v0_binarized_1981-2010.asc")
  ) %>%
  terra::as.data.frame(., xy = TRUE) #%>%
  #na.omit()

# now, create vectors of values used to manually edit the scale of the plot
# the possible values of the scale and their order
breaks.obj <- unique(regional_ensemble_1995_classified_df$ensemble_suitability)
# labels for the values
labels.obj <- c("regional UNsuitable", "regional suitable")
# vector of colors to classify scale
values.obj <- c(
  "azure4",
  "darkblue"
)

```

```{r plot binarized raster}

# plot regional binary
ggplot() +
  geom_raster(data = regional_ensemble_1995_classified_df, aes(x = x, y = y, fill = as.factor(ensemble_suitability))) +
  labs(title = "Binarized suitability for 'regional_ensemble' model") +
  scale_discrete_manual(
    name = "suitability for SLF",
    values = values.obj,
    breaks = breaks.obj,
    labels = labels.obj,
    aesthetics = "fill",
    ) +
  map_style_binarized

```

### Projected to 2041-2060

I will perform the same operation as above for the predicted climate change rasters from 2041-2070. 

```{r minmax of rasters}

# get the range of the values in the raster
terra::minmax(global_2055) %>%
  format(., scientific = FALSE) # convert scientific notation to decimals


# get the range of the values in the raster
terra::minmax(regional_ensemble_2055) %>%
  format(., scientific = FALSE)

```

Now I will create the classification rasters. The lower range of what is considered suitable will be determined by the "Maximum Test Sensitivity Plus Specificity" threshold given in the Maxent output. I will pull these from their respective .csv files.

```{r terra required classification matrices}

# create regional suitability value matrix for terra
regional_ensemble_classes_2055 <- data.frame(
  from = c(0, as.numeric(regional_ensemble_thresholds[2, 4]) + 0.0000000001), # add a small amount to the lower end of the 2nd range
  to = c(as.numeric(regional_ensemble_thresholds[2, 4]), 1), 
  becomes = c(strtoi(00000001, base = 2), strtoi(00000010, base = 2)) # the strtoi function converts to base-2, becomes 1 and 2
)

global_classes_2055 <- data.frame(
  from = c(0, as.numeric(summary_global[42, 2]) + 0.0000000001),
  to = c(as.numeric(summary_global[42, 2]), 1), 
  becomes = c(strtoi(00000100, base = 2), strtoi(00001000, base = 2)) # becomes 4 and 8
)

```

```{r reclassify maxent outputs}

if(FALSE) {
  
  # regional
  # reclassify and write regional raster
  regional_ensemble_2055_classified <- terra::classify(
    x = regional_ensemble_2055, 
    rcl = regional_ensemble_classes_2055,
    right = NA, # close both ends of the range of classification values
    others = strtoi(00000001, base = 2), # make it the unsuitable value if not in this range
    filename = file.path(mypath, "working_dir", "slf_regional_ensemble_v0_binarized_2041-2070_ssp370_GFDL.asc"), # also write to file
    filetype = "AAIGrid",
    overwrite = FALSE
    ) 
  
  # global
  # reclassify and write global raster
  global_2055_classified <- terra::classify(
    x = global_2055, 
    rcl = global_classes_2055, 
    right = NA, 
    others = strtoi(00000100, base = 2), 
    filename = file.path(mypath, "working_dir", "slf_global_v2_binarized_2041-2070_ssp370_GFDL.asc"), 
    filetype = "AAIGrid",
    overwrite = FALSE
    ) 

}

```

I will run a few error checks to ensure that the binarization process worked. 

```{r error checks}

# take minmax
terra::minmax(global_2055_classified) %>%
  format(., scientific = FALSE)

terra::minmax(regional_ensemble_2055_classified) %>%
  format(., scientific = FALSE)

# all good

# check unique values
unique(values(global_2055_classified))
unique(values(regional_ensemble_2055_classified))


```


Now that the rasters have been converted to binary, we will visualize them to ensure that the process worked. Since the same process was done to both the regional and global models, I will only plot the regional model.

```{r prepare for plotting}

# load in binary raster just created and convert to df
regional_ensemble_2055_classified_df <- terra::rast(
  x = file.path(mypath, "working_dir", "slf_regional_ensemble_v0_binarized_2041-2070_ssp370_GFDL.asc")
  ) %>%
  terra::as.data.frame(., xy = TRUE)

# now, create vectors of values used to manually edit the scale of the plot
# the possible values of the scale and their order
breaks.obj <- unique(regional_ensemble_2055_classified_df$ensemble_suitability)
# labels for the values
labels.obj <- c("regional UNsuitable", "regional suitable")
# vector of colors to classify scale
values.obj <- c(
  "azure4",
  "darkblue"
)

```

```{r plot binarized raster}

# plot regional binary
ggplot() +
  geom_raster(data = regional_ensemble_2055_classified_df, aes(x = x, y = y, fill = as.factor(ensemble_suitability))) +
  labs(
    title = "Binarized suitability for 'regional_ensemble' model",
    subtitle = "projected to 2041-2070 | ssp370 | GFDL"
    ) +
  scale_discrete_manual(
    name = "suitability for SLF",
    values = values.obj,
    breaks = breaks.obj,
    labels = labels.obj,
    aesthetics = "fill"
    ) +
  map_style_binarized

```

## Mosaic rasters and produce map

From the plots, we see that the binary conversion worked. Next, I will need to stack the reclassified global and regional rasters and add them into a single raster output. This should give me the a raster with 4 classes (Unsuitable Agreement = 5, Suitable Agreement = 10, unsuitable regional/suitable global = 9, Suitable regional/unsuitable global = 6). The mosaic function combines spatRasters that overlap in extent into a new raster, via the function specified (addition, in this case).

### 1981-2010

```{r import binarized rasters}

global_1995_classified <- terra::rast(x = file.path(mypath, "working_dir", "slf_global_v2_binarized_1981-2010.asc"))

regional_ensemble_1995_classified <- terra::rast(x = file.path(mypath, "working_dir", "slf_regional_ensemble_v0_binarized_1981-2010.asc"))

```

```{r mosaic rasters}

if(FALSE) {
  
  # overlay and combine rasters by summing values
  slf_binarized_1995 <- terra::mosaic(
    global_1995_classified, regional_ensemble_1995_classified, # rasters
    fun = "sum", 
    filename = file.path(mypath, "working_dir", "slf_binarized_summed_1981-2010.asc"),
    overwrite = FALSE,
    wopt = c(progress = 1)) # progress bar
  
}

```

I will prepare to plot these points. These categories will be interpreted in terms of risk, as discussed above:

*Unsuitable Agreement = low risk = 5
*Suitable Agreement = extreme risk = 10
*Suitable regional/unsuitable global = high risk = 6
*unsuitable regional/suitable global = moderate risk = 9

```{r prepare data for mapping}

slf_binarized_1995 <- terra::rast(x = file.path(mypath, "working_dir", "slf_binarized_summed_1981-2010.asc")) 
# rename values
names(slf_binarized_1995) <- "global_regional_binarized"
# convert to df
slf_binarized_1995_df <- terra::as.data.frame(slf_binarized_1995, xy = TRUE) #%>%
 # na.omit()

# check for the number of unique values in the raster values column
unique(slf_binarized_1995_df$global_regional_binarized)
# it seems that the reclassification worked! Lets map it to be sure.

# now, create vectors of values used to manually edit the scale of the plot
# the possible values of the scale and their order
breaks.obj <- c(5, 9, 6, 10) # i manually ordered these
# labels for the values
labels.obj <- c("low", "moderate", "high", "extreme")
# vector of colors to classify scale
values.obj <- c("azure4", "gold", "darkorange", "darkred")

```

```{r plot summed raster}

slf_binarized_1995_plot <- ggplot() +
  geom_raster(data = slf_binarized_1995_df, aes(x = x, y = y, fill = as.factor(global_regional_binarized))) +
  labs(
    title = "Projected risk of Lycorma delicatula invasion globally",
    subtitle = "1981-2010"
    ) +
  scale_discrete_manual(
    name = "projected risk",
    values = values.obj,
    breaks = breaks.obj,
    labels = labels.obj,
    aesthetics = "fill",
    guide = guide_colorsteps(frame.colour = "black", ticks.colour = "black", barwidth = 20, draw.ulim = TRUE, draw.llim = TRUE)
    ) +
  map_style_binarized +
  guides(fill = guide_legend(nrow = 1, byrow = TRUE)) +
  theme(legend.key = element_rect(color = "black"))

```

```{r save summed raster}

ggsave(
  slf_binarized_1995_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "slf_binarized_summed_1981-2010.jpg"),
  height = 8, 
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```
 
### 2041-2070

```{r import binarized rasters}

global_2055_classified <- terra::rast(x = file.path(mypath, "working_dir", "slf_global_v2_binarized_2041-2070_ssp370_GFDL.asc"))

regional_ensemble_2055_classified <- terra::rast(x = file.path(mypath, "working_dir", "slf_regional_ensemble_v0_binarized_2041-2070_ssp370_GFDL.asc"))

```

```{r mosaic rasters}

if(FALSE) {
  
  # overlay and combine rasters by summing values
  slf_binarized_2055 <- terra::mosaic(
    global_2055_classified, regional_ensemble_2055_classified, # rasters
    fun = "sum", 
    filename = file.path(mypath, "working_dir", "slf_binarized_summed_2041-2070_ssp370_GFDL.asc"),
    overwrite = FALSE,
    wopt = c(progress = 1)) # progress bar
  
}

```

```{r prepare data for mapping}

slf_binarized_2055 <- terra::rast(x = file.path(mypath, "working_dir", "slf_binarized_summed_2041-2070_ssp370_GFDL.asc")) 
# rename values
names(slf_binarized_2055) <- "global_regional_binarized"
# convert to df
slf_binarized_2055_df <- terra::as.data.frame(slf_binarized_2055, xy = TRUE) #%>%
 # na.omit()

# check for the number of unique values in the raster values column
unique(slf_binarized_2055_df$global_regional_binarized)
# it seems that the reclassification worked! Lets map it to be sure.



# now, create vectors of values used to manually edit the scale of the plot
# the possible values of the scale and their order
breaks.obj <- c(5, 9, 6, 10) # i manually ordered these
# labels for the values
labels.obj <- c("low", "moderate", "high", "extreme")
# vector of colors to classify scale
values.obj <- c("azure4", "gold", "darkorange", "darkred")

```

```{r plot summed raster}

slf_binarized_2055_plot <- ggplot() +
  geom_raster(data = slf_binarized_2055_df, aes(x = x, y = y, fill = as.factor(global_regional_binarized))) +
  labs(
    title = "Projected risk of Lycorma delicatula invasion globally under climate change",
    subtitle = "2041-2070 | ssp370 | GFDL"
    ) +
  scale_discrete_manual(
    name = "projected risk",
    values = values.obj,
    breaks = breaks.obj,
    labels = labels.obj,
    aesthetics = "fill",
    guide = guide_colorsteps(frame.colour = "black", ticks.colour = "black", barwidth = 20, draw.ulim = TRUE, draw.llim = TRUE)
    ) +
  map_style_binarized +
  guides(fill = guide_legend(nrow = 1, byrow = TRUE)) +
  theme(legend.key = element_rect(color = "black"))

```

```{r save summed raster}

ggsave(
  slf_binarized_2055_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "slf_binarized_summed_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```

# 3. Map range shifting areas

Lastly, I want to create a map of areas where SLF range is expanding, contracting or remaining the same over time. I will binarize the rasters so that any point that is above the MTSS threshold on either model becomes one number and anything above the threshold becomes another. This will follow the methodology from step 2.

For the historical rasters, I will classify the cells as the following:

*1995 unsuitable = 5            -> 00000001 = 1
*1995 suitable = 6, 9 or 10     -> 00000010 = 2

For the 2055 rastes, I will encode the outputs into these values:

*2055 unsuitable = 5            -> 00000100 = 4
*2055 suitable = 6, 9 or 10     -> 00001000 = 8  

*this is the same as in step 2*

By encoding the rasters into base-2, I have created only 4 possible values of the raster layers, which can be translated into 4 categories:

*Unsuitable Agreement = 5 (00000101)
*Suitable Agreement = 10 (00001010)
*unsuitable 1995/suitable 2055 = 9 (00001001)
*Suitable 1995/unsuitable 2055 = 6 (00000110)

I will also interpret these categories in terms of risk of SLF range expansion:

*Unsuitable Agreement = area will stay unsuitable (no range shift)
*Suitable Agreement = area will stay suitable (no range shift)
*unsuitable 1995/suitable 2055 = area will become SUITABLE in the future (range expansion)
*Suitable 1995/unsuitable 2055 = area will become UNSUITABLE in the future (range contraction)

I will classify areas of unsuitability as gray, per usual. Areas where SLF remains the same will be white, areas where SLF is expanding will be green, and areas where SLF is contracting will be red.

The first step is to classify the binarized rasters. 

## Setup

```{r load in rasters}

# 1995
slf_binarized_1995 <- terra::rast(x = file.path(mypath, "working_dir", "slf_binarized_summed_1981-2010.asc")) 
# rename values
names(slf_binarized_1995) <- "global_regional_binarized_1995"
# convert to df
slf_binarized_1995_df <- terra::as.data.frame(slf_binarized_1995, xy = TRUE) 



# 2055
slf_binarized_2055 <- terra::rast(x = file.path(mypath, "working_dir", "slf_binarized_summed_2041-2070_ssp370_GFDL.asc")) 
# rename values
names(slf_binarized_2055) <- "global_regional_binarized_2055"
# convert to df
slf_binarized_2055_df <- terra::as.data.frame(slf_binarized_2055, xy = TRUE)


```

I will check for the unique values in the rasters.

```{r unique rastes values}

unique(values(slf_binarized_1995))

unique(values(slf_binarized_2055))

# all looks good

```

Now I will create the classes for `terra::classify()`

```{r terra required classification matrices}

# create historical suitability value matrix for terra
classes_1995 <- data.frame(
  is = c(5, 6, 9, 10),
  becomes = c(strtoi(00000001, base = 2), strtoi(00000010, base = 2), strtoi(00000010, base = 2), strtoi(00000010, base = 2)) 
  # the strtoi function converts to base-2, becomes 1 and 2
)



classes_2055 <- data.frame(
  is = c(5, 6, 9, 10),
  becomes = c(strtoi(00000100, base = 2), strtoi(00001000, base = 2), strtoi(00001000, base = 2), strtoi(00001000, base = 2)) 
  # becomes 4 and 8
)

```

Now I can reclassify the MaxEnt outputs. I will load in the averaged predictions for the global and regional models for the time period 1981-2010. I will reclassify their values based on the two matrices above. This chunk might take some time to run.

```{r reclassify maxent outputs}

if(FALSE) {
  
  # regional
  # reclassify and write regional raster
  slf_binarized_1995_classified <- terra::classify(
    x = slf_binarized_1995, 
    rcl = classes_1995,
    others = strtoi(00000001, base = 2),
    filename = file.path(mypath, "working_dir", "slf_range_shift_1981-2010.asc"), # also write to file
    filetype = "AAIGrid",
    overwrite = FALSE
    ) 
  
  # global
  # reclassify and write global raster
  slf_binarized_2055_classified <- terra::classify(
    x = slf_binarized_2055, 
    rcl = classes_2055, 
    others = strtoi(00000100, base = 2),
    filename = file.path(mypath, "working_dir", "slf_range_shift_2041-2070_ssp370_GFDL.asc"), 
    filetype = "AAIGrid",
    overwrite = FALSE
    ) 

}

```

I will run a few error checks to ensure that the binarization process worked. 

```{r error checks}

# take minmax
terra::minmax(slf_binarized_1995_classified) %>%
  format(., scientific = FALSE)

terra::minmax(slf_binarized_2055_classified) %>%
  format(., scientific = FALSE)

# all good

# check unique values
unique(values(slf_binarized_1995_classified))
unique(values(slf_binarized_2055_classified))


```


Now that the rasters have been converted to binary, I will visualize 1 to ensure that the process worked. Since the same process was done to both the regional and global models, I will only plot the regional model.

```{r prepare for plotting}

# load in binary raster just created and convert to df
slf_binarized_1995_classified_df <- terra::rast(
  x = file.path(mypath, "working_dir", "slf_range_shift_1981-2010.asc")
  ) %>%
  terra::as.data.frame(., xy = TRUE) #%>%
  #na.omit()

# now, create vectors of values used to manually edit the scale of the plot
# the possible values of the scale and their order
breaks.obj <- unique(slf_binarized_1995_classified_df$global_regional_binarized_1995)
# labels for the values
labels.obj <- c("present UNsuitable", "present suitable")
# vector of colors to classify scale
values.obj <- c(
  "azure4",
  "azure"
)

```

```{r plot binarized raster}

# plot regional binary
ggplot() +
  geom_raster(data = slf_binarized_1995_classified_df, aes(x = x, y = y, fill = as.factor(global_regional_binarized_1995))) +
  labs(title = "current suitability for SLF") +
  scale_fill_manual(
    name = "suitability for SLF",
    values = values.obj,
    breaks = breaks.obj,
    labels = labels.obj,
    aesthetics = "fill",
    ) +
  map_style_binarized

```

great, the conversion worked.

## Mosaic rasters

From the plots, we see that the binary conversion worked. Next, I will need to stack the reclassified 1995 and 2055 rasters and add them into a single raster output. This should give me the a raster with 4 classes (Unsuitable Agreement = 5, Suitable Agreement = 10, unsuitable 1995/suitable 2055 = 9, Suitable 1995/unsuitable 2055 = 6). The mosaic function combines spatRasters that overlap in extent into a new raster, via the function specified (addition, in this case).

### 1981-2010

```{r re-import binarized rasters}

slf_binarized_1995_classified <- terra::rast(x = file.path(mypath, "working_dir", "slf_range_shift_1981-2010.asc"))

slf_binarized_2055_classified <- terra::rast(x = file.path(mypath, "working_dir", "slf_range_shift_2041-2070_ssp370_GFDL.asc"))

```

```{r mosaic rasters}

if(FALSE) {
  
  # overlay and combine rasters by summing values
  slf_binarized_1995 <- terra::mosaic(
    slf_binarized_1995_classified, slf_binarized_2055_classified, # rasters
    fun = "sum", 
    filename = file.path(mypath, "working_dir", "slf_range_shift_summed.asc"),
    overwrite = FALSE,
    wopt = c(progress = 1)) # progress bar
  
}

```

## Plot

I will prepare to plot these points. These categories will be interpreted in terms range shifts, as discussed above:

*Unsuitable Agreement = 5 = area will stay unsuitable (no range shift)
*Suitable Agreement = 10 = area will stay suitable (no range shift)
*unsuitable 1995/suitable 2055 = 9 = area will become SUITABLE in the future (range expansion)
*Suitable 1995/unsuitable 2055 = 6 = area will become UNSUITABLE in the future (range contraction)

```{r prepare data for mapping}

slf_range_shift <- terra::rast(x = file.path(mypath, "working_dir", "slf_range_shift_summed.asc")) 
# rename values
names(slf_range_shift) <- "range_shift_summed"
# convert to df
slf_range_shift_df <- terra::as.data.frame(slf_range_shift, xy = TRUE) #%>%
 # na.omit()

# check for the number of unique values in the raster values column
unique(slf_range_shift_df$range_shift_summed)
# it seems that the reclassification worked! Lets map it to be sure.

# now, create vectors of values used to manually edit the scale of the plot
# the possible values of the scale and their order
breaks.obj <- c(5, 10, 6, 9) # i manually ordered these
# labels for the values
labels.obj <- c("unsuitable for\nL delicatula", "retained", "contraction", "expansion")
# vector of colors to classify scale
values.obj <- c("azure4", "azure", "darkred", "darkgreen")

```

```{r plot summed raster}

slf_range_shift_plot <- ggplot() +
  geom_raster(data = slf_range_shift_df, aes(x = x, y = y, fill = as.factor(range_shift_summed))) +
  labs(title = "Projected Lycorma delicatula range expansion by 2055") +
  scale_discrete_manual(
    name = "L delicatula\nrange shift",
    values = values.obj,
    breaks = breaks.obj,
    labels = labels.obj,
    aesthetics = "fill",
    guide = guide_colorsteps(frame.colour = "black", ticks.colour = "black", barwidth = 20, draw.ulim = TRUE, draw.llim = TRUE)
    ) +
  map_style_binarized +
  # aesthetics
  guides(fill = guide_legend(nrow = 1, byrow = TRUE)) +
  theme(legend.key = element_rect(color = "black"), legend.title = element_text(hjust = 1))

```

```{r save summed raster}

ggsave(
  slf_range_shift_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "slf_range_shift_summed.jpg"),
  height = 8, 
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```


# Appendix

## Create suitability plots for global model

I will create the same suitability maps for the global model, for ease of comparison

```{r map global model: 1981-2010}

global_1995_plot <- ggplot() +
  # plot raster
  geom_raster(data = global_1995_df, aes(x = x, y = y, fill = global_suitability)) +
  # aesthetics
  scale_fill_gradientn(
    # the values of the color divisions: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    values = c(
      0, # minimum
      as.numeric(summary_global[30, 2]), # MTP thresh
      as.numeric(summary_global[30, 2]) + 0.0000001, # some small amount more than the MTP
      as.numeric(summary_global[42, 2]), # MTSS thresh
      as.numeric(summary_global[42, 2]) + 0.0000001,
      # the rest
      0.5,
      0.75,
      1
      ),
    # these colors taken from viridis color scale D
    # the colors for the divisions in the order: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    colors = c("azure4", "azure4", "azure2", "azure2", "#481567FF", "#2D708EFF", "#3CBB75FF", "#FDE725FF"),
    # the tick marks
    breaks = c(0, as.numeric(summary_global[30, 2]), as.numeric(summary_global[42, 2]), 0.5, 0.75, 1.00),
    # labels for the tick marks
    labels = c("unsuitable", "", "MTSS thresh", 0.5, 0.75, 1),
    limits = c(0, 1.0),
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20, draw.ulim = TRUE, draw.llim = TRUE)
    ) +
  # labs
  labs(
    title = "Suitability for SLF in global model",
    subtitle = "",
    caption = "MTP & MTSS thresholds | clamped"
    ) +
  # default style
  map_style

```

```{r save plot}

ggsave(
  global_1995_plot,
  filename = file.path(mypath, "slf_global_v2", "plots", "global_pred_suit_globe_1981-2010.jpg"),
  height = 8,
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```

Now, I will map the predictions for 2041-2070

```{r map global model: 2041-2070}

# I had to change the row call of the thresholds tibble to row 2 [2, x]

global_2055_plot <- ggplot() +
  # plot raster
  geom_raster(data = global_2055_df, aes(x = x, y = y, fill = global_suitability)) +
  # aesthetics
  scale_fill_gradientn(
    # the values of the color divisions: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    values = c(
      0, # minimum
      as.numeric(summary_global[30, 2]), # MTP thresh
      as.numeric(summary_global[30, 2]) + 0.0000001, # some small amount more than the MTP
      as.numeric(summary_global[42, 2]), # MTSS thresh
      as.numeric(summary_global[42, 2]) + 0.0000001,
      # the rest
      0.5,
      0.75,
      1
      ),
    # these colors taken from viridis color scale D
    # the colors for the divisions in the order: 0, MTP, slightly above MTP, MTSS, slightly above MTSS, 0.5, 0.75, 1
    colors = c("azure4", "azure4", "azure2", "azure2", "#481567FF", "#2D708EFF", "#3CBB75FF", "#FDE725FF"),
    # the tick marks
    breaks = c(0, as.numeric(summary_global[30, 2]), as.numeric(summary_global[42, 2]), 0.5, 0.75, 1.00),
    # labels for the tick marks
    labels = c("unsuitable", "", "MTSS thresh", 0.5, 0.75, 1),
    limits = c(0, 1.0),
    guide = guide_colorbar(frame.colour = "black", ticks.colour = "black", barwidth = 20, draw.ulim = TRUE, draw.llim = TRUE)
    ) +
  # labs
  labs(
    title = "Suitability for SLF in global model",
    subtitle = "projected to 2041-2070 | ssp3-70 | GFDL",
    caption = "MTP & MTSS thresholds | clamped"
    ) +
  # default style
  map_style

```

```{r save plot}

ggsave(
  global_2055_plot,
  filename = file.path(mypath, "slf_global_v2", "plots", "global_pred_suit_globe_2041-2070_GFDL_ssp370.jpg"),
  height = 8,
  width = 12,
  device = "jpeg",
  dpi = "retina"
  )

```

# References

Gallien, L., R. Douzet, S. Pratte, N. E. Zimmermann, and W. Thuiller. 2012. Invasive species distribution models – how violating the equilibrium assumption can create new insights. Global Ecology and Biogeography 21:1126–1136.

