---
title: "Setup for initial MaxEnt models used to choose background area"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2023-07-27"
output: html_document
---

This vignette will outline the methodology for selecting the best fit background area selection method. This step will only be performed with the historical versions of the bioclim layers.

(THEORY)

First, I will trim the bioclim variables retrieved in vignette 03 to a bounding box of the eastern USA

Second, I will create the fixed area AUC background points dataset, a set of points across a 1km grid of the USA.

Third, I will create three reference layers, one for each type of background area (entire eastern USA, DD model eastern USA, 355km around points).

Fourth, I  will select randomized points from each background area size as the dataset for calculating the flexible area AUC.

# Setup

```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation

library(here) #making directory pathways easier on different instances
here()
# here() starts at the root folder of this package.

library(devtools)
library(dismo) # generate random background points
library(raster)
library(terra)

library(viridis)


```

```{r ggplot object for map style}

map_style <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "lightblue",
                                colour = "lightblue")
        ),
  coord_equal() 
)

```

```{r files for plotting}

mypath <- file.path(here() %>% 
                       dirname(),
                     "ArcGIS/import_layers/geopol_topo/GL230521_lam")

# great lakes shapefile
great_lakes <- terra::vect(x = file.path(mypath, "GL230521_lam.shp")) %>%
  as.data.frame(.)



```


# 1. Trim Bioclim layers to Eastern USA


```{r setup for cropping bioclim layers}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/historical_climate_rasters/chelsa2.1_30arcsec")

# lists of target files in the directory
# load in bioclim layers to be cropped- the original .asc files
env.files <- list.files(path = file.path(mypath, "v1_maxent"), pattern = "\\.asc$", full.names = TRUE) %>%
# extract the 4 bioclim layers I will be using in my models. Access to cities will not be used until later models
  grep("atc_2015_global.asc|bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE)

# output file names
output.files <- list.files(path = file.path(mypath, "v1_maxent"), pattern = "\\.asc$", full.names = FALSE) %>%
  grep("atc|bio2|bio11|bio12|bio15", ., value = TRUE) %>%
  gsub(pattern = "global", replacement = "easternUSA")

# extent object for eastern USA
ext.obj <- terra::ext(-96.503906, -59.589844, 28.304381, 47.457809)

```

```{r loop to crop bioclim layers to eastern N america}

# view list of filetypes for terra, use .ascii
View(terra::gdal(drivers = TRUE))

if(TRUE) {
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    
    # crop new rasters to extent
    rast.hold <- terra::crop(x = rast.hold, y = ext.obj, overwrite = FALSE)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, "v1_maxent", output.files[a]), filetype = "AAIGrid", overwrite = FALSE)
    
    # remove object once its done
    rm(rast.hold)
    
  }
  
}

# I am pretty sure this method resets the raster cell numbers, which might be annoying downstream....

```

Lets plot one of the new layers to make sure the cropping worked.

```{r plot main_layer to ensure cropping worked}

bio11 <- terra::rast(x = file.path(mypath, "v1_maxent", "bio11_1981-2010_easternUSA.asc")) 
# convert to df
bio11_df <- terra::as.data.frame(bio11, xy = TRUE)

# plot main layer as example
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = bio11_df, 
            aes(x = x, y = y, fill = `CHELSA_bio11_1981-2010_V.2.1`)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)
# the cropping worked

```

The layers have been cropped to the proper extent.


# 2. Select Fixed Area AUC points

We will now generate a gridded area from which to extract a fixed-area AUC. AUC is a best-fit metric that is built into MaxEnt, but many papers have pointed out that it is sensitive to the size of the background. The size of the background happens to be the exact variable being changed between these models, creating an issue for assessing the fit of the models. [VanDerWal et.al](https://www.sciencedirect.com/science/article/pii/S0304380008005486) suggested a method for calculation of the AUC that can compensate for this sensitivity to background area. Essentially, one set of background points is generated at random from the area in question (the maxent default) and another is calculated from a 1km grid (1 point per cell) across the entire area of interest. The fixed set of points is used for all models, regardless of the distribution of presences, while the "flexible area AUC" (generated in step 4) is calculated from the background area chosen for that model. Two AUCs will be calculated per model.

For the purposes of this analysis, I will be taking the fixed area background point sets from the eastern half of the USA `(xmin: -96.503906, xmax: -59.589844, ymin: 28.304381, ymax: 47.457809)`. This area was chosen because a) it includes all known SLF records in  N America, according to the [NYSIPM SLF Map](https://lookerstudio.google.com/u/0/reporting/b0bae43d-c65f-4f88-bc9a-323f3189cd35/page/QUCkC), b) it includes most of the projected suitable areas from previous models, and c) it is a smaller overall area from which to draw points for the fixed area AUC, so AUC values are less likely to suffer from over-inflation. The "fixed area AUC" will be taken from a 1km grid that is laid out across this area. 

(find paper saying how many points to take)

First, I will extract one point per grid cell across the entire area of the bounding box I extracted of the eastern USA. These data points will be used to calculate the "fixed area AUC". I will load in a raster of the eastern USA that was created in `vignette-name`. This will be used as a reference area for the creation of the fixed area AUC points dataset. We will convert this raster to a data frame and obtain the coordinates for each grid cell. Each set of coordinates will represent the centroid of each grid cell, which are roughly 1km apart at the equator. The fixed area AUC requires a grid of regularly spaced points across the area of interest, so these coordinates should satisfy meet those criteria.

We will use `bio11`, created above.

```{r create fixed area AUC dataset}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_30arcsec")


bio11_AUC <- terra::rast(x = file.path(mypath, "v1_maxent", "bio11_1981-2010_easternUSA.asc")) 

# extract the coordinates for each grid cell
fixed_AUC <- terra::as.data.frame(x = bio11_AUC, xy = TRUE, cells = TRUE) %>%
  na.omit() %>%
  # filter out NAs
  filter(!is.na(`CHELSA_bio11_1981-2010_V.2.1`)) %>%
  dplyr::select(x, y, cell)

# This basically obtains the coordinates for the centroid of each grid cell. This will be saved as the fixed area AUC coordinates.  

```

```{r write as csv}

write_csv(x = fixed_AUC, file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_fixed_area_points_v1.csv"))

# again, I dont think the cell numbers in this file match those retrieved from the un-cropped rasters

```

Now that we have extracted a point per grid cell, we will plot it to ensure the process was correct. We will convert the raster of the eastern USA to a data frame and then plot it with the fixed area points. The fixed area AUC points should be equally spaced to about 1 every 1km grid cell, so we will also zoom in to check if the process was successful. This plot takes awhile to run, only run it if you are concerned that some points might be where there are supposed to be NAs (such as over the ocean).

```{r plot points}

# load in fixed area AUC dataset again
fixed_AUC <- read_csv(file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_fixed_area_points_v1.csv"))

if(FALSE) {

  # plot data
  fixed_AUC_plot <- ggplot() +
    geom_raster(data = bio11_df, # the raster df from earlier
                aes(x = x, y = y, fill = `CHELSA_bio11_1981-2010_V.2.1`)) +
   #geom_polygon(data = map_data("county"), aes(x = long, y = lat, group = group), fill = NA, color = "black", lwd = 0.15) + # county outlines
    geom_point(data = fixed_AUC, 
               aes(x = x, y = y), color = "darkorange") +
   #xlim(-75.484057, -74.721519) + # bucks county, PA
   #ylim(40.048595, 40.60858) +
    xlab("longitude") +
    ylab("latitude") +
    theme_minimal() +
    theme(legend.position = "none") +
    labs(title = "Fixed area AUC points") +
    coord_equal()
    # coord_quickmap(xlim = c(-75.280266, -74.955763), ylim = c(39.867004, 40.137992), expand = TRUE)

}

```

The points are so dense that we cannot resolve them at this scale. However, we can at least confirm that the function only created points on land masses. 

# 3. Create reference layer for each background type.

I will start with the bio 11 raster created above. I will mask this raster using two other methods to select the background area, from which to retrieve the random background points for the "flexible area AUC". By the end of this step, I will have three differently sized areas from which to draw these points: the entire eastern USA, a suitable subset of this region based on a Degree-Day accumulation model, and an suitable area of 355km around each known SLF presence.

The first step will be to create a raster of the entire area of the eastern USA. This assumes that all of the eastern USA is suitable. This has already been done in the step above. The raster will be slightly modified so that the output is binarized (so the entire land area will be a 1, or suitable).

The the second step will be to calculate the area of the eastern USA that is found to be suitable by an mechanistic Degree Day model. This model simply uses a threshold for the necessary number of degree days for SLF to reach a particular life stage (important thresholds have been pre-built into the function). This function then applies this equation to each grid cell across a raster. For this function to work, we will need to retrieve the monthly average temperature for 1981-2010, globally. This vignette will only display the steps of calling the function within this package that contains the model, `compute_DD_suitability()`, using the output of that function to create a binary raster of the eastern USA. All steps taken to download the CHELSA data necessary and format it for use can be found in the vignette "04-1_avg_monthly_temps_DD.Rmd". 

This model was developed by Stephanie Lewkiewicz, PhD and is loosely based on Lewkiewicz et.al, 2022. 

The final step will be to create a raster, with the suitable area being a 355km buffer area around all SLF presences in N America.

## Entire Eastern USA- suitable area

I will modify the above raster so that all land areas are equal to 1 (suitable) and all water areas are NA.

```{r modify bio11 raster}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters")

entire_USA <- terra::rast(x = file.path(mypath, "chelsa2.1_30arcsec", "v1_maxent", "bio11_1981-2010_easternUSA.asc")) 

# setup to do edits

# get minmax
terra::minmax(entire_USA)
# create matrix of suitability values for use in reclassify
classes.obj <- data.frame(
  from = -14,
  to = 19,
  becomes = 1
)

# begin edits

# change name of variable
names(entire_USA) <- "suitability"
# recalssify raster according to values
entire_USA <- terra::classify(x = entire_USA, 
                              rcl = classes.obj,
                              right = NA, # close both ends of the range of classification values
                              others = NA, # anything else, including -9999, should be NA
                              filename = file.path(mypath, "chelsa2.1_suitable_area", "output", "rasters", "easternUSA_entire.tif"), # also write to file
                              filetype = "GTiff",
                              overwrite = FALSE) 


```

The output says that both the min and max values are 1, which is a good sign. I will plot it to ensure the correct raster was created.

```{r plot entire east USA}

# convert to df
entire_USA_df <- terra::rast(x = file.path(mypath, "chelsa2.1_suitable_area", "output", "rasters", "easternUSA_entire.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

# plot main layer as example
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = entire_USA_df, 
            aes(x = x, y = y, fill = suitability)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  coord_equal()
)

```

This raster is ready for use.

## Mechanistic DD model- suitable area

I will compute the DD suitability using the threshold of 1% adult emergence first. This Degree Day threshold (991 days) was considered the minimum needed for SLF to establish at a locality, according to Calvin et.al.

```{r compute_DD_suitability function}

# use in-package function to find DD suitability
adult_emergence_1 <- slfSpread::compute_DD_suitability(x = file.path(here(), "vignette-outputs", "data-tables", "ANNUAL_ch2.1_5m_tavg.csv"))

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

# write as csv
write_csv(x = adult_emergence_1, file = file.path(mypath, "output", "dfs", "annual_DD_ch2.1_monthly_tavg_adult_emergence_1_v0.csv"))
# write as rda
save(adult_emergence_1, file = file.path(here(), "data", "annual_DD_ch2.1_monthly_tavg_adult_emergence_1_v0.rda"))

```


```{r convert DD model output csv to raster and export}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

# load in DD calculation created in R
adult_emergence_1_raster <- read_csv(file = file.path(mypath, "output", "dfs", "annual_DD_ch2.1_monthly_tavg_adult_emergence_1_v0.csv")) %>%
  dplyr::select(-c(cell, total_annual_dds))
# convert to raster
adult_emergence_1_raster <- rast(x = adult_emergence_1_raster)

# check to ensure proper range of values
terra::minmax(adult_emergence_1_raster)
# convert 0s to NAs
adult_emergence_1_raster <- terra::subst(x = adult_emergence_1_raster, from = 0, to = NA)

# write as raster
writeRaster(x = adult_emergence_1_raster, filename = file.path(mypath, "output", "rasters", "global_DD_suitable_area_adult_emergence-1.tif"), filetype = "GTiff", overwrite = FALSE)

```

```{r visualize raster}

# convert to df
adult_emergence_1_df <- terra::rast(x = file.path(mypath, "output", "rasters", "global_DD_suitable_area_adult_emergence-1.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

# plot raster
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = adult_emergence_1_df, 
            aes(x = x, y = y, fill = suitability)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)

# north america
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = adult_emergence_1_df, 
            aes(x = x, y = y, fill = suitability)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)

```

I will disaggregate, crop and convert the 0s to NAs. 

```{r crop to eastern USA and disaggregate to 30 arcsec}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

# extent object for eastern USA
ext.obj <- terra::ext(-96.503906, -59.589844, 28.304381, 47.457809)

# load in raster
eastern_USA_DD <- rast(x = file.path(mypath, "output", "rasters", "global_DD_suitable_area_adult_emergence-1.tif"))


# crop to eastern USA
eastern_USA_DD <- terra::crop(x = eastern_USA_DD, y = ext.obj)
# I will use resample to t0 30 arcsec
# 30 arcsec = 0.5 arcmin, so I will disagg by a factor of 10
eastern_USA_DD <- terra::disagg(x = eastern_USA_DD, fact = 10, method = "bilinear")
# rreplace 0s with NAs
eastern_USA_DD <- terra::subst(x = eastern_USA_DD, from = 0, to = NA)

# write raster
writeRaster(x = eastern_USA_DD, filename = file.path(mypath, "output", "rasters", "easternUSA_DD_suitable_area_adult_emergence-1.tif"), filetype = "GTiff", overwrite = TRUE)

```

```{r visualize eastern USA raster}

# convert to df
eastern_USA_DD_df <- terra::rast(x = file.path(mypath, "output", "rasters", "easternUSA_DD_suitable_area_adult_emergence-1.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

# north america
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = eastern_USA_DD_df, 
            aes(x = x, y = y, fill = suitability)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)

```

## Buffer around SLF presences- suitable area

(SUPPORT IN THE LITERATURE)

I will use the binary raster of the entire eastern USA produced earlier in this vignette to select the suitable area for SLF. I will be selecting a buffer zone of 355km around each SLF point.

```{r load in files}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

# load in SLF points
slf_points <- read_csv(file = file.path(here(), "vignette-outputs", "data-tables", "slf_all_final_coords_v1_2023-08.csv")) 

# load in eastern USA raster to filter points
entire_USA <- terra::rast(x = file.path(mypath, "output", "rasters", "easternUSA_entire.tif"))

```

This code can be found in vignette 03.

```{r creation of and edits to mask layer}

# new path
mypath <- file.path(here() %>% 
                          dirname(),
                        "maxent/historical_climate_rasters/chelsa2.1_30arcsec/originals")

global_bio1 <- terra::rast(x = file.path(mypath, "CHELSA_bio1_1981-2010_V.2.1.tif"))
# global access to cities
global_atc <- terra::rast(x = file.path(mypath, "2015_accessibility_to_cities_v1.0.tif"))



ext.obj <- terra::ext(-180, 179, -60, 83)

# create main layer for future cropping, crop to new ext
main_layer <- terra::crop(x = global_bio1, y = ext.obj, overwrite = FALSE)
# create a mask layer specifically for the cropping and masking
mask_layer <- terra::crop(x = global_atc, y = ext.obj, overwrite = FALSE)

# unify origins
# set origin of global_atc
terra::origin(mask_layer) <- c(-0.0001396088, -0.0001392488)
# resample atc to bio1 layer because origins are different- most rasters will already have the origin of the bio1 layer
mask_layer <- terra::resample(x = mask_layer, y = main_layer, method = "bilinear")

# set CRS of reference layers to be sure
main_layer <- terra::project(x = main_layer, y = "EPSG:4326", method = "bilinear")
mask_layer <- terra::project(x = mask_layer, y = "EPSG:4326", method = "bilinear")

# crop mask layer again, this time by the extent of the object 
# extent object for eastern USA
ext.obj <- terra::ext(-96.503906, -59.589844, 28.304381, 47.457809)
# crop
mask_layer <- terra::crop(x = mask_layer, y = ext.obj, overwrite = FALSE)

```

```{r create raster of buffers}

# extent object for eastern USA
ext.obj <- terra::ext(-96.503906, -59.589844, 28.304381, 47.457809)

# tidy
slf_points <- slf_points %>%
  dplyr::select(-species) %>%
  # mutate(value = 1) %>% # create a "value" column that contains 1.
  as.matrix()

slf_points_rasterized <- terra::rasterize(x = slf_points, y = entire_USA)

# create a raster object that is a buffer around the points, 355,000m (355km)
buffered_USA <- terra::buffer(x = slf_points_rasterized, width = 355000, background = 0) %>%
  terra::mask(., mask = mask_layer)


terra::minmax(buffered_USA)

# rreplace 0s with NAs
buffered_USA <- terra::subst(x = buffered_USA, from = 0, to = NA)

```

```{r visualize}

buffered_USA_df <- terra::as.data.frame(x = buffered_USA, xy = TRUE)

(ggplot() +
    geom_raster(data = buffered_USA_df, 
              aes(x = x, y = y, fill = layer)) +
    xlab("longitude") +
    ylab("latitude") +
    theme_minimal() +
    theme(legend.position = "none") +
    coord_equal()
)

```

```{r save raster}

writeRaster(x = buffered_USA, filename = file.path(mypath, "output", "rasters", "easternUSA_slf_points_buffered_suitability.tif"), filetype = "GTiff", overwrite = FALSE)

```


# 4. Select Flexible Area AUC points

First, I will load in known SLF presences so that background sampling does not occur at those points.

```{r}

# dismo requires the base function (not tidyverse)
slf_points <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "slf_all_final_coords_v1_2023-08.csv")) %>%
   dplyr::select(-species) 

```

## Entire Eastern USA

Background points datasets will be stored in `vignette-outputs/data-tables`.

```{r background points for entire Eastern USA raster}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

# load in reference layer. needs to be done with raster package because dismo doesnt recognize terra package objects
easternUSA_entire <- raster::raster(x = file.path(mypath, "output", "rasters", "easternUSA_entire.tif"))

# set seed so that the random points for this dataset are the same the next time this code is run
set.seed(1)
# generate random points 
easternUSA_entire_flexible_points <- dismo::randomPoints(mask = easternUSA_entire, 
                                                n = 10000, # default number used by maxent
                                                p = slf_points,
                                                excludep = TRUE, # exclude cells where slf has been found
                                                lonlatCorrection = TRUE, # weight samples by latitude because cell size is larger closer to equator
                                                warn = 2 # higher number gives most warnings, including if sample size not reached
                                                ) %>%
  as.data.frame(.)

# save as csv
write_csv(x = easternUSA_entire_flexible_points, file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_entire_flexible_area_points.csv"))
# save as rda file
save(easternUSA_entire_flexible_points, file = file.path(here(), "data", "easternUSA_entire_flexible_area_points.rda"))
  
  
```

```{r load in files for plotting}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

entire_USA_df <- terra::rast(x = file.path(mypath, "output", "rasters", "easternUSA_entire.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

easternUSA_entire_flexible_points <- read_csv(file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_entire_flexible_area_points.csv"))

```

```{r plot points}

background_entire <- ggplot() +
    geom_raster(data = entire_USA_df, aes(x = x, y = y), fill = "azure1") +
    geom_point(data = easternUSA_entire_flexible_points, aes(x = x, y = y), color = "darkorange", size = 0.5) +
    ggtitle("Eastern USA flexible background points- entire area") +
    map_style +
    theme(legend.position = "none") 

```

```{r save plot}

ggsave(background_entire, 
       filename = file.path(here(), "vignette-outputs", "figures", "easternUSA_entire_flexible_area_points.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```

## DD model suitable area

```{r background points for DD model area raster}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

DD_model <- raster::raster(x = file.path(mypath, "output", "rasters", "easternUSA_DD_suitable_area_adult_emergence-1.tif"))

# set seed 
set.seed(2)
# generate random points 
easternUSA_DD_flexible_points <- dismo::randomPoints(mask = DD_model, 
                                                n = 10000, # default number used by maxent
                                                p = slf_points,
                                                excludep = TRUE,
                                                lonlatCorrection = TRUE, # weight samples by latitude because cell size is larger closer to equator
                                                warn = 2
                                                ) %>%
  as.data.frame(.)

# save as csv
write_csv(x = easternUSA_DD_flexible_points, file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_adult_emergence-1_flexible_area_points.csv"))
# save as rda file
save(easternUSA_DD_flexible_points, file = file.path(here(), "data", "easternUSA_adult_emergence-1_flexible_area_points.rda"))
  
  
```

```{r load in files for plotting}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

entire_USA_df <- terra::rast(x = file.path(mypath, "output", "rasters", "easternUSA_entire.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

adult_emergence_1_df <- terra::rast(x = file.path(mypath, "output", "rasters", "easternUSA_DD_suitable_area_adult_emergence-1.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

easternUSA_DD_flexible_points <- read_csv(file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_adult_emergence-1_flexible_area_points.csv"))

```

```{r plot points}

background_DD <- ggplot() +
  geom_raster(data = entire_USA_df, aes(x = x, y = y), fill = "azure4") + # entire eastern USA raster
  geom_raster(data = adult_emergence_1_df, aes(x = x, y = y), fill = "azure1") + # DD suitable area raster
  geom_point(data = easternUSA_DD_flexible_points, aes(x = x, y = y), color = "darkorange", size = 0.5) +
  ggtitle("Eastern USA flexible background points- DD model, 1% adult emergence") +
  map_style +
  theme(legend.position = "none") 

```

```{r save plot}

ggsave(background_DD, 
       filename = file.path(here(), "vignette-outputs", "figures", "easternUSA_adult_emergence-1_flexible_area_points.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```


The black areas represent the areas where we should not have any points. The points are all in the light grey area, so the function to create the points worked properly. 

## 355km buffer suitable area

```{r background points for DD model area raster}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

easternUSA_buffer <- raster::raster(x = file.path(mypath, "output", "rasters", "easternUSA_slf_points_buffered_suitability.tif"))

# set seed 
set.seed(3)
# generate random points 
easternUSA_buffer_flexible_points <- dismo::randomPoints(mask = easternUSA_buffer, 
                                                n = 10000, # default number used by maxent
                                                p = slf_points,
                                                excludep = TRUE,
                                                lonlatCorrection = TRUE, # weight samples by latitude because cell size is larger closer to equator
                                                warn = 2
                                                ) %>%
  as.data.frame(.)

# save as csv
write_csv(x = easternUSA_buffer_flexible_points, file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_slf_points_buffered_flexible_area_points.csv"))
# save as rda file
save(easternUSA_buffer_flexible_points, file = file.path(here(), "data", "easternUSA_slf_points_buffered_flexible_area_points.rda"))
  
  
```

```{r load in files for plotting}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_suitable_area")

entire_USA_df <- terra::rast(x = file.path(mypath, "output", "rasters", "easternUSA_entire.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

easternUSA_buffer_df <- terra::rast(x = file.path(mypath, "output", "rasters", "easternUSA_slf_points_buffered_suitability.tif")) %>%
  terra::as.data.frame(., xy = TRUE)

easternUSA_buffer_flexible_points <- read_csv(file = file.path(here(), "vignette-outputs", "data-tables", "easternUSA_slf_points_buffered_flexible_area_points.csv"))

```

```{r plot points}

background_buffered <- ggplot() +
  geom_raster(data = entire_USA_df, aes(x = x, y = y), fill = "azure4") + # entire eastern USA raster
  geom_raster(data = easternUSA_buffer_df, aes(x = x, y = y), fill = "azure1") + # buffered suitable area raster
  geom_point(data = easternUSA_buffer_flexible_points, aes(x = x, y = y), color = "darkorange", size = 0.5) +
  ggtitle("Eastern USA flexible background points- 355km buffer around SLF points") +
  map_style + # plot style object
  theme(legend.position = "none") 

```

```{r save plot}

ggsave(background_buffered, 
       filename = file.path(here(), "vignette-outputs", "figures", "easternUSA_slf_points_buffered_flexible_points.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```


FIN

# References

D.D Calvin, J. Rost, J. Keller, S. Crawford, Julie Urban, B. Walsh, and M. Bosold. Seasonal Activity of Spotted Lanternfly, Lycorma delicatula (White) (Hemiptera: Fulgoridae), in Southeast Pennsylvania. Unpublished.

Lewkiewicz, S. M., S. De Bona, M. R. Helmus, and B. Seibold. 2022. Temperature sensitivity of pest reproductive numbers in age-structured PDE models, with a focus on the invasive spotted lanternfly. Journal of Mathematical Biology 85:29.





