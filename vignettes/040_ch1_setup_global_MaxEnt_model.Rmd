---
title: "Setup for global MaxEnt Models (chapter 1)"
author: "Samuel M. Owens"
contact: "sam.owens@temple.edu"
date: "2024-01-05"
output: html_document
---
# Overview

In the previous vignette, I retrieved and formatted rasters of 24 global-scale climate and human impact variables from [CHELSA](https://chelsa-climate.org/). These represent some of the most relevant variables for the accomplishment of my goal, which is to explain the distribution for Lycorma delicatula according to climate. I also retrieved climate change versions of these variables, created by the [CMIP6](https://pcmdi.llnl.gov/CMIP6/) climate modeling project. These variables were standardized and formatted for my needs. Additionally, the most relevant variables were chosen for all future models. 

The goal is to produce three models for chapter 1: a global model, a regional_invaded model, and a regional_native model. All three models will be based on historical (1981-2010) climate data and will be extrapolated for climate change using the CMIP6 rasters. Each model will be based on different training and testing ranges. The global model will be trained and tested on all available climate data, which will be split up into 10 random folds. The regional models will be trained on the regional subset of presence data. The regional_native model will be trained on SLF presences and background points chosen from provinces in China which contain known SLF presences. This model will be tested using SLF presence data from the USA. The regional_invaded model will do the opposite: It will be trained on the data from the USA and tested using data from the native range in China. All three of these models will be considered in tandem during analyses. Here is a table that explains the models. The following table outlines the training and testing of these models:

```{r model_info table}

model_info <- data.frame(
  "model" = c(
    "global",
    "regional_native",
    "regional_invaded"
    ),
  "train_data" = c(
    "80% of global presences, k-fold random cross validation",
    "SLF presences in mainland China",
    "SLF presences in North America"
  ),
  "number_train_points" = c(
    "619",
    "237",
    "328"
  ),
  "test_data" = c(
    "20% of global presences, k-fold random cross validation",
    "SLF presences in North America",
    "SLF presences in mainland China"
  ),
  "number_test_points" = c(
    "155",
    "328",
    "237"

  ),
  "projection" = "North America",
  "number_background_points" = c(
    "20,000",
    "10,000",
    "7,500"
  )
)

model_info_kable <- knitr::kable(x = model_info)
  
```

In this vignette, I will set up to run the global model and project it for climate change. In the next vignette I will run this model, and in the following vignette I will set up for the invaded and native regional models.

I will crop the rasters that were retrieved and tidied in the previous vignette to the relevant spatial scale. I will crop the historical and CMIP6 versions of these rasters to North America, which will only be used to produce map outputs of the model's predictions (projection). These rasters will also be used to project the regional model. Next, I will select the background point datasets for the global model. MaxEnt uses these points to calculate an equation that describes the relationship of SLF with its environment and predict suitability (the model output).

```{r extents table}

extents <- data.frame(
  "spatial_extent" = c("global model training", "invaded_regional model training", "native_regional model training", "projection"),
  "long_min" = c(-180, -96.504, 89.43514, -140.977),
  "long_max" = c(179, -59.590, 126.05626, -51.064),
  "lat_min" = c(-60, 23.5, 20.23827, 15.182),
  "lat_max" = c(83, 47.458, 53.32406, 60.589)
)

extents_kable <- knitr::kable(x = extents)
  
```

# Setup

I will prepare for this vignette by loading the necessary packages to run this script. I will also be creating maps during this analysis, so I will create a list object containing a standardized map style that I will continue to use.

```{r load necesssary packages, echo = FALSE}

library(tidyverse)  #data manipulation

library(here) #making directory pathways easier on different instances
here()
# here() starts at the root folder of this package.

library(devtools)
library(dismo) # generate random background points

# spatial data handling
library(raster) 
library(terra)

```

```{r ggplot object for map style}

map_style <- list(
  xlab("longitude"),
  ylab("latitude"),
  theme_classic(),
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "lightblue",
                                colour = "lightblue")
        ),
  coord_equal() 
)

```

# 1. Trim Bioclim layers 

First, I will need to create a few copies of the bioclim layers that I tidied in the last vignette. I will create a set of rasters cropped to most of North America, which will be used to project all model outputs from both the regional and global models. 

## Historical Rasters- N America

These raster copies will be used to project all models. We are specifically interested in the suitable area for the entire North American continent, but model training should not take place at this scale because it is too large. When projecting a model to create a raster of suitability, SDMtune requires a raster stack containing a layer for each covariate that was used to create the model, with the same naming convention. 

```{r set wd}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/historical_climate_rasters/chelsa2.1_30arcsec/v1_maxent_10km")

```

```{r setup for cropping bioclim layers}

# lists of target files in the directory
# load in bioclim layers to be cropped- the original .asc files
env.files <- list.files(path = file.path(mypath), pattern = "\\.asc$", full.names = TRUE) %>%
# extract the 4 bioclim layers I will be using in my models. Access to cities will not be used until later models
  grep("atc_2015_global.asc|bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE)

# output file names
output.files <- list.files(path = file.path(mypath), pattern = "\\.asc$", full.names = FALSE) %>%
  grep("atc_2015_global.asc|bio2_1981-2010_global.asc|bio11_1981-2010_global.asc|bio12_1981-2010_global.asc|bio15_1981-2010_global.asc", ., value = TRUE) %>%
  gsub(pattern = "global", replacement = "NAmerica")

# extent object for N America (retrieved 11-30-2023)
ext.obj <- terra::ext(-140.976563, -51.064453, 15.182421, 60.586967)

```

Here I will actually crop the layers and convert them to the .ascii format for MaxEnt.

```{r loop to crop bioclim layers to N america}

# view list of filetypes for terra, use .ascii
View(terra::gdal(drivers = TRUE))

if(FALSE) {
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    
    # crop new rasters to extent
    rast.hold <- terra::crop(x = rast.hold, y = ext.obj, overwrite = FALSE)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, output.files[a]), filetype = "AAIGrid", overwrite = FALSE)
    
    # remove object once its done
    rm(rast.hold)
    
  }
  
}

# I am pretty sure this method resets the raster cell numbers, which might be annoying downstream....

```

Lets plot one of the new layers to make sure the cropping worked.

```{r plot main_layer to ensure cropping worked}

bio11 <- terra::rast(x = file.path(mypath, "bio11_1981-2010_NAmerica.asc")) 
# convert to df
bio11_df <- terra::as.data.frame(bio11, xy = TRUE)

# plot main layer as example
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = bio11_df, 
            aes(x = x, y = y, fill = `CHELSA_bio11_1981-2010_V.2.1`)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)
# the cropping worked

```

## CMIP6 Rasters- N America

We will repeat the same process for the CMIP6 rasters. We only need versions cropped to North America for projection purposes.

```{r set wd}

# path to directory
  mypath <- file.path(here() %>% 
                       dirname(),
                     "maxent/future_climate_rasters/chelsa2.1_30arcsec/2041-2070_ssp370_GFDL/v1_maxent_10km")

```

```{r setup for cropping bioclim layers}

# lists of target files in the directory
# load in bioclim layers to be cropped- the original .asc files
env.files <- list.files(path = file.path(mypath), pattern = "\\.asc$", full.names = TRUE) %>%
# extract the 4 bioclim layers I will be using in my models. Access to cities will not be used until later models
  grep("bio2_2041-2070_gfdl_370_global.asc|bio11_2041-2070_gfdl_370_global.asc|bio12_2041-2070_gfdl_370_global.asc|bio15_2041-2070_gfdl_370_global.asc", ., value = TRUE)

# output file names
output.files <- list.files(path = file.path(mypath), pattern = "\\_global.asc$", full.names = FALSE) %>%
  grep("bio2_2041-2070_gfdl_370_global.asc|bio11_2041-2070_gfdl_370_global.asc|bio12_2041-2070_gfdl_370_global.asc|bio15_2041-2070_gfdl_370_global.asc", ., value = TRUE) %>%
  gsub(pattern = "global", replacement = "NAmerica")

# extent object for N America (retrieved 11-30-2023)
ext.obj <- terra::ext(-140.976563, -51.064453, 15.182421, 60.586967)

```

```{r loop to crop bioclim layers to N america}

# view list of filetypes for terra, use .ascii
View(terra::gdal(drivers = TRUE))

if(FALSE) {
  
  # loop to crop extent for all files
  for(a in seq_along(env.files)){

    #ensure that the CRS is consistent
    rast.hold <- terra::rast(env.files[a])
    
    # crop new rasters to extent
    rast.hold <- terra::crop(x = rast.hold, y = ext.obj, overwrite = FALSE)
    
    #write out the new resampled rasters!
    terra::writeRaster(x = rast.hold, filename = file.path(mypath, output.files[a]), filetype = "AAIGrid", overwrite = FALSE)
    
    # remove object once its done
    rm(rast.hold)
    
  }
  
}

# I am pretty sure this method resets the raster cell numbers, which might be annoying downstream....

```

Lets plot one of the new layers to make sure the cropping worked.

```{r plot main_layer to ensure cropping worked}

bio11_CMIP6 <- terra::rast(x = file.path(mypath, "bio11_2041-2070_gfdl_370_NAmerica.asc")) 
# convert to df
bio11_CMIP6_df <- terra::as.data.frame(bio11_CMIP6, xy = TRUE)

# plot main layer as example
(ggplot() +
  # change scale of plots to be standard across figures
  geom_raster(data = bio11_CMIP6_df, 
            aes(x = x, y = y, fill = `CHELSA_bio11_2041-2070_gfdl-esm4_ssp370_V.2.1`)) +
  xlab("longitude") +
  ylab("latitude") +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_equal()
)
# the cropping worked

```

# 2. Select Background Points for model

MaxEnt also requires a set of "background" points that it will use to sample these rasters. MaxEnt can randomly pick these internally, but it is more intuitive to manually select them. I can also account for latitudinal stretching of cell size and other factors if these are selected manually. Just for review, these points are used to characterize the variables that affect SLF distribution. Temperature / precipitation values will be extracted from the rasters for each point in this set. MaxEnt will then use these points to calculate an equation that describes the relationship of SLF with its environment and predict suitability. Note that only one set of background points need to be created for each of the global and regional models.

First, I will load in known SLF presences so that background sampling does not occur in those grid cells.

```{r load in SLF presence}

# dismo requires the base function (not tidyverse)
slf_points <- read.csv(file = file.path(here(), "vignette-outputs", "data-tables", "slf_all_final_coords_2024-02-01.csv")) %>%
   dplyr::select(-species) 

```

```{r set wd}

# file path to local directory
mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_30arcsec/v1_maxent_10km")

```

Gallien et.al recommended 20,000 points for background with a global scale model. Gallien also found that a higher number of background points artificially deflates MaxEnt predicitons, so it is important not to choose too many. However, it is appropriate to scale the datasets according to the spatial scale of the rasters. Initially, I selected 42,523 random background points using `dismo::randomPoints()`, because Santana Jr et.al recommended this amount when modeling at a global scale (Santana Jr et.al, 2019). These models were incredibly specific and overfit, and the models were incredible complex, so I downgraded the point count to 20,000. 

Note that I will be running this analysis at the 10km scale, so I need to use the 10km rasters to ensure that points are chosen with appropriate spacing. These datasets will be stored in `vignette-outputs/data-tables`.

```{r background points for global models}

# load in reference layer. needs to be done with raster package because dismo doesnt recognize terra package objects
global_bio2 <- raster::raster(x = file.path(mypath, "bio2_1981-2010_global.asc"))
# check number of cells
terra::ncell(global_bio2)
# plenty of cells to work with if we remove those with SLF points

# set seed so that the random points for this dataset are the same the next time this code is run
set.seed(1)
# generate random points 
global_points <- dismo::randomPoints(
  mask = global_bio2, 
  n = 20000, # default number used by maxent
  p = slf_points,
  excludep = TRUE, # exclude cells where slf has been found
  lonlatCorrection = TRUE, # weight samples by latitude because cell size is larger closer to equator
  warn = 2 # higher number gives most warnings, including if sample size not reached
  ) %>%
  as.data.frame(.)

# save as csv
write_csv(x = global_points, file = file.path(here(), "vignette-outputs", "data-tables", "global_background_points_v3.csv"))
# save as rds file
write_rds(global_points, file = file.path(here(), "data", "global_background_points_v3.rds"))
  
  
```

Now, I will plot these points for visualization purposes.

```{r load in files for plotting}

mypath <- file.path(here() %>% 
                     dirname(),
                   "maxent/historical_climate_rasters/chelsa2.1_30arcsec/v1_maxent_10km")

global_bio2_df <- terra::rast(x = file.path(mypath, "bio2_1981-2010_global.asc")) %>%
  terra::as.data.frame(., xy = TRUE)

global_points <- read_csv(file = file.path(here(), "vignette-outputs", "data-tables", "global_background_points_v3.csv"))

```

```{r plot points}

global_points_plot <- ggplot() +
    geom_raster(data = global_bio2_df, aes(x = x, y = y), fill = "azure1") +
    geom_point(data = global_points, aes(x = x, y = y), color = "darkorange", size = 0.1) +
    ggtitle("Global Background Points") +
    map_style +
    theme(legend.position = "none") 

```

The points seem to sufficiently cover the global extent. I can also see the latitude weighting, as the areas nearest the poles are less densely covered with points than areas near the equator.

```{r save plot}

ggsave(global_points_plot, 
       filename = file.path(here(), "vignette-outputs", "figures", "global_background_points_v3.jpg"),
       height = 8, 
       width = 10,
       device = "jpeg",
       dpi = "retina")

```

Now that we have selected the background point datasets and created rasters for training and projection purposes, we are ready to run our models. The next vignette will train and project the global model, while the following vignette will perform a similar setup for the regional model.


# References

D.D Calvin, J. Rost, J. Keller, S. Crawford, Julie Urban, B. Walsh, and M. Bosold. Seasonal Activity of Spotted Lanternfly, Lycorma delicatula (White) (Hemiptera: Fulgoridae), in Southeast Pennsylvania. Unpublished.

Gallien, L., R. Douzet, S. Pratte, N. E. Zimmermann, and W. Thuiller. 2012. Invasive species distribution models – how violating the equilibrium assumption can create new insights. Global Ecology and Biogeography 21:1126–1136.

Lewkiewicz, S. M., S. De Bona, M. R. Helmus, and B. Seibold. 2022. Temperature sensitivity of pest reproductive numbers in age-structured PDE models, with a focus on the invasive spotted lanternfly. Journal of Mathematical Biology 85:29.

Santana Jr, P. A., L. Kumar, R. S. Da Silva, J. L. Pereira, and M. C. Picanço. 2019. Assessing the impact of climate change on the worldwide distribution of Dalbulus maidis (DeLong) using MaxEnt. Pest Management Science 75:2706–2715.



