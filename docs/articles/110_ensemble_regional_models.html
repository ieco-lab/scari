<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Ensemble regional-scale models using a weighted mean • scarifSDM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Ensemble regional-scale models using a weighted mean">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">scarifSDM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/scarifSDM.html">Get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Quantify risk to specific viticultural regions</h6></li>
    <li><a class="dropdown-item" href="../articles/150_create_risk_report.html">Example usage of create_risk_report() to create reports of key viticultural areas</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Initialize scarifSDM</h6></li>
    <li><a class="dropdown-item" href="../articles/010_initialize_pkg.html">Initialization of renv package for dependencies</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>1. Retrieve and tidy input data for MaxEnt</h6></li>
    <li><a class="dropdown-item" href="../articles/020_retrieve_bioclim_variables.html">Bioclim variable rasters: CHELSA</a></li>
    <li><a class="dropdown-item" href="../articles/030_retrieve_occurrence_records.html">SLF occurrence records: GBIF, lydemapR, literature</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>2. SDM modeling pipeline</h6></li>
    <li><a class="dropdown-item" href="../articles/040_setup_global_MaxEnt_model.html">Setup for global-scale MaxEnt model</a></li>
    <li><a class="dropdown-item" href="../articles/050_run_global_MaxEnt_model.html">Run global-scale MaxEnt model</a></li>
    <li><a class="dropdown-item" href="../articles/060_setup_regional_MaxEnt_models.html">Setup for regional-scale MaxEnt models</a></li>
    <li><a class="dropdown-item" href="../articles/070_run_regional_invaded_MaxEnt_model.html">Run 'Ri.NAmerica' model trained on SLF invaded region in North America</a></li>
    <li><a class="dropdown-item" href="../articles/080_run_regional_invaded_asian_MaxEnt_model.html">Run 'Ri.Asia' model trained on SLF invaded range in Japan and South Korea</a></li>
    <li><a class="dropdown-item" href="../articles/090_run_regional_native_MaxEnt_model.html">Run 'Rn' model trained on SLF native range in east Asia</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>3. Ensemble Regional-scale SDMs</h6></li>
    <li><a class="dropdown-item" href="../articles/100_run_ExDet_MIC.html">Run an Extrapolation Detection (NT2) analysis and calculate MIC</a></li>
    <li><a class="dropdown-item" href="../articles/110_ensemble_regional_models.html">Ensemble regional-scale models using a weighted mean</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>4. Quantify SLF risk and model fit</h6></li>
    <li><a class="dropdown-item" href="../articles/120_create_suitability_maps.html">Create risk maps of each model scale and intersect predictions</a></li>
    <li><a class="dropdown-item" href="../articles/130_create_suitability_xy_plots_viticultural.html">Plot shift in SLF risk to important viticultural regions under climate change</a></li>
    <li><a class="dropdown-item" href="../articles/131_create_suitability_xy_plots_SLF.html">Infer stability of known SLF populations due climate change effects</a></li>
    <li><a class="dropdown-item" href="../articles/140_plot_response_curves.html">Analyze biological realism of model response curves</a></li>
    <li><a class="dropdown-item" href="../articles/141_plot_AUC_var_cont.html">Check model goodness of fit via AUC, TSS and confusion matrices</a></li>
    <li><a class="dropdown-item" href="../articles/142_calculate_model_fit.html">Calculate model fit using confusion matrices</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ieco-lab/scarifSDM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Ensemble regional-scale models using a weighted mean</h1>
                        <h4 data-toc-skip class="author">Samuel M.
Owens<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Temple University &lt;a href="http://www.biodiversitycenter.org/" class="external-link"&gt;Center for Biodiversity&lt;/a&gt; &lt;a href="https://www.iecolab.org/" class="external-link"&gt;iEco Lab&lt;/a&gt; &lt;a href="mailto:sam.owens@temple.edu" class="email"&gt;sam.owens@temple.edu&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>
</h4>
            
            <h4 data-toc-skip class="date">2024-08-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ieco-lab/scarifSDM/blob/HEAD/vignettes/110_ensemble_regional_models.Rmd" class="external-link"><code>vignettes/110_ensemble_regional_models.Rmd</code></a></small>
      <div class="d-none name"><code>110_ensemble_regional_models.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>In vignettes 060-090, I created three regional-scale MaxEnt models
for invasive plant pest <em>Lycorma delicatula</em> based on historical
and predicted future climate trends under climate change. One of these
models was based on the planthopper’s native range in east Asia, while
the other two models were based on the regions it has so far invaded
(the Koreas/Japan and North America). These regional models were created
using the same data and settings as the global-scale version (vignette
050), which considers all regions together.</p>
<p>Our goal is to compare the global-scale output with that from the
three regional-scale models. A global-scale model is the traditional
approach to modeling species distributions and represents an important
generalization made using all data, but it may not consider localized
climate conditions that differ between regions (Gallien et al, 2012). I
hypothesized that by creating models at multiple spatial scales, I can
have more confidence in suitability predictions made for specific SLF
populations and important viticultural regions, and can predict the risk
of specific populations spreading now and under climate change (Araújo
and New, 2007). I also hypothesize that the regional-scale models, once
ensembled into a single prediction, will make more refined predictions
than a global-scale model could.</p>
<p>We will ensemble the three regional-scale models into a single
prediction using a weighted mean approach. This will involve weighting
each model’s predictions by the ExDet metric (Which we measured in the
last vignette, 100) and its test AUC value. The ExDet metric measures
the level of extrapolation in the model’s predictions when projecting
models. Measuring the level of extrapolation is very important when
making predictions across different climate zones, time periods, or for
range shifting species (we check all of those boxes) (Elith et al, 2010;
Mesgaran et al, 2014). We will directly use the Exdet metric from each
model to measure our confidence in its predictions for a particular grid
cell. We will also use the test AUC from each model in the weighting so
that we also consider goodness of fit.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span> </span>
<span><span class="co"># here() is set at the root folder of this package</span></span>
<span></span>
<span><span class="co"># spatial data handling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># aesthetics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://eliocamp.github.io/ggnewscale/" class="external-link">ggnewscale</a></span><span class="op">)</span></span></code></pre></div>
<p><strong>Note:</strong> I will be setting the global options of this
document so that only certain code chunks are rendered in the final
.html file. I will set the <code>eval = FALSE</code> so that none of the
code is re-run (preventing files from being overwritten during knitting)
and will simply overwrite this in chunks with plots.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"plots"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h3>
<p>I will define a helper function and import the background area
rasters for plotting.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">format_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.*f"</span>, <span class="fl">2</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># formats decimals to 2 places</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># path to directory</span></span>
<span><span class="va">mypath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     <span class="st">"maxent/historical_climate_rasters/chelsa2.1_30arcsec"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># native</span></span>
<span><span class="va">regional_native_background_area</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"v1_maxent_10km"</span>, <span class="st">"bio11_1981-2010_regional_native_KG.asc"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># invaded</span></span>
<span><span class="va">regional_invaded_background_area</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"v1_maxent_10km"</span>, <span class="st">"bio11_1981-2010_regional_invaded_KG.asc"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># invaded_asian</span></span>
<span><span class="va">regional_invaded_asian_background_area</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"v1_maxent_10km"</span>, <span class="st">"bio11_1981-2010_regional_invaded_asian_KG.asc"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># convert to df</span></span>
<span><span class="va">regional_native_background_area_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">regional_native_background_area</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">regional_invaded_background_area_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">regional_invaded_background_area</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">regional_invaded_asian_background_area_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">regional_invaded_asian_background_area</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="import-datasets">1. Import datasets<a class="anchor" aria-label="anchor" href="#import-datasets"></a>
</h2>
<div class="section level3">
<h3 id="maxent-predictions">1.1 MaxEnt Predictions<a class="anchor" aria-label="anchor" href="#maxent-predictions"></a>
</h3>
<p>First, I need to load in the rasters containing the predictions from
each model. I will load in both the historical and climate change
versions of these predictions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># output directory</span></span>
<span><span class="va">mypath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">dirname</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     <span class="st">"maxent"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_regional_native</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"regional_native_pred_suit_clamped_cloglog_globe_1981-2010.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="co"># SSP126</span></span>
<span><span class="va">pred_regional_native_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"regional_native_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp126.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP370</span></span>
<span><span class="va">pred_regional_native_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"regional_native_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP585</span></span>
<span><span class="va">pred_regional_native_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"regional_native_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp585.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"regional_invaded_pred_suit_clamped_cloglog_globe_1981-2010.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="co"># SSP126</span></span>
<span><span class="va">pred_regional_invaded_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"regional_invaded_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp126.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP370</span></span>
<span><span class="va">pred_regional_invaded_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"regional_invaded_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP585</span></span>
<span><span class="va">pred_regional_invaded_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"regional_invaded_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp585.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"regional_invaded_asian_pred_suit_clamped_cloglog_globe_1981-2010.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="co"># SSP126</span></span>
<span><span class="va">pred_regional_invaded_asian_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"regional_invaded_asian_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp126.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP370</span></span>
<span><span class="va">pred_regional_invaded_asian_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"regional_invaded_asian_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp370.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># SSP585</span></span>
<span><span class="va">pred_regional_invaded_asian_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"regional_invaded_asian_pred_suit_clamped_cloglog_globe_2041-2070_GFDL_ssp585.asc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="auc-values">1.2 AUC values<a class="anchor" aria-label="anchor" href="#auc-values"></a>
</h3>
<p>Next, I will load in the AUC value from each model, which will be
used to weight each model’s predictions, specifically based on its test
AUC value.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AUC_regional_native</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"regional_native_AUC_TSS.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">AUC</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AUC_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"regional_invaded_AUC_TSS.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">AUC</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AUC_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"regional_invaded_asian_AUC_TSS.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">AUC</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AUC_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AUC_regional_native"</span>, <span class="st">"AUC_regional_invaded"</span>, <span class="st">"AUC_regional_invaded_asian"</span><span class="op">)</span>,</span>
<span>  AUC_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">AUC_regional_native</span>, <span class="va">AUC_regional_invaded</span>, <span class="va">AUC_regional_invaded_asian</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exdet-rasters">1.3 ExDet rasters<a class="anchor" aria-label="anchor" href="#exdet-rasters"></a>
</h3>
<p>Finally, I will load in the results from the ExDet analysis to weight
the ensemble.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_regional_native</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"ExDet_slf_regional_native_v3_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="co"># SSP126</span></span>
<span><span class="va">exdet_regional_native_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"ExDet_slf_regional_native_v3_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP370</span></span>
<span><span class="va">exdet_regional_native_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"ExDet_slf_regional_native_v3_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP585</span></span>
<span><span class="va">exdet_regional_native_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"ExDet_slf_regional_native_v3_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"ExDet_slf_regional_invaded_v7_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="co"># SSP126</span></span>
<span><span class="va">exdet_regional_invaded_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"ExDet_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP370</span></span>
<span><span class="va">exdet_regional_invaded_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"ExDet_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP585</span></span>
<span><span class="va">exdet_regional_invaded_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"ExDet_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"ExDet_slf_regional_invaded_asian_v2_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="co"># SSP126</span></span>
<span><span class="va">exdet_regional_invaded_asian_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"ExDet_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP370</span></span>
<span><span class="va">exdet_regional_invaded_asian_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"ExDet_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP585</span></span>
<span><span class="va">exdet_regional_invaded_asian_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"ExDet_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="edit-import-datasets">2. Edit import datasets<a class="anchor" aria-label="anchor" href="#edit-import-datasets"></a>
</h2>
<div class="section level3">
<h3 id="stack-rasters">2.1 Stack rasters<a class="anchor" aria-label="anchor" href="#stack-rasters"></a>
</h3>
<p>I will need to stack the predicted and ExDet rasters to perform this
analysis.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_hist_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pred_regional_native</span>, <span class="va">pred_regional_invaded</span>, <span class="va">pred_regional_invaded_asian</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="va">pred_126_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pred_regional_native_126</span>, <span class="va">pred_regional_invaded_126</span>, <span class="va">pred_regional_invaded_asian_126</span><span class="op">)</span></span>
<span><span class="va">pred_370_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pred_regional_native_370</span>, <span class="va">pred_regional_invaded_370</span>, <span class="va">pred_regional_invaded_asian_370</span><span class="op">)</span></span>
<span><span class="va">pred_585_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pred_regional_native_585</span>, <span class="va">pred_regional_invaded_585</span>, <span class="va">pred_regional_invaded_asian_585</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_hist_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native</span>, <span class="va">exdet_regional_invaded</span>, <span class="va">exdet_regional_invaded_asian</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="va">exdet_126_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native_126</span>, <span class="va">exdet_regional_invaded_126</span>, <span class="va">exdet_regional_invaded_asian_126</span><span class="op">)</span></span>
<span><span class="va">exdet_370_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native_370</span>, <span class="va">exdet_regional_invaded_370</span>, <span class="va">exdet_regional_invaded_asian_370</span><span class="op">)</span></span>
<span><span class="va">exdet_585_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native_585</span>, <span class="va">exdet_regional_invaded_585</span>, <span class="va">exdet_regional_invaded_asian_585</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preparatory-raster-edits">2.2 Preparatory raster edits<a class="anchor" aria-label="anchor" href="#preparatory-raster-edits"></a>
</h3>
<p>The pred rasters need to be cropped slightly because the function
used to create the ExDet rasters cropped them slightly. These raster
sets need to share the same extent for downstream manipulations.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">pred_hist_stack</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># I will trim the rasters to the extent of the exdet rasters</span></span>
<span><span class="va">ext.obj</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180.00013888885</span>, <span class="fl">178.999859675084</span>, <span class="op">-</span><span class="fl">58.5001390148238</span>, <span class="fl">82.99986041915</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># crop rasters</span></span>
<span><span class="va">pred_hist_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">pred_hist_stack</span>, <span class="va">ext.obj</span><span class="op">)</span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="va">pred_126_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">pred_126_stack</span>, <span class="va">ext.obj</span><span class="op">)</span></span>
<span><span class="va">pred_370_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">pred_370_stack</span>, <span class="va">ext.obj</span><span class="op">)</span></span>
<span><span class="va">pred_585_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">pred_585_stack</span>, <span class="va">ext.obj</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pred_hist_stack</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_regional_native"</span>, <span class="st">"pred_regional_invaded"</span>, <span class="st">"pred_regional_invaded_asian"</span><span class="op">)</span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pred_126_stack</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_regional_native_126"</span>, <span class="st">"pred_regional_invaded_126"</span>, <span class="st">"pred_regional_invaded_asian_126"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pred_370_stack</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_regional_native_370"</span>, <span class="st">"pred_regional_invaded_370"</span>, <span class="st">"pred_regional_invaded_asian_370"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pred_585_stack</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_regional_native_585"</span>, <span class="st">"pred_regional_invaded_585"</span>, <span class="st">"pred_regional_invaded_asian_585"</span><span class="op">)</span></span></code></pre></div>
<p>Now, I need to prepare to weight the predicted distribution rasters
using their respective ExDet raster.</p>
</div>
</div>
<div class="section level2">
<h2 id="ensemble-rasters">3. Ensemble rasters<a class="anchor" aria-label="anchor" href="#ensemble-rasters"></a>
</h2>
<p>I will create a weight factor for each model raster in this section
across several steps. First, I will convert the ExDet rasters to a
weight value. Next, I will add the test AUC values to these rasters and
create a weighting factor. Finally, I will apply the weights to take the
weighted mean of the three models.</p>
<div class="section level3">
<h3 id="format-exdet-rasters-into-weighting-factor">3.1 Format ExDet rasters into weighting factor<a class="anchor" aria-label="anchor" href="#format-exdet-rasters-into-weighting-factor"></a>
</h3>
<p>First, I will need to manipulate the ExDet rasters so they can be
used for weighting. I will begin by adding 1 to any negative ExDet value
and then taking the absolute value of each cell. This way, the weighting
is performed on a positive scale. The ExDet metric works such that
anything between 0 and 1 is not extrapolated, while anything below 0 or
above 1 is extrapolated. Next, I will convert any ExDet value below 0 to
1, so that cells without extrapolation are simply not weighted.</p>
<ol style="list-style-type: decimal">
<li>Add 1 to any negative ExDet values</li>
<li>Take abs value of ExDet values</li>
<li>Convert any ExDet value below 1 to 1</li>
<li>Take reciprocal of ExDet raster values</li>
</ol>
<div class="section level4">
<h4 id="historical">historical<a class="anchor" aria-label="anchor" href="#historical"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. add 1 to negatives</span></span>
<span></span>
<span><span class="co"># take minmax before</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the min values of each layer should be -1.4, -2.79 and -2.5 respectively after ifelse</span></span>
<span><span class="co"># the max values should be unchanged at 1.4, 1.22 and 2.2</span></span>
<span></span>
<span><span class="va">exdet_hist_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ifelse.html" class="external-link">ifel</a></span><span class="op">(</span></span>
<span>  <span class="va">exdet_hist_stack</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="co"># if the value is &lt; 0</span></span>
<span>  <span class="va">exdet_hist_stack</span> <span class="op">-</span> <span class="fl">1</span>, <span class="co"># subtract 1</span></span>
<span>  <span class="va">exdet_hist_stack</span> <span class="co"># else, keep the same</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># minmax after</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># 2. take abs</span></span>
<span></span>
<span><span class="va">exdet_hist_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># 3. convert values below 1 to 1</span></span>
<span></span>
<span><span class="va">exdet_hist_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ifelse.html" class="external-link">ifel</a></span><span class="op">(</span></span>
<span>  <span class="va">exdet_hist_stack</span> <span class="op">&lt;</span> <span class="fl">1</span>, <span class="co"># if the value is &lt; 1 or == 0</span></span>
<span>  <span class="fl">1</span>, <span class="co"># make 1</span></span>
<span>  <span class="va">exdet_hist_stack</span> <span class="co"># else, keep the same</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># 4. take reciprocals</span></span>
<span></span>
<span><span class="va">exdet_hist_stack</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span>, fun <span class="op">=</span> <span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_hist_stack</span>, </span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_native_v3.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_v7.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_asian_v2.tif"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"GTiff"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>I will do the same for the CMIP6 exdet rasters</p>
<!--

### SSP 126 


``` r
# 1. add 1 to negatives

# take minmax before
minmax(exdet_126_stack)


exdet_126_stack <- terra::ifel(
  exdet_126_stack < 0, # if the value is < 0
  exdet_126_stack - 1, # subtract 1
  exdet_126_stack # else, keep the same
  )

# minmax after
minmax(exdet_126_stack)


# 2. take abs

exdet_126_stack <- abs(exdet_126_stack)

minmax(exdet_126_stack)


# 3. convert values below 1 to 1

exdet_126_stack <- terra::ifel(
  exdet_126_stack < 1 | exdet_126_stack == 0, # if the value is < 1 or == 0
  1, # make 1
  exdet_126_stack # else, keep the same
  )

minmax(exdet_126_stack)


# 4. take reciprocals

exdet_126_stack <- terra::app(exdet_126_stack, fun = (function(i) 1 / i))

minmax(exdet_126_stack)
```


``` r
terra::writeRaster(
  x = exdet_126_stack, 
  filename = c(
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_native_v3_2041-2070_ssp126_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_v7_2041-2070_ssp126_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_asian_v2_2041-2070_ssp126_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )
```

### SSP 370 


``` r
# 1. add 1 to negatives

# take minmax before
minmax(exdet_370_stack)


exdet_370_stack <- terra::ifel(
  exdet_370_stack < 0, # if the value is < 0
  exdet_370_stack - 1, # subtract 1
  exdet_370_stack # else, keep the same
  )

# minmax after
minmax(exdet_370_stack)


# 2. take abs

exdet_370_stack <- abs(exdet_370_stack)

minmax(exdet_370_stack)


# 3. convert values below 1 to 1

exdet_370_stack <- terra::ifel(
  exdet_370_stack < 1 | exdet_370_stack == 0, # if the value is < 1 or == 0
  1, # make 1
  exdet_370_stack # else, keep the same
  )

minmax(exdet_370_stack)


# 4. take reciprocals

exdet_370_stack <- terra::app(exdet_370_stack, fun = (function(i) 1 / i))

minmax(exdet_370_stack)
```


``` r
terra::writeRaster(
  x = exdet_370_stack, 
  filename = c(
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_native_v3_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_v7_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_asian_v2_2041-2070_ssp370_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )
```

### SSP 585 


``` r
# 1. add 1 to negatives

# take minmax before
minmax(exdet_585_stack)


exdet_585_stack <- terra::ifel(
  exdet_585_stack < 0, # if the value is < 0
  exdet_585_stack - 1, # subtract 1
  exdet_585_stack # else, keep the same
  )

# minmax after
minmax(exdet_585_stack)


# 2. take abs

exdet_585_stack <- abs(exdet_585_stack)

minmax(exdet_585_stack)


# 3. convert values below 1 to 1

exdet_585_stack <- terra::ifel(
  exdet_585_stack < 1 | exdet_585_stack == 0, # if the value is < 1 or == 0
  1, # make 1
  exdet_585_stack # else, keep the same
  )

minmax(exdet_585_stack)


# 4. take reciprocals

exdet_585_stack <- terra::app(exdet_585_stack, fun = (function(i) 1 / i))

minmax(exdet_585_stack)
```


``` r
terra::writeRaster(
  x = exdet_585_stack, 
  filename = c(
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_native_v3_2041-2070_ssp585_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_v7_2041-2070_ssp585_GFDL.tif"),
    file.path(mypath, "models", "working_dir", "exdet_weights_slf_regional_invaded_asian_v2_2041-2070_ssp585_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )
```

-->
</div>
</div>
<div class="section level3">
<h3 id="weight-models-using-test-auc">3.2 Weight Models using Test AUC<a class="anchor" aria-label="anchor" href="#weight-models-using-test-auc"></a>
</h3>
<p>The second step in this weighting process is to also weight each
model by its goodness-of-fit. We will use the AUC value for each model
and integrate this into the weighting formula so that each model
contributes based on this goodness of fit. AUC already ranges from 0-1,
so if AUC is 1 then the weight will remain unchanged for that model.
However, if AUC is less than 1, it will lessen the weight of that model
in the overall ensemble. I will multiply each raster by its AUC value
and then save these rasters as ensemble weights.</p>
<div class="section level4">
<h4 id="historical-1">historical<a class="anchor" aria-label="anchor" href="#historical-1"></a>
</h4>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># layer 1</span></span>
<span><span class="va">exdet_hist_stack</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_hist_stack</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># layer 2</span></span>
<span><span class="va">exdet_hist_stack</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_hist_stack</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="va">y</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># layer 3</span></span>
<span><span class="va">exdet_hist_stack</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_hist_stack</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># other operations</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/minmax.html" class="external-link">minmax</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span></span>
<span><span class="co"># add names</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">exdet_hist_stack</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"regional_native"</span>, <span class="st">"regional_invaded"</span>, <span class="st">"regional_invaded_asian"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/writeRaster.html" class="external-link">writeRaster</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_hist_stack</span>, </span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_weights_slf_regional_native_v3.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_weights_slf_regional_invaded_v7.tif"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_weights_slf_regional_invaded_asian_v2.tif"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"GTiff"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Now, I will perform the same operation to the CMIP6 rasters.</p>
<!--

### SSP 126 


``` r
minmax(exdet_126_stack)

# layer 1
exdet_126_stack[[1]] <-terra::app(
  x = exdet_126_stack[[1]],
  fun = function(x) x * as.numeric(AUC_values[[1, 2]])
)

# layer 2
exdet_126_stack[[2]] <-terra::app(
  x = exdet_126_stack[[2]],
  fun = function(y) y * as.numeric(AUC_values[[2, 2]])
)

# layer 3
exdet_126_stack[[3]] <-terra::app(
  x = exdet_126_stack[[3]],
  fun = function(z) z * as.numeric(AUC_values[[3, 2]])
)


# other operations
minmax(exdet_126_stack)
# add names
names(exdet_126_stack) <- c("regional_native_126_2041-2070", "regional_invaded_126_2041-2070", "regional_invaded_asian_126_2041-2070")
```


``` r
terra::writeRaster(
  x = exdet_126_stack, 
  filename = c(
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_native_v3_2041-2070_ssp126_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_invaded_v7_2041-2070_ssp126_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_invaded_asian_v2_2041-2070_ssp126_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )
```

### SSP 370 


``` r
minmax(exdet_370_stack)

# layer 1
exdet_370_stack[[1]] <-terra::app(
  x = exdet_370_stack[[1]],
  fun = function(x) x * as.numeric(AUC_values[[1, 2]])
)

# layer 2
exdet_370_stack[[2]] <-terra::app(
  x = exdet_370_stack[[2]],
  fun = function(y) y * as.numeric(AUC_values[[2, 2]])
)

# layer 3
exdet_370_stack[[3]] <-terra::app(
  x = exdet_370_stack[[3]],
  fun = function(z) z * as.numeric(AUC_values[[3, 2]])
)


# other operations
minmax(exdet_370_stack)
# add names
names(exdet_370_stack) <- c("regional_native_370_2041-2070", "regional_invaded_370_2041-2070", "regional_invaded_asian_370_2041-2070")
```


``` r
terra::writeRaster(
  x = exdet_370_stack, 
  filename = c(
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_native_v3_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_invaded_v7_2041-2070_ssp370_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_invaded_asian_v2_2041-2070_ssp370_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )
```

### SSP 585


``` r
minmax(exdet_585_stack)

# layer 1
exdet_585_stack[[1]] <-terra::app(
  x = exdet_585_stack[[1]],
  fun = function(x) x * as.numeric(AUC_values[[1, 2]])
)

# layer 2
exdet_585_stack[[2]] <-terra::app(
  x = exdet_585_stack[[2]],
  fun = function(y) y * as.numeric(AUC_values[[2, 2]])
)

# layer 3
exdet_585_stack[[3]] <-terra::app(
  x = exdet_585_stack[[3]],
  fun = function(z) z * as.numeric(AUC_values[[3, 2]])
)


# other operations
minmax(exdet_585_stack)
# add names
names(exdet_585_stack) <- c("regional_native_585_2041-2070", "regional_invaded_585_2041-2070", "regional_invaded_asian_585_2041-2070")
```


``` r
terra::writeRaster(
  x = exdet_585_stack, 
  filename = c(
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_native_v3_2041-2070_ssp585_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_invaded_v7_2041-2070_ssp585_GFDL.tif"),
    file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_weights_slf_regional_invaded_asian_v2_2041-2070_ssp585_GFDL.tif")
  ),
  filetype = "GTiff",
  overwrite = FALSE
  )
```

-->
</div>
</div>
<div class="section level3">
<h3 id="apply-weighting-factor-to-models">3.3 Apply weighting factor to models<a class="anchor" aria-label="anchor" href="#apply-weighting-factor-to-models"></a>
</h3>
<p>Finally, I will apply these weighting factors to the predicted raster
layers from each model and take a weighted mean. Weighted means are a
common method for creating model ensembles (Araújo &amp; New, 2007). The
three predicted suitability rasters will each be weighted by their
respective weighted exdet raster. This will be repeated for the CMIP6
rasters as well.</p>
<p>The historical predictions are final, once this weighted mean is
taken, so I will create this file first and save it as a .ascii
file.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># historical</span></span>
<span><span class="va">pred_hist_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">pred_hist_stack</span>,</span>
<span>  w <span class="op">=</span> <span class="va">exdet_hist_stack</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_regional_weighted_mean_globe_1981-2010.asc"</span><span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>I will take the weighted mean of the CMIP6 rasters as well, but will
additionally take an unweighted mean of the three files created below to
obtain one prediction for the time period of 2041-2070.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CMIP6</span></span>
<span><span class="co"># SSP126</span></span>
<span><span class="va">pred_126_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">pred_126_stack</span>,</span>
<span>  w <span class="op">=</span> <span class="va">exdet_126_stack</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_regional_weighted_mean_globe_2041-2070_GFDL_ssp126.asc"</span><span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP370</span></span>
<span><span class="va">pred_370_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">pred_370_stack</span>,</span>
<span>  w <span class="op">=</span> <span class="va">exdet_370_stack</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_regional_weighted_mean_globe_2041-2070_GFDL_ssp370.asc"</span><span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SSP585</span></span>
<span><span class="va">pred_585_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">pred_585_stack</span>,</span>
<span>  w <span class="op">=</span> <span class="va">exdet_585_stack</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_regional_weighted_mean_globe_2041-2070_GFDL_ssp585.asc"</span><span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now I will take an unweighted mean of the above three rasters.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># stack rasters</span></span>
<span><span class="va">pred_CMIP6_mean_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pred_126_mean</span>, <span class="va">pred_370_mean</span>, <span class="va">pred_585_mean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># apply mean between layers</span></span>
<span><span class="va">pred_CMIP6_mean_final</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">pred_CMIP6_mean_stack</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_regional_weighted_mean_globe_2041-2070_GFDL_ssp_averaged.asc"</span><span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We now have a weighted mean raster for each of the historical and
CMIP rasters, and a final climate change prediction that is the mean of
the SSP 126, SSP 370 and SSP 585 scenarios.</p>
</div>
</div>
<div class="section level2">
<h2 id="ensemble-thresholds">4. Ensemble thresholds<a class="anchor" aria-label="anchor" href="#ensemble-thresholds"></a>
</h2>
<p>I also need to ensemble the thresholds that I will be using to create
scatter plots and thresholded maps downstream. The ensemble will be
performed using the same method as above, but slightly altered. I will
use the pred rasters to extract the coordinates of locations that have
the same suitability value as the threshold. Next, I will take these
coordinates and extract the ExDet values from those same locations. I
will take the mean or median of those values. Then, I will multiply the
threshold by this value and the AUC for that model. Finally, I will take
the weighted mean of the three modified thresh values. This will be
repeated for the MTP threshold as well. Finally, this process will also
be completed for the CMIP6 version of these models.</p>
<p>Per projected time period (historical and 2041-2070) and threshold
value: 1. Extract all values from <code>pred</code> rasters that match
the respective model threshold value. 2. Extract all values from the
converted <code>exdet</code> rasters at those locations 3. Take mean of
the exdet values at those locations. 4. Multiply this mean by the AUC
value for that model. 5. Take the weighted mean of the three threshold
values using these created weights.</p>
<div class="section level3">
<h3 id="import-data">4.1 Import data<a class="anchor" aria-label="anchor" href="#import-data"></a>
</h3>
<div class="section level4">
<h4 id="exdet-rasters-1">ExDet rasters<a class="anchor" aria-label="anchor" href="#exdet-rasters-1"></a>
</h4>
<p>I will load in the results from the ExDet analysis to weight the
ensemble.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_weight_regional_native</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_native_v3.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exdet_weight_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_v7.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exdet_weight_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_asian_v2.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_weight_hist_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_weight_regional_native</span>, <span class="va">exdet_weight_regional_invaded</span>, <span class="va">exdet_weight_regional_invaded_asian</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ssp126</span></span>
<span><span class="va">exdet_weight_regional_native_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_native_v3_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_weight_regional_invaded_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_v7_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_weight_regional_invaded_asian_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_asian_v2_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ssp370</span></span>
<span><span class="va">exdet_weight_regional_native_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_native_v3_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_weight_regional_invaded_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_v7_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_weight_regional_invaded_asian_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_asian_v2_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ssp585</span></span>
<span><span class="va">exdet_weight_regional_native_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_native_v3_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_weight_regional_invaded_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_v7_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_weight_regional_invaded_asian_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"working_dir"</span>, <span class="st">"exdet_weights_slf_regional_invaded_asian_v2_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_weight_126_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_weight_regional_native_126</span>, <span class="va">exdet_weight_regional_invaded_126</span>, <span class="va">exdet_weight_regional_invaded_asian_126</span><span class="op">)</span></span>
<span></span>
<span><span class="va">exdet_weight_370_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_weight_regional_native_370</span>, <span class="va">exdet_weight_regional_invaded_370</span>, <span class="va">exdet_weight_regional_invaded_asian_370</span><span class="op">)</span></span>
<span></span>
<span><span class="va">exdet_weight_585_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_weight_regional_native_585</span>, <span class="va">exdet_weight_regional_invaded_585</span>, <span class="va">exdet_weight_regional_invaded_asian_585</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="pred-rasters">4.2 Pred rasters<a class="anchor" aria-label="anchor" href="#pred-rasters"></a>
</h3>
<p>I will also convert the pred rasters to dfs</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#hist</span></span>
<span><span class="va">pred_hist_stack_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">pred_hist_stack</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="va">pred_126_stack_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">pred_126_stack</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pred_370_stack_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">pred_370_stack</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pred_585_stack_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">pred_585_stack</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="thresh-values">thresh values<a class="anchor" aria-label="anchor" href="#thresh-values"></a>
</h4>
<p>The summary files contain the actual threshold values, so I will load
each one in and then isolate the threshold.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># MTSS</span></span>
<span><span class="va">MTSS_regional_native</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"regional_native_summary.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">statistic_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">MTSS_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"regional_invaded_summary.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">statistic_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTSS_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"regional_invaded_asian_summary.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">statistic_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert to vector</span></span>
<span><span class="va">MTSS_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">MTSS_regional_native</span>, <span class="va">MTSS_regional_invaded</span>, <span class="va">MTSS_regional_invaded_asian</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># MTP</span></span>
<span><span class="va">MTP_regional_native</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"regional_native_summary.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">statistic_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTP_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"regional_invaded_summary.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">statistic_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTP_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"regional_invaded_asian_summary.csv"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">statistic_value</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert to vector</span></span>
<span><span class="va">MTP_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">MTP_regional_native</span>, <span class="va">MTP_regional_invaded</span>, <span class="va">MTP_regional_invaded_asian</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="create-weight-for-thresh">4.3 Create weight for thresh<a class="anchor" aria-label="anchor" href="#create-weight-for-thresh"></a>
</h3>
<div class="section level4">
<h4 id="mtss">MTSS<a class="anchor" aria-label="anchor" href="#mtss"></a>
</h4>
<p>First, I will perform these operations for the historical
rasters.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Extract all values from pred rasters that match the respective model threshold value.</span></span>
<span></span>
<span><span class="va">MTSS_regional_native_hist_coords</span> <span class="op">&lt;-</span> <span class="va">pred_hist_stack_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># filter out values with a tolerance</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html" class="external-link">near</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">3</span><span class="op">)</span>, <span class="va">MTSS_all</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, tol <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTSS_regional_invaded_hist_coords</span> <span class="op">&lt;-</span> <span class="va">pred_hist_stack_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html" class="external-link">near</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">4</span><span class="op">)</span>, <span class="va">MTSS_all</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, tol <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTSS_regional_invaded_asian_hist_coords</span> <span class="op">&lt;-</span> <span class="va">pred_hist_stack_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html" class="external-link">near</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">5</span><span class="op">)</span>, <span class="va">MTSS_all</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, tol <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.</span></span>
<span></span>
<span><span class="co"># extract values of exdet raster that are at those coordinates</span></span>
<span><span class="va">MTSS_regional_native_exdet_weight</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">exdet_weight_hist_stack</span>, y <span class="op">=</span> <span class="va">MTSS_regional_native_hist_coords</span><span class="op">)</span></span>
<span><span class="co"># tidy</span></span>
<span><span class="va">MTSS_regional_native_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTSS_regional_native_exdet_weight</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># convert to matrix and take mean</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">MTSS_regional_invaded_exdet_weight</span> <span class="op">&lt;-</span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">exdet_weight_hist_stack</span>, y <span class="op">=</span> <span class="va">MTSS_regional_invaded_hist_coords</span><span class="op">)</span></span>
<span><span class="co"># tidy</span></span>
<span><span class="va">MTSS_regional_invaded_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTSS_regional_invaded_exdet_weight</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># convert to matrix and take mean</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTSS_regional_invaded_asian_exdet_weight</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">exdet_weight_hist_stack</span>, y <span class="op">=</span> <span class="va">MTSS_regional_invaded_asian_hist_coords</span><span class="op">)</span> </span>
<span><span class="co"># tidy</span></span>
<span><span class="va">MTSS_regional_invaded_asian_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTSS_regional_invaded_asian_exdet_weight</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># convert to matrix and take mean</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># 4. Multiply this mean or median by the AUC value for that model.</span></span>
<span></span>
<span><span class="va">MTSS_regional_native_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTSS_regional_native_exdet_weight</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTSS_regional_invaded_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTSS_regional_invaded_exdet_weight</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTSS_regional_invaded_asian_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTSS_regional_invaded_asian_exdet_weight</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># convert to vector</span></span>
<span></span>
<span><span class="va">MTSS_hist_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">MTSS_regional_native_exdet_weight</span>, <span class="va">MTSS_regional_invaded_exdet_weight</span>, <span class="va">MTSS_regional_invaded_asian_exdet_weight</span><span class="op">)</span></span></code></pre></div>
<p>Now, I will take the weighted mean</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MTSS_hist_thresh</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">MTSS_all</span>,</span>
<span>  w <span class="op">=</span> <span class="va">MTSS_hist_weights</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, I will perform this operation for the CMIP6 rasters</p>
<!--

#### ssp126


``` r
# 1. Extract all values from pred rasters that match the respective model threshold value.

MTSS_regional_native_126_coords <- pred_126_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTSS_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_126_coords <- pred_126_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTSS_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_asian_126_coords <- pred_126_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTSS_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTSS_regional_native_exdet_weight_126 <- terra::extract(exdet_weight_126_stack, y = MTSS_regional_native_126_coords)
# tidy
MTSS_regional_native_exdet_weight_126 <- MTSS_regional_native_exdet_weight_126 %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTSS_regional_invaded_exdet_weight_126 <-  terra::extract(exdet_weight_126_stack, y = MTSS_regional_invaded_126_coords)
# tidy
MTSS_regional_invaded_exdet_weight_126 <- MTSS_regional_invaded_exdet_weight_126 %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTSS_regional_invaded_asian_exdet_weight_126 <- terra::extract(exdet_weight_126_stack, y = MTSS_regional_invaded_asian_126_coords) 
# tidy
MTSS_regional_invaded_asian_exdet_weight_126 <- MTSS_regional_invaded_asian_exdet_weight_126 %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTSS_regional_native_exdet_weight_126 <- MTSS_regional_native_exdet_weight_126 * as.numeric(AUC_values[1, 2])

MTSS_regional_invaded_exdet_weight_126 <- MTSS_regional_invaded_exdet_weight_126 * as.numeric(AUC_values[2, 2])

MTSS_regional_invaded_asian_exdet_weight_126 <- MTSS_regional_invaded_asian_exdet_weight_126 * as.numeric(AUC_values[3, 2])


# convert to vector

MTSS_126_weights <- c(MTSS_regional_native_exdet_weight_126, MTSS_regional_invaded_exdet_weight_126, MTSS_regional_invaded_asian_exdet_weight_126)
```

Now, I will take the weighted mean


``` r
MTSS_126_thresh <- stats::weighted.mean(
  x = MTSS_all,
  w = MTSS_126_weights
)
```

#### ssp370 


``` r
# 1. Extract all values from pred rasters that match the respective model threshold value.

MTSS_regional_native_370_coords <- pred_370_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTSS_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_370_coords <- pred_370_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTSS_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_asian_370_coords <- pred_370_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTSS_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTSS_regional_native_exdet_weight_370 <- terra::extract(exdet_weight_370_stack, y = MTSS_regional_native_370_coords)
# tidy
MTSS_regional_native_exdet_weight_370 <- MTSS_regional_native_exdet_weight_370 %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTSS_regional_invaded_exdet_weight_370 <-  terra::extract(exdet_weight_370_stack, y = MTSS_regional_invaded_370_coords)
# tidy
MTSS_regional_invaded_exdet_weight_370 <- MTSS_regional_invaded_exdet_weight_370 %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTSS_regional_invaded_asian_exdet_weight_370 <- terra::extract(exdet_weight_370_stack, y = MTSS_regional_invaded_asian_370_coords) 
# tidy
MTSS_regional_invaded_asian_exdet_weight_370 <- MTSS_regional_invaded_asian_exdet_weight_370 %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTSS_regional_native_exdet_weight_370 <- MTSS_regional_native_exdet_weight_370 * as.numeric(AUC_values[1, 2])

MTSS_regional_invaded_exdet_weight_370 <- MTSS_regional_invaded_exdet_weight_370 * as.numeric(AUC_values[2, 2])

MTSS_regional_invaded_asian_exdet_weight_370 <- MTSS_regional_invaded_asian_exdet_weight_370 * as.numeric(AUC_values[3, 2])


# convert to vector

MTSS_370_weights <- c(MTSS_regional_native_exdet_weight_370, MTSS_regional_invaded_exdet_weight_370, MTSS_regional_invaded_asian_exdet_weight_370)
```

Now, I will take the weighted mean


``` r
MTSS_370_thresh <- stats::weighted.mean(
  x = MTSS_all,
  w = MTSS_370_weights
)
```

#### ssp585 


``` r
# 1. Extract all values from pred rasters that match the respective model threshold value.

MTSS_regional_native_585_coords <- pred_585_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTSS_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_585_coords <- pred_585_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTSS_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTSS_regional_invaded_asian_585_coords <- pred_585_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTSS_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTSS_regional_native_exdet_weight_585 <- terra::extract(exdet_weight_585_stack, y = MTSS_regional_native_585_coords)
# tidy
MTSS_regional_native_exdet_weight_585 <- MTSS_regional_native_exdet_weight_585 %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTSS_regional_invaded_exdet_weight_585 <-  terra::extract(exdet_weight_585_stack, y = MTSS_regional_invaded_585_coords)
# tidy
MTSS_regional_invaded_exdet_weight_585 <- MTSS_regional_invaded_exdet_weight_585 %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTSS_regional_invaded_asian_exdet_weight_585 <- terra::extract(exdet_weight_585_stack, y = MTSS_regional_invaded_asian_585_coords) 
# tidy
MTSS_regional_invaded_asian_exdet_weight_585 <- MTSS_regional_invaded_asian_exdet_weight_585 %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTSS_regional_native_exdet_weight_585 <- MTSS_regional_native_exdet_weight_585 * as.numeric(AUC_values[1, 2])

MTSS_regional_invaded_exdet_weight_585 <- MTSS_regional_invaded_exdet_weight_585 * as.numeric(AUC_values[2, 2])

MTSS_regional_invaded_asian_exdet_weight_585 <- MTSS_regional_invaded_asian_exdet_weight_585 * as.numeric(AUC_values[3, 2])


# convert to vector

MTSS_585_weights <- c(MTSS_regional_native_exdet_weight_585, MTSS_regional_invaded_exdet_weight_585, MTSS_regional_invaded_asian_exdet_weight_585)
```

Now, I will take the weighted mean


``` r
MTSS_585_thresh <- stats::weighted.mean(
  x = MTSS_all,
  w = MTSS_585_weights
)
```

I need to repeat the above operations for the MTP thresholds as well. I will then put all of these thresholds into a table and save it in the ensemble folder.

-->
</div>
<div class="section level4">
<h4 id="mtp">MTP<a class="anchor" aria-label="anchor" href="#mtp"></a>
</h4>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Extract all values from pred rasters that match the respective model threshold value.</span></span>
<span></span>
<span><span class="va">MTP_regional_native_hist_coords</span> <span class="op">&lt;-</span> <span class="va">pred_hist_stack_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># filter out values with a tolerance</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html" class="external-link">near</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">3</span><span class="op">)</span>, <span class="va">MTP_all</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, tol <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTP_regional_invaded_hist_coords</span> <span class="op">&lt;-</span> <span class="va">pred_hist_stack_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html" class="external-link">near</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">4</span><span class="op">)</span>, <span class="va">MTP_all</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, tol <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTP_regional_invaded_asian_hist_coords</span> <span class="op">&lt;-</span> <span class="va">pred_hist_stack_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html" class="external-link">near</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">5</span><span class="op">)</span>, <span class="va">MTP_all</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, tol <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.</span></span>
<span></span>
<span><span class="co"># extract values of exdet raster that are at those coordinates</span></span>
<span><span class="va">MTP_regional_native_exdet_weight</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">exdet_weight_hist_stack</span>, y <span class="op">=</span> <span class="va">MTP_regional_native_hist_coords</span><span class="op">)</span></span>
<span><span class="co"># tidy</span></span>
<span><span class="va">MTP_regional_native_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTP_regional_native_exdet_weight</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># convert to matrix and take mean</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">MTP_regional_invaded_exdet_weight</span> <span class="op">&lt;-</span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">exdet_weight_hist_stack</span>, y <span class="op">=</span> <span class="va">MTP_regional_invaded_hist_coords</span><span class="op">)</span></span>
<span><span class="co"># tidy</span></span>
<span><span class="va">MTP_regional_invaded_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTP_regional_invaded_exdet_weight</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># convert to matrix and take mean</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTP_regional_invaded_asian_exdet_weight</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">exdet_weight_hist_stack</span>, y <span class="op">=</span> <span class="va">MTP_regional_invaded_asian_hist_coords</span><span class="op">)</span> </span>
<span><span class="co"># tidy</span></span>
<span><span class="va">MTP_regional_invaded_asian_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTP_regional_invaded_asian_exdet_weight</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># convert to matrix and take mean</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co"># 4. Multiply this mean or median by the AUC value for that model.</span></span>
<span></span>
<span><span class="va">MTP_regional_native_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTP_regional_native_exdet_weight</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTP_regional_invaded_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTP_regional_invaded_exdet_weight</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">MTP_regional_invaded_asian_exdet_weight</span> <span class="op">&lt;-</span> <span class="va">MTP_regional_invaded_asian_exdet_weight</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">AUC_values</span><span class="op">[</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># convert to vector</span></span>
<span></span>
<span><span class="va">MTP_hist_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">MTP_regional_native_exdet_weight</span>, <span class="va">MTP_regional_invaded_exdet_weight</span>, <span class="va">MTP_regional_invaded_asian_exdet_weight</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MTP_hist_thresh</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">MTP_all</span>,</span>
<span>  w <span class="op">=</span> <span class="va">MTP_hist_weights</span></span>
<span><span class="op">)</span></span></code></pre></div>
<!--

#### ssp126 


``` r
# 1. Extract all values from pred rasters that match the respective model threshold value.

MTP_regional_native_126_coords <- pred_126_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTP_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_126_coords <- pred_126_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTP_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_asian_126_coords <- pred_126_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTP_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTP_regional_native_exdet_weight_126 <- terra::extract(exdet_weight_126_stack, y = MTP_regional_native_126_coords)
# tidy
MTP_regional_native_exdet_weight_126 <- MTP_regional_native_exdet_weight_126 %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTP_regional_invaded_exdet_weight_126 <-  terra::extract(exdet_weight_126_stack, y = MTP_regional_invaded_126_coords)
# tidy
MTP_regional_invaded_exdet_weight_126 <- MTP_regional_invaded_exdet_weight_126 %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTP_regional_invaded_asian_exdet_weight_126 <- terra::extract(exdet_weight_126_stack, y = MTP_regional_invaded_asian_126_coords) 
# tidy
MTP_regional_invaded_asian_exdet_weight_126 <- MTP_regional_invaded_asian_exdet_weight_126 %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTP_regional_native_exdet_weight_126 <- MTP_regional_native_exdet_weight_126 * as.numeric(AUC_values[1, 2])

MTP_regional_invaded_exdet_weight_126 <- MTP_regional_invaded_exdet_weight_126 * as.numeric(AUC_values[2, 2])

MTP_regional_invaded_asian_exdet_weight_126 <- MTP_regional_invaded_asian_exdet_weight_126 * as.numeric(AUC_values[3, 2])


# convert to vector

MTP_126_weights <- c(MTP_regional_native_exdet_weight_126, MTP_regional_invaded_exdet_weight_126, MTP_regional_invaded_asian_exdet_weight_126)
```


``` r
MTP_126_thresh <- stats::weighted.mean(
  x = MTP_all,
  w = MTP_126_weights
)
```

#### ssp370


``` r
# 1. Extract all values from pred rasters that match the respective model threshold value.

MTP_regional_native_370_coords <- pred_370_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTP_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_370_coords <- pred_370_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTP_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_asian_370_coords <- pred_370_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTP_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTP_regional_native_exdet_weight_370 <- terra::extract(exdet_weight_370_stack, y = MTP_regional_native_370_coords)
# tidy
MTP_regional_native_exdet_weight_370 <- MTP_regional_native_exdet_weight_370 %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTP_regional_invaded_exdet_weight_370 <-  terra::extract(exdet_weight_370_stack, y = MTP_regional_invaded_370_coords)
# tidy
MTP_regional_invaded_exdet_weight_370 <- MTP_regional_invaded_exdet_weight_370 %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTP_regional_invaded_asian_exdet_weight_370 <- terra::extract(exdet_weight_370_stack, y = MTP_regional_invaded_asian_370_coords) 
# tidy
MTP_regional_invaded_asian_exdet_weight_370 <- MTP_regional_invaded_asian_exdet_weight_370 %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTP_regional_native_exdet_weight_370 <- MTP_regional_native_exdet_weight_370 * as.numeric(AUC_values[1, 2])

MTP_regional_invaded_exdet_weight_370 <- MTP_regional_invaded_exdet_weight_370 * as.numeric(AUC_values[2, 2])

MTP_regional_invaded_asian_exdet_weight_370 <- MTP_regional_invaded_asian_exdet_weight_370 * as.numeric(AUC_values[3, 2])


# convert to vector

MTP_370_weights <- c(MTP_regional_native_exdet_weight_370, MTP_regional_invaded_exdet_weight_370, MTP_regional_invaded_asian_exdet_weight_370)
```


``` r
MTP_370_thresh <- stats::weighted.mean(
  x = MTP_all,
  w = MTP_370_weights
)
```

#### ssp585


``` r
# 1. Extract all values from pred rasters that match the respective model threshold value.

MTP_regional_native_585_coords <- pred_585_stack_df %>%
  # filter out values with a tolerance
  dplyr::filter(near(dplyr::select(., 3), MTP_all[[1]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_585_coords <- pred_585_stack_df %>%
  dplyr::filter(near(dplyr::select(., 4), MTP_all[[2]], tol = 0.005)) %>%
  dplyr::select(x, y)

MTP_regional_invaded_asian_585_coords <- pred_585_stack_df %>%
  dplyr::filter(near(dplyr::select(., 5), MTP_all[[3]], tol = 0.005)) %>%
  dplyr::select(x, y)





# 2, 3. Extract all values from the converted `exdet` rasters at those locations, Take mean of the exdet values at those locations.

# extract values of exdet raster that are at those coordinates
MTP_regional_native_exdet_weight_585 <- terra::extract(exdet_weight_585_stack, y = MTP_regional_native_585_coords)
# tidy
MTP_regional_native_exdet_weight_585 <- MTP_regional_native_exdet_weight_585 %>%
  dplyr::select(., 2) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean(na.rm = TRUE)


MTP_regional_invaded_exdet_weight_585 <-  terra::extract(exdet_weight_585_stack, y = MTP_regional_invaded_585_coords)
# tidy
MTP_regional_invaded_exdet_weight_585 <- MTP_regional_invaded_exdet_weight_585 %>%
  dplyr::select(., 3) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()

MTP_regional_invaded_asian_exdet_weight_585 <- terra::extract(exdet_weight_585_stack, y = MTP_regional_invaded_asian_585_coords) 
# tidy
MTP_regional_invaded_asian_exdet_weight_585 <- MTP_regional_invaded_asian_exdet_weight_585 %>%
  dplyr::select(., 4) %>%
  # convert to matrix and take mean
  as.matrix() %>%
  mean()




# 4. Multiply this mean or median by the AUC value for that model.

MTP_regional_native_exdet_weight_585 <- MTP_regional_native_exdet_weight_585 * as.numeric(AUC_values[1, 2])

MTP_regional_invaded_exdet_weight_585 <- MTP_regional_invaded_exdet_weight_585 * as.numeric(AUC_values[2, 2])

MTP_regional_invaded_asian_exdet_weight_585 <- MTP_regional_invaded_asian_exdet_weight_585 * as.numeric(AUC_values[3, 2])


# convert to vector

MTP_585_weights <- c(MTP_regional_native_exdet_weight_585, MTP_regional_invaded_exdet_weight_585, MTP_regional_invaded_asian_exdet_weight_585)
```


``` r
MTP_585_thresh <- stats::weighted.mean(
  x = MTP_all,
  w = MTP_585_weights
)
```

-->
</div>
</div>
<div class="section level3">
<h3 id="combine-in-table-and-export">4.4 Combine in table and export<a class="anchor" aria-label="anchor" href="#combine-in-table-and-export"></a>
</h3>
<p>Now, I can create a table for these thresholds and export these
data.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ensemble_thresh_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  thresh <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"MTP"</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"MTSS"</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  time_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1981-2010"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"2041-2070"</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"1981-2010"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"2041-2070"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  CMIP6_model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="st">"ssp126_GFDL-ESM4"</span>, <span class="st">"ssp370_GFDL-ESM4"</span>, <span class="st">"ssp585_GFDL-ESM4"</span>, <span class="st">"ssp_mean_GFDL-ESM4"</span>, <span class="cn">NA</span>, <span class="st">"ssp126_GFDL-ESM4"</span>, <span class="st">"ssp370_GFDL-ESM4"</span>, <span class="st">"ssp585_GFDL-ESM4"</span>, <span class="st">"ssp_mean_GFDL-ESM4"</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">MTP_hist_thresh</span>, <span class="co"># hist</span></span>
<span>    <span class="va">MTP_126_thresh</span>, <span class="va">MTP_370_thresh</span>, <span class="va">MTP_585_thresh</span>, <span class="co"># the three ssp scenarios</span></span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">MTP_126_thresh</span>, <span class="va">MTP_370_thresh</span>, <span class="va">MTP_585_thresh</span><span class="op">)</span><span class="op">)</span>, <span class="co"># the mean of the ssp scenarios</span></span>
<span>    <span class="va">MTSS_hist_thresh</span>, </span>
<span>    <span class="va">MTSS_126_thresh</span>, <span class="va">MTSS_370_thresh</span>, <span class="va">MTSS_585_thresh</span>, </span>
<span>    <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">MTSS_126_thresh</span>, <span class="va">MTSS_370_thresh</span>, <span class="va">MTSS_585_thresh</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">ensemble_thresh_values</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_threshold_values.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># also write to .rds</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_rds.html" class="external-link">write_rds</a></span><span class="op">(</span><span class="va">ensemble_thresh_values</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"data"</span>, <span class="st">"ensemble_threshold_values.rds"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now that I have the suitability values and thresholds ensembled, I
can begin to analyze the differences between the global and regional
ensemble predictions. I will begin by creating suitability maps in the
next vignette.</p>
</div>
</div>
<div class="section level2">
<h2 id="ensemble-exdet-mic-maps">5. Ensemble ExDet / MIC maps<a class="anchor" aria-label="anchor" href="#ensemble-exdet-mic-maps"></a>
</h2>
<p>As a final step, I will ensemble the ExDet and MIC rasters themselves
for visualization.</p>
<div class="section level3">
<h3 id="exdet">5.1 ExDet<a class="anchor" aria-label="anchor" href="#exdet"></a>
</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_style_exdet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"azure3"</span>,</span>
<span>                                        colour <span class="op">=</span> <span class="st">"azure3"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"longitude"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"latitude"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># color scheme taken from: https://colorbrewer2.org/?type=diverging&amp;scheme=RdBu&amp;n=11</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_exdet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">raster</span>, <span class="va">raster.df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># default plot style</span></span>
<span>    <span class="va">map_style_exdet</span> <span class="op">+</span></span>
<span>    <span class="co"># plot regular raster of values first</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">raster.df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># fill scale</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span></span>
<span>      name <span class="op">=</span> <span class="st">"ExDet Score"</span>,</span>
<span>      colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#67001f"</span>, <span class="st">"#f4a582"</span>, <span class="st">"white"</span>, <span class="st">"white"</span>, <span class="st">"white"</span>, <span class="st">"#92c5de"</span>, <span class="st">"#053061"</span><span class="op">)</span>,</span>
<span>      values <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/rescale.html" class="external-link">rescale</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">raster</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>        <span class="fl">0</span>, <span class="fl">1</span>, </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">raster</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span><span class="op">)</span>,</span>
<span>      breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="fu">format_decimal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">raster</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fl">0</span>, <span class="fl">1</span>, </span>
<span>        <span class="fu">format_decimal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">raster</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>      limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="fu">format_decimal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">raster</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        <span class="fu">format_decimal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">raster</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>      guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>frame.colour <span class="op">=</span> <span class="st">"black"</span>, ticks.colour <span class="op">=</span> <span class="st">"black"</span>, barwidth <span class="op">=</span> <span class="fl">20</span>, order <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="op">)</span> </span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level4">
<h4 id="prepare-files">prepare files<a class="anchor" aria-label="anchor" href="#prepare-files"></a>
</h4>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_regional_native</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"exdet_slf_regional_native_v3_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exdet_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"exdet_slf_regional_invaded_v7_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">exdet_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"exdet_slf_regional_invaded_asian_v2_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ssp 126</span></span>
<span><span class="va">exdet_regional_native_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"exdet_slf_regional_native_v3_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_regional_invaded_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"exdet_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_regional_invaded_asian_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"exdet_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ssp 370 </span></span>
<span><span class="va">exdet_regional_native_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"exdet_slf_regional_native_v3_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_regional_invaded_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"exdet_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_regional_invaded_asian_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"exdet_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ssp 585</span></span>
<span><span class="va">exdet_regional_native_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"exdet_slf_regional_native_v3_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_regional_invaded_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"exdet_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">exdet_regional_invaded_asian_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"exdet_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># hist</span></span>
<span><span class="va">exdet_hist_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native</span>, <span class="va">exdet_regional_invaded</span>, <span class="va">exdet_regional_invaded_asian</span><span class="op">)</span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="va">exdet_126_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native_126</span>, <span class="va">exdet_regional_invaded_126</span>, <span class="va">exdet_regional_invaded_asian_126</span><span class="op">)</span></span>
<span><span class="va">exdet_370_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native_370</span>, <span class="va">exdet_regional_invaded_370</span>, <span class="va">exdet_regional_invaded_asian_370</span><span class="op">)</span></span>
<span><span class="va">exdet_585_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_regional_native_585</span>, <span class="va">exdet_regional_invaded_585</span>, <span class="va">exdet_regional_invaded_asian_585</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="historical-2">historical<a class="anchor" aria-label="anchor" href="#historical-2"></a>
</h4>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># historical</span></span>
<span><span class="va">exdet_hist_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_hist_stack2</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ExDet_slf_regional_ensemble_v1_background_projGlobe_1981-2010.asc"</span><span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># re-load</span></span>
<span><span class="va">exdet_hist_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span>x <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ExDet_slf_regional_ensemble_v1_background_projGlobe_1981-2010.asc"</span></span>
<span>    <span class="op">)</span><span class="op">)</span> </span>
<span><span class="co"># convert to df</span></span>
<span><span class="va">exdet_hist_mean_df</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">exdet_hist_mean</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># plot mean raster first</span></span>
<span><span class="va">exdet_regional_ensemble_hist_plot</span> <span class="op">&lt;-</span> <span class="fu">map_exdet</span><span class="op">(</span></span>
<span>  raster <span class="op">=</span> <span class="va">exdet_hist_mean</span>, </span>
<span>  raster.df <span class="op">=</span> <span class="va">exdet_hist_mean_df</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span><span class="co"># add background area shapes</span></span>
<span>  <span class="co"># new fill scale</span></span>
<span>  <span class="fu">ggnewscale</span><span class="fu">::</span><span class="fu"><a href="https://eliocamp.github.io/ggnewscale/reference/new_scale.html" class="external-link">new_scale_fill</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="co"># add layer for bg point area</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">regional_native_background_area_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="st">"Background"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">regional_invaded_background_area_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="st">"Background"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">regional_invaded_asian_background_area_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="st">"Background"</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="co"># scale 2</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Background"</span> <span class="op">=</span> <span class="st">"azure4"</span><span class="op">)</span>, guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>order <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># labels</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"ExDet analysis | bio2, bio11, bio12, bio15 | 1981-2010"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Global climate divergence from 'regional_ensemble' model training set"</span></span>
<span>    <span class="op">)</span> </span>
<span></span>
<span><span class="va">exdet_regional_ensemble_hist_plot</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/create%20hist%20exdet%20plot-1.png" width="700"></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># save plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html" class="external-link">ggsave</a></span><span class="op">(</span></span>
<span>  <span class="va">exdet_regional_ensemble_hist_plot</span>, </span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"vignette-outputs"</span>, <span class="st">"figures"</span>, <span class="st">"ExDet_slf_regional_ensemble_v1_background_projGlobe_1981-2010.jpg"</span><span class="op">)</span>,</span>
<span>  height <span class="op">=</span> <span class="fl">8</span>, </span>
<span>  width <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  device <span class="op">=</span> <span class="va">jpeg</span>,</span>
<span>  dpi <span class="op">=</span> <span class="st">"retina"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="ssp126">ssp126<a class="anchor" aria-label="anchor" href="#ssp126"></a>
</h4>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CMIP6</span></span>
<span><span class="va">exdet_126_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_126_stack2</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ExDet_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp126.asc"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/create%20CMIP6%20exdet%20plot-%20ssp%20126-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="ssp370">ssp370<a class="anchor" aria-label="anchor" href="#ssp370"></a>
</h4>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CMIP6</span></span>
<span><span class="va">exdet_370_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_370_stack2</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ExDet_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp370.asc"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/create%20CMIP6%20exdet%20plot-%20ssp%20370-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="ssp585">ssp585<a class="anchor" aria-label="anchor" href="#ssp585"></a>
</h4>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CMIP6</span></span>
<span><span class="va">exdet_585_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_585_stack2</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ExDet_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp585.asc"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/create%20CMIP6%20exdet%20plot-%20ssp%20585-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="ssp-mean">ssp mean<a class="anchor" aria-label="anchor" href="#ssp-mean"></a>
</h4>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exdet_ssp_mean_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">exdet_126_mean</span>, <span class="va">exdet_370_mean</span>, <span class="va">exdet_585_mean</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CMIP6</span></span>
<span><span class="va">exdet_ssp_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">exdet_ssp_mean_stack</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ExDet_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp_mean.asc"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/create%20CMIP6%20exdet%20plot-%20ssp%20mean-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="mic">5.2 MIC<a class="anchor" aria-label="anchor" href="#mic"></a>
</h3>
<p>I will also ensemble the MIC maps. These will be combined according
to the mode (the most common value of the cell) among the 3 rasters.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_style_MIC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"azure3"</span>,</span>
<span>                                        colour <span class="op">=</span> <span class="st">"azure3"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"longitude"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"latitude"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># color scheme taken from: https://colorbrewer2.org/?type=diverging&amp;scheme=RdBu&amp;n=11</span></span></code></pre></div>
<div class="section level4">
<h4 id="prepare-files-1">prepare files<a class="anchor" aria-label="anchor" href="#prepare-files-1"></a>
</h4>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mic_regional_native</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"mic_slf_regional_native_v3_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">mic_regional_invaded</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"mic_slf_regional_invaded_v7_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">mic_regional_invaded_asian</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"mic_slf_regional_invaded_asian_v2_background_projGlobe.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ssp 126</span></span>
<span><span class="va">mic_regional_native_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"mic_slf_regional_native_v3_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mic_regional_invaded_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"mic_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mic_regional_invaded_asian_126</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"mic_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp126_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ssp 370</span></span>
<span><span class="va">mic_regional_native_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"mic_slf_regional_native_v3_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mic_regional_invaded_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"mic_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mic_regional_invaded_asian_370</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"mic_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp370_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ssp 585</span></span>
<span><span class="va">mic_regional_native_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_native_v3"</span>, <span class="st">"mic_slf_regional_native_v3_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mic_regional_invaded_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_v7"</span>, <span class="st">"mic_slf_regional_invaded_v7_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mic_regional_invaded_asian_585</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_invaded_asian_v2"</span>, <span class="st">"mic_slf_regional_invaded_asian_v2_background_projGlobe_2041-2070_ssp585_GFDL.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># historical</span></span>
<span><span class="va">mic_hist_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mic_regional_native</span>, <span class="va">mic_regional_invaded</span>, <span class="va">mic_regional_invaded_asian</span><span class="op">)</span></span>
<span><span class="co"># CMIP6</span></span>
<span><span class="va">mic_126_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mic_regional_native_126</span>, <span class="va">mic_regional_invaded_126</span>, <span class="va">mic_regional_invaded_asian_126</span><span class="op">)</span></span>
<span><span class="va">mic_370_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mic_regional_native_370</span>, <span class="va">mic_regional_invaded_370</span>, <span class="va">mic_regional_invaded_asian_370</span><span class="op">)</span></span>
<span><span class="va">mic_585_stack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mic_regional_native_585</span>, <span class="va">mic_regional_invaded_585</span>, <span class="va">mic_regional_invaded_asian_585</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="historical-3">historical<a class="anchor" aria-label="anchor" href="#historical-3"></a>
</h4>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># historical</span></span>
<span><span class="va">mic_hist_mean</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">mic_hist_stack2</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"modal"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"mic_slf_regional_ensemble_v1_background_projGlobe_1981-2010.asc"</span><span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/create%20MIC%20plot-%20hist-1.png" width="700"></p>
<!--

### ssp 126 


``` r
mic_126_mean <- terra::app(
  x = mic_126_stack2,
  fun = "modal",
  filename = file.path(
    mypath, "models", "slf_regional_ensemble_v1", "mic_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp126.asc"
    ),
  filetype = "AAIGrid",
  overwrite = FALSE
)

# make df
mic_126_mean_df <- terra::rast(x =  file.path(
    mypath, "models", "slf_regional_ensemble_v1", "mic_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp126.asc"
    )) %>%
  terra::as.data.frame(xy = TRUE)
```


``` r
# plot mean raster first
mic_126_mean_plot <- ggplot() +
  # default plot style
  map_style_MIC +
  # plot regular raster of values first
  geom_raster(data = mic_126_mean_df, aes(x = x, y = y, fill = as.factor(modal))) +
  # scale 1
  viridis::scale_fill_viridis(name = "MIC", discrete = TRUE, labels = c("analogous", "bio11", "bio12", "bio15", "bio2"), guide = guide_legend(order = 1)) +
  # new scale
  ggnewscale::new_scale_fill() +
   # add layer for bg point area
  geom_raster(data = regional_native_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
  geom_raster(data = regional_invaded_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
  geom_raster(data = regional_invaded_asian_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
   # scale 2
   scale_fill_manual(name = "", values = c("Background" = "azure4"), guide = guide_legend(order = 2)) +
  # labels
  labs(
    title = "Most Influential Covariate (MIC) analysis | 2041-2070 | ssp126 GFDL-ESM4",
    subtitle = "Covariate causing most extrapolation from 'regional_ensemble' model training set"
    ) 
```


``` r
# save plot
ggsave(
  mic_126_mean_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_ensemble_v1_background_projGlobe_2041-2070_ssp126_GFDL.jpg"),
  height = 8, 
  width = 12,
  device = jpeg,
  dpi = "retina"
  )
```

### ssp 370 


``` r
mic_370_mean <- terra::app(
  x = mic_370_stack2,
  fun = "modal",
  filename = file.path(
    mypath, "models", "slf_regional_ensemble_v1", "mic_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp370.asc"
    ),
  filetype = "AAIGrid",
  overwrite = FALSE
)

# make df
mic_370_mean_df <- terra::rast(x =  file.path(
    mypath, "models", "slf_regional_ensemble_v1", "mic_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp370.asc"
    )) %>%
  terra::as.data.frame(xy = TRUE)
```


``` r
# plot mean raster first
mic_370_mean_plot <- ggplot() +
  # default plot style
  map_style_MIC +
  # plot regular raster of values first
  geom_raster(data = mic_370_mean_df, aes(x = x, y = y, fill = as.factor(modal))) +
  # scale 1
  viridis::scale_fill_viridis(name = "MIC", discrete = TRUE, labels = c("analogous", "bio11", "bio12", "bio15", "bio2"), guide = guide_legend(order = 1)) +
  # new scale
  ggnewscale::new_scale_fill() +
   # add layer for bg point area
  geom_raster(data = regional_native_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
  geom_raster(data = regional_invaded_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
  geom_raster(data = regional_invaded_asian_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
   # scale 2
   scale_fill_manual(name = "", values = c("Background" = "azure4"), guide = guide_legend(order = 2)) +
  # labels
  labs(
    title = "Most Influential Covariate (MIC) analysis | 2041-2070 | ssp370 GFDL-ESM4",
    subtitle = "Covariate causing most extrapolation from 'regional_ensemble' model training set"
    ) 
```


``` r
# save plot
ggsave(
  mic_370_mean_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_ensemble_v1_background_projGlobe_2041-2070_ssp370_GFDL.jpg"),
  height = 8, 
  width = 12,
  device = jpeg,
  dpi = "retina"
  )
```

### ssp 585 


``` r
mic_585_mean <- terra::app(
  x = mic_585_stack2,
  fun = "modal",
  filename = file.path(
    mypath, "models", "slf_regional_ensemble_v1", "mic_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp585.asc"
    ),
  filetype = "AAIGrid",
  overwrite = FALSE
)

# make df
mic_585_mean_df <- terra::rast(x =  file.path(
    mypath, "models", "slf_regional_ensemble_v1", "mic_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp585.asc"
    )) %>%
  terra::as.data.frame(xy = TRUE)
```


``` r
# plot mean raster first
mic_585_mean_plot <- ggplot() +
  # default plot style
  map_style_MIC +
  # plot regular raster of values first
  geom_raster(data = mic_585_mean_df, aes(x = x, y = y, fill = as.factor(modal))) +
  # scale 1
  viridis::scale_fill_viridis(name = "MIC", discrete = TRUE, labels = c("analogous", "bio11", "bio12", "bio15", "bio2"), guide = guide_legend(order = 1)) +
  # new scale
  ggnewscale::new_scale_fill() +
   # add layer for bg point area
  geom_raster(data = regional_native_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
  geom_raster(data = regional_invaded_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
  geom_raster(data = regional_invaded_asian_background_area_df, aes(x = x, y = y, fill = "Background"), alpha = 0.75) +
   # scale 2
   scale_fill_manual(name = "", values = c("Background" = "azure4"), guide = guide_legend(order = 2)) +
  # labels
  labs(
    title = "Most Influential Covariate (MIC) analysis | 2041-2070 | ssp585 GFDL-ESM4",
    subtitle = "Covariate causing most extrapolation from 'regional_ensemble' model training set"
    ) 
```


``` r
# save plot
ggsave(
  mic_585_mean_plot, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_slf_regional_ensemble_v1_background_projGlobe_2041-2070_ssp585_GFDL.jpg"),
  height = 8, 
  width = 12,
  device = jpeg,
  dpi = "retina"
  )
```

-->
</div>
<div class="section level4">
<h4 id="ssp-mode">ssp mode<a class="anchor" aria-label="anchor" href="#ssp-mode"></a>
</h4>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mic_ssp_mode_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mic_126_mean</span>, <span class="va">mic_370_mean</span>, <span class="va">mic_585_mean</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CMIP6</span></span>
<span><span class="va">mic_ssp_mode</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/app.html" class="external-link">app</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">mic_ssp_mode_stack</span>,</span>
<span>  fun <span class="op">=</span> <span class="st">"modal"</span>,</span>
<span>  filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"mic_slf_regional_ensemble_v1_background_projGlobe_2041-2070_GFDL_ssp_mode.asc"</span></span>
<span>    <span class="op">)</span>,</span>
<span>  filetype <span class="op">=</span> <span class="st">"AAIGrid"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/create%20CMIP6%20mic%20plot-%20ssp%20mean-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="plot--relative-weights-percent-cont">6. plot- Relative weights percent cont<a class="anchor" aria-label="anchor" href="#plot--relative-weights-percent-cont"></a>
</h2>
<p>This bar chart will show the relative weights of each of the three
regional models as a percent contribution to the total ensemble. I will
take the relative weights from each exdet raster, normalize them and
plot those weights.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># native</span></span>
<span><span class="va">ensemble_weight_regional_native_hist</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_weights_slf_regional_native_v3.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># invaded</span></span>
<span><span class="va">ensemble_weight_regional_invaded_hist</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_weights_slf_regional_invaded_v7.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># invaded_asian</span></span>
<span><span class="va">ensemble_weight_regional_invaded_asian_hist</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">mypath</span>, <span class="st">"models"</span>, <span class="st">"slf_regional_ensemble_v1"</span>, <span class="st">"ensemble_weights_slf_regional_invaded_asian_v2.tif"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># stack</span></span>
<span><span class="va">ensemble_weights_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ensemble_weight_regional_native_hist</span>, <span class="va">ensemble_weight_regional_invaded_hist</span>, <span class="va">ensemble_weight_regional_invaded_asian_hist</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># take mean of weights</span></span>
<span><span class="va">relative_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  regional_native <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">ensemble_weights_stack</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  regional_invaded <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">ensemble_weights_stack</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  regional_invaded_asian <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">ensemble_weights_stack</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># absolute value </span></span>
<span></span>
<span><span class="co"># sum the weights</span></span>
<span><span class="va">relative_weights_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">relative_weights</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># normalize weights to sum to 1</span></span>
<span><span class="va">relative_weights_prop</span> <span class="op">&lt;-</span> <span class="va">relative_weights</span> <span class="op">/</span> <span class="va">relative_weights_sum</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># change names of weights</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">relative_weights_prop</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Rn (native)"</span>, <span class="st">"Ri.NAmerica"</span>, <span class="st">"Ri.Asia"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># plotting colors</span></span>
<span><span class="va">ensemble_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"Ri.NAmerica"</span> <span class="op">=</span>  <span class="st">"#e41a1c"</span>,</span>
<span>  <span class="st">"Ri.ASia"</span> <span class="op">=</span> <span class="st">"#377eb8"</span>,</span>
<span>  <span class="st">"Rn (native)"</span> <span class="op">=</span> <span class="st">"#4daf4a"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="110_ensemble_regional_models_files/figure-html/plot%20proportions-1.png" width="700"></p>
<p>Now that we have created an ensembled prediction for our
regional-scale models, we can compare them with the global model
predictions and explore the suitability for SLF under climate change
using suitability maps, point-wise predictions, quadrant plots, variable
response curves and others.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Araújo, M. B., &amp; New, M. (2007). Ensemble forecasting of
species distributions. Trends in Ecology &amp; Evolution, 22(1), 42–47.
<a href="https://doi.org/10.1016/j.tree.2006.09.010" class="external-link uri">https://doi.org/10.1016/j.tree.2006.09.010</a></p></li>
<li><p>Elith, J., Kearney, M., &amp; Phillips, S. (2010). The art of
modelling range-shifting species. Methods in Ecology and Evolution,
1(4), 330–342. <a href="https://doi.org/10.1111/j.2041-210X.2010.00036.x" class="external-link uri">https://doi.org/10.1111/j.2041-210X.2010.00036.x</a></p></li>
<li><p>Mesgaran, M. B., Cousens, R. D., &amp; Webber, B. L. (2014). Here
be dragons: A tool for quantifying novelty due to covariate range and
correlation change when projecting species distribution models.
Diversity and Distributions, 20(10), 1147–1159. <a href="https://doi.org/10.1111/ddi.12209" class="external-link uri">https://doi.org/10.1111/ddi.12209</a></p></li>
</ol>
<!--

# Appendix 

## Unweighted mean ensemble

The weighted mean ensemble is more rigorous because it considers climatic extrapolation and goodness of fit in how it combines the models. However, I will also include the code to create an unweighted ensemble, in the event that one preferred that over the weighted ensemble.


``` r
# historical
pred_hist_mean <- terra::app(
  x = pred_hist_stack,
  fun = "mean",
  filename = file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_regional_unweighted_mean_globe_1981-2010.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)

# CMIP6
# ssp126
pred_126_mean <- terra::app(
  x = pred_126_stack,
  fun = "mean",
  filename = file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_regional_unweighted_mean_globe_2041-2070_GFDL_ssp126.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)
# ssp126
pred_370_mean <- terra::app(
  x = pred_370_stack,
  fun = "mean",
  filename = file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_regional_unweighted_mean_globe_2041-2070_GFDL_ssp370.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)

# ssp585
pred_585_mean <- terra::app(
  x = pred_585_stack,
  fun = "mean",
  filename = file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_regional_unweighted_mean_globe_2041-2070_GFDL_ssp585.asc"),
  filetype = "AAIGrid",
  overwrite = FALSE
)
```

I will also take the mean of the MTSS and MTP thresholds


``` r
#take means
MTSS_mean_unweighted <- mean(MTSS_all)
MTP_mean_unweighted <- mean(MTP_all)

# put into table
ensemble_thresh_values_unweighted <- tibble(
  thresh = c("MTP", "MTSS"),
  value = c(MTP_mean_unweighted, MTSS_mean_unweighted)
)
```


``` r
write_csv(ensemble_thresh_values_unweighted, file = file.path(mypath, "models", "slf_regional_ensemble_v1", "ensemble_threshold_values_unweighted.csv"))
```

## test

I wanted to test if the weighted.mean function normalizes weights to 1. My weights sum to above 1 so I wanted to make sure they normalize.


``` r
test_raster <- exdet_hist_stack
values(test_raster) <- 2

minmax(pred_hist_stack)

# weighted mean
test_weighted <- terra::weighted.mean(
  x = pred_hist_stack,
  w = test_raster # all cell weights are 2
)

minmax(test_weighted)

# just take the mean
test_unweighted <- terra::app(
  x = pred_hist_stack,
  fun = "mean" 
)

minmax(test_unweighted)





# also try with different weights
values(test_raster[[1]]) <- 0.33
values(test_raster[[2]]) <- 0.52
values(test_raster[[3]]) <- 0.15

# weighted mean
test_weighted <- terra::weighted.mean(
  x = pred_hist_stack,
  w = test_raster # all cell weights are 2
)

minmax(test_weighted)

# just take the mean
test_unweighted <- terra::app(
  x = pred_hist_stack,
  fun = "mean" 
)

minmax(test_unweighted)
```

I think they do because the weighted.mean was the same as the mean when the weights were kept equal proportionally to each other, but summed to over 1.

## Patchwork plots- MIC


``` r
# historical
mic_hist_mean_plot <- mic_hist_mean_plot + 
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank(),
    plot.caption = element_blank(),
    axis.title = element_blank()
    ) +
  labs(tag = "A") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme(
    plot.tag.location = "panel",
    plot.tag.position = c(0.05, 0.1),
    plot.tag = element_text(face = "bold", size = 25)
    )


# CMIP6
# ssp 126
mic_126_mean_plot <- mic_126_mean_plot + 
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank(),
    plot.caption = element_blank(),
    axis.title = element_blank()
    ) +
  labs(tag = "B") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))  +
  theme(
    plot.tag.location = "panel",
    plot.tag.position = c(0.05, 0.1),
    plot.tag = element_text(face = "bold", size = 25)
  )
# ssp 370
mic_370_mean_plot <- mic_370_mean_plot + 
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank(),
    plot.caption = element_blank(),
    axis.title = element_blank()
    ) +
  labs(tag = "C") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))  +
  theme(
    plot.tag.location = "panel",
    plot.tag.position = c(0.05, 0.1),
    plot.tag = element_text(face = "bold", size = 25)
  )
# ssp 585
mic_585_mean_plot <- mic_585_mean_plot + 
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank(),
    plot.caption = element_blank(),
    axis.title = element_blank()
    ) +
  labs(tag = "D") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))  +
  theme(
    plot.tag.location = "panel",
    plot.tag.position = c(0.05, 0.1),
    plot.tag = element_text(face = "bold", size = 25)
  )

# patch together
mic_regional_ensemble_patchwork <- (
  mic_hist_mean_plot / mic_126_mean_plot /
  mic_370_mean_plot / mic_585_mean_plot
) +
  plot_layout(axes = "collect", axis_titles = "collect", guides = "collect") +
  plot_annotation(
    title = "Most Influential Covariate (MIC) analysis | (A) Present and 2055 climate change scnerios\n(B) ssp126 (C) ssp370 (D) ssp585",
    subtitle = "Covariate causing most extrapolation from 'regional_ensemble' model training sets"
    ) &
  theme(legend.position = "bottom")
```


``` r
ggsave(
  mic_regional_ensemble_patchwork, 
  filename = file.path(here::here(), "vignette-outputs", "figures", "MIC_regional_ensemble_background_projGlobe_patchwork.jpg"),
  height = 14, 
  width = 12,
  device = jpeg,
  dpi = "retina"
  )
```

-->
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Samuel M. Owens, Matthew R. Helmus.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
